<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>packages_renderer_shared_core_src_lib_ads_ts.222c3af732acbe73baf5.html</title>
</head>
<body>

<script>
"use strict";(globalThis.__LOADABLE_LOADED_CHUNKS__=globalThis.__LOADABLE_LOADED_CHUNKS__||[]).push([["packages_renderer_shared_core_src_lib_ads_ts"],{"../../../packages/renderer/shared/core/src/lib/ads.ts":(e,t,s)=>{s.d(t,{h7:()=>O,tI:()=>B,B7:()=>T,J$:()=>I,tU:()=>C});var i=s("../../../node_modules/.pnpm/strongly-typed-events@2.1.16/node_modules/strongly-typed-events/dist/index.js"),n=s("../../../packages/shared/core/src/lib/deferred.ts"),r=s("../../../packages/shared/core/src/lib/logging.ts");const o=r.b9.logger("Startup/ready.ts");let a;!function(e){e.DOM="DOM",e.POLY="POLY",e.MOAT="MOAT",e.BRIDGE="BRIDGE",e.GPT="GPT"}(a||(a={}));const d=new class{constructor(){this.events={},this.getDeferredEvent=e=>this.events[e],this.hasBeenInit=!1,this.init=()=>(this.hasBeenInit||(this.registerGlobalCallback(a.DOM,"domCompleteReady"),this.registerGlobalCallback(a.MOAT,"moatYieldReady",250),this.hasBeenInit=!0),this),Object.keys(a).forEach((e=>{this.events[e]=new n.B,this.eventCompletedDuringInit(e)&&this.signal(a[e])}))}eventCompletedDuringInit(e){if("undefined"!=typeof window)return!!(window.bootEvents||{})[e]}waitFor(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return Promise.all(t.map((e=>this.events[e])))}registerGlobalCallback(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if("undefined"!=typeof window)if(this.eventCompletedDuringInit(e))o.debug(`Startup event ${e} already done`),this.signal(e);else{let i;o.debug(`Registering startup event ${e}`);let n=!1;s&&(i=setTimeout((()=>{n=!0,this.fail(e)}),s)),window[t]=()=>{if(i&&window.clearTimeout(i),!n)return o.debug(`Triggering startup event handler ${t}`),this.signal(e)}}}signal(e){return o.debug(`Signalling startup complete for ${e}`),this.events[e].resolve(!0),!0}fail(e){return o.debug(`Signalling startup failed for ${e}`),this.events[e].reject(!1),!1}};var l=s("../../../packages/renderer/shared/core/src/abstracts/store/base-store.abstract.ts"),c=s("../../../packages/renderer/shared/core/src/utilities/cookie.ts"),h=s("../../../packages/renderer/shared/core/src/utilities/window.ts");const g=(e,t)=>{const s=new Promise(((t,s)=>{const i=setTimeout((()=>{clearTimeout(i),s(`Timed out in ${e} ms.`)}),e)}));return Promise.race([t,s])},u=r.b9.logger("AmazonBidding");const p=r.b9.logger("RubiconBidding");const b=r.b9.logger("BiddingManager/bidding/index.ts"),m=[class{constructor(e){this.opts=e,this._library=void 0,this.libId="amazon-tam-lib",this.pendingFetchPromise=null}loadLibrary(){if(this._library)return this._library;const{env:e}=this.opts.store;return this._library=new Promise(((t,s)=>{const i=document.querySelector("head"),n=document.createElement("script");i&&e.AMAZON_TAM_LIBRARY?(n.id=this.libId,n.async=!0,n.defer=!0,n.src=e.AMAZON_TAM_LIBRARY,n.onload=()=>{u.debug("Amazon TAM library loaded"),window.apstag.init({pubID:e.AMAZON_PUBLISHER_ID||"",adServer:"googletag"}),t()},n.onerror=(e,t,i,n,r)=>{r&&u.debug("Amazon TAM library could not be loaded",r.message),s(new Error("Amazon TAM library could not be loaded"))},i.appendChild(n)):(u.debug(`Amazon TAM library could not be loaded: head? ${!!i} configured? ${e.AMAZON_TAM_LIBRARY}`),s(new Error("Amazon TAM library could not be loaded")))})),this._library}async fetch(e){const t=e?.map((e=>({slotID:e.slot.getSlotElementId(),slotName:e.slot.getAdUnitPath(),sizes:e.sizes})))||[];return g(this.opts.timeout,this.loadLibrary().then((async()=>t?.length?(this.pendingFetchPromise||(this.pendingFetchPromise=new n.B),window.apstag.fetchBids({slots:t},(()=>{window.apstag.setDisplayBids(),this.pendingFetchPromise?.resolve(!0)})),this.pendingFetchPromise.promise):Promise.reject(!1))).catch((e=>(u.debug(e.message),Promise.reject(!1)))))}},class{constructor(e){this.opts=e,this._library=void 0,this.libId="rubicon-lib",this.pendingFetchPromise=null}loadLibrary(){if(this._library)return this._library;const{env:e}=this.opts.store;return this._library=new Promise(((t,s)=>{const i=document.querySelector("head"),n=document.createElement("script");i&&e.RUBICON_BIDDING_LIBRARY?(n.id=this.libId,n.async=!0,n.defer=!0,n.src=e.RUBICON_BIDDING_LIBRARY,n.onload=()=>{p.debug("Rubicon Bidding library loaded"),t()},n.onerror=(e,t,i,n,r)=>{r&&p.debug("Rubicon Bidding library could not be loaded",r.message),s(new Error("Rubicon Bidding library could not be loaded"))},i.appendChild(n)):(p.debug(`Rubicon Bidding library could not be loaded: head? ${!!i} configured? ${e.RUBICON_BIDDING_LIBRARY}`),s(new Error("Rubicon Bidding library could not be loaded")))})),this._library}async fetch(e){const t=e?.map((e=>e.slot))||[];return g(this.opts.timeout,this.loadLibrary().then((async()=>t?.length?(this.pendingFetchPromise||(this.pendingFetchPromise=new n.B),window.pbjs.rp.requestBids({gptSlotObjects:t,callback:()=>{this.pendingFetchPromise?.resolve(!0)}}),this.pendingFetchPromise.promise):Promise.reject(!1))).catch((e=>(p.debug(e.message),Promise.reject(!1)))))}}];class f{constructor(e){this.store=e,this.enabled=!1,this.providers=[],this.queue=e=>{e&&this.providers.push(e)},this.refresh=e=>{if(this.enabled=this.store?.getCcpaStatus()!==l._.OptOut&&this.store?.site.sections.ads?.header_bidding||!1,!this.enabled){const e="Header bidding disabled";return b.debug(e),Promise.resolve(e)}return Promise.all(this.providers.map((t=>t.fetch(e))))}}}var w=s("../../../packages/renderer/shared/core/src/lib/resize-watcher.ts");class S{constructor(){this.intersection=null,this.store=void 0,this.gpt=void 0}}S.PUSHDOWN_INDEX="7004",S.POSITION_ATTRIBUTE="data-position",S.ADSPLIT_ATTRIBUTE="data-split",S.SELECTORS={adSlots:"component-ad-unit:not(.initialized)",collapse:"ad-collapse",lazyLoad:"lazy-load",initialized:"initialized",refresh:"viewport-refresh"};class v{constructor(){this.active=!0,this.configuredSlots={},this.pendingPromise=null,this.pub=void 0,this._onSlotRendered=new i.FK,this.refreshInProgress=!1}get onSlotRendered(){return this._onSlotRendered.asEvent()}}const y=r.b9.logger("ADS"),T=e=>{const t=e?.blocks.find((e=>"ad:top-leaderboard"===e.region));return t&&"0"!==t?.value?.position?t:(y.error("No pushdown found"),null)},I=e=>e?.tags?.includes("display-hints/sticky-ad")||!1;class A extends S{constructor(e,t){super(),this.store=e,this.gpt=t,this.init=async()=>{const{site:e}=this.store;return"undefined"==typeof IntersectionObserver?(y.debug("No IntersectionObserver"),!1):e.sections.ads?.dfp_switch&&this.gpt.active?this.gpt.init().then((()=>(new MutationObserver((()=>this.handleMutationEvent())).observe(document.body,{childList:!0,subtree:!0}),w.n.onWidthChange.subscribe((()=>{this.gpt.clearDisplayed(),this.gpt.refreshAllVisibleAds()})),this.gpt.onSlotRendered.subscribe((e=>this.slotRendered(e))),this.store.onIntersectAction.subscribe((e=>{const{entry:t}=e;t.isIntersecting&&(this.gpt.setVisible(t.target.id,t.isIntersecting),w.n.resizeInProgress||this.gpt.refreshAllVisibleAds())})),!0))).catch((e=>(y.warn("Error initializing Ads: ",e),!1))):(y.debug("DFP Ads disabled"),!1)},this.clear=()=>{this.gpt.clearDisplayed()},this.handleMutationEvent=()=>this.scan(),this.slotRendered=e=>{const{isEmpty:t,slot:s}=e,[i]=s.getTargeting("pos"),n=`dfp-ad-${i}`,r=document.getElementById(n);if(i===A.PUSHDOWN_INDEX&&!t){const e=this.gpt.configuredSlots[n];e&&(window.$Ads.pdInstance=new E(e))}"3317"===i&&t&&r&&r.remove(),r&&!t&&r.classList.add("slot-rendered")},this.handleIntersectionUpdate=e=>{e.forEach((e=>{this.gpt.setVisible(e.target.id,e.isIntersecting)})),w.n.resizeInProgress||this.gpt.refreshAllVisibleAds()},this.scan=()=>!!this.gpt.active&&(this.scanForSlots(document).forEach((e=>{let{id:t,position:s,collapse:i,element:n,lazy:r,visibleChangeRefresh:o,split:a}=e;n&&(n.classList.add(A.SELECTORS.initialized),this.gpt.createSlot(t,s,n,i,o,a),r||this.gpt.setVisible(t,!0))})),this.gpt.refreshAllVisibleAds(),!0),this.cleanup=()=>{this.gpt.destroySlots()}}scanForSlots(e){const t=e.querySelectorAll(`.${A.SELECTORS.adSlots}`);return Array.from(t).map((e=>{const t=e.classList.contains(A.SELECTORS.collapse),s=e.classList.contains(A.SELECTORS.lazyLoad),i=e.classList.contains(A.SELECTORS.initialized),n=e.classList.contains(A.SELECTORS.refresh),r=e.getAttribute(A.POSITION_ATTRIBUTE),o=e.getAttribute(A.ADSPLIT_ATTRIBUTE);return{id:e.id,element:e,initialized:i,position:r,collapse:t,lazy:s,visibleChangeRefresh:n,split:o}}))}}const _=r.b9.logger("Ads");class E{get onTransitionEnd(){return this._onTransitionEnd.asEvent()}constructor(e){this.slot=e,this.gate_cookie="",this.adIframe=null,this._onTransitionEnd=new i.nz;if(e.element.classList.contains(E.INIT_CLASS))_.warn(`PD=${e.id} has already been initialized`);else if(e.element.classList.add(E.INIT_CLASS),this.gate_cookie=`pd-seen-${e.id}`,this.adIframe=e.element.querySelector("iframe"),this.adIframe){this.adIframe.addEventListener("transitionend",(()=>{this._onTransitionEnd.dispatch()}));(0,c.Q)().get(this.gate_cookie)||this.pushdownAutoStart()}}pushdownAutoStart(){const e=this.adIframe;e&&e.contentWindow&&"function"==typeof e.contentWindow.expand?(e.contentWindow.expand(),this.pushdownExpand(),window.setTimeout((()=>{e&&e.contentWindow&&"function"==typeof e.contentWindow.collapse&&e.contentWindow.collapse(),(0,c.Q)().set(this.gate_cookie,"1",1)}),E.PUSHDOWN_TIMEOUT)):this.slot.element.remove()}pushdownExpand(e){"function"==typeof e&&this.onTransitionEnd.one(e),this.adIframe&&this.adIframe.classList.add("expanded")}pushdownCollapse(e){"function"==typeof e&&this.onTransitionEnd.one(e),this.adIframe&&this.adIframe.classList.remove("expanded")}}E.INIT_CLASS="pd-init",E.PUSHDOWN_TIMEOUT=1e4;const P="gpt-lib",R=r.b9.logger("GPTUtils/ads.ts");class L extends v{constructor(e,t){super(),this.store=e,this.bidding=t,this.active=!0,this.configuredSlots={},this.pendingPromise=null,this.pub=void 0,this.configurePubAdsService=()=>{this.queue((async()=>{const{session:e}=this.store;R.debug("Configuring Google PubAds Service"),this.pub=window.googletag.pubads(),this.pub.disableInitialLoad(),this.pub.enableAsyncRendering(),this.pub.enableSingleRequest(),this.setBaseTargeting();try{await d.init().waitFor(a.MOAT)}catch(e){R.warn("Startup Event for MOAT never fired",e)}this.pub.addEventListener("slotRenderEnded",(e=>this.handleSlotRenderEnded(e)));let t=(0,h.Ax)()&&window.location.search.toLowerCase().includes("ccpa")||!1;e.currentSession?(e.currentSession.state.authenticated&&e.currentSession.hasPrivacy&&(t=this.store?.getCcpaStatus()===l._.OptOut),e.currentSession.onStatusChanged.sub((()=>{this.pub?.setPrivacySettings?.({restrictDataProcessing:this.store?.getCcpaStatus()===l._.OptOut})}))):R.debug("No current session"),R.debug("restrictDataProcessing: ",t),this.pub?.setPrivacySettings?.({restrictDataProcessing:t}),window.googletag.enableServices(),this.pendingPromise?.resolve(!0)}))},this.enableServices=()=>new Promise((e=>{this.queue((()=>{window.googletag.enableServices(),e()}))})),this.setBaseTargeting=()=>{this.pub?.setTargeting("hn",window.location.hostname);const e=this.store?.tags.ads;e?.env&&this.pub?.setTargeting("env",e.env),this.pub?.setTargeting("referrer",document.referrer),this.pub?.setTargeting("vers","Inferno")},window.googletag=window.googletag||{},window.googletag.cmd=window.googletag.cmd||[]}queue(e){this.active&&window.googletag&&window.googletag.cmd&&window.googletag.cmd.push(e)}async init(){if(R.debug("Initializing GPT Utils"),this.pendingPromise||(this.pendingPromise=new n.B),m.map((e=>this.bidding?.queue(new e({store:this.store,timeout:2e3,googletag:window.googletag})))),(0,h.Ax)()){const e=document.querySelector("head");let t=document.getElementById(P);e&&!t&&(t=document.createElement("script"),t.id=P,t.async=!0,t.defer=!0,t.src="//www.googletagservices.com/tag/js/gpt.js",t.onload=()=>{R.debug("GPT Library Loaded"),this.configurePubAdsService()},t.onerror=()=>{R.debug("Error loading GPT Library"),this.pendingPromise?.reject(!1)},e.appendChild(t))}else this.pendingPromise?.reject(!1);return this.pendingPromise.promise}clearDisplayed(){this.queue((()=>{this.pub?.clearTargeting(),this.setBaseTargeting(),Object.values(this.configuredSlots).forEach((e=>{e.displayed=!1,e.rendered=!1,e.slot.clearTargeting(),this.setupSlotTargeting(e.slot,e.position_id)}))}))}setVisible(e,t){this.queue((()=>{const s=this.configuredSlots[e];s&&s.visibleChangeRefresh&&s.visible&&!t&&(s.displayed=!1),s&&(s.visible=t)}))}refreshAllVisibleAds(){this.queue((()=>{const e=Object.values(this.configuredSlots).filter((e=>e.visible&&!e.displayed));e.length&&!this.refreshInProgress&&(this.refreshInProgress=!0,this.bidding?.refresh(e.map((e=>({slot:e.slot,sizes:e.sizes||[]})))).catch((e=>{R.debug(e)})).finally((()=>{window.googletag.pubads().refresh(e.map((e=>e.slot))),e.forEach((e=>e.displayed=!0)),this.refreshInProgress=!1})))}))}resolveSlot(e){const t=this.store?.site.config.adPositions.find((t=>t.positionId===e));if(!this.store||!t)return;const s=this.store.site.index.market.replace("markets/",""),{facets:i}=this.store.site.index;return{dfp_id:`dfp-ad-${e}`,market:s,ad_site:s.replace("-",".").toLowerCase(),station:this.store.site.index.slug.toLowerCase(),format:i.map((e=>e.replace("formats/",""))),...t}}createSlot(e,t,s){let i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],n=arguments.length>4&&void 0!==arguments[4]&&arguments[4],r=arguments.length>5?arguments[5]:void 0;this.queue((async()=>{let o=[];const a=googletag.sizeMapping(),d=this.resolveSlot(t);if(this.configuredSlots[e])return void R.debug("slot: ",this.configuredSlots[e]);if(!d)return void R.debug(`Couldn't find configured position for ${t}`);d.breakpoints.forEach((e=>{if(e.sizes){const t=e.sizes.filter((e=>e.w&&e.h)).map((e=>[e.w,e.h]));o=o.concat(t),a.addSize([e.breakpoint,0],t)}}));const l=Math.floor(100*Math.random())<=parseInt(r,10)?".n":"",c=`/6663/ccr.${d.ad_site.toLowerCase()}${l}/${d.station.toLowerCase()}`,h=!!o.map((e=>-1===e[0]&&-1===e[1])).filter(Boolean).length?"fluid":function(e){const t=new Set;return e.filter((e=>{const s=!t.has(e.toString());return t.add(e.toString()),s}))}(o),g=window.googletag.defineSlot(c,h,e);return this.setupSlotTargeting(g,t),g.defineSizeMapping(a.build()).setCollapseEmptyDiv(!0,!0).addService(window.googletag.pubads()),this.configuredSlots[e]={id:e,slot:g,position_id:t,element:s,visibleChangeRefresh:n,displayed:!1,visible:!1,rendered:!1,sizes:h},g.setCollapseEmptyDiv(i),g}))}setupSlotTargeting(e,t){const s=this.resolveSlot(t);if(!s)return;e.setTargeting("ccrpos",[s.positionId]),e.setTargeting("pos",[s.positionId]),e.setTargeting("market",[s.market]);const i=this.store?.tags.ads;i&&(e.setTargeting("format",i.format),e.setTargeting("genre",i.genre),e.setTargeting("keywords",i.keywords),e.setTargeting("topics",i.topics),e.setTargeting("path",i.path),e.setTargeting("contenttype",i.type),""!==i.microsite&&e.setTargeting("microsite",i.microsite))}destroySlots(){this.queue((()=>{window.googletag.destroySlots()}))}isRendered(e){const t=this.configuredSlots[e];return!!t&&t.rendered}isSlotRenderEndedEvent(e){return e}handleSlotRenderEnded(e){const[t]=e.slot.getTargeting("pos"),s=this.configuredSlots[t];s&&(s.rendered=!0),this.isSlotRenderEndedEvent(e)&&this._onSlotRendered.dispatch(e)}}const O=e=>{if((0,h.Ax)())return new A(e,new L(e,new f(e)))},B=e=>e>0,C=(e,t,s,i)=>i&&e>t&&s+1<e&&(s+1)%t==0},"../../../packages/shared/core/src/lib/deferred.ts":(e,t,s)=>{s.d(t,{B:()=>i});class i{constructor(){this.promise=void 0,this.resolve=()=>null,this.reject=()=>null,this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}get then(){return this.promise.then.bind(this.promise)}get catch(){return this.promise.catch.bind(this.promise)}}}}]);
//# sourceMappingURL=packages_renderer_shared_core_src_lib_ads_ts.222c3af732acbe73baf5.js.map
</script>

</body>
</html>
