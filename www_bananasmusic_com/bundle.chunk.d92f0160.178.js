"use strict";(globalThis.productionBundleChunks=globalThis.productionBundleChunks||[]).push([[178],{4178:(e,t,o)=>{o.r(t),o.d(t,{RecommendationInstantiator:()=>d,defined:()=>m});var n=o(3554),r=o(4247),i=o(7241),c=o.n(i),s=o(8732),l=o(7762),a=o(6310),f=o(7689),g=o(1611),p=o(5860);class d{constructor(e,t,o){var n=this;if(this.mode=s.$.production,this.controller={},this.uses=[],this.plugins=[],this.middleware=[],this.config=e,!this.config)throw new Error("Recommendation Instantiator config is required");if(!this.config.config?.branch)throw new Error("Recommendation Instantiator config must contain 'branch' property");if(!this.config.components||"object"!=typeof this.config.components||!Object.keys(this.config.components).length)throw new Error("Recommendation Instantiator config must contain 'components' mapping property");if(!(t?.client&&t?.tracker||this.config?.client?.globals?.siteId))throw new Error("Recommendation Instantiator config must contain a valid config.client.globals.siteId value");this.config.mode&&Object.values(s.$).includes(this.config.mode)&&(this.mode=this.config.mode,this.config?.client?.globals?.siteId&&(this.config.client.config=this.config.client.config||{},this.config.client.config.mode=this.config.client.config.mode||this.mode)),window.searchspring=window.searchspring||{},this.context=c()(o||{},e.context||{}),this.client=t?.client||new f.K(this.config.client.globals,this.config.client.config),this.tracker=t?.tracker||new p.J(this.config.client.globals),this.logger=t?.logger||new g.V({prefix:"RecommendationInstantiator ",mode:this.mode});const r={};this.targeter=new l.b([{selector:`${this.config.selector||'script[type="searchspring/recommend"], script[type="searchspring/personalized-recommendations"]'}, script[type="searchspring/recommend"][profile="email"]`,autoRetarget:!0,clickRetarget:!0,inject:{action:"before",element:function(e,t){const o=t.getAttribute("profile")||"",n=document.createElement("div");return n.setAttribute("searchspring-recommend",o),n}}},{selector:'script[type="searchspring/recommendations"]',autoRetarget:!0,clickRetarget:!0,emptyTarget:!1}],(async function(e,t,o){const i=(0,a.S)(["shopperId","shopper","product","products","seed","cart","filters","blockedItems","options","profile","custom","profiles","globals"],o||t);if(i.profiles&&i.profiles.length){const e=i.profiles,t=i.globals,o={...m({blockedItems:t?.blockedItems,filters:t?.filters,cart:t?.cart&&u(t.cart),products:t?.products,shopper:t?.shopper?.id,batchId:Math.random()})},s=[];e.forEach((function(e){if(e.selector){const t={selector:e.selector,autoRetarget:!0,clickRetarget:!0,profile:e};s.push(t)}})),new l.b(s,(async function(e,s,l){if(e.profile?.profile||e.profile?.tag){const a={...o,profile:e.profile?.options,tag:e.profile.tag||e.profile.profile},f=c()(n.context,m({globals:t,profile:e.profile}));i.custom&&(f.custom=i.custom),h(n,s,f,r,l,a)}}))}else{const{profile:e,products:s,product:l,seed:a,filters:f,blockedItems:g,options:p,shopper:d,shopperId:b}=i,w=[].concat(s||l||a||[]),y=[d,d?.id,b,b?.id].filter((function(e){return e&&"string"==typeof e})).pop(),k={tag:e,...m({products:w.length?w:void 0,cart:i.cart&&u(i.cart),shopper:y,filters:f,blockedItems:g,profile:p})};h(n,t,c()(n.context,i),r,o,k)}}))}plugin(e){for(var t=arguments.length,o=new Array(t>1?t-1:0),n=1;n<t;n++)o[n-1]=arguments[n];this.plugins.push({func:e,args:o})}on(e){for(var t=arguments.length,o=new Array(t>1?t-1:0),n=1;n<t;n++)o[n-1]=arguments[n];this.middleware.push({event:e,func:o})}use(e){this.uses.push(e)}}async function h(e,t,i,s,l,a){const{profile:f,batchId:g,cart:p,tag:d}=a,h=f?.batched??a.batched??!0;if(!d)return void e.logger.warn("'tag' is missing from <script> tag, skipping this profile",l);Array.isArray(p)&&e.tracker.cookies.cart.set(p),s[d]=s[d]+1||1;const u=c().all([e.config.client?.globals||{},e.config.config?.globals||{},a]),m={id:`recommend_${d}_${s[d]-1}`,tag:d,batched:h??!0,realtime:Boolean(i.options?.realtime??i.profile?.options?.realtime),batchId:g,...e.config.config,globals:u};f?.branch&&(m.branch=f?.branch);let b=Object.keys(e.controller).map((function(t){return e.controller[t]})).filter((function(e){return JSON.stringify({batched:e.config.batched,branch:e.config.branch,globals:e.config.globals,tag:e.config.tag,realtime:e.config.realtime})==JSON.stringify({batched:m.batched,branch:m.branch,globals:m.globals,tag:m.tag,realtime:m.realtime})}))[0];if(!b){const t=(await o.e(954).then(o.bind(o,6954))).default;b=t({url:e.config.url,controller:m,context:i,mode:e.config.mode},{client:e.client,tracker:e.tracker}),e.uses.forEach((function(e){return b.use(e)})),e.plugins.forEach((function(e){return b.plugin(e.func,...e.args)})),e.middleware.forEach((function(e){return b.on(e.event,...e.func)}))}b.store.loaded||b.store.loading||await b.search(),b.addTargeter(e.targeter),e.controller[b.config.id]=b,window.searchspring.controller=window.searchspring.controller||{},window.searchspring.controller[b.config.id]=b;const w=b.store.profile.display.templateParameters,y=b.store.profile.display.template?.component;if(b.store.error)return;if(!b.store.profile.display.template)return void e.logger.error(`profile '${d}' found on the following element is missing a template!\n${l?.outerHTML}`);if(!w)return void e.logger.error(`profile '${d}' found on the following element is missing templateParameters!\n${l?.outerHTML}`);if(!y)return void e.logger.error(`profile '${d}' found on the following element is missing a component!\n${l?.outerHTML}`);const k=e.config.components[y]&&await e.config.components[y]();k?setTimeout((function(){t&&(0,r.XX)((0,n.Y)(k,{controller:b}),t)})):e.logger.error(`profile '${d}' found on the following element is expecting component mapping for '${y}' - verify instantiator config.\n${l?.outerHTML}`)}function u(e){if("function"==typeof e)try{const t=e();if(Array.isArray(t))return t}catch(e){}else if(Array.isArray(e))return e;return[]}function m(e){const t={};return Object.keys(e).map((function(o){void 0!==e[o]&&(t[o]=e[o])})),t}}}]);