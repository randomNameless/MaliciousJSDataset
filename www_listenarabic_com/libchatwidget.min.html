<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>libchatwidget.min.html</title>
</head>
<body>

<script>
(()=>{var t={446:function(t){
/*! Browser bundle of nunjucks 3.2.4 (slim, only works with precompiled templates) */
var e;"undefined"!=typeof self&&self,e=function(){return function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:s})},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=6)}([function(t,e){},function(t,e,i){"use strict";var s=Array.prototype,n=Object.prototype,r={"&":"&amp;",'"':"&quot;","'":"&#39;","<":"&lt;",">":"&gt;","\\":"&#92;"},o=/[&"'<>\\]/g;function a(t,e){return n.hasOwnProperty.call(t,e)}function h(t){return r[t]}function l(t,e,i){var s,n,r;if(t instanceof Error&&(t=(n=t).name+": "+n.message),Object.setPrototypeOf?(s=new Error(t),Object.setPrototypeOf(s,l.prototype)):(s=this,Object.defineProperty(s,"message",{enumerable:!1,writable:!0,value:t})),Object.defineProperty(s,"name",{value:"Template render error"}),Error.captureStackTrace&&Error.captureStackTrace(s,this.constructor),n){var o=Object.getOwnPropertyDescriptor(n,"stack");(r=o&&(o.get||function(){return o.value}))||(r=function(){return n.stack})}else{var a=new Error(t).stack;r=function(){return a}}return Object.defineProperty(s,"stack",{get:function(){return r.call(s)}}),Object.defineProperty(s,"cause",{value:n}),s.lineno=e,s.colno=i,s.firstUpdate=!0,s.Update=function(t){var e="("+(t||"unknown path")+")";return this.firstUpdate&&(this.lineno&&this.colno?e+=" [Line "+this.lineno+", Column "+this.colno+"]":this.lineno&&(e+=" [Line "+this.lineno+"]")),e+="\n ",this.firstUpdate&&(e+=" "),this.message=e+(this.message||""),this.firstUpdate=!1,this},s}function c(t){return"[object Function]"===n.toString.call(t)}function u(t){return"[object Array]"===n.toString.call(t)}function d(t){return"[object String]"===n.toString.call(t)}function p(t){return"[object Object]"===n.toString.call(t)}function m(t){var e,i=(e=t)?"string"==typeof e?e.split("."):[e]:[];return function(t){for(var e=t,s=0;s<i.length;s++){var n=i[s];if(!a(e,n))return;e=e[n]}return e}}function f(t){return Array.prototype.slice.call(t)}function g(t,e,i){return Array.prototype.indexOf.call(t||[],e,i)}function b(t){var e=[];for(var i in t)a(t,i)&&e.push(i);return e}(e=t.exports={}).hasOwnProp=a,e._prettifyError=function(t,i,s){if(s.Update||(s=new e.TemplateError(s)),s.Update(t),!i){var n=s;(s=new Error(n.message)).name=n.name}return s},Object.setPrototypeOf?Object.setPrototypeOf(l.prototype,Error.prototype):l.prototype=Object.create(Error.prototype,{constructor:{value:l}}),e.TemplateError=l,e.escape=function(t){return t.replace(o,h)},e.isFunction=c,e.isArray=u,e.isString=d,e.isObject=p,e.getAttrGetter=m,e.groupBy=function(t,e,i){for(var s={},n=c(e)?e:m(e),r=0;r<t.length;r++){var o=t[r],a=n(o,r);if(void 0===a&&!0===i)throw new TypeError('groupby: attribute "'+e+'" resolved to undefined');(s[a]||(s[a]=[])).push(o)}return s},e.toArray=f,e.without=function(t){var e=[];if(!t)return e;for(var i=t.length,s=f(arguments).slice(1),n=-1;++n<i;)-1===g(s,t[n])&&e.push(t[n]);return e},e.repeat=function(t,e){for(var i="",s=0;s<e;s++)i+=t;return i},e.each=function(t,e,i){if(null!=t)if(s.forEach&&t.forEach===s.forEach)t.forEach(e,i);else if(t.length===+t.length)for(var n=0,r=t.length;n<r;n++)e.call(i,t[n],n,t)},e.map=function(t,e){var i=[];if(null==t)return i;if(s.map&&t.map===s.map)return t.map(e);for(var n=0;n<t.length;n++)i[i.length]=e(t[n],n);return t.length===+t.length&&(i.length=t.length),i},e.asyncIter=function(t,e,i){var s=-1;!function n(){++s<t.length?e(t[s],s,n,i):i()}()},e.asyncFor=function(t,e,i){var s=b(t||{}),n=s.length,r=-1;!function o(){r++;var a=s[r];r<n?e(a,t[a],r,n,o):i()}()},e.indexOf=g,e.keys=b,e._entries=function(t){return b(t).map((function(e){return[e,t[e]]}))},e._values=function(t){return b(t).map((function(e){return t[e]}))},e._assign=e.extend=function(t,e){return t=t||{},b(e).forEach((function(i){t[i]=e[i]})),t},e.inOperator=function(t,e){if(u(e)||d(e))return-1!==e.indexOf(t);if(p(e))return t in e;throw new Error('Cannot use "in" operator to search for "'+t+'" in unexpected types.')}},function(t,e,i){"use strict";var s=i(1),n=Array.from,r="function"==typeof Symbol&&Symbol.iterator&&"function"==typeof n,o=function(){function t(t,e){this.variables=Object.create(null),this.parent=t,this.topLevel=!1,this.isolateWrites=e}var e=t.prototype;return e.set=function(t,e,i){var s=t.split("."),n=this.variables,r=this;if(i&&(r=this.resolve(s[0],!0)))r.set(t,e);else{for(var o=0;o<s.length-1;o++){var a=s[o];n[a]||(n[a]={}),n=n[a]}n[s[s.length-1]]=e}},e.get=function(t){var e=this.variables[t];return void 0!==e?e:null},e.lookup=function(t){var e=this.parent,i=this.variables[t];return void 0!==i?i:e&&e.lookup(t)},e.resolve=function(t,e){var i=e&&this.isolateWrites?void 0:this.parent;return void 0!==this.variables[t]?this:i&&i.resolve(t)},e.push=function(e){return new t(this,e)},e.pop=function(){return this.parent},t}();function a(t){return t&&Object.prototype.hasOwnProperty.call(t,"__keywords")}function h(t){var e=t.length;return 0===e?0:a(t[e-1])?e-1:e}function l(t){if("string"!=typeof t)return t;this.val=t,this.length=t.length}l.prototype=Object.create(String.prototype,{length:{writable:!0,configurable:!0,value:0}}),l.prototype.valueOf=function(){return this.val},l.prototype.toString=function(){return this.val},t.exports={Frame:o,makeMacro:function(t,e,i){return function(){for(var s=arguments.length,n=new Array(s),r=0;r<s;r++)n[r]=arguments[r];var o,l=h(n),c=function(t){var e=t.length;if(e){var i=t[e-1];if(a(i))return i}return{}}(n);if(l>t.length)o=n.slice(0,t.length),n.slice(o.length,l).forEach((function(t,i){i<e.length&&(c[e[i]]=t)})),o.push(c);else if(l<t.length){o=n.slice(0,l);for(var u=l;u<t.length;u++){var d=t[u];o.push(c[d]),delete c[d]}o.push(c)}else o=n;return i.apply(this,o)}},makeKeywordArgs:function(t){return t.__keywords=!0,t},numArgs:h,suppressValue:function(t,e){return t=null!=t?t:"",!e||t instanceof l||(t=s.escape(t.toString())),t},ensureDefined:function(t,e,i){if(null==t)throw new s.TemplateError("attempted to output null or undefined value",e+1,i+1);return t},memberLookup:function(t,e){if(null!=t)return"function"==typeof t[e]?function(){for(var i=arguments.length,s=new Array(i),n=0;n<i;n++)s[n]=arguments[n];return t[e].apply(t,s)}:t[e]},contextOrFrameLookup:function(t,e,i){var s=e.lookup(i);return void 0!==s?s:t.lookup(i)},callWrap:function(t,e,i,s){if(!t)throw new Error("Unable to call `"+e+"`, which is undefined or falsey");if("function"!=typeof t)throw new Error("Unable to call `"+e+"`, which is not a function");return t.apply(i,s)},handleError:function(t,e,i){return t.lineno?t:new s.TemplateError(t,e,i)},isArray:s.isArray,keys:s.keys,SafeString:l,copySafeness:function(t,e){return t instanceof l?new l(e):e.toString()},markSafe:function(t){var e=typeof t;return"string"===e?new l(t):"function"!==e?t:function(e){var i=t.apply(this,arguments);return"string"==typeof i?new l(i):i}},asyncEach:function(t,e,i,n){if(s.isArray(t)){var r=t.length;s.asyncIter(t,(function(t,s,n){switch(e){case 1:i(t,s,r,n);break;case 2:i(t[0],t[1],s,r,n);break;case 3:i(t[0],t[1],t[2],s,r,n);break;default:t.push(s,r,n),i.apply(this,t)}}),n)}else s.asyncFor(t,(function(t,e,s,n,r){i(t,e,s,n,r)}),n)},asyncAll:function(t,e,i,n){var r,o,a=0;function h(t,e){a++,o[t]=e,a===r&&n(null,o.join(""))}if(s.isArray(t))if(r=t.length,o=new Array(r),0===r)n(null,"");else for(var l=0;l<t.length;l++){var c=t[l];switch(e){case 1:i(c,l,r,h);break;case 2:i(c[0],c[1],l,r,h);break;case 3:i(c[0],c[1],c[2],l,r,h);break;default:c.push(l,r,h),i.apply(this,c)}}else{var u=s.keys(t||{});if(r=u.length,o=new Array(r),0===r)n(null,"");else for(var d=0;d<u.length;d++){var p=u[d];i(p,t[p],d,r,h)}}},inOperator:s.inOperator,fromIterator:function(t){return"object"!=typeof t||null===t||s.isArray(t)?t:r&&Symbol.iterator in t?n(t):t}}},function(t,e,i){"use strict";function s(t,e){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},s(t,e)}var n=function(t){var e,i;function n(e){var i;return(i=t.call(this)||this).precompiled=e||{},i}return i=t,(e=n).prototype=Object.create(i.prototype),e.prototype.constructor=e,s(e,i),n.prototype.getSource=function(t){return this.precompiled[t]?{src:{type:"code",obj:this.precompiled[t]},path:t}:null},n}(i(4));t.exports={PrecompiledLoader:n}},function(t,e,i){"use strict";function s(t,e){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},s(t,e)}var n=i(0),r=i(5).EmitterObj;t.exports=function(t){var e,i;function r(){return t.apply(this,arguments)||this}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,s(e,i);var o=r.prototype;return o.resolve=function(t,e){return n.resolve(n.dirname(t),e)},o.isRelative=function(t){return 0===t.indexOf("./")||0===t.indexOf("../")},r}(r)},function(t,e,i){"use strict";function s(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,(n=s.key,r=void 0,"symbol"==typeof(r=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,e||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(n,"string"))?r:String(r)),s)}var n,r}function n(t,e,i){return e&&s(t.prototype,e),i&&s(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function r(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,o(t,e)}function o(t,e){return o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},o(t,e)}var a=i(13),h=i(1);function l(t,e,i){i=i||{},h.keys(i).forEach((function(e){var s,n;i[e]=(s=t.prototype[e],n=i[e],"function"!=typeof s||"function"!=typeof n?n:function(){var t=this.parent;this.parent=s;var e=n.apply(this,arguments);return this.parent=t,e})}));var s=function(t){function i(){return t.apply(this,arguments)||this}return r(i,t),n(i,[{key:"typename",get:function(){return e}}]),i}(t);return h._assign(s.prototype,i),s}var c=function(){function t(){this.init.apply(this,arguments)}return t.prototype.init=function(){},t.extend=function(t,e){return"object"==typeof t&&(e=t,t="anonymous"),l(this,t,e)},n(t,[{key:"typename",get:function(){return this.constructor.name}}]),t}(),u=function(t){function e(){var e,i;return(e=i=t.call(this)||this).init.apply(e,arguments),i}return r(e,t),e.prototype.init=function(){},e.extend=function(t,e){return"object"==typeof t&&(e=t,t="anonymous"),l(this,t,e)},n(e,[{key:"typename",get:function(){return this.constructor.name}}]),e}(a);t.exports={Obj:c,EmitterObj:u}},function(t,e,i){"use strict";var s,n=i(1),r=i(7),o=r.Environment,a=r.Template,h=i(4),l=i(3),c=i(0),u=i(0),d=i(0),p=i(0),m=i(2),f=i(0),g=i(17);function b(t,e){var i;return e=e||{},n.isObject(t)&&(e=t,t=null),l.FileSystemLoader?i=new l.FileSystemLoader(t,{watch:e.watch,noCache:e.noCache}):l.WebLoader&&(i=new l.WebLoader(t,{useCache:e.web&&e.web.useCache,async:e.web&&e.web.async})),s=new o(i,e),e&&e.express&&s.express(e.express),s}t.exports={Environment:o,Template:a,Loader:h,FileSystemLoader:l.FileSystemLoader,NodeResolveLoader:l.NodeResolveLoader,PrecompiledLoader:l.PrecompiledLoader,WebLoader:l.WebLoader,compiler:u,parser:d,lexer:p,runtime:m,lib:n,nodes:f,installJinjaCompat:g,configure:b,reset:function(){s=void 0},compile:function(t,e,i,n){return s||b(),new a(t,e,i,n)},render:function(t,e,i){return s||b(),s.render(t,e,i)},renderString:function(t,e,i){return s||b(),s.renderString(t,e,i)},precompile:c?c.precompile:void 0,precompileString:c?c.precompileString:void 0}},function(t,e,i){"use strict";function s(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,n(t,e)}function n(t,e){return n=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},n(t,e)}var r=i(8),o=i(11),a=i(1),h=i(0),l=i(12),c=i(3),u=c.FileSystemLoader,d=c.WebLoader,p=c.PrecompiledLoader,m=i(14),f=i(15),g=i(5),b=g.Obj,y=g.EmitterObj,_=i(2),v=_.handleError,w=_.Frame,A=i(16);function S(t,e,i){r((function(){t(e,i)}))}var E={type:"code",obj:{root:function(t,e,i,s,n){try{n(null,"")}catch(t){n(v(t,null,null))}}}},T=function(t){function e(){return t.apply(this,arguments)||this}s(e,t);var i=e.prototype;return i.init=function(t,e){var i=this;e=this.opts=e||{},this.opts.dev=!!e.dev,this.opts.autoescape=null==e.autoescape||e.autoescape,this.opts.throwOnUndefined=!!e.throwOnUndefined,this.opts.trimBlocks=!!e.trimBlocks,this.opts.lstripBlocks=!!e.lstripBlocks,this.loaders=[],t?this.loaders=a.isArray(t)?t:[t]:u?this.loaders=[new u("views")]:d&&(this.loaders=[new d("/views")]),"undefined"!=typeof window&&window.nunjucksPrecompiled&&this.loaders.unshift(new p(window.nunjucksPrecompiled)),this._initLoaders(),this.globals=f(),this.filters={},this.tests={},this.asyncFilters=[],this.extensions={},this.extensionsList=[],a._entries(l).forEach((function(t){var e=t[0],s=t[1];return i.addFilter(e,s)})),a._entries(m).forEach((function(t){var e=t[0],s=t[1];return i.addTest(e,s)}))},i._initLoaders=function(){var t=this;this.loaders.forEach((function(e){e.cache={},"function"==typeof e.on&&(e.on("update",(function(i,s){e.cache[i]=null,t.emit("update",i,s,e)})),e.on("load",(function(i,s){t.emit("load",i,s,e)})))}))},i.invalidateCache=function(){this.loaders.forEach((function(t){t.cache={}}))},i.addExtension=function(t,e){return e.__name=t,this.extensions[t]=e,this.extensionsList.push(e),this},i.removeExtension=function(t){var e=this.getExtension(t);e&&(this.extensionsList=a.without(this.extensionsList,e),delete this.extensions[t])},i.getExtension=function(t){return this.extensions[t]},i.hasExtension=function(t){return!!this.extensions[t]},i.addGlobal=function(t,e){return this.globals[t]=e,this},i.getGlobal=function(t){if(void 0===this.globals[t])throw new Error("global not found: "+t);return this.globals[t]},i.addFilter=function(t,e,i){var s=e;return i&&this.asyncFilters.push(t),this.filters[t]=s,this},i.getFilter=function(t){if(!this.filters[t])throw new Error("filter not found: "+t);return this.filters[t]},i.addTest=function(t,e){return this.tests[t]=e,this},i.getTest=function(t){if(!this.tests[t])throw new Error("test not found: "+t);return this.tests[t]},i.resolveTemplate=function(t,e,i){return t.isRelative&&e&&t.isRelative(i)&&t.resolve?t.resolve(e,i):i},i.getTemplate=function(t,e,i,s,n){var r,o=this,h=this,l=null;if(t&&t.raw&&(t=t.raw),a.isFunction(i)&&(n=i,i=null,e=e||!1),a.isFunction(e)&&(n=e,e=!1),t instanceof O)l=t;else{if("string"!=typeof t)throw new Error("template names must be a string: "+t);for(var c=0;c<this.loaders.length;c++){var u=this.loaders[c];if(l=u.cache[this.resolveTemplate(u,i,t)])break}}return l?(e&&l.compile(),n?void n(null,l):l):(a.asyncIter(this.loaders,(function(e,s,n,r){function o(t,i){t?r(t):i?(i.loader=e,r(null,i)):n()}t=h.resolveTemplate(e,i,t),e.async?e.getSource(t,o):o(null,e.getSource(t))}),(function(i,a){if(a||i||s||(i=new Error("template not found: "+t)),i){if(n)return void n(i);throw i}var h;a?(h=new O(a.src,o,a.path,e),a.noCache||(a.loader.cache[t]=h)):h=new O(E,o,"",e),n?n(null,h):r=h})),r)},i.express=function(t){return A(this,t)},i.render=function(t,e,i){a.isFunction(e)&&(i=e,e=null);var s=null;return this.getTemplate(t,(function(t,n){if(t&&i)S(i,t);else{if(t)throw t;s=n.render(e,i)}})),s},i.renderString=function(t,e,i,s){return a.isFunction(i)&&(s=i,i={}),new O(t,this,(i=i||{}).path).render(e,s)},i.waterfall=function(t,e,i){return o(t,e,i)},e}(y),I=function(t){function e(){return t.apply(this,arguments)||this}s(e,t);var i=e.prototype;return i.init=function(t,e,i){var s=this;this.env=i||new T,this.ctx=a.extend({},t),this.blocks={},this.exported=[],a.keys(e).forEach((function(t){s.addBlock(t,e[t])}))},i.lookup=function(t){return t in this.env.globals&&!(t in this.ctx)?this.env.globals[t]:this.ctx[t]},i.setVariable=function(t,e){this.ctx[t]=e},i.getVariables=function(){return this.ctx},i.addBlock=function(t,e){return this.blocks[t]=this.blocks[t]||[],this.blocks[t].push(e),this},i.getBlock=function(t){if(!this.blocks[t])throw new Error('unknown block "'+t+'"');return this.blocks[t][0]},i.getSuper=function(t,e,i,s,n,r){var o=a.indexOf(this.blocks[e]||[],i),h=this.blocks[e][o+1];if(-1===o||!h)throw new Error('no super block available for "'+e+'"');h(t,this,s,n,r)},i.addExport=function(t){this.exported.push(t)},i.getExported=function(){var t=this,e={};return this.exported.forEach((function(i){e[i]=t.ctx[i]})),e},e}(b),O=function(t){function e(){return t.apply(this,arguments)||this}s(e,t);var i=e.prototype;return i.init=function(t,e,i,s){if(this.env=e||new T,a.isObject(t))switch(t.type){case"code":this.tmplProps=t.obj;break;case"string":this.tmplStr=t.obj;break;default:throw new Error("Unexpected template object type "+t.type+"; expected 'code', or 'string'")}else{if(!a.isString(t))throw new Error("src must be a string or an object describing the source");this.tmplStr=t}if(this.path=i,s)try{this._compile()}catch(t){throw a._prettifyError(this.path,this.env.opts.dev,t)}else this.compiled=!1},i.render=function(t,e,i){var s=this;"function"==typeof t?(i=t,t={}):"function"==typeof e&&(i=e,e=null);var n=!e;try{this.compile()}catch(t){var r=a._prettifyError(this.path,this.env.opts.dev,t);if(i)return S(i,r);throw r}var o=new I(t||{},this.blocks,this.env),h=e?e.push(!0):new w;h.topLevel=!0;var l=null,c=!1;return this.rootRenderFunc(this.env,o,h,_,(function(t,e){if(!c||!i||void 0===e)if(t&&(t=a._prettifyError(s.path,s.env.opts.dev,t),c=!0),i)n?S(i,t,e):i(t,e);else{if(t)throw t;l=e}})),l},i.getExported=function(t,e,i){"function"==typeof t&&(i=t,t={}),"function"==typeof e&&(i=e,e=null);try{this.compile()}catch(t){if(i)return i(t);throw t}var s=e?e.push():new w;s.topLevel=!0;var n=new I(t||{},this.blocks,this.env);this.rootRenderFunc(this.env,n,s,_,(function(t){t?i(t,null):i(null,n.getExported())}))},i.compile=function(){this.compiled||this._compile()},i._compile=function(){var t;if(this.tmplProps)t=this.tmplProps;else{var e=h.compile(this.tmplStr,this.env.asyncFilters,this.env.extensionsList,this.path,this.env.opts);t=new Function(e)()}this.blocks=this._getBlocks(t),this.rootRenderFunc=t.root,this.compiled=!0},i._getBlocks=function(t){var e={};return a.keys(t).forEach((function(i){"b_"===i.slice(0,2)&&(e[i.slice(2)]=t[i])})),e},e}(b);t.exports={Environment:T,Template:O}},function(t,e,i){"use strict";var s=i(9),n=[],r=[],o=s.makeRequestCallFromTimer((function(){if(r.length)throw r.shift()}));function a(t){var e;(e=n.length?n.pop():new h).task=t,s(e)}function h(){this.task=null}t.exports=a,h.prototype.call=function(){try{this.task.call()}catch(t){a.onerror?a.onerror(t):(r.push(t),o())}finally{this.task=null,n[n.length]=this}}},function(t,e,i){"use strict";(function(e){function i(t){n.length||s(),n[n.length]=t}t.exports=i;var s,n=[],r=0;function o(){for(;r<n.length;){var t=r;if(r+=1,n[t].call(),r>1024){for(var e=0,i=n.length-r;e<i;e++)n[e]=n[e+r];n.length-=r,r=0}}n.length=0,r=0}var a,h,l,c=void 0!==e?e:self,u=c.MutationObserver||c.WebKitMutationObserver;function d(t){return function(){var e=setTimeout(s,0),i=setInterval(s,50);function s(){clearTimeout(e),clearInterval(i),t()}}}"function"==typeof u?(a=1,h=new u(o),l=document.createTextNode(""),h.observe(l,{characterData:!0}),s=function(){a=-a,l.data=a}):s=d(o),i.requestFlush=s,i.makeRequestCallFromTimer=d}).call(e,i(10))},function(t,e){var i;i=function(){return this}();try{i=i||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(i=window)}t.exports=i},function(t,e,i){var s;!function(){"use strict";var i=function(){var t=Array.prototype.slice.call(arguments);"function"==typeof t[0]&&t[0].apply(null,t.splice(1))},n=function(t){"function"==typeof setImmediate?setImmediate(t):"undefined"!=typeof process&&process.nextTick?process.nextTick(t):setTimeout(t,0)},r=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},o=function(t,e,s){var o=s?n:i;if(e=e||function(){},!r(t)){var a=new Error("First argument to waterfall must be an array of functions");return e(a)}if(!t.length)return e();var h=function(t){return function(i){if(i)e.apply(null,arguments),e=function(){};else{var s=Array.prototype.slice.call(arguments,1),n=t.next();n?s.push(h(n)):s.push(e),o((function(){t.apply(null,s)}))}}};h(function(t){var e=function(i){var s=function(){return t.length&&t[i].apply(null,arguments),s.next()};return s.next=function(){return i<t.length-1?e(i+1):null},s};return e(0)}(t))()};void 0===(s=function(){return o}.apply(e,[]))||(t.exports=s)}()},function(t,e,i){"use strict";var s=i(1),n=i(2);function r(t,e){return null==t||!1===t?e:t}function o(t){return t!=t}function a(t){var e=(t=r(t,"")).toLowerCase();return n.copySafeness(t,e.charAt(0).toUpperCase()+e.slice(1))}function h(t){if(s.isString(t))return t.split("");if(s.isObject(t))return s._entries(t||{}).map((function(t){return{key:t[0],value:t[1]}}));if(s.isArray(t))return t;throw new s.TemplateError("list filter: type not iterable")}function l(t){return function(e,i,n){void 0===i&&(i="truthy");var r=this,o=r.env.getTest(i);return s.toArray(e).filter((function(e){return o.call(r,e,n)===t}))}}function c(t){return n.copySafeness(t,t.replace(/^\s*|\s*$/g,""))}(e=t.exports={}).abs=Math.abs,e.batch=function(t,e,i){var s,n=[],r=[];for(s=0;s<t.length;s++)s%e==0&&r.length&&(n.push(r),r=[]),r.push(t[s]);if(r.length){if(i)for(s=r.length;s<e;s++)r.push(i);n.push(r)}return n},e.capitalize=a,e.center=function(t,e){if(e=e||80,(t=r(t,"")).length>=e)return t;var i=e-t.length,o=s.repeat(" ",i/2-i%2),a=s.repeat(" ",i/2);return n.copySafeness(t,o+t+a)},e.default=function(t,e,i){return i?t||e:void 0!==t?t:e},e.dictsort=function(t,e,i){if(!s.isObject(t))throw new s.TemplateError("dictsort filter: val must be an object");var n,r=[];for(var o in t)r.push([o,t[o]]);if(void 0===i||"key"===i)n=0;else{if("value"!==i)throw new s.TemplateError("dictsort filter: You can only sort by either key or value");n=1}return r.sort((function(t,i){var r=t[n],o=i[n];return e||(s.isString(r)&&(r=r.toUpperCase()),s.isString(o)&&(o=o.toUpperCase())),r>o?1:r===o?0:-1})),r},e.dump=function(t,e){return JSON.stringify(t,null,e)},e.escape=function(t){return t instanceof n.SafeString?t:(t=null==t?"":t,n.markSafe(s.escape(t.toString())))},e.safe=function(t){return t instanceof n.SafeString?t:(t=null==t?"":t,n.markSafe(t.toString()))},e.first=function(t){return t[0]},e.forceescape=function(t){return t=null==t?"":t,n.markSafe(s.escape(t.toString()))},e.groupby=function(t,e){return s.groupBy(t,e,this.env.opts.throwOnUndefined)},e.indent=function(t,e,i){if(""===(t=r(t,"")))return"";e=e||4;var o=t.split("\n"),a=s.repeat(" ",e),h=o.map((function(t,e){return 0!==e||i?""+a+t:t})).join("\n");return n.copySafeness(t,h)},e.join=function(t,e,i){return e=e||"",i&&(t=s.map(t,(function(t){return t[i]}))),t.join(e)},e.last=function(t){return t[t.length-1]},e.length=function(t){var e=r(t,"");return void 0!==e?"function"==typeof Map&&e instanceof Map||"function"==typeof Set&&e instanceof Set?e.size:!s.isObject(e)||e instanceof n.SafeString?e.length:s.keys(e).length:0},e.list=h,e.lower=function(t){return(t=r(t,"")).toLowerCase()},e.nl2br=function(t){return null==t?"":n.copySafeness(t,t.replace(/\r\n|\n/g,"<br />\n"))},e.random=function(t){return t[Math.floor(Math.random()*t.length)]},e.reject=l(!1),e.rejectattr=function(t,e){return t.filter((function(t){return!t[e]}))},e.select=l(!0),e.selectattr=function(t,e){return t.filter((function(t){return!!t[e]}))},e.replace=function(t,e,i,s){var r=t;if(e instanceof RegExp)return t.replace(e,i);void 0===s&&(s=-1);var o="";if("number"==typeof e)e=""+e;else if("string"!=typeof e)return t;if("number"==typeof t&&(t=""+t),"string"!=typeof t&&!(t instanceof n.SafeString))return t;if(""===e)return o=i+t.split("").join(i)+i,n.copySafeness(t,o);var a=t.indexOf(e);if(0===s||-1===a)return t;for(var h=0,l=0;a>-1&&(-1===s||l<s);)o+=t.substring(h,a)+i,h=a+e.length,l++,a=t.indexOf(e,h);return h<t.length&&(o+=t.substring(h)),n.copySafeness(r,o)},e.reverse=function(t){var e;return(e=s.isString(t)?h(t):s.map(t,(function(t){return t}))).reverse(),s.isString(t)?n.copySafeness(t,e.join("")):e},e.round=function(t,e,i){e=e||0;var s=Math.pow(10,e);return("ceil"===i?Math.ceil:"floor"===i?Math.floor:Math.round)(t*s)/s},e.slice=function(t,e,i){for(var s=Math.floor(t.length/e),n=t.length%e,r=[],o=0,a=0;a<e;a++){var h=o+a*s;a<n&&o++;var l=o+(a+1)*s,c=t.slice(h,l);i&&a>=n&&c.push(i),r.push(c)}return r},e.sum=function(t,e,i){return void 0===i&&(i=0),e&&(t=s.map(t,(function(t){return t[e]}))),i+t.reduce((function(t,e){return t+e}),0)},e.sort=n.makeMacro(["value","reverse","case_sensitive","attribute"],[],(function(t,e,i,n){var r=this,o=s.map(t,(function(t){return t})),a=s.getAttrGetter(n);return o.sort((function(t,o){var h=n?a(t):t,l=n?a(o):o;if(r.env.opts.throwOnUndefined&&n&&(void 0===h||void 0===l))throw new TypeError('sort: attribute "'+n+'" resolved to undefined');return!i&&s.isString(h)&&s.isString(l)&&(h=h.toLowerCase(),l=l.toLowerCase()),h<l?e?1:-1:h>l?e?-1:1:0})),o})),e.string=function(t){return n.copySafeness(t,t)},e.striptags=function(t,e){var i=c((t=r(t,"")).replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>|<!--[\s\S]*?-->/gi,"")),s="";return s=e?i.replace(/^ +| +$/gm,"").replace(/ +/g," ").replace(/(\r\n)/g,"\n").replace(/\n\n\n+/g,"\n\n"):i.replace(/\s+/gi," "),n.copySafeness(t,s)},e.title=function(t){var e=(t=r(t,"")).split(" ").map((function(t){return a(t)}));return n.copySafeness(t,e.join(" "))},e.trim=c,e.truncate=function(t,e,i,s){var o=t;if(e=e||255,(t=r(t,"")).length<=e)return t;if(i)t=t.substring(0,e);else{var a=t.lastIndexOf(" ",e);-1===a&&(a=e),t=t.substring(0,a)}return t+=null!=s?s:"...",n.copySafeness(o,t)},e.upper=function(t){return(t=r(t,"")).toUpperCase()},e.urlencode=function(t){var e=encodeURIComponent;return s.isString(t)?e(t):(s.isArray(t)?t:s._entries(t)).map((function(t){var i=t[0],s=t[1];return e(i)+"="+e(s)})).join("&")};var u=/^(?:\(|<|&lt;)?(.*?)(?:\.|,|\)|\n|&gt;)?$/,d=/^[\w.!#$%&'*+\-\/=?\^`{|}~]+@[a-z\d\-]+(\.[a-z\d\-]+)+$/i,p=/^https?:\/\/.*$/,m=/^www\./,f=/\.(?:org|net|com)(?:\:|\/|$)/;e.urlize=function(t,e,i){o(e)&&(e=1/0);var s=!0===i?' rel="nofollow"':"";return t.split(/(\s+)/).filter((function(t){return t&&t.length})).map((function(t){var i=t.match(u),n=i?i[1]:t,r=n.substr(0,e);return p.test(n)?'<a href="'+n+'"'+s+">"+r+"</a>":m.test(n)?'<a href="http://'+n+'"'+s+">"+r+"</a>":d.test(n)?'<a href="mailto:'+n+'">'+n+"</a>":f.test(n)?'<a href="http://'+n+'"'+s+">"+r+"</a>":t})).join("")},e.wordcount=function(t){var e=(t=r(t,""))?t.match(/\w+/g):null;return e?e.length:null},e.float=function(t,e){var i=parseFloat(t);return o(i)?e:i};var g=n.makeMacro(["value","default","base"],[],(function(t,e,i){void 0===i&&(i=10);var s=parseInt(t,i);return o(s)?e:s}));e.int=g,e.d=e.default,e.e=e.escape},function(t,e,i){"use strict";var s,n="object"==typeof Reflect?Reflect:null,r=n&&"function"==typeof n.apply?n.apply:function(t,e,i){return Function.prototype.apply.call(t,e,i)};s=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var o=Number.isNaN||function(t){return t!=t};function a(){a.init.call(this)}t.exports=a,t.exports.once=function(t,e){return new Promise((function(i,s){function n(i){t.removeListener(e,r),s(i)}function r(){"function"==typeof t.removeListener&&t.removeListener("error",n),i([].slice.call(arguments))}b(t,e,r,{once:!0}),"error"!==e&&function(t,e,i){"function"==typeof t.on&&b(t,"error",e,i)}(t,n,{once:!0})}))},a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var h=10;function l(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function c(t){return void 0===t._maxListeners?a.defaultMaxListeners:t._maxListeners}function u(t,e,i,s){var n,r,o,a;if(l(i),void 0===(r=t._events)?(r=t._events=Object.create(null),t._eventsCount=0):(void 0!==r.newListener&&(t.emit("newListener",e,i.listener?i.listener:i),r=t._events),o=r[e]),void 0===o)o=r[e]=i,++t._eventsCount;else if("function"==typeof o?o=r[e]=s?[i,o]:[o,i]:s?o.unshift(i):o.push(i),(n=c(t))>0&&o.length>n&&!o.warned){o.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=t,h.type=e,h.count=o.length,a=h,console&&console.warn&&console.warn(a)}return t}function d(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(t,e,i){var s={fired:!1,wrapFn:void 0,target:t,type:e,listener:i},n=d.bind(s);return n.listener=i,s.wrapFn=n,n}function m(t,e,i){var s=t._events;if(void 0===s)return[];var n=s[e];return void 0===n?[]:"function"==typeof n?i?[n.listener||n]:[n]:i?function(t){for(var e=new Array(t.length),i=0;i<e.length;++i)e[i]=t[i].listener||t[i];return e}(n):g(n,n.length)}function f(t){var e=this._events;if(void 0!==e){var i=e[t];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function g(t,e){for(var i=new Array(e),s=0;s<e;++s)i[s]=t[s];return i}function b(t,e,i,s){if("function"==typeof t.on)s.once?t.once(e,i):t.on(e,i);else{if("function"!=typeof t.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t);t.addEventListener(e,(function n(r){s.once&&t.removeEventListener(e,n),i(r)}))}}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return h},set:function(t){if("number"!=typeof t||t<0||o(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");h=t}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||o(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},a.prototype.getMaxListeners=function(){return c(this)},a.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e.push(arguments[i]);var s="error"===t,n=this._events;if(void 0!==n)s=s&&void 0===n.error;else if(!s)return!1;if(s){var o;if(e.length>0&&(o=e[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var h=n[t];if(void 0===h)return!1;if("function"==typeof h)r(h,this,e);else{var l=h.length,c=g(h,l);for(i=0;i<l;++i)r(c[i],this,e)}return!0},a.prototype.addListener=function(t,e){return u(this,t,e,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(t,e){return u(this,t,e,!0)},a.prototype.once=function(t,e){return l(e),this.on(t,p(this,t,e)),this},a.prototype.prependOnceListener=function(t,e){return l(e),this.prependListener(t,p(this,t,e)),this},a.prototype.removeListener=function(t,e){var i,s,n,r,o;if(l(e),void 0===(s=this._events))return this;if(void 0===(i=s[t]))return this;if(i===e||i.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete s[t],s.removeListener&&this.emit("removeListener",t,i.listener||e));else if("function"!=typeof i){for(n=-1,r=i.length-1;r>=0;r--)if(i[r]===e||i[r].listener===e){o=i[r].listener,n=r;break}if(n<0)return this;0===n?i.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(i,n),1===i.length&&(s[t]=i[0]),void 0!==s.removeListener&&this.emit("removeListener",t,o||e)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(t){var e,i,s;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[t]),this;if(0===arguments.length){var n,r=Object.keys(i);for(s=0;s<r.length;++s)"removeListener"!==(n=r[s])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=i[t]))this.removeListener(t,e);else if(void 0!==e)for(s=e.length-1;s>=0;s--)this.removeListener(t,e[s]);return this},a.prototype.listeners=function(t){return m(this,t,!0)},a.prototype.rawListeners=function(t){return m(this,t,!1)},a.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):f.call(t,e)},a.prototype.listenerCount=f,a.prototype.eventNames=function(){return this._eventsCount>0?s(this._events):[]}},function(t,e,i){"use strict";var s=i(2).SafeString;e.callable=function(t){return"function"==typeof t},e.defined=function(t){return void 0!==t},e.divisibleby=function(t,e){return t%e==0},e.escaped=function(t){return t instanceof s},e.equalto=function(t,e){return t===e},e.eq=e.equalto,e.sameas=e.equalto,e.even=function(t){return t%2==0},e.falsy=function(t){return!t},e.ge=function(t,e){return t>=e},e.greaterthan=function(t,e){return t>e},e.gt=e.greaterthan,e.le=function(t,e){return t<=e},e.lessthan=function(t,e){return t<e},e.lt=e.lessthan,e.lower=function(t){return t.toLowerCase()===t},e.ne=function(t,e){return t!==e},e.null=function(t){return null===t},e.number=function(t){return"number"==typeof t},e.odd=function(t){return t%2==1},e.string=function(t){return"string"==typeof t},e.truthy=function(t){return!!t},e.undefined=function(t){return void 0===t},e.upper=function(t){return t.toUpperCase()===t},e.iterable=function(t){return"undefined"!=typeof Symbol?!!t[Symbol.iterator]:Array.isArray(t)||"string"==typeof t},e.mapping=function(t){var e=null!=t&&"object"==typeof t&&!Array.isArray(t);return Set?e&&!(t instanceof Set):e}},function(t,e,i){"use strict";t.exports=function(){return{range:function(t,e,i){void 0===e?(e=t,t=0,i=1):i||(i=1);var s=[];if(i>0)for(var n=t;n<e;n+=i)s.push(n);else for(var r=t;r>e;r+=i)s.push(r);return s},cycler:function(){return t=Array.prototype.slice.call(arguments),e=-1,{current:null,reset:function(){e=-1,this.current=null},next:function(){return++e>=t.length&&(e=0),this.current=t[e],this.current}};var t,e},joiner:function(t){return function(t){t=t||",";var e=!0;return function(){var i=e?"":t;return e=!1,i}}(t)}}}},function(t,e,i){var s=i(0);t.exports=function(t,e){function i(t,e){if(this.name=t,this.path=t,this.defaultEngine=e.defaultEngine,this.ext=s.extname(t),!this.ext&&!this.defaultEngine)throw new Error("No default engine was specified and no extension was provided.");this.ext||(this.name+=this.ext=("."!==this.defaultEngine[0]?".":"")+this.defaultEngine)}return i.prototype.render=function(e,i){t.render(this.name,e,i)},e.set("view",i),e.set("nunjucksEnv",t),t}},function(t,e,i){t.exports=function(){"use strict";var t,e,i=this.runtime,s=this.lib,n=this.compiler.Compiler,r=this.parser.Parser,o=(this.nodes,this.lexer,i.contextOrFrameLookup),a=i.memberLookup;function h(t,e,s,n){t=t||[],null===e&&(e=n<0?t.length-1:0),null===s?s=n<0?-1:t.length:s<0&&(s+=t.length),e<0&&(e+=t.length);for(var r=[],o=e;!(o<0||o>t.length||n>0&&o>=s||n<0&&o<=s);o+=n)r.push(i.memberLookup(t,o));return r}function l(t,e){return Object.prototype.hasOwnProperty.call(t,e)}n&&(t=n.prototype.assertType),r&&(e=r.prototype.parseAggregate),i.contextOrFrameLookup=function(t,e,i){var s=o.apply(this,arguments);if(void 0!==s)return s;switch(i){case"True":return!0;case"False":return!1;case"None":return null;default:return}};var c={pop:function(t){if(void 0===t)return this.pop();if(t>=this.length||t<0)throw new Error("KeyError");return this.splice(t,1)},append:function(t){return this.push(t)},remove:function(t){for(var e=0;e<this.length;e++)if(this[e]===t)return this.splice(e,1);throw new Error("ValueError")},count:function(t){for(var e=0,i=0;i<this.length;i++)this[i]===t&&e++;return e},index:function(t){var e;if(-1===(e=this.indexOf(t)))throw new Error("ValueError");return e},find:function(t){return this.indexOf(t)},insert:function(t,e){return this.splice(t,0,e)}},u={items:function(){return s._entries(this)},values:function(){return s._values(this)},keys:function(){return s.keys(this)},get:function(t,e){var i=this[t];return void 0===i&&(i=e),i},has_key:function(t){return l(this,t)},pop:function(t,e){var i=this[t];if(void 0===i&&void 0!==e)i=e;else{if(void 0===i)throw new Error("KeyError");delete this[t]}return i},popitem:function(){var t=s.keys(this);if(!t.length)throw new Error("KeyError");var e=t[0],i=this[e];return delete this[e],[e,i]},setdefault:function(t,e){return void 0===e&&(e=null),t in this||(this[t]=e),this[t]},update:function(t){return s._assign(this,t),null}};return u.iteritems=u.items,u.itervalues=u.values,u.iterkeys=u.keys,i.memberLookup=function(t,e,i){return 4===arguments.length?h.apply(this,arguments):(t=t||{},s.isArray(t)&&l(c,e)?c[e].bind(t):s.isObject(t)&&l(u,e)?u[e].bind(t):a.apply(this,arguments))},function(){i.contextOrFrameLookup=o,i.memberLookup=a,n&&(n.prototype.assertType=t),r&&(r.prototype.parseAggregate=e)}}}])},t.exports=e()}},e={};function i(s){var n=e[s];if(void 0!==n)return n.exports;var r=e[s]={exports:{}};return t[s].call(r.exports,r,r.exports,i),r.exports}(()=>{"use strict";
/*!
 * Generated using the Bootstrap Customizer (https://getbootstrap.com/docs/3.4/customize/)
 */
/*!
 * Bootstrap v3.4.1 (https://getbootstrap.com/)
 * Copyright 2011-2022 Twitter, Inc.
 * Licensed under the MIT license
 */
if("undefined"==typeof jQuery)throw new Error("Bootstrap's JavaScript requires jQuery");!function(){var t=jQuery.fn.jquery.split(" ")[0].split(".");if(t[0]<2&&t[1]<9||1==t[0]&&9==t[1]&&t[2]<1||t[0]>3)throw new Error("Bootstrap's JavaScript requires jQuery version 1.9.1 or higher, but lower than version 4")}(),function(t){var e=["sanitize","whiteList","sanitizeFn"],i=["background","cite","href","itemtype","longdesc","poster","src","xlink:href"],s={"*":["class","dir","id","lang","role",/^aria-[\w-]*$/i],a:["target","href","title","rel"],area:[],b:[],br:[],col:[],code:[],div:[],em:[],hr:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],i:[],img:["src","alt","title","width","height"],li:[],ol:[],p:[],pre:[],s:[],small:[],span:[],sub:[],sup:[],strong:[],u:[],ul:[]},n=/^(?:(?:https?|mailto|ftp|tel|file):|[^&:/?#]*(?:[/?#]|$))/gi,r=/^data:(?:image\/(?:bmp|gif|jpeg|jpg|png|tiff|webp)|video\/(?:mpeg|mp4|ogg|webm)|audio\/(?:mp3|oga|ogg|opus));base64,[a-z0-9+/]+=*$/i;function o(e,s){var o=e.nodeName.toLowerCase();if(-1!==t.inArray(o,s))return-1===t.inArray(o,i)||Boolean(e.nodeValue.match(n)||e.nodeValue.match(r));for(var a=t(s).filter((function(t,e){return e instanceof RegExp})),h=0,l=a.length;h<l;h++)if(o.match(a[h]))return!0;return!1}function a(e,i,s){if(0===e.length)return e;if(s&&"function"==typeof s)return s(e);if(!document.implementation||!document.implementation.createHTMLDocument)return e;var n=document.implementation.createHTMLDocument("sanitization");n.body.innerHTML=e;for(var r=t.map(i,(function(t,e){return e})),a=t(n.body).find("*"),h=0,l=a.length;h<l;h++){var c=a[h],u=c.nodeName.toLowerCase();if(-1!==t.inArray(u,r))for(var d=t.map(c.attributes,(function(t){return t})),p=[].concat(i["*"]||[],i[u]||[]),m=0,f=d.length;m<f;m++)o(d[m],p)||c.removeAttribute(d[m].nodeName);else c.parentNode.removeChild(c)}return n.body.innerHTML}var h=function(t,e){this.type=null,this.options=null,this.enabled=null,this.timeout=null,this.hoverState=null,this.$element=null,this.inState=null,this.init("tooltip",t,e)};h.VERSION="3.4.1",h.TRANSITION_DURATION=150,h.DEFAULTS={animation:!0,placement:"top",selector:!1,template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',trigger:"hover focus",title:"",delay:0,html:!1,container:!1,viewport:{selector:"body",padding:0},sanitize:!0,sanitizeFn:null,whiteList:s},h.prototype.init=function(e,i,s){if(this.enabled=!0,this.type=e,this.$element=t(i),this.options=this.getOptions(s),this.$viewport=this.options.viewport&&t(document).find(t.isFunction(this.options.viewport)?this.options.viewport.call(this,this.$element):this.options.viewport.selector||this.options.viewport),this.inState={click:!1,hover:!1,focus:!1},this.$element[0]instanceof document.constructor&&!this.options.selector)throw new Error("`selector` option must be specified when initializing "+this.type+" on the window.document object!");for(var n=this.options.trigger.split(" "),r=n.length;r--;){var o=n[r];if("click"==o)this.$element.on("click."+this.type,this.options.selector,t.proxy(this.toggle,this));else if("manual"!=o){var a="hover"==o?"mouseenter":"focusin",h="hover"==o?"mouseleave":"focusout";this.$element.on(a+"."+this.type,this.options.selector,t.proxy(this.enter,this)),this.$element.on(h+"."+this.type,this.options.selector,t.proxy(this.leave,this))}}this.options.selector?this._options=t.extend({},this.options,{trigger:"manual",selector:""}):this.fixTitle()},h.prototype.getDefaults=function(){return h.DEFAULTS},h.prototype.getOptions=function(i){var s=this.$element.data();for(var n in s)s.hasOwnProperty(n)&&-1!==t.inArray(n,e)&&delete s[n];return(i=t.extend({},this.getDefaults(),s,i)).delay&&"number"==typeof i.delay&&(i.delay={show:i.delay,hide:i.delay}),i.sanitize&&(i.template=a(i.template,i.whiteList,i.sanitizeFn)),i},h.prototype.getDelegateOptions=function(){var e={},i=this.getDefaults();return this._options&&t.each(this._options,(function(t,s){i[t]!=s&&(e[t]=s)})),e},h.prototype.enter=function(e){var i=e instanceof this.constructor?e:t(e.currentTarget).data("bs."+this.type);if(i||(i=new this.constructor(e.currentTarget,this.getDelegateOptions()),t(e.currentTarget).data("bs."+this.type,i)),e instanceof t.Event&&(i.inState["focusin"==e.type?"focus":"hover"]=!0),i.tip().hasClass("in")||"in"==i.hoverState)i.hoverState="in";else{if(clearTimeout(i.timeout),i.hoverState="in",!i.options.delay||!i.options.delay.show)return i.show();i.timeout=setTimeout((function(){"in"==i.hoverState&&i.show()}),i.options.delay.show)}},h.prototype.isInStateTrue=function(){for(var t in this.inState)if(this.inState[t])return!0;return!1},h.prototype.leave=function(e){var i=e instanceof this.constructor?e:t(e.currentTarget).data("bs."+this.type);if(i||(i=new this.constructor(e.currentTarget,this.getDelegateOptions()),t(e.currentTarget).data("bs."+this.type,i)),e instanceof t.Event&&(i.inState["focusout"==e.type?"focus":"hover"]=!1),!i.isInStateTrue()){if(clearTimeout(i.timeout),i.hoverState="out",!i.options.delay||!i.options.delay.hide)return i.hide();i.timeout=setTimeout((function(){"out"==i.hoverState&&i.hide()}),i.options.delay.hide)}},h.prototype.show=function(){var e=t.Event("show.bs."+this.type);if(this.hasContent()&&this.enabled){this.$element.trigger(e);var i=t.contains(this.$element[0].ownerDocument.documentElement,this.$element[0]);if(e.isDefaultPrevented()||!i)return;var s=this,n=this.tip(),r=this.getUID(this.type);this.setContent(),n.attr("id",r),this.$element.attr("aria-describedby",r),this.options.animation&&n.addClass("fade");var o="function"==typeof this.options.placement?this.options.placement.call(this,n[0],this.$element[0]):this.options.placement,a=/\s?auto?\s?/i,l=a.test(o);l&&(o=o.replace(a,"")||"top"),n.detach().css({top:0,left:0,display:"block"}).addClass(o).data("bs."+this.type,this),this.options.container?n.appendTo(t(document).find(this.options.container)):n.insertAfter(this.$element),this.$element.trigger("inserted.bs."+this.type);var c=this.getPosition(),u=n[0].offsetWidth,d=n[0].offsetHeight;if(l){var p=o,m=this.getPosition(this.$viewport);o="bottom"==o&&c.bottom+d>m.bottom?"top":"top"==o&&c.top-d<m.top?"bottom":"right"==o&&c.right+u>m.width?"left":"left"==o&&c.left-u<m.left?"right":o,n.removeClass(p).addClass(o)}var f=this.getCalculatedOffset(o,c,u,d);this.applyPlacement(f,o);var g=function(){var t=s.hoverState;s.$element.trigger("shown.bs."+s.type),s.hoverState=null,"out"==t&&s.leave(s)};t.support.transition&&this.$tip.hasClass("fade")?n.one("bsTransitionEnd",g).emulateTransitionEnd(h.TRANSITION_DURATION):g()}},h.prototype.applyPlacement=function(e,i){var s=this.tip(),n=s[0].offsetWidth,r=s[0].offsetHeight,o=parseInt(s.css("margin-top"),10),a=parseInt(s.css("margin-left"),10);isNaN(o)&&(o=0),isNaN(a)&&(a=0),e.top+=o,e.left+=a,t.offset.setOffset(s[0],t.extend({using:function(t){s.css({top:Math.round(t.top),left:Math.round(t.left)})}},e),0),s.addClass("in");var h=s[0].offsetWidth,l=s[0].offsetHeight;"top"==i&&l!=r&&(e.top=e.top+r-l);var c=this.getViewportAdjustedDelta(i,e,h,l);c.left?e.left+=c.left:e.top+=c.top;var u=/top|bottom/.test(i),d=u?2*c.left-n+h:2*c.top-r+l,p=u?"offsetWidth":"offsetHeight";s.offset(e),this.replaceArrow(d,s[0][p],u)},h.prototype.replaceArrow=function(t,e,i){this.arrow().css(i?"left":"top",50*(1-t/e)+"%").css(i?"top":"left","")},h.prototype.setContent=function(){var t=this.tip(),e=this.getTitle();this.options.html?(this.options.sanitize&&(e=a(e,this.options.whiteList,this.options.sanitizeFn)),t.find(".tooltip-inner").html(e)):t.find(".tooltip-inner").text(e),t.removeClass("fade in top bottom left right")},h.prototype.hide=function(e){var i=this,s=t(this.$tip),n=t.Event("hide.bs."+this.type);function r(){"in"!=i.hoverState&&s.detach(),i.$element&&i.$element.removeAttr("aria-describedby").trigger("hidden.bs."+i.type),e&&e()}if(this.$element.trigger(n),!n.isDefaultPrevented())return s.removeClass("in"),t.support.transition&&s.hasClass("fade")?s.one("bsTransitionEnd",r).emulateTransitionEnd(h.TRANSITION_DURATION):r(),this.hoverState=null,this},h.prototype.fixTitle=function(){var t=this.$element;(t.attr("title")||"string"!=typeof t.attr("data-original-title"))&&t.attr("data-original-title",t.attr("title")||"").attr("title","")},h.prototype.hasContent=function(){return this.getTitle()},h.prototype.getPosition=function(e){var i=(e=e||this.$element)[0],s="BODY"==i.tagName,n=i.getBoundingClientRect();null==n.width&&(n=t.extend({},n,{width:n.right-n.left,height:n.bottom-n.top}));var r=window.SVGElement&&i instanceof window.SVGElement,o=s?{top:0,left:0}:r?null:e.offset(),a={scroll:s?document.documentElement.scrollTop||document.body.scrollTop:e.scrollTop()},h=s?{width:t(window).width(),height:t(window).height()}:null;return t.extend({},n,a,h,o)},h.prototype.getCalculatedOffset=function(t,e,i,s){return"bottom"==t?{top:e.top+e.height,left:e.left+e.width/2-i/2}:"top"==t?{top:e.top-s,left:e.left+e.width/2-i/2}:"left"==t?{top:e.top+e.height/2-s/2,left:e.left-i}:{top:e.top+e.height/2-s/2,left:e.left+e.width}},h.prototype.getViewportAdjustedDelta=function(t,e,i,s){var n={top:0,left:0};if(!this.$viewport)return n;var r=this.options.viewport&&this.options.viewport.padding||0,o=this.getPosition(this.$viewport);if(/right|left/.test(t)){var a=e.top-r-o.scroll,h=e.top+r-o.scroll+s;a<o.top?n.top=o.top-a:h>o.top+o.height&&(n.top=o.top+o.height-h)}else{var l=e.left-r,c=e.left+r+i;l<o.left?n.left=o.left-l:c>o.right&&(n.left=o.left+o.width-c)}return n},h.prototype.getTitle=function(){var t=this.$element,e=this.options;return t.attr("data-original-title")||("function"==typeof e.title?e.title.call(t[0]):e.title)},h.prototype.getUID=function(t){do{t+=~~(1e6*Math.random())}while(document.getElementById(t));return t},h.prototype.tip=function(){if(!this.$tip&&(this.$tip=t(this.options.template),1!=this.$tip.length))throw new Error(this.type+" `template` option must consist of exactly 1 top-level element!");return this.$tip},h.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".tooltip-arrow")},h.prototype.enable=function(){this.enabled=!0},h.prototype.disable=function(){this.enabled=!1},h.prototype.toggleEnabled=function(){this.enabled=!this.enabled},h.prototype.toggle=function(e){var i=this;e&&((i=t(e.currentTarget).data("bs."+this.type))||(i=new this.constructor(e.currentTarget,this.getDelegateOptions()),t(e.currentTarget).data("bs."+this.type,i))),e?(i.inState.click=!i.inState.click,i.isInStateTrue()?i.enter(i):i.leave(i)):i.tip().hasClass("in")?i.leave(i):i.enter(i)},h.prototype.destroy=function(){var t=this;clearTimeout(this.timeout),this.hide((function(){t.$element.off("."+t.type).removeData("bs."+t.type),t.$tip&&t.$tip.detach(),t.$tip=null,t.$arrow=null,t.$viewport=null,t.$element=null}))},h.prototype.sanitizeHtml=function(t){return a(t,this.options.whiteList,this.options.sanitizeFn)};var l=t.fn.tooltip;t.fn.tooltip=function(e){return this.each((function(){var i=t(this),s=i.data("bs.tooltip"),n="object"==typeof e&&e;!s&&/destroy|hide/.test(e)||(s||i.data("bs.tooltip",s=new h(this,n)),"string"==typeof e&&s[e]())}))},t.fn.tooltip.Constructor=h,t.fn.tooltip.noConflict=function(){return t.fn.tooltip=l,this}}(jQuery);const t=Object.freeze({ACTION_MESSAGE:1,ACTION_QUESTION:2,ACTION_REQUEST_INFO:3,ACTION_FAQ:4,ACTION_CHAT:5,ACTION_TICKET:6,ACTION_LIBGUIDES:7,ACTION_LIBCAL:8,ACTION_WELCOME:9,ACTION_LINK:10,ACTION_LIBWIZARD:11,ACTION_RATING:12,ACTION_PARAMS:13}),e=Object.freeze({ACTION_END:-1,ACTION_SKIP:-2,ACTION_NULL:-4,ACTION_TRANSFER:-5}),s=Object.freeze({[t.ACTION_MESSAGE]:"fa-commenting-o",[t.ACTION_QUESTION]:"fa-question-circle-o",[t.ACTION_REQUEST_INFO]:"fa-address-book",[t.ACTION_FAQ]:"fa-search",[t.ACTION_CHAT]:"fa-comments-o",[t.ACTION_TICKET]:"fa-ticket",[t.ACTION_LIBGUIDES]:"fa-search",[t.ACTION_LIBCAL]:"fa-calendar",[t.ACTION_WELCOME]:"fa-home",[e.ACTION_END]:"fa-home",[t.ACTION_LINK]:"fa-link",[t.ACTION_LIBWIZARD]:"fa-clipboard",[t.ACTION_RATING]:"fa-star",[t.ACTION_PARAMS]:"fa-map-signs"}),n=Object.freeze({[t.ACTION_MESSAGE]:"alert-info",[t.ACTION_QUESTION]:"alert-info",[t.ACTION_REQUEST_INFO]:"alert-success",[t.ACTION_FAQ]:"alert-warning",[t.ACTION_CHAT]:"alert-warning",[t.ACTION_TICKET]:"alert-warning",[t.ACTION_LIBGUIDES]:"alert-warning",[t.ACTION_LIBCAL]:"alert-warning",[t.ACTION_WELCOME]:"alert-info",[t.ACTION_LINK]:"alert-warning",[t.ACTION_LIBWIZARD]:"alert-warning",[t.ACTION_RATING]:"alert-info",[t.ACTION_PARAMS]:"alert-info"}),r=Object.freeze({PRESET:0,FREE:1,PASSALONG:2}),o=Object.freeze({MATCH_ANY:1,MATCH_ALL:2}),a=Object.freeze({PAGE_BACK:-1,PAGE_FORWARD:-2,STAGE_BACK:-3}),h=Object.freeze({INFO_NAME:1,INFO_EMAIL:2,INFO_ID:4,INFO_NAME_EMAIL:3,INFO_NAME_ID:5,INFO_EMAIL_ID:6,INFO_NAME_EMAIL_ID:7}),l=Object.freeze({NAME:0,ID:1,EMAIL:2,EVALUATE:3}),c=Object.freeze({SEND_OP:1,SEND_DEPT:2}),u=Object.freeze({PROMPT:0,RESULT:1,FAIL:2,CHAINED:3}),d=Object.freeze({FAQ_SINGLE:1,FAQ_SEARCH:2,FAQ_RESULTS:3}),p=Object.freeze({GUIDE_SINGLE:1,AZ_SINGLE:2,GUIDE_SEARCH:3,AZ_SEARCH:4,LG_OTHER:5}),m=Object.freeze({BOOKING_SPACE:1,BOOKING_EQUIP:2,BOOKING_APPT:3,EVENT_SEARCH:4,HOURS_TODAY:5,HOURS_WEEK:6}),f=Object.freeze({GROUP_PROMPT:0,CAT_PROMPT:2,CAT_USER_PROMPT:3,USER_PROMPT:4,DATE_PROMPT:5,TIME_PROMPT:6,FORM:8,AUTHLINK:9,FAIL:99}),g=(Object.freeze({LWZ_FORM:1,LWZ_SURVEY:2,LWZ_QUIZ:4,LWZ_TUTORIAL:8}),Object.freeze({TYPE_TEXT:0,TYPE_CHOICE:1}),Object.freeze({PROMPT:0,CONTACT:1,QUESTION:2,FORM:3})),b=Object.freeze({YES:1,NO:2}),y=Object.freeze({RETRY:3,UNRESOLVED:1,RESOLVED:2}),_=Object.freeze({AVAIL_ONLINE:0,AVAIL_ALWAYS:1,AVAIL_OFFLINE_ONLY:2,AVAIL_COOP_ONLY:3,AVAIL_CUSTOM_HOURS:4}),v=Object.freeze({CHAT_FORM:0,NPS_SURVEY:1}),w=Object.freeze({PARAM_CHAT_STATUS:1,PARAM_OPEN_HOURS:2,PARAM_LC_HOURS:3}),A=Object.freeze({PARAM_CHAT_STATUS_ONLINE:1,PARAM_CHAT_STATUS_OFFLINE:2,PARAM_HOURS_OPEN:3,PARAM_HOURS_CLOSED:4}),S=Object.freeze({ACTION_RESPONSE_SEARCH:0,ACTION_RESPONSE_CLICK:1,ACTION_RESPONSE_HELP_YES:2,ACTION_RESPONSE_HELP_NO:3,ACTION_RESPONSE_RESOLVED:4,ACTION_RESPONSE_UNRESOLVED:5});const E=Object.freeze({PUBLIC:0,PRIVATE:1,FLOW:5,OTHERS:100});class T{constructor({id:t=0,text:e=""}){this.id=Number(t),this.text=e}}class I{constructor({id:t=0,label:e="",question:i="",type:s=0,typeLabel:n="",responses:r=[],free_response:o=!1,archived:a=!1,visibility:h=1,flow_uuid:l=null}){this.id=Number(t),this.label=e,this.question=i,this.type=Number(s),this.typeLabel=n,this.responses=[],Array.isArray(r)&&r.forEach((t=>{this.responses.push(new T(t))})),this.free_response=!!o,this.archived=!!a,this.visibility=Number(h),this.flow_uuid=l}get htmlLabel(){return`${this.label}${this.visibility===E.PRIVATE?" (p)":""}`}getLabelByResponseId(t){const e=this.responses.find((e=>e.id===t));return e?e.text:""}isMultiChoice(){return 1===this.type}}class O{constructor({questionId:t=0,question:e="",text:i="",responseId:s=0}){this.questionId=Number(t),this.question=e,this.text=i,this.responseId=Number(s)}}const C=/^<?(['a-zA-Z0-9_=\.\-\+&!#\$%\*\?\^\|\{\}\~])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,6})+>?$/i,k=/^\+?[0-9]{10,}$/;class N{constructor({u:t=0,d:e=[],c:i="",coverageType:s=0,coverageHours:n=null,fallbackSeconds:r=0}){this.u=t,this.d=e,this.c=i,this.coverageType=s,this.coverageHours=n,this.fallbackSeconds=r}toJSON(){return{u:this.u,d:this.d,c:this.c,fallbackSeconds:this.fallbackSeconds}}}let x={};const R=function(t,e,i={}){let s=function(t){const e=t.split(".");if(1===e.length)return x[e[0]]||"";let i=x[e[0]];if("object"!=typeof i)return"";for(let t=1;t<e.length;t++){if(t===e.length-1)return i[e[t]]||"";if(i=i[e[t]],"object"!=typeof i)return""}return""}(t);""===s&&(s=e);const n=Object.keys(i);return 0===n.length||n.forEach((t=>{s=s.replace(`%${t}%`,i[t])})),s},L=function(t,e,i){if(0===i.length)return!1;for(let s=0;s<=i.length;s++){const n=i[s];if(!Array.isArray(n)||2!==n.length)continue;const r=n[0].split(":").map((t=>parseInt(t,10))),o=n[1].split(":").map((t=>parseInt(t,10)));if(!(r[0]>t||o[0]<t)){if(r[0]<t&&o[0]>t)return!0;if(r[0]!==t){if(o[0]!==t);else if(o[1]>e)return!0}else if(r[1]<e)return!0}}return!1};class P{constructor({id:t=0,name:e="",duration:i=0,padding:s=0}){this.id=Number(t),this.name=e,this.duration=Number(i),this.padding=Number(s)}}class M{constructor({id:t=0,name:e=""}){this.id=t,this.name=e}}class F{constructor({id:t=0,name:e="",categories:i=[],users:s=[]}){this.id=Number(t),this.name=e,this.categories=[],i.forEach((t=>{"object"==typeof t&&this.categories.push(new P(t))})),this.users=[],s.forEach((t=>{"object"==typeof t&&this.users.push(new M(t))}))}getCategory(t){return this.categories.find((e=>e.id===t))}getUser(t){return this.users.find((e=>e.id===t))}}class ${constructor({id:t=0,domain:e="",name:i="",groups:s=[],language:n={back:""}}){this.id=Number(t),this.domain=e,this.name=i,this.groups=[],s.forEach((t=>{"object"==typeof t&&this.groups.push(new F(t))})),this.language=n}getGroup(t){return this.groups.find((e=>e.id===t))}}class q{constructor({userId:t=0,start:e="",startDisplay:i="",endDisplay:s="",crc:n=""}){this.userId=t,this.start=e,this.startDisplay=i,this.endDisplay=s,this.crc=n}}class D{#t=null;constructor({siteId:t=0,locationId:e=0,groupId:i=0,categoryId:s=0,userId:n=0,date:r="",time:o=""}){this.siteId=t,this.locationId=e,this.groupId=i,this.categoryId=s,this.userId=n,this.date=r,this.setTime(o)}setTime(t){t instanceof q&&(this.#t=t,this.userId=t.userId)}getCrc(){return this.#t?.crc}getStartTime(){return this.#t?.start}}class U{constructor({id:t=0,libAuthId:e=0,libAuthRuleId:i=0}){this.id=t,this.libAuthId=e,this.libAuthRuleId=i}}class j{constructor({dates:t=[],date:e="",times:i=[],timezoneNote:s="",users:n=[],language:r={prev:"",next:""}}){this.dates=t,this.date=e,this.times=[],Array.isArray(i)&&i.forEach((t=>{this.times.push(new q(t))})),this.timezoneNote=s,this.users=[],Array.isArray(n)&&n.forEach((t=>{this.users.push(new U(t))})),this.language=r}areAllUsersAuthed(){return this.users.filter((t=>t.libAuthId>0)).length===this.users.length}}class B{constructor({groupId:t=0,categoryId:e=0,promptGroup:i="",promptCat:s="",promptCatUser:n="",promptUser:r="",promptDate:o="",promptTime:a="",promptNoAvail:h="",successMsg:l="",promptAuth:c=""}){this.groupId=t,this.categoryId=e,this.promptGroup=i,this.promptCat=s,this.promptCatUser=n,this.promptUser=r,this.promptDate=o,this.promptTime=a,this.promptNoAvail=h,this.successMsg=l,this.promptAuth=c}toJSON(){const t={};return this.groupId>0&&(t.groupId=this.groupId),this.categoryId>0&&(t.categoryId=this.categoryId),""!==this.promptGroup&&(t.promptGroup=this.promptGroup),""!==this.promptCat&&(t.promptCat=this.promptCat),""!==this.promptCatUser&&(t.promptCatUser=this.promptCatUser),""!==this.promptUser&&(t.promptUser=this.promptUser),""!==this.promptDate&&(t.promptDate=this.promptDate),""!==this.promptTime&&(t.promptTime=this.promptTime),""!==this.promptNoAvail&&(t.promptNoAvail=this.promptNoAvail),""!==this.successMsg&&(t.successMsg=this.successMsg),""!==this.promptAuth&&(t.promptAuth=this.promptAuth),t}}class H{constructor({id:t=0,actionId:e=0,text:i="",freeResponse:s=!1,otherResponse:n=!1,page:r=0,back:o=!1}){this.id=t,this.actionId=e,this.text=i,this.freeResponse=s,this.otherResponse=n,this.page=r,this.back=o}}class W{constructor({name:t,type:i,defaultNextAction:s=e.ACTION_END}){this.type=Number(i),this.name=t,this.defaultNextAction=s}}class z{constructor({categoryIds:t=[],campusIds:e=[],audienceIds:i=[]}){this.categoryIds=t,this.campusIds=e,this.audienceIds=i}toJSON(){const t={};return this.categoryIds.length>0&&(t.categoryIds=this.categoryIds),this.campusIds.length>0&&(t.campusIds=this.campusIds),this.audienceIds.length>0&&(t.audienceIds=this.audienceIds),t}}class V{constructor({id:t=0,ruleType:e=r.PRESET,preset_responses:i=[],matchType:s=0,matchVal:n=[],target:o=0,message:a="",flow_uuid:h=""}){this.id=Number(t),this.ruleType=Number(e),Array.isArray(i)&&(this.preset_responses=i.map((t=>Number(t)))),this.matchType=Number(s),this.matchVal=Array.isArray(n)?n:[],this.target=Number(o),this.message=a,this.flow_uuid=h}setTempTarget(t){t instanceof W&&(this.newTarget=t)}getTempTarget(){return this.newTarget||null}clearTempTarget(){this.newTarget=null}isPreset(){return this.ruleType===r.PRESET}isFreeText(){return this.ruleType===r.FREE}isPassAlong(){return this.ruleType===r.PASSALONG}escapeRegExp(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}doesTextMatch(t){if(this.isPassAlong())return!0;if(!this.isFreeText()||0===this.matchVal.length)return!1;try{const e=this.matchVal.map((t=>this.escapeRegExp(t)));switch(this.matchType){case o.MATCH_ANY:for(const i of e){if(new RegExp(i,"im").test(t))return!0}return!1;case o.MATCH_ALL:for(const i of e){if(!new RegExp(i,"im").test(t))return!1}return!0}}catch(t){return!1}return!1}validate(){if(this.isPreset()&&0===this.preset_responses.length)throw new Error(R("errors.validation.ruleResponses","Response is required."));if(this.isFreeText()){if(!this.matchType)throw new Error(R("errors.validation.matchType","Selecting Any Words or All Words is required."));if(0===this.matchVal.length)throw new Error(R("errors.validation.ruleMatches","Keyword/phrase is required."))}if(0===this.target&&!this.getTempTarget()&&!this.message)throw new Error(R("errors.validation.ruleTarget","Result action or message is required."))}toJSON(){const t={id:this.id,ruleType:this.ruleType,target:this.target};return this.preset_responses.length>0&&(t.preset_responses=this.preset_responses),this.matchVal.length>0&&(t.matchVal=this.matchVal),0!==this.matchType&&(t.matchType=this.matchType),this.message&&(t.message=this.message),this.flow_uuid&&(t.flow_uuid=this.flow_uuid),t}}class G{constructor({nextActionId:t=0,text:e="",passAlong:i=!1,message:s="",flow_uuid:n="",chainNextSearch:r=!1}){this.nextActionId=Number(t),this.text=e,this.passAlong=!!i,this.message=s,this.flow_uuid=n,this.chainNextSearch=!!r}}class Q{constructor({id:t=0,type:i=0,name:s="",defaultNextAction:n=e.ACTION_END,messages:r=[],subType:o=0,rules:a=[]}){this.id=Number(t),this.type=Number(i),this.name=s,this.subType=Number(o),this.messages=r,this.defaultNextAction=n,this.rules=a.map((t=>t instanceof V?t:new V(t))),this.responses=[]}get icon(){return s[this.type]??""}get alertType(){return n[this.type]??"info"}getRule(t){return this.rules.find((e=>e.id===t))}addRule(t){0===t.id&&(t.id=this.nextRuleId),this.rules.push(t)}removeRule(t){const e=this.rules.findIndex((e=>e.id===t));e<=-1||this.rules.splice(e,1)}allowNewRules(){return this.rules.length<30}get nextRuleId(){let t=0;return this.rules.forEach((e=>{e.id>t&&(t=e.id)})),t+1}getAllTargetIds(){const t=[];return t.push(this.defaultNextAction),this.rules.forEach((e=>{e.target>0&&t.push(e.target)})),t}goToPreviousStage(){return!1}getMessages(){return this.messages}getResponses(){return this.responses}_getResponseForPresetRules(t=0,e="",i=!1){let s=null;return s=this.rules.find((e=>e.isPreset()&&e.preset_responses.indexOf(t)>=0)),new G({nextActionId:s&&0!==s.target?s.target:this.defaultNextAction,text:e,passAlong:!!s&&s.isPassAlong(),message:s?s.message:"",flow_uuid:s?s.flow_uuid:"",chainNextSearch:i})}getResultForResponse(){return new G({nextActionId:this.defaultNextAction})}isSearchAction(){return!1}isResourceAction(){return!1}getQuestion(){return null}validateResponse(t=""){return!!t}isNextSearchChained(){return!1}validate(){if(this.id<=0)throw new Error("Id is invalid.");if(!this.name)throw new Error(R("errors.validation.nameReq","Name is required."));if(!this.type)throw new Error(R("errors.validation.actionReq","Action type is invalid."));if(0===this.defaultNextAction)throw new Error(R("errors.validation.nextReq","Next Action is required."));this.messages.forEach((t=>{if(t.length>500)throw new Error(R("errors.validation.msgLength","Messages and prompts are limited to 500 characters."))}))}toJSON(){const t={id:this.id,type:this.type,name:this.name,icon:this.icon,alertType:this.alertType,subType:this.subType,defaultNextAction:this.defaultNextAction};return this.isResourceAction()&&(t.isResourceAction=!0),this.isSearchAction()&&(t.isSearchAction=!0),""!==this.subTypeId&&(t.subTypeId=this.subTypeId),this.messages.length>0&&(t.messages=this.messages),this.rules.length>0&&(t.rules=this.rules),this.success_message&&(t.success_message=this.success_message),this.fail_message&&(t.fail_message=this.fail_message),this.question&&(t.question=this.question),this.prompt&&(t.prompt=this.prompt),this.prompt2&&(t.prompt2=this.prompt2),this.prompt3&&(t.prompt3=this.prompt3),this.startText&&(t.startText=this.startText),this.dismissText&&(t.dismissText=this.dismissText),this.siteId&&(t.siteId=this.siteId),this.saveAnswer&&(t.saveAnswer=this.saveAnswer),this.previewLink&&(t.previewLink=this.previewLink),this.useForm&&(t.useForm=this.useForm),this.searchFilter&&(t.searchFilter=this.searchFilter),this.botAppt&&(t.botAppt=!0),this.apptParams&&(t.apptParams=this.apptParams),this.customHoursString&&(t.customHoursString=this.customHoursString),this.chainNextSearch&&(t.chainNextSearch=this.chainNextSearch),t}}class K extends Q{constructor({id:e=0,name:i="",defaultNextAction:s=-1,messages:n=[],startText:r="",dismissText:o=""}){super({id:e,type:t.ACTION_WELCOME,name:i,defaultNextAction:s,messages:n}),this.startText=r,this.dismissText=o,this.skip_bot=!1,this.chat_online=!1}setChatOnline(){this.chat_online=!0}getResponses(){const t=[new H({id:1,actionId:this.id,text:this.startText}),new H({id:e.ACTION_END,actionId:this.id,text:this.dismissText})];return this.skip_bot&&this.chat_online&&t.push(new H({id:e.ACTION_SKIP,actionId:this.id,text:this.skip_text})),t}getResultForResponse({id:t=0}){let i=e.ACTION_END;return 1===t&&(i=this.defaultNextAction),t===e.ACTION_SKIP&&(i=e.ACTION_SKIP),new G({nextActionId:i})}validate(){if(super.validate(),!this.startText)throw new Error(R("errors.validation.startReq","Start chat text is required."));if(!this.dismissText)throw new Error(R("errors.validation.dismissReq","Dismiss chat text is required."))}}class Y extends Q{constructor({id:e=0,name:i="",defaultNextAction:s=-1,rules:n=[],subType:r=0,question:o=null}){super({id:e,type:t.ACTION_QUESTION,name:i,defaultNextAction:s,subType:r,rules:n}),this.setQuestion(o),this.saveAnswer=!1}setQuestion(t){this.question=t instanceof I?t:new I(t||{})}getQuestion(){return this.question}getMessages(){return[this.question.question]}getResponses(){const t=[];return this.question.isMultiChoice()?(this.question.responses.forEach((e=>{t.push(new H({id:e.id,actionId:this.id,text:e.text,otherResponse:0===e.id}))})),t):(t.push(new H({actionId:this.id,freeResponse:!0})),t)}getResultForResponse({id:t=0,text:e=""}){let i=null;return this.question.isMultiChoice()?(i=this.rules.find((e=>e.isPreset()&&e.preset_responses.indexOf(t)>=0)),!i&&this.question.free_response&&""!==e&&(i=this.rules.find((t=>t.doesTextMatch(e))))):i=this.rules.find((t=>t.doesTextMatch(e))),new G({nextActionId:i&&0!==i.target?i.target:this.defaultNextAction,text:e,passAlong:!!i&&i.isPassAlong(),message:i?i.message:"",flow_uuid:i?i.flow_uuid:""})}validate(){if(super.validate(),this.subType<=0)throw new Error(R("errors.validation.questionReq","Question is required."))}}class J extends Q{constructor({id:e=0,name:i="",defaultNextAction:s=-1,rules:n=[],subType:r=h.INFO_NAME,prompt:o=R("defaults.requestNameMsg","What is your name?"),prompt2:a="",prompt3:l=""}){super({id:e,type:t.ACTION_REQUEST_INFO,name:i,defaultNextAction:s,subType:r,rules:n}),this.prompt=o,this.prompt2=a,this.prompt3=l,this.stage=this._getStartingStage(),this.resolvedNextAction=this.defaultNextAction}_getStartingStage(){let t=l.EVALUATE;return this.usesName()?t=l.NAME:this.usesEmail()?t=l.EMAIL:this.usesId()&&(t=l.ID),t}getMessages(){switch(this.stage){case l.NAME:return[this.prompt];case l.EMAIL:return[this.prompt2];case l.ID:return[this.prompt3]}return[]}getResponses(){return[new H({actionId:this.id,freeResponse:!0})]}_getNextStage(){switch(this.stage){case l.NAME:return this.usesId()?l.ID:this.usesEmail()?l.EMAIL:l.EVALUATE;case l.ID:return this.usesEmail()?l.EMAIL:l.EVALUATE;case l.EMAIL:default:return l.EVALUATE}}getResultForResponse({text:t=""}){let e=this.defaultNextAction,i=null;switch(this.stage){case l.NAME:this.stage=this._getNextStage(),e=this.id;break;case l.ID:this.stage=this._getNextStage(),i=this.rules.find((e=>!!e.preset_responses.includes(h.INFO_ID)&&(e.isFreeText()&&e.doesTextMatch(t)))),i&&(this.resolvedNextAction=0!==i.target?i.target:this.defaultNextAction),e=this.id;break;case l.EMAIL:this.stage=this._getNextStage(),i=this.rules.find((e=>!!e.preset_responses.includes(h.INFO_EMAIL)&&(e.isFreeText()&&e.doesTextMatch(t)))),i&&(this.resolvedNextAction=0!==i.target?i.target:this.defaultNextAction),e=this.id}return this.stage===l.EVALUATE&&(e=this.resolvedNextAction,this.stage=this._getStartingStage(),this.resolvedNextAction=this.defaultNextAction),new G({nextActionId:e,text:t,message:i?i.message:"",flow_uuid:i?i.flow_uuid:""})}validateResponse(t=""){return!!t&&(this.stage!==l.EMAIL||null!==t.match(C))}usesName(){return this.subType===h.INFO_NAME||this.subType===h.INFO_NAME_EMAIL||this.subType===h.INFO_NAME_EMAIL_ID||this.subType===h.INFO_NAME_ID}usesEmail(){return this.subType===h.INFO_EMAIL||this.subType===h.INFO_NAME_EMAIL_ID||this.subType===h.INFO_EMAIL_ID||this.subType===h.INFO_NAME_EMAIL}usesId(){return this.subType===h.INFO_ID||this.subType===h.INFO_NAME_EMAIL_ID||this.subType===h.INFO_EMAIL_ID||this.subType===h.INFO_NAME_ID}validate(){if(super.validate(),this.subType<=0)throw new Error(R("errors.validation.infoTypeReq","Contact Information Type is required."));if(this.usesName()&&""===this.prompt||this.usesEmail()&&""===this.prompt2||this.usesId()&&""===this.prompt3)throw new Error(R("errors.validation.prompt","Prompt cannot be blank."));if(this.prompt.length>500||this.prompt2.length>500||this.prompt3.length>500)throw new Error(R("errors.validation.msgLength","Messages and prompts are limited to 500 characters."))}toJSON(){const t=super.toJSON();return t.usesName=this.usesName(),t.usesEmail=this.usesEmail(),t.usesId=this.usesId(),t}}class Z extends Q{constructor({id:e=0,name:i="",defaultNextAction:s=-1,prompt:n="",prompt2:r="",messages:o=[R("defaults.linkMsg","This link may help you:")],rules:a=[]}){super({id:e,type:t.ACTION_LINK,name:i,defaultNextAction:s,messages:o,rules:a}),this.prompt=n,this.prompt2=r,this.link_prompt=""}getMessages(){const t=`<a href="${this.prompt}" class="action_click" target="_blank">${this.prompt2?this.prompt2:this.prompt}</a>`;return this.messages.concat([t],0===this.rules.length?[]:[this.link_prompt])}getResponses(){return this.isResourceAction()&&0===this.rules.length?[]:this.responses}isResourceAction(){return!0}getResultForResponse({id:t=0,text:e=""}){return super._getResponseForPresetRules(t,e)}validate(){if(super.validate(),""===this.prompt)throw new Error(R("errors.validation.urlReq","Website URL is required."));try{if(!new URL(this.prompt).protocol.match("http"))throw new Error}catch(t){throw new Error(R("errors.validation.urlInvalid","Website URL appears invalid."))}}}class X extends Q{constructor({id:e=0,name:i="",defaultNextAction:s=-1,subType:n=0,subTypeId:r="",prompt:o="",success_message:a="",fail_message:h="",messages:l=[],rules:c=[],chainNextSearch:d=!1}){super({id:e,type:t.ACTION_FAQ,name:i,defaultNextAction:s,subType:n,messages:l,rules:c}),this.subTypeId=r,this.prompt=o,this.success_message=a,this.fail_message=h,this.stage=u.PROMPT,this.search_prompt="",this.link_prompt="",this.chainNextSearch=!!d,this.parentSearchActionId=0}getMessages(t=""){if(this.isResourceAction()){const e=this.messages.concat([t]);return this.rules.length>0&&e.push(this.link_prompt),e}return this.isSearchAction()&&this.stage===u.RESULT?[this.success_message,t,this.search_prompt]:this.isSearchAction()&&this.stage===u.FAIL?[t||this.fail_message,this.search_prompt]:this.messages}getResponses(){return this.isSearchAction()&&this.stage===u.PROMPT?[new H({actionId:this.id,freeResponse:!0})]:this.isResourceAction()&&0===this.rules.length?[]:this.responses}isSearchAction(){return this.subType===d.FAQ_SEARCH}isResourceAction(){return this.subType===d.FAQ_SINGLE||this.subType===d.FAQ_RESULTS}getResultForResponse({id:t=0,text:e=""}){if(this.isSearchAction()){if(""!==e&&this.stage!==u.CHAINED){this.stage=u.RESULT;const t=new G({nextActionId:this.id,text:e,chainNextSearch:this.chainNextSearch});return this.parentSearchActionId>0&&(t.nextActionId=this.parentSearchActionId,t.chainNextSearch=!0),t}this.stage=u.PROMPT}return super._getResponseForPresetRules(t,e,this.chainNextSearch)}isNextSearchChained(){return this.chainNextSearch}validate(){if(super.validate(),this.subType<=0)throw new Error(R("errors.validation.faqTypeReq","FAQ Type is required."));if(this.subType===d.FAQ_SINGLE&&!this.subTypeId)throw new Error(R("errors.validation.faqIdReq","FAQ ID is required."));if(this.subType===d.FAQ_SEARCH&&""===this.subTypeId)throw new Error(R("errors.validation.groupsReq","Groups are required."));if(this.subType===d.FAQ_RESULTS&&(""===this.subTypeId||""===this.prompt))throw new Error(R("errors.validation.faqResults","Group and Search are required."))}}class tt extends Q{constructor({id:e=0,name:i="",defaultNextAction:s=-1,subType:n=0,subTypeId:r="",useFallback:o=!0,fail_message:a=R("defaults.chatFailMsg","We're sorry, operators are not online currently."),messages:h=[R("defaults.chatMsg","We'll check to see if an operator is online, please wait one moment.")]}){super({id:e,type:t.ACTION_CHAT,name:i,defaultNextAction:s,subType:n,messages:h}),this.subTypeId=r,this.useFallback=!!o,this.fail_message=a}getStatusRule(){return new N({u:this.subType===c.SEND_OP?this.subTypeId:0,d:this.subType===c.SEND_DEPT?[this.subTypeId]:[]})}validate(){if(super.validate(),this.subType<=0)throw new Error(R("errors.validation.chatTypeReq","Chat Action Type is required."));if(this.subType===c.SEND_OP&&!Number(this.subTypeId))throw new Error(R("errors.validation.opReq","Operator is required."));if(this.subType===c.SEND_DEPT&&!Number(this.subTypeId))throw new Error(R("errors.validation.deptReq","Department is required."))}}class et extends Q{constructor({id:e=0,name:i="",defaultNextAction:s=-1,subType:n=0,startText:r=R("defaults.startTicketMsg","Submit Ticket."),dismissText:o=R("defaults.dismissTicketMsg","Don't submit."),messages:a=[R("defaults.ticketMsg","Would you like to submit a ticket?")],prompt:h=R("defaults.ticketPrompt","Please type your query in below."),prompt2:l=R("defaults.contactPrompt","Please provide your email address in order to submit this ticket."),useForm:c=!1,success_message:u=R("defaults.ticketSuccessMsg","Your ticket has been submitted. Someone will be in touch soon. Thank you!")}){super({id:e,type:t.ACTION_TICKET,name:i,defaultNextAction:s,subType:n,messages:a}),this.startText=r,this.dismissText=o,this.prompt=h,this.prompt2=l,this.useForm=!!c,this.success_message=u,this.stage=g.PROMPT}getMessages(){switch(this.stage){case g.PROMPT:return this.messages;case g.CONTACT:return[this.prompt2];case g.QUESTION:return[this.prompt]}return[]}getResponses(){return this.stage===g.PROMPT?[new H({id:1,actionId:this.id,text:this.startText}),new H({id:0,actionId:this.id,text:this.dismissText})]:this.stage===g.FORM?[]:[new H({id:1,actionId:this.id,freeResponse:!0})]}getResultForResponse({id:t=0}){let i=this.defaultNextAction;switch(this.stage){case g.PROMPT:0!==t&&(this.useForm?this.stage=g.FORM:this.stage=g.CONTACT,i=this.id);break;case g.CONTACT:this.stage=g.QUESTION,i=this.id;break;case g.QUESTION:case g.FORM:t>0&&(i=e.ACTION_END)}return new G({nextActionId:i})}validateResponse(t=""){return!!t&&(this.stage!==g.CONTACT||null!==t.match(C))}validate(){if(super.validate(),this.subType<=0)throw new Error(R("errors.validation.queueReq","Queue is required."));if(""===this.startText||""===this.dismissText)throw new Error(R("errors.validation.buttonLabelReq","Button labels are required."));if(""===this.prompt)throw new Error(R("errors.validation.promptReq","Prompt cannot be blank."));if(this.prompt.length>500)throw new Error(R("errors.validation.msgLength","Messages and prompts are limited to 500 characters."))}}class it extends Q{constructor({id:e=0,name:i="",defaultNextAction:s=-1,subType:n=0,subTypeId:r="",siteId:o=0,success_message:a="",fail_message:h="",prompt:l="",prompt2:c="",messages:d=[R("defaults.guideMsg","What can I help you find today in our LibGuides System?")],rules:p=[],chainNextSearch:m=!1}){super({id:e,type:t.ACTION_LIBGUIDES,name:i,defaultNextAction:s,subType:n,messages:d,rules:p}),this.subTypeId=r,this.siteId=Number(o||0),this.success_message=a,this.fail_message=h,this.prompt=l,this.prompt2=c,this.stage=u.PROMPT,this.search_prompt="",this.link_prompt="",this.chainNextSearch=!!m,this.parentSearchActionId=0}getMessages(t=""){if(this.isResourceAction()){this.subType===p.LG_OTHER&&(t=`<a href="${this.prompt}" class="action_click" target="_blank">${this.prompt2?this.prompt2:this.prompt}</a>`);const e=this.messages.concat([t]);return this.rules.length>0&&e.push(this.link_prompt),e}return this.isSearchAction()&&this.stage===u.RESULT?[this.success_message,t,this.search_prompt]:this.isSearchAction()&&this.stage===u.FAIL?[t||this.fail_message,this.search_prompt]:this.messages}getResponses(){return this.isSearchAction()&&this.stage===u.PROMPT?[new H({actionId:this.id,freeResponse:!0})]:this.isResourceAction()&&0===this.rules.length?[]:this.responses}isSearchAction(){return this.subType===p.GUIDE_SEARCH||this.subType===p.AZ_SEARCH}isResourceAction(){return this.subType===p.GUIDE_SINGLE||this.subType===p.AZ_SINGLE||this.subType===p.LG_OTHER}isNextSearchChained(){return this.chainNextSearch}getResultForResponse({id:t=0,text:e=""}){if(this.isSearchAction()){if(""!==e&&this.stage!==u.CHAINED){this.stage=u.RESULT;const t=new G({nextActionId:this.id,text:e,chainNextSearch:this.chainNextSearch});return this.parentSearchActionId>0&&(t.nextActionId=this.parentSearchActionId,t.chainNextSearch=!0),t}this.stage=u.PROMPT}return super._getResponseForPresetRules(t,e,this.chainNextSearch)}validate(){if(super.validate(),this.siteId<=0)throw new Error(R("errors.validation.siteReq","Selecting a Site is Required."));if(this.subType<=0)throw new Error(R("errors.validation.typeReq","Selecting an Item is Required."));if((this.subType===p.GUIDE_SINGLE||this.subType===p.AZ_SINGLE)&&!this.subTypeId)throw new Error(R("errors.validation.itemReq","Item Id is required."));if(this.subType===p.LG_OTHER){if(""===this.prompt)throw new Error(R("errors.validation.urlReq","Website URL is required."));try{if(!new URL(this.prompt).protocol.match("http"))throw new Error}catch(t){throw new Error(R("errors.validation.urlInvalid","Website URL appears invalid."))}}}}class st extends Q{#e=null;#i=null;#s=null;constructor({id:e=0,name:i="",defaultNextAction:s=-1,subType:n=0,siteId:r=0,subTypeId:o="",success_message:a="",fail_message:h="",messages:l=[R("defaults.calMsg","You may find the information you're looking for in our LibCal system!")],rules:c=[],searchFilter:d=null,botAppt:p=!1,apptParams:m=null,chainNextSearch:f=!1}){super({id:e,type:t.ACTION_LIBCAL,name:i,defaultNextAction:s,subType:n,messages:l,rules:c}),this.subTypeId=o,this.siteId=Number(r||0),this.success_message=a,this.fail_message=h,this.stage=u.PROMPT,this.search_prompt="",this.link_prompt="",this.searchFilter=d?new z(d):null,this.botAppt=!!p,this.apptParams=m?new B(m):null,this.chainNextSearch=!!f,this.parentSearchActionId=0}getBookingInfo(){return this.#i}getLocationAndUserName(){if(!this.#e||!this.#i)return"";const t=this.#e.name;let e="";const i=this.#e.getGroup(this.#i.groupId);if(i){const t=i.getUser(this.#i.userId);t&&(e=t.name)}return`${t}: ${e}`.trim()}#n(){const t=`https://${this.#e.domain}/appointment/${this.#i.userId}?lid=${this.#i.locationId}&g=${this.#i.groupId}&c=${this.#i.categoryId}`;return`<a href="${t}" class="action_click" data-actionid="${this.id}">${t}</a>`}getPreviousBookingStage(){if(this.stage===f.GROUP_PROMPT)return f.GROUP_PROMPT;if(this.stage===f.FORM)return f.TIME_PROMPT;if(this.stage===f.TIME_PROMPT)return f.DATE_PROMPT;if(this.stage===f.CAT_PROMPT)return this.apptParams.groupId>0?f.CAT_PROMPT:f.GROUP_PROMPT;if(this.stage===f.CAT_USER_PROMPT||this.stage===f.USER_PROMPT){if(this.apptParams.categoryId>0)return this.stage;const t=this.#e.getGroup(this.#i.groupId);return t?t.categories.length>0?f.CAT_PROMPT:this.apptParams.groupId>0?this.stage:f.GROUP_PROMPT:f.FAIL}if(this.stage===f.DATE_PROMPT){const t=this.#e.getGroup(this.#i.groupId);return t?t.users.length>1?0===t.categories.length?f.USER_PROMPT:f.CAT_USER_PROMPT:this.apptParams.categoryId>0?f.CAT_USER_PROMPT:0===t.categories.length?f.GROUP_PROMPT:f.CAT_PROMPT:f.FAIL}return f.FAIL}goToPreviousStage(){return!!this.isBotBooking()&&(this.stage=this.getPreviousBookingStage(),this.stage===f.DATE_PROMPT&&(this.#i.date=""),this.stage!==f.USER_PROMPT&&this.stage!==f.CAT_USER_PROMPT||(this.#i.userId=0),this.stage===f.CAT_PROMPT&&(this.#i.categoryId=0),this.stage===f.GROUP_PROMPT_PROMPT&&(this.#i.groupId=0),!0)}#r(t=""){if(!this.#e||!this.apptParams)throw new Error;if(this.stage===f.FAIL)return[t];this.#i||(this.#i=new D({siteId:this.siteId,locationId:Number(this.subTypeId)}));let e=[];""!==t&&e.push(t);let i=null,s=null,n=null;if(this.stage===f.GROUP_PROMPT){if(e=e.concat(this.messages),0===this.apptParams.groupId){const t=this.apptParams.promptGroup.replace("{nameToken}",this.#e.name);return e.push(t),e}if(i=this.#e.getGroup(this.apptParams.groupId),!i)throw new Error;this.#i.groupId=i.id,this.stage=f.CAT_PROMPT}if(i||(i=this.#e.getGroup(this.#i.groupId)),this.stage===f.CAT_PROMPT){if(0===this.apptParams.categoryId&&i.categories.length>0){const t=this.apptParams.promptCat.replace("{nameToken}",i.name);return e.push(t),e}this.apptParams.categoryId>0&&i.categories.length>0?(s=i.getCategory(this.apptParams.categoryId),s&&(this.#i.categoryId=s.id,this.stage=f.CAT_USER_PROMPT)):this.stage=f.USER_PROMPT}if(s||(s=i.getCategory(this.#i.categoryId)),this.stage===f.CAT_USER_PROMPT){if(i.users.length>0){const t=this.apptParams.promptCatUser.replace("{nameToken}",s.name);return e.push(t),e}this.stage=f.DATE_PROMPT}if(this.stage===f.USER_PROMPT){if(i.users.length>0){const t=this.apptParams.promptUser.replace("{nameToken}",i.name);return e.push(t),e}this.stage=f.DATE_PROMPT}if(n=i.getUser(this.#i.userId),this.stage===f.DATE_PROMPT){const t=this.apptParams.promptDate.replace("{nameToken}",n?n.name:"");return e.push(t),e}if(this.stage===f.TIME_PROMPT){const t=`${this.apptParams.promptTime.replace("{nameToken}",n?n.name:"")} ${this.#s.timezoneNote}`;return e.push(t),e}if(this.stage===f.AUTHLINK){const t=this.apptParams.promptAuth.replace("{libAuthLink}",this.#n());return e.push(t),e.push(this.link_prompt),e}return[this.apptParams.successMsg,this.link_prompt]}#o(){return new H({id:a.STAGE_BACK,action:this.id,text:this.#e.language?.back||"Return To Prior Step",back:!0})}#a({page:t=0}){const e=[];if(this.stage===f.GROUP_PROMPT)return this.#e.groups.forEach((t=>{e.push(new H({id:t.id,actionId:this.id,text:t.name}))})),e;if(this.stage===f.CAT_PROMPT){return this.#e.getGroup(this.#i.groupId).categories.forEach((t=>{e.push(new H({id:t.id,actionId:this.id,text:t.name}))})),this.getPreviousBookingStage()!==this.stage&&e.push(this.#o()),e}if(this.stage===f.CAT_USER_PROMPT||this.stage===f.USER_PROMPT){return this.#e.getGroup(this.#i.groupId).users.forEach((t=>{e.push(new H({id:t.id,actionId:this.id,text:t.name}))})),this.getPreviousBookingStage()!==this.stage&&e.push(this.#o()),e}if(this.stage===f.DATE_PROMPT){if(this.#s.dates.length<=14)this.#s.dates.forEach(((t,i)=>{e.push(new H({id:i,actionId:this.id,text:t}))}));else{0===t&&(t=1);const i=15;let s=0,n=15;t>1&&(s=(t-1)*i,n=s+i,e.push(new H({id:a.PAGE_BACK,actionId:this.id,text:this.#s.language?.prev||"See Previous Dates",page:t-1}))),this.#s.dates.forEach(((t,i)=>{i<s||i>=n||e.push(new H({id:i,actionId:this.id,text:t}))})),n<=this.#s.dates.length&&e.push(new H({id:a.PAGE_FORWARD,actionId:this.id,text:this.#s.language?.next||"See More Dates",page:t+1}))}return e.push(this.#o()),e}return this.stage===f.TIME_PROMPT?(this.#s.times.forEach(((t,i)=>{e.push(new H({id:i,actionId:this.id,text:t.start}))})),e.push(this.#o()),e):this.responses}#h({id:t=0}){if(this.stage===f.GROUP_PROMPT){this.#i.groupId=t;const e=this.#e.getGroup(t);return e?0===e.categories.length?this.stage=f.USER_PROMPT:this.stage=f.CAT_PROMPT:this.stage=f.FAIL,this.stage=f.CAT_PROMPT,new G({nextActionId:this.id})}return this.stage===f.CAT_PROMPT?(this.#i.categoryId=t,this.stage=f.CAT_USER_PROMPT,new G({nextActionId:this.id})):this.stage===f.CAT_USER_PROMPT||this.stage===f.USER_PROMPT?(this.#i.userId=t,this.stage=f.DATE_PROMPT,new G({nextActionId:this.id})):this.stage===f.DATE_PROMPT?(this.#i.date=this.#s.dates[t]||"",this.#s.areAllUsersAuthed()?this.stage=f.AUTHLINK:this.stage=f.TIME_PROMPT,new G({nextActionId:this.id})):this.stage===f.TIME_PROMPT?(this.#i.setTime(this.#s.times[t]),this.#s.areAllUsersAuthed()?this.stage=f.AUTHLINK:this.stage=f.FORM,new G({nextActionId:this.id})):super._getResponseForPresetRules(t,"")}getMessages(t=""){if(this.isBotBooking())return this.#r(t);if(this.isResourceAction()){const e=this.messages.concat([t]);return this.rules.length>0&&e.push(this.link_prompt),e}return this.isSearchAction()&&this.stage===u.RESULT?[this.success_message,t,this.search_prompt]:this.isSearchAction()&&this.stage===u.FAIL?[t||this.fail_message,this.search_prompt]:this.messages}getResponses({page:t=0}){return this.isBotBooking()?this.#a({page:t}):this.isSearchAction()&&this.stage===u.PROMPT?[new H({actionId:this.id,freeResponse:!0})]:this.isResourceAction()&&0===this.rules.length?[]:this.responses}isSearchAction(){return this.subType===m.EVENT_SEARCH}isResourceAction(){return this.subType===m.BOOKING_APPT||this.subType===m.BOOKING_EQUIP||this.subType===m.BOOKING_SPACE||this.subType===m.HOURS_TODAY||this.subType===m.HOURS_WEEK}isBotBooking(){return this.subType===m.BOOKING_APPT&&this.botAppt}isHours(){return this.subType===m.HOURS_TODAY||this.subType===m.HOURS_WEEK}isLocationInfoSet(){return null!==this.#e}setLocationInfo(t){t instanceof $&&(this.#e=t)}setBookingAvailability(t){t instanceof j&&(this.#s=t)}getResultForResponse({id:t=0,text:e=""}){if(this.isBotBooking())return this.#h({id:t,text:e});if(this.isSearchAction()){if(""!==e&&this.stage!==u.CHAINED){this.stage=u.RESULT;const t=new G({nextActionId:this.id,text:e,chainNextSearch:this.chainNextSearch});return this.parentSearchActionId>0&&(t.nextActionId=this.parentSearchActionId,t.chainNextSearch=!0),t}this.stage=u.PROMPT}return super._getResponseForPresetRules(t,e,this.chainNextSearch)}isNextSearchChained(){return this.chainNextSearch}validate(){if(super.validate(),this.siteId<=0)throw new Error(R("errors.validation.siteReq","Selecting a Site is Required."));if(this.subType<=0)throw new Error(R("errors.validation.typeReq","Selecting an Item is Required."));if(this.subType!==m.EVENT_SEARCH&&(!this.subTypeId||"0"===this.subTypeId))throw new Error(R("errors.validation.locationReq","Location or Library is required."))}}class nt extends Q{constructor({id:e=0,name:i="",defaultNextAction:s=-1,subType:n=0,siteId:r=0,subTypeId:o="",messages:a=[R("defaults.lwzMsg","Please head to our LibWizard form and fill it out!")],rules:h=[]}){super({id:e,type:t.ACTION_LIBWIZARD,name:i,defaultNextAction:s,subType:n,messages:a,rules:h}),this.subTypeId=o,this.siteId=Number(r||0)}getMessages(t=""){const e=this.messages.concat([t]);return this.rules.length>0&&e.push(this.link_prompt),e}getResponses(){return this.isResourceAction()&&0===this.rules.length?[]:this.responses}isResourceAction(){return!0}getResultForResponse({id:t=0,text:e=""}){return super._getResponseForPresetRules(t,e)}validate(){if(super.validate(),this.siteId<=0)throw new Error(R("errors.validation.siteReq","Selecting a Site is Required."));if(this.subType<=0)throw new Error(R("errors.validation.typeReq","Selecting an Item is Required."));if(!this.subTypeId||"0"===this.subTypeId)throw new Error(R("errors.validation.itemReq","Item Id is required."))}}class rt extends Q{constructor({id:i=0,name:s="",subType:n=0,subTypeId:r="",defaultNextAction:o=e.ACTION_END,messages:a=[R("defaults.ratingMsg","We'd love to get your feedback on this interaction.")],prompt:h="",prompt2:l=""}){super({id:i,type:t.ACTION_RATING,name:s,defaultNextAction:o,subType:n,messages:a}),this.subTypeId=r,this.prompt=h,this.prompt2=l}getResponses(){return[new H({id:e.ACTION_END,actionId:this.id,text:""})]}validate(){if(super.validate(),this.subType===v.NPS_SURVEY&&!this.subTypeId)throw new Error(R("errors.validation.typeReq","Selecting an Item is Required."))}}class ot extends Q{constructor({id:e=0,name:i="",defaultNextAction:s=-1,subType:n=0,rules:r=[],customHoursString:o="",customHoursObj:a=null,siteId:h=0,subTypeId:l=""}){super({id:e,type:t.ACTION_PARAMS,name:i,defaultNextAction:s,subType:n,rules:r}),this.customHoursString=o,this.customHoursObj=a,this.siteId=h,this.subTypeId=l}getResultForResponse({id:t=0,text:e=""}){return super._getResponseForPresetRules(t,e)}validate(){if(super.validate(),this.subType<=0)throw new Error(R("errors.validation.typeReq","Selecting an Item is Required."));if(this.subType===w.PARAM_OPEN_HOURS&&!this.customHoursString)throw new Error(R("errors.validation.openHours","Please set your Open Hours to continue."));if(this.subType===w.PARAM_LC_HOURS&&!this.subTypeId)throw new Error(R("errors.validation.locationReq","Location or Library is required."))}}const at=function(e,i){let s=null;if(e instanceof Q)return i.setResponses(s),s;switch(Number(e.type)){case t.ACTION_QUESTION:s=new Y(e);break;case t.ACTION_REQUEST_INFO:s=new J(e);break;case t.ACTION_FAQ:s=new X(e);break;case t.ACTION_CHAT:s=new tt(e);break;case t.ACTION_TICKET:s=new et(e);break;case t.ACTION_LIBGUIDES:s=new it(e);break;case t.ACTION_LIBCAL:s=new st(e);break;case t.ACTION_WELCOME:s=new K(e);break;case t.ACTION_LINK:s=new Z(e);break;case t.ACTION_LIBWIZARD:s=new nt(e);break;case t.ACTION_RATING:s=new rt(e);break;case t.ACTION_PARAMS:s=new ot(e);break;default:s=new Q(e)}return i.setResponses(s),e.previewLink&&(s.previewLink=e.previewLink),s};class ht{constructor({uuid:t="",iid:e=0,name:i="",description:s="",actions:n=[],timeout:r=0,availability:o=0,message_delay:a=2,skip_text:h="",message_end:l="",message_chat:c="",error_generic:u="",error_input:d="",provide_email:p="",bot_name:m="Chatbot",profile_url:f="",profile_color:g="",search_prompt:b="",search_retry:y="",search_continue:_="",search_resolved:v="",link_prompt:w="",link_yes:A="",link_no:S="",use_autoload:E=!1,questions:T=[],customHours:I={}},O){if(this.uuid=t,this.iid=Number(e),this.name=i,this.description=s,this.timeout=r,this.availability=Number(o),this.message_delay=Number(a),this.skip_bot=!1,this.skip_text=h,this.message_end=l,this.message_chat=c,this.error_generic=u,this.error_input=d,this.provide_email=p,this.bot_name=m,this.profile_url=f,this.profile_color=g,this.search_prompt=b,this.search_retry=y,this.search_continue=_,this.search_resolved=v,this.link_prompt=w,this.link_yes=A,this.link_no=S,this.use_autoload=E,this.customHours=I,this.actions=[],this.setActions(n),this.setQuestions(T),this.skip_bot){const t=this.getWelcomeAction();t.skip_bot=this.skip_bot,""!==this.skip_text&&(t.skip_text=this.skip_text)}this.emitter=O}getName(){return this.bot_name}getProfileImage(){return{path:this.profile_url,color:this.profile_color}}isItDuringCustomHours(){const t=new Date,e=t.getUTCDay(),i=t.getUTCHours(),s=t.getUTCMinutes(),n=this.customHours;if(!n||!n[e]||0===n[e].length)return!1;const r=n[e];return L(i,s,r)}isAvailableOffline(){return this.availability===_.AVAIL_ALWAYS||this.availability===_.AVAIL_OFFLINE_ONLY||this.availability===_.AVAIL_CUSTOM_HOURS&&this.isItDuringCustomHours()}isAvailableOnline(t=!1){return this.availability===_.AVAIL_ALWAYS||(!(this.availability!==_.AVAIL_CUSTOM_HOURS||!this.isItDuringCustomHours())||!(!t||!t.isOnline)&&(this.availability===_.AVAIL_ONLINE||this.availability===_.AVAIL_COOP_ONLY&&""!==t.coopId))}getActions(){return this.actions}getActionNames(){const t={};return this.getActions().forEach((e=>{t[e.id]=e.name})),t[-1]=R("actionform.options.endChat","End Chat"),t}getAction(t=0){return this.actions.find((e=>e.id===t))}getActionsByType(t=0){return this.actions.filter((e=>e.type===t))}getWelcomeAction(){return this.actions.find((e=>e.type===t.ACTION_WELCOME))}addAction({type:t,name:e="",defaultNextAction:i=-1}){if(!this.allowNewActions())throw new Error(R("errors.validation.actionLimit","You have reached the allowed number of actions (%maxLimit%) in a single flow. Please remove actions that are no longer needed to add more.",{maxLimit:50}));let s=0;this.actions.forEach((t=>{t.id>s&&(s=t.id)}));const n=at({id:s+1,type:t,name:e,defaultNextAction:i},this);return this.actions.push(n),n}setActions(t){t.forEach((t=>{t=at(t,this),this.actions.push(t)}))}updateAction(t){const e=t.id,i=this.actions.findIndex((t=>t.id===e));if(-1===i)throw new Error(`Action ${e} not found to update.`);this.actions.splice(i,1,t)}removeAction(t){const i=this.actions.findIndex((e=>e.id===t));if(i>-1){const[s]=this.actions.splice(i,1);this.actions.forEach((i=>{i.defaultNextAction===t&&(i.defaultNextAction=s.defaultNextAction||e.ACTION_END),i.rules.forEach((e=>{e.target===t&&(e.target=s.defaultNextAction||i.defaultNextAction)}))}))}}setQuestions(e){this.actions.forEach((i=>{if(i.type!==t.ACTION_QUESTION)return;const s=e.find((t=>t.id===i.subType));s&&i.setQuestion(s)}))}setResponses(t){if(t.isResourceAction())return t.responses=this.getResourceResponses(t.id),void(t.link_prompt=this.link_prompt);t.isSearchAction()&&(t.responses=this.getSearchResultResponses(t.id),t.search_prompt=this.search_prompt)}getSearchResultResponses(t){return[new H({id:y.RETRY,actionId:t,text:this.search_retry,otherResponse:!0}),new H({id:y.UNRESOLVED,actionId:t,text:this.search_continue}),new H({id:y.RESOLVED,actionId:t,text:this.search_resolved})]}getResourceResponses(t=0){return[new H({id:b.YES,actionId:t,text:this.link_yes}),new H({id:b.NO,actionId:t,text:this.link_no})]}getActionsThatPointAtTarget(t){const e=[];return this.getActions().forEach((i=>{if(i.id===t)return;if(i.defaultNextAction===t)return void e.push(i);let s=!1;i.rules.forEach((e=>{e.target===t&&(s=!0)})),s&&e.push(i)})),e}allowNewActions(){return this.getActions().length<50}transferFlow(t){this.bot_name=t.bot_name,this.profile_url=t.profile_url,this.profile_color=t.profile_color,this.message_delay=t.message_delay}toJSON(){return{uuid:this.uuid,iid:this.iid,name:this.name,description:this.description,actions:this.actions.map((t=>t.toJSON())),timeout:this.timeout,availability:this.availability,message_delay:this.message_delay,skip_bot:!1,skip_text:this.skip_text,message_end:this.message_end,message_chat:this.message_chat,error_generic:this.error_generic,error_input:this.error_input,provide_email:this.provide_email,bot_name:this.bot_name,profile_url:this.profile_url,profile_color:this.profile_color,search_prompt:this.search_prompt,search_retry:this.search_retry,search_continue:this.search_continue,search_resolved:this.search_resolved,link_prompt:this.link_prompt,link_yes:this.link_yes,link_no:this.link_no,use_autoload:this.use_autoload}}}const lt={defaults:{},emitter:null,init:function(t,e){this.set(t,{silent:!0}),void 0!==e&&(this.emitter=e)},get:function(t){if(void 0!==this[t])return this[t];const e=void 0!==this.defaults[t]?this.defaults[t]:null;return"object"!=typeof e?e:null===e?null:JSON.parse(JSON.stringify(e))},set:function(t,e,i){const s=[];if("object"==typeof t){i=e;Object.keys(t).forEach((function(e){this.sameValues(this.get(e),t[e])||s.push(e),this[e]=t[e]}),this)}else this.sameValues(this.get(t),e)||s.push(t),this[t]=e;void 0===i&&(i={silent:!1}),i.silent||null===this.emitter||!i.silent&&s.length>0&&(s.forEach((function(t){this.emitter.trigger(`change:${t}`,{model:this})}),this),this.emitter.trigger("change",{model:this}))},sameValues:function(t,e){return JSON.stringify(t)===JSON.stringify(e)},reset:function(){Object.keys(this.defaults).forEach((function(t){delete this[t]}),this)},toJSON:function(){const t={};return Object.keys(this.defaults).forEach((function(e){t[e]=void 0!==this[e]?this[e]:this.defaults[e]}),this),t},trigger:function(){this.emitter.trigger.apply(this.emitter,arguments)}};class ct{constructor({u:t=0,d:e=[],c:i="",away:s=!1}={},n=[]){this.u=Number(t),this.d=[],Array.isArray(e)&&e.forEach((t=>{n[t]&&this.d.push(n[t])})),this.c=i,this.away=!!s}get opId(){return this.u}get deptIds(){return this.d}get coopId(){return this.c}get isAway(){return this.away}get isOffline(){return this.u<=0&&0===this.d.length&&!this.c}getFirstDept(){return this.d[0]||{}}get isOnline(){return this.u>0||this.d.length>0||""!==this.c}}class ut{constructor({name:t="",id:e=0,show:i=0,required:s=0,type:n="t",val:r=""}){this.name=t,"click to edit"===t&&(this.name=""),this.id=e,this.show=!!i,this.required=!!s,"t"!==n&&"l"!==n&&(n="t"),this.type=n,this.val=Array.isArray(r)?r:r.split(",").filter((t=>""!==t.trim())),"l"===this.type&&0===this.val.length&&(this.show=!1),""===this.name&&(this.show=!1)}}const dt=Object.create(lt);dt.defaults={id:0,iid:0,hash:"",name:"",note:"",language:"",key:"",queue_id:0,auth_id:0,flow_id:"",unit_id:0,chat_title:"Welcome to LibChat!",byeMsg:"Thanks for chatting!",dept_label:"Select Department:",name_label:"Name (blank=anonymous)",name_default:"",guest_label:"Guest",contact_label:"Contact Info",dept_message:"You are now chatting with %deptName% Department.",width:"100%",height:340,chat_button:"Start Chat",press_enter:"Press ENTER to send",submit_button:"Submit",email_trans:"View/Email Transcript",offline_text:"Ask Us",offline_url:"",slidebutton_url:"",slidebutton_url_off:"",slidebutton_url_bot:"",slidebutton_text:"Ask Us",slidebutton_text_off:"Offline",slidebutton_text_bot:"",slidebutton_position:"r",slidebutton_bcolor:"#286090",slidebutton_color:"#ffffff",slidebutton_bcolor_off:"#286090",slidebutton_color_off:"#ffffff",slidebutton_bcolor_bot:"#286090",slidebutton_color_bot:"#ffffff",slidebutton_width:"",slidebutton_height:"",la_hide:!0,la_hide_msg:"Sorry, chat is offline but you can still get help.",la_hide_msg2:'<a href="{{ domain }}" target="_parent">Search our Knowledgebase and/or submit your question</a>',la_search_opt:{group_id:0,button:"Search",placeholder:"",label:"Search box"},la_search_box:"",star_text:"How did we do?",rate_1:"Bad",rate_2:"So-so",rate_3:"Good",rate_4:"Great",survey_uuid:"",trans:"Enter an email address to send this chat transcript to:",error_sess:"Error starting session.",error_send:"Error sending this message.",initial_question:!1,initial_question_label:"Your Question",comments_label:"Any comments?",comments_button_text:"Submit Feedback",comments_followup:"I would like to be contacted for a follow-up.",comments_email:"Email yourself a transcript of this chat",enable_anon:!0,enable_sound:!1,star_ratings:!0,file_uploads:!0,file_title:"Upload File",file_intro:"Note: Maximum file size is 20MB. File is removed after one month, it is not kept permanently.",file_label:"Attach a file",file_action:"Upload",max_file_size_label:"Maximum File Size",clear_file_btn:"Clear File",restart_chat:"Start New Chat",cancel_button:"Cancel",custom_css:"",color_backg:"#f9f9f9",color_head:"#286090",color_btn:"#FFFFFF",color_border:"",customFields:[],error_off:"Sorry it doesn't appear any librarians are online... Please try again later.",wait:"Please wait... A librarian will connect shortly!",onlineRules:[{d:[],u:0,c:""}],widget_type:2,skip_login:!1,nologin_message:"Type your question in the box below and press Enter to start chatting.",autoload_time:0,autoload_head:"Do you need help?",autoload_text:"A librarian is online ready to help.",autoload_yes:"Chat Now",autoload_no:"No Thanks",autoload_default:!0,autoload_image:"",autoload_name:"",missedchat_time:30,missedchat_message:"We apologize for the delay. Don't want to wait?",missedchat_link:"Submit your question.",error_link:"Submit your question.",away_message:"Chat is online but the operator is temporarily away.",away_link:"Submit your question.",reload_button:"Recheck Status",valid_form_q:"Please enter your question.",valid_form_n:"Please enter your name.",valid_form_c:"Please enter valid contact information.",fbwidget:!1,autopop:!1,question_text:"",contact_request:!1,contact_required:!1,contact_request_msg:"To help us be able to follow up with you, please enter an email address or sms number.",followup_enabled:!0,followup_msg:"If you wish to be followed up with via email or phone, submit a message below to create a new support ticket.",cal_offline:!1,cal_autoload:!1,cal_text:"Schedule a Meeting",cal_url:"",online_rule:!1,translation:{},domain:"",defaultProfile:"",dataNotice:"",greetingLocal:"",greetingCoop:"A partner librarian from our Cooperative is joining the chat.",timedFallback:0,authUrl:"",authText:"",authButton:"",isAuthValidated:!1},dt.peel=!1,dt.autologin=!1,dt.client_question="",dt.widget_types={button:1,embed:2,tab:3,float:6},dt.referer="",dt.referer_title="",dt.loggedIn=!1,dt.cascade=null,dt.connected=!1,dt.reconnect=!0,dt.hasConnected=!1,dt.hasSubscribed=!1,dt.chatting=!1,dt.ticketCreated=!1,dt.answered=!1,dt.peelingParent=!1,dt.status_offline=0,dt.status_online=1,dt.status_away=2,dt.initialize=function(t,e){this.convertCustomFields(t),t.widget_type&&(t.widget_type=parseInt(t.widget_type,10)),t.iid&&(t.iid=Number(t.iid)),t.queue_id&&(t.queue_id=Number(t.queue_id)),t.timedFallback&&(t.timedFallback=Number(t.timedFallback)),this.init(t,e)},dt.convertCustomFields=function(t){if(t.customFields&&Array.isArray(t.customFields))return void t.customFields.forEach(((e,i)=>{e instanceof ut||e.id&&(t.customFields[i]=new ut(e))}));const e=[];for(let i=1;i<=3;i++){const s=`user${i}`,n=t[s]||{};n.id=i;const r=new ut(n);e.push(r),delete t[s]}t.customFields=e},dt.getFormUrl=function(){return`${this.get("domain")}/form?queue_id=${this.get("queue_id")}&pquestion=${encodeURIComponent(this.get("client_question"))}`},dt.getFormLink=function(t){return`<a href="${this.getFormUrl()}" target="_blank">${t}</a>`},dt.getMissedChatMessage=function(){let t="";const e=this.get("missedchat_message");if(""!==e&&(t+=e),!this.get("followup_enabled"))return t;const i=this.get("missedchat_link");return""!==i&&(t+=`<br/><br/>${this.getFormLink(i)}`),t},dt.getErrorMessage=function(){let t=this.get("translation").ch_connect_error;if(this.get("followup_enabled"))return t;const e=this.get("error_link");return""!==e&&(t+=`<br/><br/>${this.getFormLink(e)}`),t},dt.getOfflineMessage=function(){let t="";const e=this.get("error_off");if(""!==e&&(t+=e),!this.get("followup_enabled"))return t;if(this.get("contact_request"))return t;const i=this.get("error_link");return""!==i&&(t+=`<br/><br/>${this.getFormLink(i)}`),t},dt.getAwayMessage=function(){let t="";const e=this.get("away_message");if(""!==e&&(t+=e),!this.get("followup_enabled"))return t;if(this.get("contact_request"))return t;const i=this.get("away_link");return""!==i&&(t+=`<br/><br/>${this.getFormLink(i)}`),t},dt.isButton=function(){return parseInt(this.get("widget_type"),10)===this.get("widget_types").button},dt.isFloat=function(){return parseInt(this.get("widget_type"),10)===this.get("widget_types").float},dt.isTab=function(){return parseInt(this.get("widget_type"),10)===this.get("widget_types").tab},dt.isEmbed=function(){return parseInt(this.get("widget_type"),10)===this.get("widget_types").embed},dt.offlineLinkTarget=function(){return this.get("peel")||this.isButton()?"_blank":"_parent"},dt.generateAnonName=function(){const t=Math.floor(99999999*Math.random());return this.get("guest_label")+t},dt.validateContact=function(t){if(this.get("contact_required")&&""===t)return!1;if(""===t)return!0;if(null===t.match(C)){if(null===t.replace(/[\-\(\)\s\.]/g,"").match(k))return!1}return!0},dt.getPeelUrl=function(t){return`/chat/widget/${this.get("hash")}?peelKey=${t}&referer=${this.get("referer")}`},dt.focusOnLoad=function(){return!(this.get("widget_type")===this.get("widget_types").embed)},dt.sanitizeMessage=function(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/(^|\s|&nbsp;)(https?:[^\s"\n]+?)([.,!]?(\s|\n|$|<|&nbsp;))/g,'$1<a href="$2" target="_blank">$2</a>$3')},dt.getGreeting=function(t){return t?this.get("greetingLocal"):this.get("greetingCoop")},dt.isAuthValidOrNotSet=function(){return!!(this.get("auth_id")<=0||this.get("isAuthValidated"))},dt.isOnline=function(){const t=this.get("online_rule");return!1!==t&&t instanceof ct&&t.isOnline};const pt=class{constructor(){this.events={},this.debug=!1}listenerIndex(t,e){return this.events[t].findIndex((t=>t.listener===e))}on(t,e,i){if("function"==typeof e){if(void 0===i&&(i=null),this.events[t]=this.events[t]||[],this.events[t].length>0){const i=this.listenerIndex(t,e);i>-1&&this.events[t].splice(i,1)}this.events[t].push({listener:e,boundObj:i})}}off(t,e){if(Array.isArray(this.events[t])){const i=this.listenerIndex(t,e);if(-1===i)return;this.events[t].splice(i,1),0===this.events[t].length&&delete this.events[t]}}trigger(t){this.debug&&console&&console.log(`sui.eventemitter triggered: ${t}`);const e=[].slice.call(arguments,1);Array.isArray(this.events[t])&&this.events[t].forEach((t=>{const i=null===t.boundObj?this:t.boundObj;t.listener.apply(i,e)}))}};var mt=i(446);const ft=class{constructor({sessionId:t="",opId:e=0,role:i="system",room:s="",ts:n="",msg:r="",msgId:o=0,ended:a=!1}){this.sessionId=t,this.opId=Number(e),this.role=i,this.room=s,this.ts=n,this.msg=r,this.msgId=Number(o),""===this.ts&&(this.ts=(new Date).toISOString()),this.ended=a}},gt=function(t){return{u:t.u,d:t.d,c:t.c,fallbackSeconds:t.fallbackSeconds||0}},bt=function(t){const e=[],i=new Date,s=i.getUTCDay(),n=i.getUTCHours(),r=i.getUTCMinutes();return t.forEach((t=>{if(!t.c||1===t.coverageType)return void e.push(gt(t));if(0===t.coverageType)return;const i=t.coverageHours;if(!i||!i[s]||0===i[s].length)return;const o=i[s];L(n,r,o)&&e.push(gt(t))})),e};const yt=class{constructor({name:t="",actionId:e=0,actionType:i=0,ts:s="",msgId:n=0,msg:r="",responses:o=[],profile_url:a="",profile_color:h="",isError:l=!1}){this.role="bot",this.name=t,this.actionId=Number(e),this.actionType=Number(i),this.msgId=Number(n),this.msg=r,this.responses=o,this.profile_url=a,this.profile_color=h,this.isError=!!l,this.ts=s,""===this.ts&&(this.ts=(new Date).toISOString())}},_t=Object.freeze({generic:0,noResults:2,botBlockedError:3});class vt{constructor({code:t=_t.generic,message:e="",actionId:i=0,end_chat:s=!1}){this.code=t,this.message=e,this.actionId=Number(i),this.end_chat=!!s}getMessage(){return new yt({actionId:this.actionId,msg:this.message})}}class wt{#l=!1;constructor(t,e,i,s,n,r){this.botService=t,this.templateEng=e,this.flow=i,this.emitter=s,this.patronSession=n,this.widget=r,this.isStarted=!1,this.isSkipped=!1,this.messagePause=1e3*this.flow.message_delay,this.botTimeoutId=null}isBotEnabled(){return!this.isSkipped&&""!==this.flow.uuid}isBotActiveOffline(){return this.isBotEnabled()&&this.flow.isAvailableOffline()}isBotActiveOnline(){return!!this.isBotEnabled()&&this.flow.isAvailableOnline(this.widget.get("online_rule"))}_timeoutBot(){this.emitter.trigger("bot:reset")}_clearBotTimeout(){null!==this.botTimeoutId&&(clearTimeout(this.botTimeoutId),this.botTimeoutId=null)}_resetBotTimeout(){this._clearBotTimeout(),this.botTimeoutId=setTimeout(this._timeoutBot.bind(this),60*this.flow.timeout*1e3)}async _generateMessagesFromAction(e,{text:i=""}){if(!e)return[];const s=[];let n="";if(e.isSearchAction()&&e.stage!==u.PROMPT){try{e.stage=u.RESULT,n=await this.botService.searchAction(e,this.patronSession.getChannel(),i)}catch(t){e.stage=u.FAIL,t.code!==_t.noResults&&(n=t.message)}if(Number(e?.parentSearchActionId||0)>0){const t=`${i} [Chained Search]`;this.botService.saveSessionAction(this.patronSession.getChannel(),e,{response:t})}}if(e.type===t.ACTION_FAQ&&e.subType===d.FAQ_SINGLE&&(n=await this.botService.getFAQ(e.subTypeId)),e.type===t.ACTION_FAQ&&e.subType===d.FAQ_RESULTS)try{n=await this.botService.searchAction(e,this.patronSession.getChannel(),e.prompt)}catch(t){n=t.code===_t.noResults?e.fail_message:t.message}if(e.type===t.ACTION_LIBGUIDES&&(e.subType===p.GUIDE_SINGLE?n=await this.botService.getGuide(e.subTypeId,e.siteId,this.patronSession.getChannel()):e.subType===p.AZ_SINGLE&&(n=await this.botService.getDatabase(e.subTypeId,e.siteId,this.patronSession.getChannel()))),e.type===t.ACTION_LIBCAL&&e.subType===m.BOOKING_APPT&&e.botAppt){if(e.stage===f.DATE_PROMPT||e.stage===f.TIME_PROMPT)try{n=await this.botService.getBookingAvailability(e,this.patronSession.getChannel(),this.widget.get("language"))}catch(t){e.stage=f.FAIL,n=t.message||this.flow.error_generic}if(e.stage===f.GROUP_PROMPT&&!e.isLocationInfoSet())try{await this.botService.getBookingLocationInfo(e,this.patronSession.getChannel())}catch(t){e.stage=f.FAIL,n=t.message||this.flow.error_generic}}e.type!==t.ACTION_LIBCAL||e.subType===m.EVENT_SEARCH||e.botAppt||(n=e.isHours()?await this.botService.getLCHours(e,this.patronSession.getChannel()):await this.botService.getLocation(e,this.patronSession.getChannel())),e.type===t.ACTION_LIBWIZARD&&(n=await this.botService.getLibWizardItem(e,this.patronSession.getChannel()));const r=e.getMessages(n),o=this.flow.getAction(e.defaultNextAction);return r.forEach(((t,i)=>{const n=i+1,a=new yt({actionId:e.id,actionType:e.type,msg:t,responses:r.length===n?e.getResponses({}):[]});[u.RESULT,u.FAIL].includes(e.stage)&&e.isNextSearchChained()&&o?.isSearchAction()&&r.length===n||s.push(a)})),s}_handleEndAction(){const t=new yt({msg:this.flow.message_end});this._sendMessagesToWidget([t]),0===this.patronSession.ticketId&&""!==this.patronSession.getChannel()&&this.botService.saveEndSession(this.patronSession.getChannel()).catch((()=>{})),this._clearBotTimeout(),this.emitter.trigger("bot:end",{})}_handleTicketForm(t){this.botService.getQuestionForm(this.patronSession.getChannel(),t).then((({html:e,errormsg:i,translations:s,isAuthed:n,autoReplySettings:r,url:o,rules:a})=>{if(n&&0===this.widget.get("auth_id")){const e=new yt({actionId:t.id,actionType:t.type,msg:`${this.widget.get("translation").ch_botticket_form}<br/><a href="${o}">${o}</a>`});return this._sendMessagesToWidget([e]),void setTimeout((()=>{this._handleNextAction(t,{id:1})}),this.messagePause)}this.emitter.trigger("bot:ticket:form",{html:e,errormsg:i,translations:s,autoReplySettings:r,action:t,rules:a})})).catch((e=>{this._sendErrorToWidget({actionId:t.id,message:e.message}),this._handleNextAction(t,{})}))}#c(t){const e=new yt({actionId:t.id,actionType:t.type,msg:t.getMessages().find(Boolean)||"",responses:t.getResponses()});e.survey_uuid=t.subTypeId,e.rate_1=t.prompt,e.rate_4=t.prompt2,this._sendMessagesToWidget([e])}#u(t){this.botService.getBookingForm(t,this.patronSession.getChannel(),this.widget.get("language")).then((({html:e=""})=>{this.emitter.trigger("bot:booking:form",{html:e,action:t})})).catch((e=>{this._sendErrorToWidget({actionId:t.id,message:e.message}),this._handleNextAction(t,{})}))}_sendMessagesToWidget(t,e=!1){t.forEach(((t,i)=>{t.name=this.flow.getName(),t.profile_url=this.flow.profile_url,t.profile_color=this.flow.profile_color,t.msgId=i+1,0!==i?setTimeout((()=>{this.emitter.trigger("bot:action",{botMessage:t,endChat:e})}),this.messagePause*i):this.emitter.trigger("bot:action",{botMessage:t,endChat:e})}))}_sendErrorToWidget({actionId:t=0,message:e="",endChat:i=!1}){e||(e=this.flow.error_generic);const s=new yt({actionId:t,msg:e,isError:!0});this._sendMessagesToWidget([s],i)}_handleNoResponseActions(e,i=1,s=""){e.type!==t.ACTION_CHAT?setTimeout((()=>{e.isNextSearchChained()?e.stage=u.CHAINED:s="",this._handleNextAction(e,{id:0,text:s})}),this.messagePause*i):setTimeout((()=>{const t=e.getStatusRule();this.emitter.trigger("bot:sendtochat",{rule:t,actionId:e.id})}),this.messagePause*i)}_checkForExistingResponse(e){if(-1===[t.ACTION_REQUEST_INFO,t.ACTION_QUESTION,t.ACTION_TICKET].indexOf(e.type))return null;if(e.type===t.ACTION_REQUEST_INFO){let t="";switch(e.stage){case l.NAME:t=this.patronSession.get("name");break;case l.EMAIL:t=this.patronSession.get("client_contact");break;case l.ID:t=this.patronSession.get("local_id")}return t?{text:t}:null}if(e.type===t.ACTION_QUESTION){if(!e.saveAnswer)return null;const t=this.patronSession.getAnswerByQuestionId(e.subType);return t?{id:t.responseId,text:t.text}:null}return e.type===t.ACTION_TICKET?this.patronSession.ticketId>0?{}:e.useForm||e.stage!==g.CONTACT||""===this.patronSession.get("client_contact")?null:{text:this.patronSession.get("client_contact")}:null}_handleFlowTransfer(t,e){this.botService.getFlowTransfer(this.patronSession.getChannel(),e).then((t=>{const e=new ht(t);e.transferFlow(this.flow),this.flow=e,this.botService.flow=this.flow;const i=this.flow.getWelcomeAction();this._handleNextAction(i,{id:1})})).catch((e=>{this._sendErrorToWidget({actionId:t.id,message:e.message}),this._handleNextAction(t,{})}))}_handleParamsCheck(t){const e={id:0,text:""};t.subType===w.PARAM_CHAT_STATUS&&(e.id=this.#l?A.PARAM_CHAT_STATUS_ONLINE:A.PARAM_CHAT_STATUS_OFFLINE),t.subType!==w.PARAM_OPEN_HOURS?t.subType!==w.PARAM_LC_HOURS?this._handleNextAction(t,e):this.botService.checkLCHours(t,this.patronSession.getChannel()).then(((i=A.PARAM_HOURS_CLOSED)=>{e.id=i,this._handleNextAction(t,e)})).catch((()=>{this._handleNextAction(t,{})})):this.botService.checkOpenHours(t).then(((i=A.PARAM_HOURS_CLOSED)=>{e.id=i,this._handleNextAction(t,e)})).catch((()=>{this._handleNextAction(t,{})}))}_processNextAction(e,{text:i=""},s=new G({})){if(s.passAlong)return void this._handleFreeText({actionId:s.nextActionId,text:s.text});if(e.type===t.ACTION_PARAMS)return void this._handleParamsCheck(e);const n=this._checkForExistingResponse(e);if(!n)return e.type===t.ACTION_RATING?document.getElementById("s-lch-rate-form")?void this._handleNextAction(e,{}):void this.#c(e):void(e.type===t.ACTION_TICKET&&e.useForm&&e.stage===g.FORM?this._handleTicketForm(e):e.type===t.ACTION_LIBCAL&&e.botAppt&&e.stage===f.FORM?this.#u(e):(e.isSearchAction()&&s.chainNextSearch&&(i=s.text,e.stage=u.RESULT),e.type===t.ACTION_TICKET&&(e.prompt2=this.flow.provide_email),this._generateMessagesFromAction(e,{text:i}).then((t=>{const s=t.filter((t=>t.responses?.length>0));this._sendMessagesToWidget(t),0===s.length&&this._handleNoResponseActions(e,t.length,i)})).catch((()=>{this._sendErrorToWidget({actionId:e.id}),this._handleNextAction(e,{})}))));this._handleNextAction(e,n)}_handleNextAction(t,{id:i=0,text:s=""}){const n=t.getResultForResponse({id:i,text:s});if(n.nextActionId===e.ACTION_SKIP)return this.isSkipped=!0,void this.emitter.trigger("bot:skipbot");if(""!==n.message){const e=new yt({actionId:t.id,actionType:t.type,msg:n.message});this._sendMessagesToWidget([e])}if(n.nextActionId===e.ACTION_END)return void this._handleEndAction();if(n.nextActionId===e.ACTION_TRANSFER)return void this._handleFlowTransfer(t,n.flow_uuid);const r=this.flow.getAction(n.nextActionId);r?(n.chainNextSearch&&r.isSearchAction()&&r.id!==t.id&&t?.parentSearchActionId!==r.id&&(r.parentSearchActionId=t.parentSearchActionId>0?t.parentSearchActionId:t.id),this._processNextAction(r,{text:s},n)):this._sendErrorToWidget({actionId:n.nextActionId,endChat:!0})}_handleActionTrigger({actionId:t=0}){const e=this.flow.getAction(t);e?this._processNextAction(e,{}):this._sendErrorToWidget({actionId:t,endChat:!0,message:this.flow.error_generic})}async _storeRequestResponse(t,e){switch(t.stage){case l.NAME:this.patronSession.set("name",e);break;case l.EMAIL:this.patronSession.set("client_contact",e);break;case l.ID:this.patronSession.set("local_id",e)}await this.botService.saveContactInfo(t,this.patronSession.getChannel(),e)}async _saveTicketContactInfo(t,e){t.stage===g.CONTACT&&(this.patronSession.set("client_contact",e),await this.botService.saveContactInfo(t,this.patronSession.getChannel(),e))}async _storeQuestionAnswer(t,{text:e="",id:i=0}){if(!t.saveAnswer)return void this.botService.saveSessionAction(this.patronSession.getChannel(),t,{response:e,response_id:i});const s=t.getQuestion();if(!s)return;const n=new O({questionId:t.subType,question:s.question,text:""===e?s.getLabelByResponseId(i):e,responseId:i});this.patronSession.addAnswer(n),await this.botService.saveQuestionAnswer(t,this.patronSession.getChannel(),{id:i,text:e})}async _storeResponseData(e,{text:i="",id:s=0}){switch(e.type){case t.ACTION_REQUEST_INFO:await this._storeRequestResponse(e,i);break;case t.ACTION_QUESTION:await this._storeQuestionAnswer(e,{text:i,id:s});break;case t.ACTION_TICKET:await this._saveTicketContactInfo(e,i)}if(e.isSearchAction()){let t=0;s===y.RESOLVED?t=S.ACTION_RESPONSE_RESOLVED:s===y.UNRESOLVED&&(t=S.ACTION_RESPONSE_UNRESOLVED),this.botService.saveSessionAction(this.patronSession.getChannel(),e,{response_id:t,response:i})}if(e.isResourceAction()&&s>0){if(e.botAppt&&e.stage!==f.FORM)return;const t=s===b.NO?S.ACTION_RESPONSE_HELP_NO:S.ACTION_RESPONSE_HELP_YES;this.botService.saveSessionAction(this.patronSession.getChannel(),e,{response_id:t})}}_handleWelcomeResponse(t,i){const s=t.getResultForResponse({id:i});if(s.nextActionId>0)this.emitter.trigger("bot:startsession",{nextActionId:s.nextActionId,flowUuid:this.flow.uuid});else{if(s.nextActionId===e.ACTION_SKIP)return this.isSkipped=!0,void this.emitter.trigger("bot:skipbot");this.botService.saveDismissal(this.widget.get("id")).catch((()=>{})),this._handleEndAction()}}_handleResponse({actionId:e,responseId:i}){this._resetBotTimeout();const s=this.flow.getAction(e);s?s.type!==t.ACTION_WELCOME?this._storeResponseData(s,{id:i}).then((()=>{this._handleNextAction(s,{id:i})})).catch((t=>{let e=!1;t.code===_t.botBlockedError&&(e=!0),this._sendErrorToWidget({actionId:s.id,message:t.message,endChat:e}),e||this._handleNextAction(s,{id:i})})):this._handleWelcomeResponse(s,i):this._sendErrorToWidget({actionId:e,endChat:!0,message:this.flow.error_generic})}#d({actionId:t=0,page:e=0}){this._resetBotTimeout();const i=this.flow.getAction(t);if(!i)return void this._sendErrorToWidget({actionId:t,endChat:!0,message:this.flow.error_generic});const s=i.getResponses({page:e});this.emitter.trigger("bot:action:page",{actionId:t,actionType:i.type,responses:s})}#p({actionId:t=0}){this._resetBotTimeout();const e=this.flow.getAction(t);e&&e.goToPreviousStage()?this._processNextAction(e,{}):this._sendErrorToWidget({actionId:t,endChat:!0,message:this.flow.error_generic})}_handleFreeText({actionId:e,text:i=""}){this._resetBotTimeout();const s=this.flow.getAction(e);if(s){if(!s.validateResponse(i)){let i=this.flow.error_input;return s.type===t.ACTION_REQUEST_INFO&&s.stage===l.EMAIL&&(i=this.widget.get("translation").ch_validate_email||this.flow.error_input),void this._sendErrorToWidget({actionId:e,message:i})}s.type!==t.ACTION_TICKET||s.stage!==g.QUESTION?this._storeResponseData(s,{text:i}).then((()=>{this._handleNextAction(s,{text:i})})).catch((t=>{let e=!1;t.code===_t.botBlockedError&&(e=!0),this._sendErrorToWidget({actionId:s.id,message:t.message,endChat:e}),e||this._handleNextAction(s,{text:i})})):this.botService.submitTicket(s,this.patronSession.getChannel(),i).then((({ticket_id:t})=>{this.patronSession.ticketId=t;const e=new yt({actionId:s.id,actionType:s.type,msg:s.success_message});this._sendMessagesToWidget([e])})).catch((t=>{this._sendErrorToWidget({actionId:s.id,message:t.message})})).finally((()=>{setTimeout((()=>{this._handleNextAction(s,{id:this.patronSession.ticketId})}),this.messagePause)}))}else this._sendErrorToWidget({actionId:e,endChat:!0,message:this.flow.error_generic})}_handleClickSave({actionId:t=0,url:e=""}){if(t<=0||""===e)return;const i=this.flow.getAction(t);i&&this.botService.saveSessionAction(this.patronSession.getChannel(),i,{response_id:1,response:e})}_handleChatOffline({actionId:t=0,fallbackAttempt:e=!1}){if(e)return void this._handleChatFail({actionId:t});const i=this.flow.getAction(t);i?i.useFallback?this.emitter.trigger("bot:sendtochat",{actionId:i.id,fallbackAttempt:!0}):this._handleChatFail({actionId:t}):this._sendErrorToWidget({actionId:t,endChat:!0})}_handleChatFail({actionId:t=0}){const e=this.flow.getAction(t);if(!e||!e.fail_message)return void this._sendErrorToWidget({actionId:t,endChat:!0});const i=new yt({actionId:t,msg:e.fail_message});this._sendMessagesToWidget([i]),this._handleNextAction(e,{})}_handleSessionLoad({actionId:t,flow:e}){this.flow.setActions(e.actions||[]),this.flow.setQuestions(e.questions||[]),this._handleActionTrigger({actionId:t})}startBot(t=!1){if(this.isStarted)return;this.#l=t,this.isStarted=!0,this.emitter.trigger("bot:start"),this.emitter.on("bot:response",this._handleResponse.bind(this)),this.emitter.on("bot:response:page",this.#d.bind(this)),this.emitter.on("bot:response:back",this.#p.bind(this)),this.emitter.on("bot:freetext",this._handleFreeText.bind(this)),this.emitter.on("bot:loadactions",this._handleSessionLoad.bind(this)),this.emitter.on("bot:ticket:success",(({action:t,ticket_id:e=0})=>{this.patronSession.ticketId=e;const i=new yt({actionId:t.id,actionType:t.type,msg:t.success_message});this._sendMessagesToWidget([i]),this._handleNextAction(t,{id:e})})),this.emitter.on("bot:ticket:cancel",(({action:t})=>{this._handleNextAction(t,{})})),this.emitter.on("bot:booking:success",(({action:t})=>{this.botService.saveSessionAction(this.patronSession.getChannel(),t,{response:t.getLocationAndUserName()}),this._generateMessagesFromAction(t,{}).then((t=>{this._sendMessagesToWidget(t)})).catch((()=>{this._sendErrorToWidget({actionId:t.id}),this._handleNextAction(t,{})}))})),this.emitter.on("bot:booking:cancel",(({action:t})=>{this._handleNextAction(t,{})})),this.emitter.on("bot:triggeraction",this._handleActionTrigger.bind(this)),this.emitter.on("bot:chatoffline",this._handleChatOffline.bind(this)),this.emitter.on("bot:chatfail",this._handleChatFail.bind(this)),this.emitter.on("bot:click",this._handleClickSave.bind(this)),this.emitter.on("bot:message",this._sendMessagesToWidget.bind(this));const e=this.flow.getWelcomeAction();this.#l&&e.setChatOnline(),this._generateMessagesFromAction(e,{}).then((t=>{this._sendMessagesToWidget(t)})).catch((()=>{this._sendErrorToWidget({actionId:e.id,endChat:!0})}))}stopBot(){this.isStarted=!1,this._clearBotTimeout(),this.emitter.trigger("bot:stop")}}const At=function(t){let e="";if(!t.responseText)return e;try{const i=JSON.parse(t.responseText);i.error&&(e=i.error)}catch(t){}return e};class St{constructor(t,e){this.templateEng=t,this.flow=e}_getPathPrefix(t=""){return`/chat/session/${t}`}getFAQ(t){return new Promise(((e,i)=>{window.$.ajax({method:"GET",url:`/chat/faq/${t}`,data:{instid:this.flow.iid}}).done((t=>{const i=this.templateEng.render("item_faq.njk",{faq:t});e(i)})).fail((()=>{i(this.flow.error_generic)}))}))}#m(t,e){return new Promise(((i,s)=>{window.$.ajax({method:"GET",url:"/chat/faq/search",data:{iid:this.flow.iid,group_ids:`[${t}]`,q:e}}).done((t=>{t.results&&0!==t.results.length?i({faqs:t.results,searchUrl:t.fullSearchUrl}):s(new vt({code:_t.noResults,message:"No results found"}))})).fail((()=>{s(new vt({message:this.flow.error_generic}))}))}))}getGuide(t,e,i){return new Promise(((s,n)=>{window.$.ajax({method:"GET",url:`${this._getPathPrefix(i)}/libguides/guide/list`,data:{guide_ids:[t],site_id:e,iid:this.flow.iid}}).done((t=>{if(Array.isArray(t)&&t.length>0){const e=this.templateEng.render("item_guide.njk",{item:t.shift()});s(e)}else n("No guides found.")})).fail((()=>{n(this.flow.error_generic)}))}))}#f(t,e,i){return new Promise(((s,n)=>{window.$.ajax({method:"GET",url:`${this._getPathPrefix(e)}/libguides/guide/search`,data:{iid:this.flow.iid,site_id:t,term:i,limit:15}}).done((t=>{Array.isArray(t)&&0!==t.length?s(t):n(new vt({code:_t.noResults,message:"No results found"}))})).fail((()=>{n(new vt({message:this.flow.error_generic}))}))}))}getDatabase(t,e,i){return new Promise(((s,n)=>{window.$.ajax({method:"GET",url:`${this._getPathPrefix(i)}/libguides/database/list`,data:{asset_ids:[t],site_id:e,iid:this.flow.iid}}).done((t=>{if(Array.isArray(t)&&t.length>0){const e=this.templateEng.render("item_guide.njk",{item:t.shift()});s(e)}else n("No databases found.")})).fail((()=>{n(this.flow.error_generic)}))}))}#g(t,e,i){return new Promise(((s,n)=>{window.$.ajax({method:"GET",url:`${this._getPathPrefix(e)}/libguides/database/search`,data:{iid:this.flow.iid,site_id:t,term:i,limit:5}}).done((t=>{Array.isArray(t)&&0!==t.length?s(t):n(new vt({code:_t.noResults,message:"No results found"}))})).fail((()=>{n(new vt({message:this.flow.error_generic}))}))}))}getLocation(t,e){return new Promise(((i,s)=>{window.$.ajax({method:"GET",url:`${this._getPathPrefix(e)}/libcal/locations`,data:{type:t.subType,location_ids:[t.subTypeId],site_id:t.siteId,iid:this.flow.iid}}).done((t=>{if(Array.isArray(t)&&t.length>0){const e=this.templateEng.render("item_guide.njk",{item:t.shift()});i(e)}else s("No locations found.")})).fail((()=>{s(this.flow.error_generic)}))}))}#b(t,e,i){return new Promise(((s,n)=>{window.$.ajax({method:"GET",url:`${this._getPathPrefix(e)}/libcal/events/search`,data:{iid:this.flow.iid,site_id:t.siteId,term:i,calendar_id:t.subTypeId,search_filter:JSON.stringify(t.searchFilter)}}).done((t=>{Array.isArray(t)&&0!==t.length?s(t):n(new vt({code:_t.noResults,message:"No results found"}))})).fail((()=>{n(new vt({message:this.flow.error_generic}))}))}))}getLCHours(t,e){let i="day";return t.subType===m.HOURS_WEEK&&(i="range"),new Promise(((s,n)=>{window.$.ajax({method:"GET",url:`${this._getPathPrefix(e)}/libcal/hours/library/${i}`,data:{type:t.subType,location_id:t.subTypeId,site_id:t.siteId,iid:this.flow.iid}}).done((({days:t=[],timezone:e="UTC"})=>{if(Array.isArray(t)&&t.length>0){const i=[],n=navigator.language||"en-US",r=new Intl.DateTimeFormat(n,{dateStyle:"short",timeZone:e}),o=new Intl.DateTimeFormat(n,{timeStyle:"short",timeZone:e});return t.forEach((({date:t="",hours:e=[],label:s=""})=>{let n=`${r.format(new Date(t))}: `;e.length>0?n+=`${e.map((({to:t,from:e})=>`${o.format(new Date(e))} - ${o.format(new Date(t))}`)).join("; ")}`:n+=s,i.push(n)})),void s(i.join("<br/>"))}n("No hours found.")})).fail((()=>{n(this.flow.error_generic)}))}))}getBookingLocationInfo(t,e,i){if(!t.apptParams)throw new Error;return new Promise(((s,n)=>{window.$.ajax({method:"GET",url:`${this._getPathPrefix(e)}/libcal/booking/location`,data:{type:t.subType,location_id:t.subTypeId,site_id:t.siteId,iid:this.flow.iid,group_id:t.apptParams?.groupId,category_id:t.apptParams?.categoryId,language:i}}).done((e=>{if(!e||"object"!=typeof e)return void n("No location info found.");const i=new $(e);t.setLocationInfo(i),s(!0)})).fail((()=>{n(this.flow.error_generic)}))}))}getBookingAvailability(t,e,i){const s=t.getBookingInfo();return new Promise(((n,r)=>{window.$.ajax({method:"GET",url:`${this._getPathPrefix(e)}/libcal/booking/availability`,data:{location_id:s.locationId,site_id:s.siteId,iid:this.flow.iid,group_id:s.groupId,category_id:s.categoryId,user_id:s.userId,date:s.date,language:i}}).done((({availability:e=null,message:i=""})=>{if(!e||"object"!=typeof e)return void r("No availability found.");const o=new j(e);return""!==s.date&&0===o.times.length||""===s.date&&0===o.dates.length?(t.stage=t.getPreviousBookingStage(),void n(i)):(t.setBookingAvailability(o),void n(""))})).fail((()=>{r(this.flow.error_generic)}))}))}getBookingForm(t,e,i){const s=t.getBookingInfo();return new Promise(((t,n)=>{window.$.ajax({method:"GET",url:`${this._getPathPrefix(e)}/libcal/booking/form`,data:{location_id:s.locationId,site_id:s.siteId,iid:this.flow.iid,group_id:s.groupId,category_id:s.categoryId,user_id:s.userId,start_time:s.getStartTime(),crc:s.getCrc(),language:i}}).done((({html:e=""})=>{""!==e?t({html:e}):n("No form found.")})).fail((()=>{n(this.flow.error_generic)}))}))}getLibWizardItem(t,e){return new Promise(((i,s)=>{window.$.ajax({method:"GET",url:`${this._getPathPrefix(e)}/libwizard/forms`,data:{type:t.subType,item_id:t.subTypeId,site_id:t.siteId,iid:this.flow.iid}}).done((t=>{if(t.url&&""!==t.url){const e=this.templateEng.render("item_guide.njk",{item:t});i(e)}else s("No form found.")})).fail((()=>{s(this.flow.error_generic)}))}))}async searchAction(e,i,s){if(e.type===t.ACTION_FAQ){const{faqs:t,searchUrl:i}=await this.#m(e.subTypeId,s);return this.templateEng.render("list_faqs.njk",{faqs:t,searchUrl:i})}if(e.type===t.ACTION_LIBGUIDES){let t=[];return e.subType===p.GUIDE_SEARCH?t=await this.#f(e.siteId,i,s):e.subType===p.AZ_SEARCH&&(t=await this.#g(e.siteId,i,s)),this.templateEng.render("list_guides.njk",{items:t})}if(e.type===t.ACTION_LIBCAL){const t=await this.#b(e,i,s);return this.templateEng.render("list_guides.njk",{items:t})}throw new vt({message:this.flow.error_generic})}submitTicket(t,e,i){return new Promise(((s,n)=>{window.$.ajax({method:"POST",url:`/chat/bot/session/${e}/ticket`,data:{iid:this.flow.iid,question:i,queue_id:t.subType}}).done((({ticket_id:t=0})=>{t>0?s({ticket_id:t}):n(this.flow.error_generic)})).fail((()=>{n(this.flow.error_generic)}))}))}saveQuestionAnswer(t,e,{id:i=0,text:s=""}){return new Promise(((n,r)=>{window.$.ajax({method:"POST",url:`/chat/bot/session/${e}/question/${t.subType}`,data:{iid:this.flow.iid,response_id:i,text:s}}).done((()=>{n()})).fail((()=>{r(new vt({actionId:t.id,message:this.flow.error_generic}))}))}))}saveContactInfo(e,i,s){let n=0;if(e.type===t.ACTION_REQUEST_INFO)switch(e.stage){case l.NAME:n=h.INFO_NAME;break;case l.EMAIL:n=h.INFO_EMAIL;break;case l.ID:n=h.INFO_ID}else{if(e.type!==t.ACTION_TICKET)throw new Error("Invalid action type");n=h.INFO_EMAIL}return new Promise(((t,r)=>{window.$.ajax({method:"POST",url:`/chat/bot/session/${i}/contact`,data:{iid:this.flow.iid,type:n,text:s}}).done((()=>{t()})).fail((t=>{const i=At(t)||this.flow.error_generic;let s=_t.generic,n=!1;t&&403===t.status&&(s=_t.botBlockedError,n=!0),r(new vt({code:s,message:i,actionId:e.id,end_chat:n}))}))}))}saveEndSession(t){return new Promise(((e,i)=>{window.$.ajax({method:"POST",url:`/chat/bot/session/${t}/end`,data:{iid:this.flow.iid}}).done((()=>{e()})).fail((()=>{i("Failed")}))}))}saveSessionAction(t,e,{response:i="",response_id:s=0}){window.$.ajax({method:"POST",url:`/chat/bot/session/${t}/action`,data:{iid:this.flow.iid,type:e.type,sub_type:e.subType,object_id:s,response:i,time:Date.now()}}).done((()=>{})).fail((t=>{const e=At(t);console.error(e)}))}getQuestionForm(t,e){return new Promise(((i,s)=>{window.$.ajax({method:"GET",url:`${this._getPathPrefix(t)}/qform`,data:{iid:this.flow.iid,queue_id:e.subType}}).done((({html:t="",errormsg:e=[],translations:s=[],isAuthed:n=!1,autoReplySettings:r={},url:o="",rules:a=[]})=>{i({html:t,errormsg:e,translations:s,isAuthed:n,autoReplySettings:r,url:o,rules:a})})).fail((()=>{s(new vt({message:this.flow.error_generic}))}))}))}getFlowTransfer(t,e){return new Promise(((i,s)=>{window.$.ajax({method:"POST",url:`${this._getPathPrefix(t)}/bottransfer`,data:{iid:this.flow.iid,flow_uuid:e}}).done((({flow:t=null})=>{i(t)})).fail((t=>{const e=At(t)||this.flow.error_generic;s(new vt({code:_t.generic,message:e}))}))}))}saveDismissal(t){return new Promise(((e,i)=>{window.$.ajax({method:"POST",url:`/chat/bot/widget/${t}/dismiss`,data:{iid:this.flow.iid}}).done((()=>{e()})).fail((()=>{i("Failed")}))}))}checkOpenHours(e){if(e.type!==t.ACTION_PARAMS||e.subType!==w.PARAM_OPEN_HOURS)throw new Error("Invalid action.");return new Promise((t=>{const i=e.customHoursObj,s=new Date,n=s.getUTCDay(),r=s.getUTCHours(),o=s.getUTCMinutes(),a=i[n]||[];L(r,o,a)?t(A.PARAM_HOURS_OPEN):t(A.PARAM_HOURS_CLOSED)}))}checkLCHours(e,i){if(e.type!==t.ACTION_PARAMS||e.subType!==w.PARAM_LC_HOURS)throw new Error("Invalid action.");return new Promise((t=>{window.$.ajax({method:"GET",url:`${this._getPathPrefix(i)}/libcal/hours/open`,data:{location_id:e.subTypeId,site_id:e.siteId,iid:this.flow.iid}}).done((({open:e=!1})=>{t(e?A.PARAM_HOURS_OPEN:A.PARAM_HOURS_CLOSED)})).fail((()=>{t(A.PARAM_HOURS_CLOSED)}))}))}}const Et=new class{constructor(){this.supported=!1,this._isSupported()}get(t){let e=null;return this.supported&&(e=window.localStorage.getItem(t)),null!==e?e:""}set(t,e){if(this.supported){try{window.localStorage.setItem(t,e)}catch(t){return!1}return!0}return!0}remove(t){this.supported&&window.localStorage.removeItem(t)}iterate(t){if(this.supported&&window.localStorage.length>0){const e=[];for(let t=0;t<window.localStorage.length;t++)e.push(window.localStorage.key(t));if(e.length>0)for(let i=0;i<e.length;i++)t.call(this,e[i])}}_isSupported(){try{if(!("localStorage"in window)||null===window.localStorage)return;this.supported=!0}catch(t){return}}},Tt=Object.create(lt);Tt.defaults={sessionId:"",name:"",fullname:"",role:"op",opId:0,consortium:[],coopIds:[],siteName:"",iid:0,isAway:!1,profile_image:{path:"",color:""},deptsMonitored:[],deptsInternal:[],ip:"",joined:"",isConnected:!1,currentUserChats:[],region:"",unitId:0,unitName:""},Tt.isShared=!1,Tt.awayTimeout=null,Tt.initialize=function(t,e){t.fullname&&""!==t.fullname||(t.fullname=t.name||""),this.init(t,e)},Tt.getRoom=function(){return`internal-${this.get("sessionId")}`},Tt.getStatusText=function(){const t=this.get("isConnected"),e=this.get("isAway");return t?e?"away":0===this.get("deptsMonitored").length&&0===this.get("coopIds").length?"internal":"online":"offline"},Tt.addDept=function(t){this.get("deptsMonitored").includes(t)||this.get("deptsMonitored").push(t)},Tt.removeDept=function(t){const e=this.get("deptsMonitored").indexOf(t);-1!==e&&this.get("deptsMonitored").splice(e,1)},Tt.isMonitoringDept=function(t){return-1!==this.get("deptsMonitored").indexOf(t)},Tt.addCoop=function(t){this.get("coopIds").includes(t)||this.get("coopIds").push(t)},Tt.removeCoop=function(t){const e=this.get("coopIds").indexOf(t);-1!==e&&this.get("coopIds").splice(e,1)},Tt.isMonitoringCoop=function(t){return-1!==this.get("coopIds").indexOf(t)},Tt.addUser=function(t){const e=this.get("currentUserChats");-1===e.indexOf(t)&&e.push(t)},Tt.removeUser=function(t){const e=this.get("currentUserChats"),i=e.indexOf(t);-1!==i&&e.splice(i,1)},Tt.updateFromServer=function(t){const e={};t.sessionId&&(e.sessionId=t.sessionId),t.deptsMonitored&&(e.deptsMonitored=t.deptsMonitored),t.coopIds&&(e.coopIds=t.coopIds),void 0!==t.isAway&&(e.isAway=t.isAway),void 0!==t.isConnected&&(e.isConnected=t.isConnected),t.joined&&(e.joined=t.joined),t.profile_image&&(e.profile_image=t.profile_image),this.set(e)},Tt.setPendingTimeout=function(t){window.clearTimeout(this.awayTimeout),this.awayTimeout=window.setTimeout(t,6e4)},Tt.clearPendingTimeout=function(){window.clearTimeout(this.awayTimeout)},Tt.toJSON=function(){const t=lt.toJSON.call(this);return t.status=this.getStatusText(),t};const It=Tt;const Ot=new class{#y=null;#_="s-ui-notifyarea";#v="s-ui-notify";#w="s-ui-notify";#A={msg:'<i class="fa fa-spinner fa-pulse mg-right" aria-hidden="true"></i> <span>Working...</span>',className:"s-ui-notify-working"};#S={msg:"Success.",className:"s-ui-notify-success"};#E={msg:"Error: Please try again.",className:"s-ui-notify-error"};#T=0;#I=null;constructor({parent_id:t=null}){t&&(this.#_=t)}#O(){let t=document.getElementById(this.#_);return t||(t=document.createElement("DIV"),t.id=this.#_,t.setAttribute("role","alert"),document.body.appendChild(t)),t}#C(){return this.#y||(this.#y=this.#O()),this.#y}error(t="",e=null){const i={...this.#E};t&&(i.msg=t),i.msg=`<i class="fa fa-exclamation-triangle mg-right" aria-hidden="true"></i> ${i.msg}`,i.id=e,this.show(i)}success(t="",e=null,i=0){const s={...this.#S};t&&(s.msg=t),i>0&&(s.ms=i),s.msg=`<i class="fa fa-check-circle mg-right" aria-hidden="true"></i> ${s.msg}`,s.id=e,this.show(s)}working(t="",e=null){const i={...this.#A};t&&(i.msg=t),i.id=e,this.show(i)}show({msg:t="",className:e=null,id:i=null,ms:s=0}){if(!t)return null;let n=null;i?(n=document.getElementById(i),n&&n.remove()):(this.#T++,i=`${this.#v}-${this.#T}`),n=document.createElement("DIV"),n.id=i,n.classList.add(this.#w),e&&n.classList.add(e),n.innerHTML=`<div class="s-ui-notification-message">${t}</div><button class="btn" aria-label="${window?.springyText?.modal?.close||"Close"}">&times;</button>`;return this.#C().appendChild(n),n.addEventListener("click",(t=>{t.preventDefault(),this.hide(t.currentTarget)})),s>0&&setTimeout((()=>{this.hide(n)}),s),null===this.#I&&(this.#I=this.keyboardEvents.bind(this),document.addEventListener("keydown",this.#I,!0)),i}hide(t=null){t?t.remove():this.#y&&(this.#y.innerHTML=""),this.#k()}hideWorking(){this.#y&&(this.#y.querySelectorAll(`.${this.#A.className}`).forEach((t=>{t.remove()})),this.#k())}#k(){null===this.#I||!this.#y||this.#y.children.length>0||(document.removeEventListener("keydown",this.#I,!0),this.#I=null)}keyboardEvents(t){if("Escape"!==t.key)return;const e=this.#y.querySelector(`.${this.#w}`);e&&e.remove(),this.#k()}}({}),Ct=function(t,e=!1){const i=t.tagName;if(void 0===i)return!1;if(!((s=t).offsetWidth||s.offsetHeight||s.getClientRects().length))return!1;var s;const n=t.disabled,r=parseInt(t.getAttribute("tabindex"),10),o=t.getAttribute("contenteditable");switch(i){case"INPUT":case"TEXTAREA":case"SELECT":case"BUTTON":case"A":return-1!==r&&(!n&&("hidden"!==t.type&&!("A"===i&&!t.href)));default:if(e&&r>=0)return!0;if(!e&&r>=-1)return!0;if("true"===o)return!0}return!1},kt=function(t,e=!1,i=!1){let s=[];const n=Array.from(function(t){if("function"==typeof t.assignedElements){const e=t.assignedElements();return e.length?e:t.children}return t.children}(t));if(0===n.length)return s;for(const t of n){if(Ct(t,e)&&(s.push(t),i))return s;const n=kt(t,e,i);if(i&&1===n.length)return n;s=s.concat(n)}return s},Nt=function(t,e=!1,i=!1){return kt(t,e,i)},xt=function(t){return Nt(t,!1,!0).shift()},Rt=function(t){return Nt(t,!0,!0).shift()},Lt=function(t){const e=Nt(t,!0);return e[e.length-1]},Pt=function(t){const e=xt(t);e&&e.focus()},Mt={el:null,$el:null,id:"",tagName:"div",className:"",model:null,events:{},listeners:{},templateEng:null,templates:{main:function(){return""}},init:function(t){void 0===t&&(t={});Object.keys(t).forEach((function(e){if("events"!==e&&"listeners"!==e)this[e]=t[e];else{Object.keys(t[e]).forEach((function(i){this[e][i]=t[e][i]}),this)}}),this),this.initElement(),this.registerEvents(this.events),this.registerListeners(this.listeners)},generateElement:function(){if(!this.id)throw Error("springyView el must have an id.");this.el=document.createElement(this.tagName),this.el.id=this.id,this.$el=window.$(this.el),""!==this.className&&this.$el.addClass(this.className)},checkElementConfig:function(){if(null===this.el&&null===this.$el&&!this.id)throw Error("springyView el, $el, or id must be set.");if(null===this.el&&null===this.$el){const t=window.$(`#${this.id}`);if(0===t.length)return void this.generateElement();this.$el=t}},initElement:function(){if(this.checkElementConfig(),null===this.el?this.el=this.$el[0]:null===this.$el&&(this.$el=window.$(this.el)),this.id=this.el.id,!this.id)throw Error("springyView el must have an id.");this.tagName=this.el.tagName,this.className=this.$el.attr("class")},registerEvents:function(t){Object.keys(t).forEach((function(e){this.addEvent(e,t[e])}),this)},addEvent:function(t,e){this.events[t]||(this.events[t]=e),"function"!=typeof e&&(e=this[e].bind(this));const i=t.match(/^(\S+)\s*(.*)$/i),s=i[1],n=i[2];this.$el.on(`${s}.viewDelegated-${this.id}`,n,e)},registerListeners:function(t){Object.keys(t).forEach((function(e){this.listen(e,t[e])}),this)},listen:function(t,e){if(this.model&&this.model.emitter){this.listeners[t]=e;e.split(" ").forEach((function(e){this.model.emitter.on(t,this[e],this)}),this)}},stopListening:function(){if(!this.model||!this.model.emitter)return void(this.listeners={});Object.keys(this.listeners).forEach((function(t){this.listeners[t].split(" ").forEach((function(e){this.model.emitter.off(t,this[e])}),this)}),this),this.listeners={}},trapFocus:function(t){if("Tab"!==t.key||this.el.classList.contains("breakfocus"))return;const e=function(){let t=document.activeElement;for(;t&&t.shadowRoot&&t.shadowRoot.activeElement;)t=t.shadowRoot.activeElement;return t}();if(e)if(t.shiftKey){if(e===xt(this.el)||e===Rt(this.el)){const e=Lt(this.el);e&&(t.preventDefault(),e.focus())}}else if(e===Lt(this.el)){const e=Rt(this.el);e&&(t.preventDefault(),e.focus())}},remove:function(){this.stopListening(),this.$el.remove()},render:function(){return this}},Ft=Object.create(Mt);Ft.events={keydown:"trapFocus"},Ft.initialize=function(t){t.$el=window.$("#autoload"),this.init(t)},Ft._getOnlineProfile=function({botname:t="",botimage:e=""}){if(this.model.get("autoload_default")){if(""!==t)return{name:t,image:e,color:this.model.get("color_head")};const i=this.model.get("online_rule");if(i.opId>0||""!==i.coopId)return{name:"",image:"",color:""};const s=i.getFirstDept();return{name:s.name||"",image:s.image||"",color:s.color||""}}return{name:this.model.get("autoload_name"),image:this.model.get("autoload_image"),color:this.model.get("color_head")}},Ft.hideView=function(){this.$el.addClass("hidden")},Ft.showView=function(){this.$el.removeClass("hidden")},Ft.isShowing=function(){return!this.$el[0].classList.contains("hidden")},Ft.render=function(t={}){this.$el.empty();const e={profile:this._getOnlineProfile(t),autoload_head:this.model.get("autoload_head"),autoload_text:this.model.get("autoload_text"),autoload_yes:this.model.get("autoload_yes"),autoload_no:this.model.get("autoload_no"),cal_autoload:this.model.get("cal_autoload"),cal_url:this.model.get("cal_url"),cal_text:this.model.get("cal_text")};this.$el.html(this.templateEng.render("pane_autoload.njk",e));const i=this.model.offlineLinkTarget();return this.$el[0].querySelectorAll("a").forEach((t=>{t.getAttribute("target")||t.setAttribute("target",i)})),this};const $t=Ft,qt=Object.create(Mt);qt.events={"click .btn-cancel":"closeWidget"},qt.initialize=function(t){t.$el=window.$("#libauth"),this.init(t),this.model.isEmbed()||this.addEvent("keydown","trapFocus")},qt.hideView=function(){this.$el.addClass("hidden")},qt.showView=function(){this.$el.removeClass("hidden"),this.model.isEmbed()||Pt(this.el)},qt.closeWidget=function(){this.model.emitter.trigger("closeWidget")},qt.render=function(){this.$el.empty();const t={auth_id:this.model.get("auth_id"),isAuthValidated:this.model.get("isAuthValidated"),authText:this.model.get("authText"),authUrl:this.model.get("authUrl"),authButton:this.model.get("authButton"),isEmbed:this.model.isEmbed(),cancelButton:this.model.get("cancel_button")};if(this.$el.html(this.templateEng.render("overlay_libauth.njk",t)),window!==window.top){const t=this.$el[0].querySelector(".btn-libauth");t&&t.setAttribute("target","_blank")}return this.model.isEmbed()||Pt(this.el),this};const Dt=qt;class Ut{constructor({inputSelector:t="",queryUrl:e="",staticData:i=[],queryProcessor:s=null,dataProcessor:n=null,selectCallback:r=null,resultLimit:o=10,queryData:a={},instructionsText:h="{{count}} options available. Use up and down arrows to browse available options and enter to select one.",preventSubmit:l=!1,listLabel:c="Suggested results",showAllOnFocus:u=!1,allowEmptySearch:d=!1}){if(this.input=document.querySelector(t),!this.input)throw new Error(`${t} not found in the DOM.`);if(this.queryUrl=e,this.staticData=i,!this.queryUrl&&0===this.staticData.length)throw new Error("Must set queryUrl or staticData.");this.queryProcessor="function"==typeof s?s:null,this.dataProcessor="function"==typeof n?n:null,this.selectCallback="function"==typeof r?r:null,this.resultLimit=Number(o),this.queryData=a,this.instructionsText=h,this.preventSubmit=!!l,this.listLabel=c,this.showAllOnFocus=!!u,this.allowEmptySearch=!!d,this.showAllOnFocus&&(this.allowEmptySearch=!0),this.list=null,this.instructions=null,this.throttle=null,this.xhrSearch=null,this.queryName="",this.typedQuery="",this.formatInput(),this.createList(),this.addInstructions(),this.attachEvents()}clearInput(){this.input.value=""}selectNext(){const t=this.list.querySelector("li[aria-selected=true]");let e=null;if(null===t){if(e=this.list.querySelector("li:first-of-type"),null===e)return}else{if(e=t.nextElementSibling,null===e)return;t.setAttribute("aria-selected",!1)}e.setAttribute("aria-selected",!0),this.input.value=e.textContent}selectPrevious(){const t=this.list.querySelector("li[aria-selected=true]");if(null===t)return;const e=t.previousElementSibling;null===e?this.input.value=this.typedQuery:(e.setAttribute("aria-selected",!0),this.input.value=e.textContent),t.setAttribute("aria-selected",!1)}selectByClick(t){const e=this.list.querySelector("li[aria-selected=true]");null!==e&&e.setAttribute("aria-selected",!1),t.setAttribute("aria-selected",!0),this.selectOption(),this.showAllOnFocus||this.input.focus()}escapeRegExp(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}formatOption(t){let e="";if(t.display)e=t.display;else{const i=new RegExp(`(${this.escapeRegExp(this.typedQuery)})`,"ig");e=t.label.replace(i,"<strong>$1</strong>")}if(!e)return null;const i=document.createElement("li");return i.setAttribute("aria-selected",!1),i.setAttribute("role","option"),Object.keys(t).forEach((e=>{"label"!==e&&"display"!==e&&(i.dataset[e]=t[e])})),i.innerHTML=e,i}displayResults(t){if(0===t.length)return void this.closeList();let e=t.map(this.formatOption,this);e.length>this.resultLimit&&!this.allowEmptySearch&&(e=e.slice(0,this.resultLimit)),this.list.innerHTML="";const i=document.createDocumentFragment();e.forEach((t=>{t&&i.appendChild(t)})),this.list.appendChild(i),this.updateInstructions(e.length),this.openList()}isListOpen(){return!this.list.classList.contains("hidden")}isOptionSelected(){return null!==this.list.querySelector("li[aria-selected=true]")}openList(){this.list.style.left=`${this.input.offsetLeft}px`,this.list.style.top=`${this.input.offsetTop+this.input.offsetHeight}px`,this.list.style.minWidth=`${this.input.offsetWidth}px`,this.list.classList.remove("hidden"),this.input.setAttribute("aria-expanded",!0)}closeList(){this.list.classList.add("hidden"),this.list.innerHTML="",this.input.setAttribute("aria-expanded",!1),this.updateInstructions(0)}selectOption(){const t=this.list.querySelector("li[aria-selected=true]");this.input.dataset.oldvalue=this.input.value,this.input.value=t.textContent,null!==this.selectCallback&&this.selectCallback(t),this.closeList()}processData(t){return null!==this.dataProcessor?this.dataProcessor(t):t}buildQueryString(){const t=this.input.value,e=null!==this.queryProcessor?this.queryProcessor(t):t,i=new URLSearchParams;i.append(this.queryName,e),i.append("limit",this.resultLimit);return Object.keys(this.queryData).forEach((function(t){const e=this.queryData[t];"function"!=typeof e?i.append(t,e):i.append(t,e())}),this),`?${i.toString()}`}xhrOnLoad(){if(this.xhrSearch.status>=200&&this.xhrSearch.status<400){const t=JSON.parse(this.xhrSearch.responseText),e=this.processData(t);this.displayResults(e)}else console.log(this.xhrSearch.statusText)}xhrOnError(){console.log(this.xhrSearch.statusText)}makeRequest(){const t=this.buildQueryString();this.xhrSearch=new XMLHttpRequest,this.xhrSearch.open("GET",this.queryUrl+t,!0),this.xhrSearch.setRequestHeader("Accept","application/json"),this.xhrSearch.onload=this.xhrOnLoad.bind(this),this.xhrSearch.onerror=this.xhrOnError.bind(this),this.xhrSearch.send()}searchData(){const t=this.input.value;if(""===t&&!this.allowEmptySearch)return void this.closeList();let e=null!==this.queryProcessor?this.queryProcessor(t):t;if(e=e.toLowerCase(),""===e)return void this.displayResults(this.staticData);const i=this.staticData.filter((t=>-1!==t.label.toLowerCase().indexOf(e)));this.displayResults(i)}getExactMatch(){const t=this.input.value.trim().toLowerCase();if(""===t)return null;const e=this.staticData.find((e=>e.label.toLowerCase()===t));return e||null}query(){this.staticData.length>0?this.searchData():(this.throttle&&clearTimeout(this.throttle),this.xhrSearch&&this.xhrSearch.abort(),""!==this.input.value||this.allowEmptySearch?this.throttle=setTimeout(this.makeRequest.bind(this),500):this.closeList())}disable(){this.list.parentNode.removeChild(this.list)}createList(){this.list=document.createElement("ul"),this.list.id=this.getListId(),this.list.setAttribute("role","listbox"),this.list.setAttribute("aria-label",this.listLabel),this.list.classList.add("s-ui-autocomplete-list"),this.list.classList.add("hidden"),this.input.parentNode.insertBefore(this.list,this.input.nextSibling)}getListId(){return`${this.input.id}_list`}getInstructionsId(){return`${this.input.id}_instructions`}formatInput(){this.input.setAttribute("role","combobox"),this.input.setAttribute("aria-autocomplete","list"),this.input.setAttribute("aria-expanded","false"),this.input.setAttribute("aria-controls",this.getListId()),this.input.setAttribute("aria-describedby",this.getInstructionsId()),this.input.setAttribute("autocomplete","off"),this.queryName=this.input.getAttribute("name")}updateInstructions(t){this.instructions.innerHTML=this.instructionsText.replace("{{count}}",t)}handleTypingDown(t){const e=this.isListOpen();switch(t.key){case"Escape":e&&this.closeList();break;case"ArrowDown":e?(t.preventDefault(),this.selectNext()):this.showAllOnFocus&&""===this.input.value&&this.query();break;case"ArrowUp":e&&(t.preventDefault(),this.selectPrevious());break;case"Enter":e&&this.isOptionSelected()?(t.preventDefault(),this.selectOption()):this.preventSubmit&&t.preventDefault();break;case"Tab":e&&this.isOptionSelected()?this.selectOption():e&&this.closeList()}}handleTypingUp(t){switch(t.key){case"Escape":case"ArrowDown":case"ArrowUp":case"ArrowLeft":case"ArrowRight":case"Enter":case"Tab":break;default:this.typedQuery=this.input.value,this.query()}}handleClick(t){const e=t.target.closest("li[aria-selected=false]");null!==e&&this.selectByClick(e)}handleOutsideClick(t){const e=t.target;null!==e.closest(`#${this.list.id}`)||null!==e.closest(`#${this.input.id}`)||this.closeList()}attachEvents(){this.input.addEventListener("keydown",this.handleTypingDown.bind(this)),this.input.addEventListener("keyup",this.handleTypingUp.bind(this)),this.list.addEventListener("click",this.handleClick.bind(this)),document.body.addEventListener("click",this.handleOutsideClick.bind(this)),this.showAllOnFocus&&this.input.addEventListener("focus",(()=>{""===this.input.value&&this.query()}))}addInstructions(){this.instructions=document.createElement("div"),this.instructions.id=this.getInstructionsId(),this.instructions.setAttribute("aria-live","polite"),this.instructions.classList.add("sr-only"),this.instructions.innerHTML=this.instructionsText.replace("{{count}}",0),this.list.parentNode.insertBefore(this.instructions,this.list.nextSibling)}}const jt=Object.create(Mt);jt.events={"click .s-lch-btn-close":"closeWidget"},jt.initialize=function(t){t.$el=window.$("#offline"),t.patronSession&&(this.patronSession=t.patronSession),t.emitter&&(this.emitter=t.emitter),this.init(t),this.model.isEmbed()||this.addEvent("keydown","trapFocus"),this.renderOfflineMessages()},jt.renderOfflineMessages=function(){let t="",e="";const i=/\{\{\s*domain\s*\}\}/g,s=this.model.get("domain");try{t=this.model.get("la_hide_msg").replace(i,s)}catch(e){t=this.model.get("la_hide_msg")}try{e=this.model.get("la_hide_msg2").replace(i,s)}catch(t){e=this.model.get("la_hide_msg2")}this.model.set({la_hide_msg:t,la_hide_msg2:e},{silent:!0})},jt.autcompleteDataFormatCb=function(t){const e=[];return t.results.forEach((t=>{t.label=t.question,e.push(t)})),e},jt.autocompleteSelectCb=function(t){const e=this.$el[0].querySelector(`#s-la-content-search-${this.model.get("id")} form`);if(!e)return;let i=e.querySelector("input[name=originalq]");null===i&&(i=document.createElement("input"),i.setAttribute("type","hidden"),i.setAttribute("name","originalq"),e.insertBefore(i,e.firstChild));const s=e.querySelector(`#s-la-content-search-query-${this.model.get("id")}`);i.value=s.dataset.oldvalue||"";let n=e.querySelector("input[name=faqid]");null===n&&(n=document.createElement("input"),n.setAttribute("type","hidden"),n.setAttribute("name","faqid"),e.insertBefore(n,e.firstChild)),n.value=t.getAttribute("data-faqid"),e.submit()},jt.enableAutocomplete=function(){if(null===this.$el[0].querySelector(".s-la-content-search"))return;const t=this.model.get("la_search_opt");try{this.autocomplete=new Ut({inputSelector:`#s-la-content-search-query-${this.model.get("id")}`,queryUrl:`${this.model.get("domain")}/faq/searchpublic`,dataProcessor:this.autcompleteDataFormatCb.bind(this),selectCallback:this.autocompleteSelectCb.bind(this),queryData:{rows:5,iid:this.model.get("iid"),group_ids:t.group_id||0}})}catch(t){}},jt.showView=function(){this.$el.removeClass("hidden"),this.model.isEmbed()||Pt(this.el)},jt.closeWidget=function(){this.model.emitter.trigger("closeWidget")},jt.render=function(){this.$el.empty(),this.$el.html(this.templateEng.render("pane_offline.njk",this.model.toJSON()));const t=this.model.offlineLinkTarget();return this.$el[0].querySelectorAll("a, form").forEach((e=>{e.getAttribute("target")||e.setAttribute("target",t)})),(this.model.isFloat()||this.model.isTab())&&this.$el.find(".s-lch-btn-close").removeClass("hidden"),this.enableAutocomplete(),this};const Bt=jt,Ht=Object.create(Mt);Ht.patronSession=null,Ht.$form=null,Ht.events={"submit form":"processLoginForm","click .s-lch-btn-close":"handleCancelClick"},Ht.listeners={chatError:"showLoginError",chatBlockedError:"showLoginError"},Ht.initialize=function(t){t.patronSession&&(this.patronSession=t.patronSession),t.$el=window.$("#login"),this.init(t),this.model.isEmbed()||this.addEvent("keydown","trapFocus")},Ht.validateName=function(){const t=this.$form.find("input[name=client_name]");let e=t.val().trim();if(!0===this.model.get("autologin"))e=this.model.generateAnonName();else if(""===e&&!this.model.get("autologin")){if(!this.model.get("enable_anon"))return this.showValidationError(t,this.model.get("valid_form_n")),t.focus(),!1;e=this.model.generateAnonName(),t.val(e)}return this.patronSession.set("name",e),!0},Ht.validateContact=function(){if(this.model.get("contact_request")){const t=this.$form.find("input[name=client_contact]"),e=t.val().trim();if(!this.model.validateContact(e))return this.showValidationError(t,this.model.get("valid_form_c")),t.focus(),!1;this.patronSession.setContactInfo(e)}return!0},Ht.validateQuestion=function(){const t=this.$form.find("textarea[name=client_question]"),e=1===t.length?t.val().trim():"";return this.model.get("initial_question")&&!this.model.get("autologin")&&""===e?(this.showValidationError(t,this.model.get("valid_form_q")),t.focus(),!1):(this.patronSession.set("client_question",this.model.sanitizeMessage(e)),this.model.set("client_question",this.patronSession.get("client_question")),!0)},Ht.validateCustomFields=function(){const t=this.model.get("customFields");if(!Array.isArray(t)||0===t.length)return!0;let e=!0;return t.forEach((t=>{if(!t.show)return;const i=this.$form.find(`#s-lch-user${t.id}`);if(!i||0===i.length)return;const s=i.val().trim();if(t.required){let n=!1;if(("l"===t.type&&(!i[0].selectedIndex||i[0].selectedIndex<=0)||""===s)&&(n=!0),n)return e=!1,this.showValidationError(i,this.model.get("translation").required||"Required"),void i.focus()}this.patronSession.set(`user${t.id}`,{name:t.name,val:i.val().trim()})})),e},Ht.processLoginForm=function(t){if(t.preventDefault(),this.$submitButton.prop("disabled",!0),this.$form.find(".s-lch-form-error").remove(),!(this.validateName()&&this.validateContact()&&this.validateQuestion()&&this.validateCustomFields()))return this.$submitButton.prop("disabled",!1),!1;const e=this.$form.find("*[name=opId]"),i=this.$form.find("*[name=dept]");return e.length>0&&this.patronSession.set("uid",Number(e.val())),this.patronSession.get("uid")<1&&i.length>0&&this.patronSession.set("did",Number(i.val())),this.model.set("loggedIn",!0),!0},Ht.showLoginError=function(t=""){const e=t||this.model.getErrorMessage();this.$form.replaceWith(`<p class="alert alert-danger">${e}</p>`)},Ht.handleCancelClick=function(){this.model.emitter.trigger("closeWidget")},Ht.showValidationError=function(t,e){""!==e&&t.prev("label").append(`<span class="text-danger s-lch-form-error">${e}</span>`)},Ht.showView=function(){if(this.$el.removeClass("hidden"),this.model.get("auth_id")>0&&!this.model.get("isAuthValidated"))return this.$el[0].querySelectorAll("input,select,button,textarea").forEach((t=>{t.disabled=!0})),void this.$el[0].setAttribute("aria-hidden","true");this.model.isEmbed()||Pt(this.el)},Ht.repopulateForm=function(t){const e=["client_name","client_contact","client_question","dept","user1","user2","user3"],i=this.$form[0];Array.from(t.entries()).forEach((([t,s])=>{if(e.indexOf(t)<0)return;const n=i.elements[t];if(n)if("SELECT"===n.tagName)n.querySelectorAll("option").forEach((t=>{t.value===s&&(n.value=s)}));else n.value=s}))},Ht.inIframe=function(){try{return window.self!==window.top}catch(t){return!0}},Ht.render=function(){let t=null;null!==this.$form&&(t=new FormData(this.$form[0])),this.$el.empty();const e=this.model.toJSON();return e.patron=this.patronSession.toJSON(),e.inIframe=this.inIframe(),this.$el.html(this.templateEng.render("pane_login.njk",e)),this.$form=this.$el.find("#s-lch-login-form"),this.$submitButton=this.$form.find("button[type=submit]"),null!==t&&this.repopulateForm(t),this};const Wt=Ht;class zt{#N=null;#x=null;#R=function(){return!0};#L=0;#P=0;#M=0;#F=!1;#$=!0;#q={max_file_size:"Maximum file size"};#D=[];#U=null;#j=null;#B=[];#H=[];#W={current:0,total:0};#z=null;#V=null;#G=null;constructor({form:t=null,callback:e=null,error_callback:i=null,validate:s=null,max_files:n=0,max_upload_size:r=0,max_file_size:o=0,batch_files:a=!1,autoupload:h=!0,translations:l=null,allowedMimeTypes:c=[]}){this.#U=t,this.#N=e,this.#x=i,s&&(this.#R=s),this.#L=n,this.#P=r,this.#M=o,this.#F=a,this.#$=h,l&&(this.#q=l),this.#D=c,this.#U&&(this.#j=this.#U.querySelector(".s-ui-filedrop"),this.#z=this.#j?.querySelector('input[type="file"]'),this.#V=this.#j?.querySelector("label"))}#Q(){if(!this.#z)return;const t=this.#j.querySelector(".s-ui-filedrop-filenames"),e=t.querySelector("ul"),i=[];let s=0;this.#B.forEach((t=>{const e=document.createElement("li");e.innerText=t.name,i.push(e),s+=t.size})),e.innerHTML="",0===i.length?t.classList.add("hidden"):(t.classList.remove("hidden"),i.forEach((t=>{e.appendChild(t)}))),this.#L>0&&i.length>this.#L&&this.showError(`${this.#L} file uploads maximum.`),!this.#F&&this.#P>0&&s>this.#P&&this.showError(`Files total ${this.#K(s)} MB which exceeds the maximum of ${this.#K(this.#P)}MB at a time.`)}reset(){this.#U.reset(),this.#Y(),this.#B=[],this.#W.current=0,this.#W.total=0,this.#J(),this.#Q(),this.#z?.classList.remove("has-focus")}#Z(){this.#X(),this.#B=[],this.#W.current=0,this.#W.total=0,this.#Q()}#X(){if(!this.#z)return;const t=document.createElement("FORM"),e=this.#z.cloneNode(!0);t.append(e),t.reset(),this.#z.replaceWith(e),this.#z=e,this.#tt()}showError(t){if(!this.#j)return;const e=document.createElement("p");if(e.innerText=t,this.#U.querySelector("div.s-ui-filedrop-error"))return void this.#U.querySelector("div.s-ui-filedrop-error").append(e);const i=document.createElement("div");i.classList.add("alert"),i.classList.add("alert-danger"),i.classList.add("s-ui-filedrop-error"),i.setAttribute("role","alert"),i.append(e),this.#j.prepend(i)}#Y(){const t=this.#U.querySelector("div.s-ui-filedrop-error");t&&(t.innerHTML="")}countFiles(){return this.#z?this.#B.length:0}isLastBatch(){return this.#W.current>=this.#W.total}#et(){if(!this.#j)return;if(this.#G&&""!==this.#G.innerHTML)return;let t=!0;this.#G=this.#U.querySelector("div.s-ui-filedrop-progress"),this.#G||(t=!1,this.#G=document.createElement("DIV"),this.#G.classList.add("s-ui-filedrop-progress"));const e=document.createElement("DIV");e.id="s-ui-filedrop-progresslabel",e.innerText="Uploading files";const i=document.createElement("DIV");i.classList.add("s-ui-filedrop-progbar"),i.setAttribute("role","progressbar"),i.setAttribute("aria-valuenow","0"),i.setAttribute("aria-valuemin","0"),i.setAttribute("aria-valuemax","100"),i.setAttribute("aria-labelledby","s-ui-filedrop-progresslabel");const s=document.createElement("span");i.append(s),this.#G.append(e,i),t||this.#j.prepend(this.#G)}#it(t,e){const i=Math.round(t/e*100),s=this.#G.querySelector("span:first-of-type");if(s&&(s.style.width=`${i}%`),this.#G.querySelector(".s-ui-filedrop-progbar")?.setAttribute("aria-valuenow",i),this.#W.total>1&&i<50){const t=this.#G.querySelector("div:first");t&&(t.innerHTML=`Uploading file batch (${this.#W.current}/${this.#W.total})`)}}#J(){this.#G&&(this.#G.innerHTML="")}#K(t){return(parseInt(t,10)/1048576).toFixed(1)}#st(t){if(this.#L>0&&this.countFiles()+t.length>this.#L)return this.showError(`${this.#L} file uploads maximum.`),!1;let e=0;this.#B.forEach((t=>{e+=t.size}));const i=[];for(let s=0;s<t.length;s++){const n=t[s];if(this.#B.length>0){let t=!1;if(this.#B.forEach((e=>{e.name===n.name&&(t=!0)})),t){i.push(s);continue}}this.#D.length>0&&-1===this.#D.indexOf(n.type)?(this.showError(`File: ${n.name} is not an allowed file type.`),i.push(s)):this.#M>0&&n.size>this.#M?(this.showError(`File: ${n.name} is greater than allowed file size of ${this.#K(this.#M)} MB.`),i.push(s)):!1===this.#F&&e+n.size>this.#P?(this.showError(`File: ${n.name} causes files to go over maximum upload size of ${this.#K(this.#P)} MB at a time.`),i.push(s)):e+=n.size}if(!1===this.#F&&this.#P>0&&e>this.#P)return this.showError(`Files total ${e} bytes which exceeds the maximum of ${this.#K(this.#P)} MB at a time.`),!1;for(let e=0;e<t.length;e++)-1===i.indexOf(e)&&this.#B.push(t[e]);return 0!==this.#B.length}#nt(){const t=[],e=[];if(!this.#F)return t.push(this.#B),t;let i=1;return t.push([]),e.push(0),this.#B.forEach((s=>{let n=!1;if(e.forEach(((i,r)=>{!n&&i+s.size<this.#P&&(e[r]=i+s.size,t[r].push(s),n=!0)})),!n){e.push(0),i++,t.push([]);const n=i-1;e[n]=s.size,t[n].push(s)}})),t}#rt(t=!1){this.#W.current>=this.#W.total||t?(this.#U.removeAttribute("data-submitting"),this.#J()):(this.#W.current++,this.#ot())}#ot(){const t=this.#U.querySelector('input[name="batch_current"]');t&&(t.value=this.#W.current);const e=new FormData(this.#U);"function"==typeof e.delete&&this.#z&&e.delete(this.#z.getAttribute("name")),this.#H[this.#W.current-1].forEach((t=>{this.#z&&e.append(this.#z.getAttribute("name"),t)}));const i=new XMLHttpRequest;i.onload=()=>{const t=i.status;let e=!0;if(t>=200&&t<300)try{const t=JSON.parse(i.responseText);this.#N&&this.#N(t,this),e=!1}catch(t){this.#x&&this.#x(i,this)}else this.#x&&this.#x(i,this);this.#rt(e)},i.onerror=()=>{this.#x&&this.#x(i,this),this.#rt(!0)},i.onprogress=t=>{this.countFiles()>0&&this.#it(t.loaded,t.total)},i.open(this.#U.method,this.#U.action),this.countFiles()>0&&this.#et(),i.send(e)}#at(t){switch(t.preventDefault(),t.stopPropagation(),t.type){case"dragover":case"dragenter":this.#j.classList.add("is-dragover");break;case"dragleave":case"dragend":case"drop":this.#j.classList.remove("is-dragover")}}#ht(){if(this.#j){if(this.#j.classList.add("has-advanced-upload"),this.#F){const t=document.createElement("INPUT");t.setAttribute("type","hidden"),t.setAttribute("name","batch_current"),t.value=0;const e=document.createElement("INPUT");e.setAttribute("type","hidden"),e.setAttribute("name","batch_total"),e.value=0,this.#U.prepend(t,e)}this.#j.addEventListener("drag",this.#at.bind(this)),this.#j.addEventListener("dragstart",this.#at.bind(this)),this.#j.addEventListener("dragend",this.#at.bind(this)),this.#j.addEventListener("dragover",this.#at.bind(this)),this.#j.addEventListener("dragenter",this.#at.bind(this)),this.#j.addEventListener("dragleave",this.#at.bind(this)),this.#j.addEventListener("drop",(t=>{this.#at(t);const e=this.#st(t.dataTransfer.files);if(this.#Q(),!0===e&&this.#$){const t=new SubmitEvent("submit",{cancelable:!0});this.#U.dispatchEvent(t)}})),this.#j.addEventListener("click",(t=>{const e=t.target.tagName;if(-1!==["A","I","SPAN","B","STRONG","BUTTON"].indexOf(e)){const e=t.target.closest("a, button");e?.classList.contains("s-ui-filedrop-clear")&&(this.#Z(),this.#Y())}}))}}#lt(t){if(t.target.files){const e=this.#st(t.target.files);if(this.#X(),!0===e&&this.#$){const t=new SubmitEvent("submit",{cancelable:!0});this.#U.dispatchEvent(t)}this.#z.classList.remove("has-focus"),this.#Q()}}#tt(){this.#z&&(this.#z.addEventListener("change",(t=>{this.#lt(t)})),this.#z.addEventListener("focus",(t=>{t.target.classList.add("has-focus")})),this.#z.addEventListener("blur",(t=>{t.target.classList.remove("has-focus")})))}#ct(t){if(t.preventDefault(),this.#U.dataset.submitting)return;if(this.#U.classList.remove("is-error"),this.#Y(),this.#L>0&&this.countFiles()>this.#L)return void this.showError(`${this.#L} file uploads maximum.`);if(!1===this.#R(this))return void this.#U.classList.add("is-error");this.#U.dataset.submitting="true",this.#W.current=1,this.#H=this.#nt(),this.#W.total=this.#H.length;const e=this.#U.querySelector('input[name="batch_total"]');e&&(e.value=this.#W.total),this.#ot()}init(){if(this.#U&&(this.#U.addEventListener("submit",(t=>{this.#ct(t)})),this.#tt(),this.#ht(),this.#V&&this.#q.max_file_size)){const t=document.createElement("p");t.innerHTML=`${this.#q.max_file_size}: ${this.#K(this.#M)}MB`,this.#V.append(t)}}}const Vt=Object.create(Mt);Vt.events={"click .btn-file-cancel":"closeView",keydown:"trapFocus"},Vt.initialize=function(t){t.patronSession&&(this.patronSession=t.patronSession),t.emitter&&(this.emitter=t.emitter),t.$el=window.$("#file"),this.init(t)},Vt.closeView=function(){this.filedrop.reset(),this.$submitButton.val(this.model.get("file_action")).prop("disabled",!1),this.emitter.trigger("changeView","chat")},Vt.formValidate=function(t){return 0===t.countFiles()?(t.showError(this.model.get("translation").ch_file_nofiles),!1):(0===this.$form.find("input[name=channel]").length?this.$form.prepend(window.$('<input type="hidden" name="channel" />').val(this.patronSession.getChannel())):this.$form.find("input[name=channel]").val(this.patronSession.getChannel()),!0)},Vt.formError=function(t,e){let i="";i=413===Number(t.status)?this.model.get("translation").ch_file_toolarge:400===Number(t.status)?At(t):this.model.get("translation").ch_file_error,e.showError(i)},Vt.formSuccess=function(t,e){const i=document.createElement("span");i.innerText="attached a file: ";const s=document.createElement("a");s.href=t.url,s.setAttribute("target","_blank"),s.classList.add("s-la-cfile"),s.innerText=t.url,"inline"!==t.preview&&"modal"!==t.preview||(s.dataset.preview=t.preview),i.appendChild(s),this.emitter.trigger("fileUpload",i.outerHTML),e.reset()},Vt.showView=function(){this.$el.removeClass("hidden"),Pt(this.el)},Vt.render=function(){this.$el.empty();const t=this.model.toJSON();return t.channel=this.patronSession.getChannel(),this.$el.html(this.templateEng.render("pane_fileupload.njk",t)),this.$form=this.$el.find("form"),this.$submitButton=this.$form.find("button[type=submit]"),this.filedrop=new zt({form:this.$form[0],autoupload:!1,max_files:1,max_upload_size:20971520,max_file_size:20971520,callback:this.formSuccess.bind(this),error_callback:this.formError.bind(this),validate:this.formValidate.bind(this),translations:{max_file_size:this.model.get("max_file_size_label")}}),this.filedrop.init(),this};const Gt=Vt,Qt=Object.create(Mt);Qt.patronSession=null,Qt.operatorsList=[],Qt.currentTypers=[],Qt.events={"click .s-lch-btn-sound":"toggleSoundButton","keyup #s-lch-post-input":"patronTyping","keydown #s-lch-post-input":"triggerSubmitOnEnter","submit #s-lch-post-form":"messageSubmit","click .s-lch-btn-trans":"sendTranscript","click .s-lch-header-end .s-lch-btn-close":"closeWidget","click #s-lch-rate-form .s-lch-btn-close":"reloadCloseChat","click .s-lch-msg-op a":"followLink","click a.s-la-cfile[data-preview]":"showFileUploadPreview","click a":"openNewTab","click button[data-responseid]":"handleBotResponseOpts",keydown:"trapFocus"},Qt.listeners={opJoin:"showOpJoin",opLeave:"showOpLeave",opAway:"showOpAway",endChat:"endChatDisplay",chatSubscribe:"chatSubscribeDisplay",chatReconnecting:"showReconnecting",chatReconnected:"showReconnected",chatError:"showChatError",chatBlockedError:"showBlockedError",requestContact:"showContactRequestForm",chatAway:"showChatAwayStatus",patronMessagePosted:"showPatronMessage","change:chatting":"enableChatting","change:peelingParent":"peeledOutDisplay","change:connected":"setConnectState",showGreeting:"showGreeting",deptGreeting:"showDeptGreeting",chatMsgNotSendable:"showMessageNotSendable","bot:start":"activateBot","bot:startsession":"startBot","bot:stop":"stopBot","bot:action":"showBotMessage","bot:skipbot":"skipBot","bot:end":"endBot","bot:action:page":"showPagedOptions"},Qt.missedChatTime=null,Qt.timedFallbackTime=null,Qt.isBotActive=!1,Qt.initialize=function(t){t.patronSession&&(this.patronSession=t.patronSession),t.emitter&&(this.emitter=t.emitter),t.operatorsList&&(this.operatorsList=t.operatorsList),t.$el=window.$("#chat"),this.init(t),this.model.isEmbed()&&this.el.classList.add("breakfocus")},Qt.patronTyping=function(t){if(this.isBotActive)return;if(t.key&&"Enter"===t.key)return;const e=""!==window.$(t.target).val().trim();this.emitter.trigger("isTyping",e)},Qt.triggerSubmitOnEnter=function(t){"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.$form.trigger("submit"))},Qt.handleBotResponseSubmit=function(){const t=new FormData(this.$form[0]),e=Number(t.get("action_id")||0),i=Number(t.get("responseid")||0);let s=t.get("msg")||"";s=s.trim();const n=this.$form[0].querySelector(`button[data-responseid="${i}"], option[value="${i}"]`),r=1===Number(n&&n.dataset.other||0),o=Number(n&&n.dataset.page||0),a=!!n&&!!n.dataset.back;if(!n||r){if(""===s)return;return this.showPatronMessage(s),void this.emitter.trigger("bot:freetext",{actionId:e,text:s})}o>0?this.emitter.trigger("bot:response:page",{actionId:e,page:o}):a?this.emitter.trigger("bot:response:back",{actionId:e}):(s=n.innerText,this.showPatronMessage(s),this.emitter.trigger("bot:response",{actionId:e,responseId:i}))},Qt.messageSubmit=function(t){if(t.preventDefault(),this.isBotActive)return void this.handleBotResponseSubmit();const e=this.$msgInput.val().trim();this.emitter.trigger("messageSubmit",e)},Qt.clearTextarea=function(t){this.$msgInput.val(""),t&&this.$msgInput.focus()},Qt.followLink=function(t){const e=t.currentTarget;""===(e.href?e.href:"")&&t.preventDefault()},Qt.showChatMsg=function(t){if(!t.msg)return;let e="";t.id=t.id?t.id:"",t.opId=t.opId?t.opId:0,t.ts=t.ts?new Date(t.ts):new Date,t.ts_html="",t.ts_time="",void 0===t.show_meta&&(t.show_meta=this.checkShowMeta(t.role,t.ts,t.opId)),""!==t.ts&&"Invalid Date"!==t.ts&&(t.ts_html=this.htmlTime(t.ts),t.ts_time=t.ts.toLocaleTimeString()),"user"===t.role?(t.name=this.model.get("translation").ch_user_pronoun,e=this.templateEng.render("message_patron.njk",t)):"op"===t.role&&(t.profile_image=t.profile_image?t.profile_image:{path:"",color:""},e=this.templateEng.render("message_op.njk",t)),this.log.insertAdjacentHTML("beforeend",e)},Qt.checkShowMeta=function(t,e,i){void 0!==e&&"Invalid Date"!==e||(e=new Date);let s="";switch(t){case"op":s=`s-lch-msg-op-${i}`;break;case"user":s="s-lch-msg-patron";break;case"sys":s="s-lch-msg-sys";break;default:return!0}const n=[...this.log.querySelectorAll(".s-lch-msg")].at(-1);if(!n||!n.classList.contains(s))return!0;const r=n.querySelector("time");if(r){const t=new Date(r.getAttribute("pubdate"));if(this.checkMinuteDiff(e,t,5))return!0}return!1},Qt.checkMinuteDiff=function(t,e,i){let s=Math.abs(t-e);return s=Math.round(s/1e3/60),s>=i},Qt.showChatSysMsg=function(t){if(t.msg){if(t.id=t.id?t.id:"",t.ts=t.ts?new Date(t.ts):new Date,""!==t.ts&&"Invalid Date"!==t.ts&&(t.ts_html=this.htmlTime(t.ts),t.ts_time=t.ts.toLocaleTimeString()),t.show_meta=this.checkShowMeta("sys",t.ts),""!==t.id){const e=this.log.querySelector(`#${t.id}`);e&&e.remove()}this.log.insertAdjacentHTML("beforeend",this.templateEng.render("message_system.njk",t)),this.scrollLog()}},Qt.htmlTime=function(t){let e="";return e+=`${(t=new Date(t)).getFullYear()}-`,e+=`${t.getMonth()<10?"0":""}${t.getMonth()+1}-`,e+=`${t.getDate()<10?"0":""}${t.getDate()}`,e+=`T${t.getHours()<10?"0":""}${t.getHours()}:`,e+=`${t.getMinutes()<10?"0":""}${t.getMinutes()}:`,e+=`${t.getSeconds()<10?"0":""}${t.getSeconds()}`,e+=-t.getTimezoneOffset()<0?"-":"+",e+=`${Math.abs(t.getTimezoneOffset()/60)<10?"0":""}${Math.abs(t.getTimezoneOffset()/60)}:00`,e},Qt.scrollLog=function(){try{this.log.lastElementChild?.scrollIntoView(!1)}catch(t){}},Qt.showFileUpload=function(t){this.showChatMsg({msg:t,name:"You",role:"user"}),this.scrollLog(),this.$msgInput.focus()},Qt.contactSave=function(t){t.preventDefault(),this.contactForm.querySelector(".s-lch-form-error")?.remove();const e=this.contactForm.querySelector("input[name=client_contact]"),i=e?e.value.trim():"";if(!this.model.validateContact(i))return void this.showValidationError(e,this.model.get("valid_form_c"));this.patronSession.setContactInfo(i);const s=this.contactForm.querySelector("input[name=client_name]");if(s){const t=s.value.trim();if(!1===this.model.get("enable_anon")&&""===t)return void this.showValidationError(s,this.model.get("valid_form_n"));""!==t&&this.patronSession.set("name",t)}let n=!0;const r=this.model.get("customFields");if(Array.isArray(r)&&r.length>0&&r.forEach((t=>{if(!t.show)return;const e=this.contactForm.querySelector(`#s-lch-user${t.id}`);if(!e)return;const i=e.value.trim();if(t.required){let s=!1;if(("l"===t.type&&(!e.selectedIndex||e.selectedIndex<=0)||""===i)&&(s=!0),s)return n=!1,this.showValidationError(e,this.model.get("translation").required||"Required"),void e.focus()}this.patronSession.set(`user${t.id}`,{name:t.name,val:i})})),n){if(this.contactForm.querySelectorAll("button[type=submit], input").forEach((t=>{t.disabled=!0})),null===this.model.get("cascade")){const t=this.contactForm.querySelector("form");return t&&(t.innerHTML=`<p>${this.model.get("translation").ch_thanks}</p>`),this.$msgInput.focus(),void this.emitter.trigger("startSession")}this.emitter.trigger("contactSave",this.contactForm.querySelector("form"))}},Qt.contactFormSuccess=function(){const t=this.contactForm.querySelector("form");t&&(t.innerHTML=`<p>${this.model.get("translation").ch_contact_info_saved}</p>`),this.$msgInput.focus(),""!==this.$msgInput.val()&&this.$form.submit()},Qt.contactSaveError=function(){this.contactForm.insertAdjacentHTML("beforeend",`<p>${this.model.get("translation").ch_contact_info_not_saved}</p>`),this.contactForm.querySelectorAll("button[type=submit], input").forEach((t=>{t.disabled=!1}))},Qt.showContactRequestForm=function(t){if(""!==this.patronSession.get("client_contact"))return;void 0===t&&(t=!1),null!==this.contactForm&&(this.contactForm.remove(),this.contactForm=null);const e=this.model.toJSON();e.allFields=t,e.channel=this.patronSession.getChannel(),this.log.insertAdjacentHTML("beforeend",this.templateEng.render("form_contactrequest.njk",e)),this.contactForm=this.el.querySelector("#s-lch-msg-contact"),this.contactForm.querySelector("form")?.addEventListener("submit",this.contactSave.bind(this)),this.contactForm.querySelector("input[name=client_contact]")?.focus(),this.scrollLog()},Qt.showRatingForm=function(t=!1,{survey_uuid:e="",rate_1:i="",rate_4:s=""}={}){const n=this.model.toJSON();n.channel=this.patronSession.getChannel(),n.isBot=t,t&&""!==e&&(n.survey_uuid=e,n.rate_1=i,n.rate_4=s),n.clientContact=this.patronSession.get("client_contact");const r=this.templateEng.render("form_rating.njk",n);this.log.insertAdjacentHTML("beforeend",r);const o=this.log.querySelector("#s-lch-rate-form");if(!o)return;o.addEventListener("submit",this.saveRating.bind(this)),o.querySelectorAll('input[type="checkbox"]').forEach((t=>{t.addEventListener("change",this.toggleCommentContactInput.bind(this))})),this.scrollLog(),this.hideForm(),this.disableForm();const a=o.querySelector('input[type="radio"]');a&&a.focus()},Qt.toggleCommentContactInput=function(){if(""!==this.patronSession.get("client_contact"))return;const t=this.log.querySelector("#s-lch-rate-form"),e=t.querySelector("#rate_client_contact"),i=e?e.closest("div.form-group"):null;0===t.querySelectorAll('input[type="checkbox"]:checked').length?i&&(i.classList.add("hidden"),e.removeAttribute("required")):i&&(i.classList.remove("hidden"),e.setAttribute("required",!0))},Qt.saveRating=function(t){t.preventDefault();const e=t.target;e.querySelector(".s-lch-form-error")?.remove();const i=new FormData(e),s=e.querySelector("textarea[name=client_comment]"),n=i.get("request_followup"),r=i.get("email_transcript");if(n||r){const t=i.get("client_contact").toString();if(""===t||!this.model.validateContact(t)){const t=e.querySelector("input[name=client_contact]");return void this.showValidationError(t,this.model.get("valid_form_c"))}this.patronSession.setContactInfo(t)}n&&""===s.value?this.showValidationError(s,this.model.get("translation").ch_include_comment):(e.querySelectorAll("button[type=submit], fieldset, textarea, input").forEach((t=>{t.disabled=!0})),window.$.ajax({url:e.action,type:"POST",dataType:"json",data:{rating:Number(i.get("chat_rating")),comment:i.get("client_comment"),followup:n?1:0,transcript:r?1:0,client_contact:this.patronSession.get("client_contact"),queue_id:this.model.get("queue_id"),iid:this.model.get("iid"),page_name:this.model.get("referer_title"),page_url:this.model.get("referer"),survey_uuid:i.get("survey_uuid")}}).done((t=>{this.ratingSaveSuccess(t,i)})).fail(this.ratingSaveError.bind(this)))},Qt.ratingSaveSuccess=function(t,e){e.get("request_followup")&&(t.ticket.isSuccess&&this.model.set("ticketCreated",!0),this.showChatSysMsg({msg:t.ticket.message})),e.get("email_transcript")&&this.showChatSysMsg({msg:t.email.message}),this.showChatSysMsg({msg:this.model.get("translation").ch_comment_success}),this.isBotActive&&this.handleBotResponseSubmit()},Qt.ratingSaveError=function(){this.showChatSysMsg({msg:this.model.get("translation").ch_comment_error}),this.isBotActive&&this.handleBotResponseSubmit()},Qt.showValidationError=function(t,e){if(""===e)return;const i=t.previousElementSibling;"LABEL"===i.tagName&&(i.classList.remove("sr-only"),i.insertAdjacentHTML("beforeend",`<span class="text-danger s-lch-form-error">${e}</span>`))},Qt.showFollowUpMsg=function(){this.model.get("ticketCreated")||this.model.get("followup_enabled")&&(this.enableForm(),this.showChatSysMsg({msg:this.model.get("followup_msg"),id:"s-lch-msg-followup"}))},Qt.removeFollowUpMsg=function(){this.log.querySelector("#s-lch-msg-followup")?.remove()},Qt.toggleSoundButton=function(){const t=!this.model.get("enable_sound");this.model.set("enable_sound",t);const e=window.$(".s-lch-btn-sound");let i="";t?(i=this.model.get("translation").ch_sound_on,e.attr("aria-label",i).find("i").removeClass("fa-volume-off").addClass("fa-volume-up")):(i=this.model.get("translation").ch_sound_off,e.attr("aria-label",i).find("i").removeClass("fa-volume-up").addClass("fa-volume-off")),e.find("span.icon-label").html(i),e.data("bs.tooltip")&&(e.data("bs.tooltip").options.title=i)},Qt.setOperatorTypingStatus=function(t){if("user"===t.role)return;const e=this.getOpName(t.opId);if(""===e)return;const i=this.currentTypers.indexOf(e);t.isTyping?-1===i&&this.currentTypers.push(e):-1!==i&&this.currentTypers.splice(i,1),0!==this.currentTypers.length?this.$chatTyping.html(`${this.currentTypers.join(", ")} ${this.model.get("translation").ch_op_typing}`):this.clearOperatorTyping()},Qt.clearOperatorTyping=function(){this.$chatTyping.html("")},Qt.showPeelButton=function(){this.inIframe()&&this.$el.find(".s-lch-btn-peel").removeClass("hidden")},Qt.hidePeelButton=function(){this.$el.find(".s-lch-btn-peel").addClass("hidden")},Qt.closeWidget=function(){this.model.emitter.trigger("closeWidget")},Qt.reloadCloseChat=function(){(this.model.isFloat()||this.model.isTab())&&this.inIframe()?this.model.emitter.trigger("closeWidget"):this.model.emitter.trigger("reloadWidget")},Qt.sendTranscript=function(){const t=window.$("<form></form>").attr({target:"_blank",action:`/chat/session/${this.patronSession.getChannel()}/transcript`,method:"post"}).addClass("hidden"),e=[];e.push(window.$("<input />").attr({type:"hidden",name:"iid"}).val(this.model.get("iid"))),e.push(window.$("<input />").attr({type:"hidden",name:"page_url"}).val(this.model.get("referer"))),e.push(window.$("<input />").attr({type:"hidden",name:"page_name"}).val(this.model.get("referer_title"))),t.append(e),window.$("body").append(t),t.trigger("submit"),t.remove()},Qt.getProfileImage=function(t){const e={path:this.model.get("defaultProfile"),color:""};if(0===this.operatorsList.length)return e;const i=this.operatorsList.find((e=>Number(e.get("opId"))===Number(t)));return void 0!==i?i.get("profile_image"):e},Qt.getOpName=function(t){const e=this.operatorsList.find((e=>e.get("opId")===t));return void 0!==e?e.get("name"):""},Qt.insertMessageHistory=function(t,e){if("all"===e&&this.log.setAttribute("aria-live","off"),Array.isArray(t)&&t.length>0){const e=window.$(".s-lch-msg-op");t.forEach((function(t){if("note"===t.role||"system"===t.system)return;0===e.filter(((e,i)=>{const s=i.querySelector(".s-lch-msg-txt");return!!s&&s.innerHTML===t.msg})).length&&(t.opId&&(t.profile_image=this.getProfileImage(t.opId)),this.showChatMsg(t))}),this)}"all"===e?(this.log.setAttribute("aria-live","polite"),this.showChatSysMsg({msg:this.model.get("translation").ch_reconnect_chat,id:""})):this.scrollLog()},Qt.showMissedChatMsg=function(){this.showChatSysMsg({msg:this.model.getMissedChatMessage(),id:""})},Qt.setMissedChatTimeout=function(){""!==this.patronSession.get("peel")||Number(this.model.get("missedchat_time"))<=0||(this.missedChatTime=window.setTimeout(this.showMissedChatMsg.bind(this),1e3*this.model.get("missedchat_time")))},Qt.triggerFallback=function(){this.emitter.trigger("triggerFallback")},Qt.setTimedFallbackTimeout=function(t){""!==this.patronSession.get("peel")||t<=0||(this.timedFallbackTime=window.setTimeout(this.triggerFallback.bind(this),1e3*t))},Qt.clearFallbackTimeout=function(){window.clearTimeout(this.timedFallbackTime)},Qt.accessibleIcons=function(){this.$el.find("button > .fa").each(((t,e)=>{const i=window.$(e).parent("button"),s=i.attr("aria-label");""!==s&&i.tooltip({title:s,html:!0,placement:i.attr("data-tooltip")?i.attr("data-tooltip"):"bottom"})}))},Qt.inIframe=function(){try{return window.self!==window.top}catch(t){return!0}},Qt.play_sound=function(){try{this.model.get("enable_sound")&&(this.audio||(this.audio=document.getElementById("sound")),this.audio.play())}catch(t){}},Qt.showOpJoin=function(t){window.clearTimeout(this.missedChatTime),this.clearFallbackTimeout(),this.play_sound(),this.showChatSysMsg({msg:`${t.get("name")} ${this.model.get("translation").ch_op_join}`,id:""}),this.removeFollowUpMsg()},Qt.showOpLeave=function(t){this.showChatSysMsg({msg:`${t.get("name")} ${this.model.get("translation").ch_op_left}`}),this.clearOperatorTyping(),this.play_sound()},Qt.showOpAway=function(t){this.clearOperatorTyping(),t.get("isAway")?this.showChatSysMsg({msg:`${t.get("name")} ${this.model.get("translation").ch_op_away}`}):this.showChatSysMsg({msg:`${t.get("name")} ${this.model.get("translation").ch_op_back}`})},Qt.showDeptGreeting=function(t=""){if(""===t)return;let e=this.model.get("dept_message");e&&(e=e.replace("%deptName%",t),this.showChatSysMsg({msg:e}),this.emitter.trigger("systemMessage",e))},Qt.showGreeting=function(t){const e=this.model.getGreeting(t);this.showChatSysMsg({msg:e,id:"msg_greeting"}),this.emitter.trigger("systemMessage",e),this.model.isEmbed()&&this.el.classList.remove("breakfocus")},Qt.showNewMessage=function(t){0!==t.opId&&(this.showChatMsg({msgId:t.msgId,msg:t.msg,ts:t.ts,name:this.getOpName(t.opId),opId:t.opId,role:t.role,profile_image:this.getProfileImage(t.opId)}),this.scrollLog(),this.play_sound(),this.enableForm())},Qt.activateBot=function(){this.isBotActive=!0,this.$el.find(".s-lch-header-end").addClass("hidden")},Qt.startBot=function(){this.$el.find(".s-lch-header-end").removeClass("hidden"),this.model.isEmbed()&&this.el.classList.remove("breakfocus")},Qt.stopBot=function(){this.isBotActive=!1,this.resetFormForChat(),this.$el.find(".s-lch-header-end").removeClass("hidden"),this.$msgInput[0].removeAttribute("maxlength"),this.model.isEmbed()&&this.el.classList.add("breakfocus")},Qt.endBot=function(){this.isBotActive&&(this.isBotActive=!1,this.updateBotForm({}),this.disableForm(),this.setEndChatButtonToReload(),this.$el.find(".s-lch-header-end").removeClass("hidden"),this.model.isEmbed()&&this.el.classList.add("breakfocus"))},Qt.updateBotForm=function({actionId:e=0,responses:i=[],actionType:s=0}){const n={actionId:e,responses:[]};let r=!1;i.forEach((t=>{t.freeResponse?r=!0:n.responses.push(t)}));const o=this.templateEng.render("form_bot_responses.njk",n);this.$form[0].querySelector(".bot-responses").outerHTML=o,this.$msgInput[0].setAttribute("maxlength",200),r?this.showBotTextInput():this.hideBotTextInput(),this.showForm(),this.enableForm();const a=this.$form[0].querySelector("select");if(a&&(a.addEventListener("change",(t=>{this.handleBotSelectOpts(t)})),this.submitBtn.classList.remove("hidden")),this.model.isEmbed()&&s===t.ACTION_WELCOME)return;const h=this.$form[0].querySelector("textarea:not(.hidden), button:not(.hidden), select");h&&h.focus()},Qt.showBotTextInput=function(){this.$msgInput[0].classList.remove("hidden"),this.submitBtn.classList.remove("hidden")},Qt.hideBotTextInput=function(){this.$msgInput[0].classList.add("hidden"),this.$msgInput[0].value="",this.submitBtn.classList.add("hidden")},Qt.handleBotResponseOpts=function({target:t=null}){if(!t)return;const e=Number(t.dataset.responseid||0),i=this.$form[0].querySelector('input[name="responseid"]');i&&(i.value=e);1===Number(t.dataset.other||0)?this.showBotTextInput():(this.hideBotTextInput(),this.handleBotResponseSubmit())},Qt.handleBotSelectOpts=function({target:t=null}){if(!t)return;const e=t.options[t.selectedIndex]||null;if(!e)return;1===Number(e.dataset.other||0)?this.showBotTextInput():(this.hideBotTextInput(),this.submitBtn.classList.remove("hidden"))},Qt.showBotMessage=function({botMessage:e=null,endChat:i=!1}){const s={actionId:e.actionId,msg:e.msg,ts:new Date(e.ts),name:e.name,role:e.role,profile_image:{path:e.profile_url,color:e.profile_color},ts_html:"",ts_time:"",show_meta:1===e.msgId};""!==s.ts&&"Invalid Date"!==s.ts&&(s.ts_html=this.htmlTime(s.ts),s.ts_time=s.ts.toLocaleTimeString());const n=this.templateEng.render("message_bot.njk",s);this.log.insertAdjacentHTML("beforeend",n),this.scrollLog(),this.play_sound(),e.isError||this.updateBotForm({actionId:e.actionId,responses:e.responses,actionType:e.actionType}),e.actionType===t.ACTION_RATING&&this.showRatingForm(!0,e),i&&this.endBot()},Qt.showPagedOptions=function({actionId:t,actionType:e=0,responses:i=[]}){this.updateBotForm({actionId:t,responses:i,actionType:e})},Qt.skipBot=function(){this.isBotActive=!1,this.model.set("flow_id",""),this.model.set("skip_login",!0),this.render()},Qt.removeMessage=function(t){if(t<=0)return;const e=this.log.querySelector(`li[data-msgid="${t}"]`);if(e){if(!e.classList.contains("chatMsgNoMeta")){const t=e.nextElementSibling;t&&t.classList.remove("chatMsgNoMeta")}e.remove()}},Qt.showPatronMessage=function(t){this.clearTextarea(!0),this.showChatMsg({msg:t,name:"You",role:"user"}),this.scrollLog()},Qt.setEndChatButtonToReload=function(){const t=this.model.get("restart_chat"),e=this.$el.find(".s-lch-btn-end");e.removeClass("hidden"),e.find("i").addClass("fa-repeat").removeClass("fa-times"),e.attr("aria-label",t),e.data("bs.tooltip")&&(e.data("bs.tooltip").options.title=t)},Qt.endChatDisplay=function(t){window.clearTimeout(this.missedChatTime),this.clearFallbackTimeout(),this.setEndChatButtonToReload(),this.model.isEmbed()&&this.el.classList.add("breakfocus"),t&&this.model.get("answered")?(this.disableForm(),!0!==this.model.get("star_ratings")?this.showChatSysMsg({msg:this.model.get("byeMsg")}):this.showRatingForm()):this.showFollowUpMsg()},Qt.chatSubscribeDisplay=function(t){this.disableForm(),window.$("#nologin_message").remove(),this.setConnectState(),""!==this.patronSession.get("client_question")&&this.showChatMsg({msg:this.patronSession.get("client_question"),name:"You",role:"user"}),t===this.model.get("status_away")?this.showChatSysMsg({msg:this.model.getAwayMessage(),id:"msg_away"}):this.showChatSysMsg({msg:this.model.get("wait"),id:""}),this.model.get("contact_request")&&""===this.model.get("client_contact")&&this.showContactRequestForm(),this.setMissedChatTimeout(),this.emitter.trigger("setFirstFallback")},Qt.enableChatting=function(){this.model.get("chatting")&&(this.enableForm(),this.$msgInput.focus(),this.$el.find(".s-lch-btn-trans, .s-lch-btn-file").removeClass("hidden"),this.showPeelButton())},Qt.peeledOutDisplay=function(){this.model.get("peelingParent")&&this.disableForm()},Qt.setConnectState=function(){const t=this.model.get("connected");let e,i;this.model.hasSubscribed?t?(e="connected",i=this.model.get("translation").ch_status_connected):(e="disconnected",i=this.model.get("translation").ch_status_disconnected,this.$el.find(".s-lch-btn-peel, .s-lch-btn-file").addClass("hidden")):(e="connected",i=this.model.get("translation").ch_status_connecting),window.$("#s-lch-status").removeClass("connected disconnected").addClass(e).html(`<span class="sr-only">${this.model.get("translation").ch_status_label}: </span>${i}`)},Qt.showReconnecting=function(){this.showChatSysMsg({msg:this.model.get("translation").ch_connect_lost,id:"msg_reconnecting"})},Qt.showReconnected=function(){this.showChatSysMsg({msg:this.model.get("translation").ch_connect_regained,id:"msg_reconnecting"}),this.enableForm(),this.$el.find(".s-lch-btn-file").removeClass("hidden"),this.showPeelButton()},Qt.showChatError=function(t=""){this.showChatSysMsg({msg:t||this.model.getErrorMessage(),id:"msg_error"})},Qt.showBlockedError=function(t=""){const e=t||this.model.getErrorMessage();this.$el.html(`<p class="alert alert-danger">${e}</p>`)},Qt.showChatAwayStatus=function(){this.showChatSysMsg({msg:this.model.getAwayMessage(),id:"msg_away"}),this.showFollowUpMsg()},Qt.disableForm=function(){this.$msgInput.prop("disabled",!0),this.submitBtn.disabled=!0},Qt.hideForm=function(){this.$form.addClass("hidden")},Qt.showForm=function(){this.$form[0].classList.remove("hidden")},Qt.enableForm=function(){this.$msgInput.prop("disabled",!1),this.submitBtn.disabled=!1},Qt.resetFormForChat=function(){const t=this.$form[0].querySelector(".bot-responses");t&&(t.innerHTML="",t.classList.add("hidden")),this.$form[0].querySelector("#s-lch-post-input").classList.remove("hidden"),this.submitBtn.classList.remove("hidden")},Qt.showView=function(){if(this.$el.removeClass("hidden"),this.model.get("auth_id")>0&&!this.model.get("isAuthValidated"))return this.$el[0].querySelectorAll("input,select,button,textarea").forEach((t=>{t.disabled=!0})),this.$el[0].querySelectorAll('[tabindex="0"],a').forEach((t=>{t.setAttribute("tabindex","-1")})),void this.$el[0].setAttribute("aria-hidden","true");(!this.model.isEmbed()||this.model.get("answered")||this.isBotActive)&&(this.$msgInput.disabled?Pt(this.el):this.$msgInput.focus())},Qt.toggleCloseButton=function(){this.model.isFloat()&&!this.model.peel||this.$el.find(".s-lch-btn-close").addClass("hidden")},Qt.showFileUploadPreview=function(t){const e=t.currentTarget,i=new URL(e.href).pathname.split("/").pop();if(i){t.preventDefault();const e=`/chat/session/${this.patronSession.getChannel()}/upload/${i}/preview`;window.open(e,"_blank")}},Qt.showMessageNotSendable=function(){this.showChatSysMsg({msg:this.model.get("translation").ch_message_unsendable})},Qt.openNewTab=function(t){if(t.defaultPrevented)return;const e=t.currentTarget,i=e.getAttribute("href");if(0===i.indexOf("#"))return;if(this.isBotActive&&e.classList.contains("action_click")){const t=e.closest("[data-actionid]");if(t){const i=Number(t.dataset.actionid||0);i>0&&this.emitter.trigger("bot:click",{actionId:i,url:e.href})}}"_blank"!==e.getAttribute("target")&&(t.preventDefault(),i&&"#"!==i?window.open(i,"_blank"):t.preventDefault())},Qt.render=function(){return this.$el.empty(),this.$el.html(this.templateEng.render("pane_chatting.njk",this.model.toJSON())),this.$form=this.$el.find("#s-lch-post-form"),this.$msgInput=this.$form.find("textarea"),this.submitBtn=this.$form[0].querySelector("button[type=submit]"),this.log=this.el.querySelector("#s-lch-msg-log"),this.$chatTyping=this.$el.find("#istyping"),this.contactForm=null,this.toggleCloseButton(),this.accessibleIcons(),this};const Kt=Qt;class Yt extends HTMLElement{static get props(){return{}}static get observedAttributes(){return Object.keys(this.props).map((t=>this.attributeName(t)))}static attributeName(t){return t.replace(/([a-zA-Z])(?=[A-Z])/g,"$1-").toLowerCase()}constructor(){super(),this.$={},this.attrToProp={},this.propToAttr={},Object.keys(this.constructor.props).forEach((t=>{const e=this.constructor.attributeName(t);this.attrToProp[e]=t,this.propToAttr[t]=e})),this.attachShadow({mode:"open"}),this._renderPromise=null,this._isConnected=!1,this._triggers={},this._props={}}connectedCallback(){if(this._isConnected)return;const t=Object.keys(this.constructor.props).reduce(((t,e)=>({...t,[e]:this[e]})),{});Object.keys(this.constructor.props).forEach((e=>{const i=this.constructor.props[e],s=this.propToAttr[e];let n=this[e];if(this.hasAttribute(s)){if(n=this.getAttribute(s),[Array,Object].includes(i.type))try{n=JSON.parse(n)}catch(t){}}else void 0!==t[e]&&(n=t[e]);Object.defineProperty(this,e,{set:this.setter(e),get:this.getter(e)}),this[e]=n})),this._isConnected=!0,this._render(!0,!0)}disconnectedCallback(){this._isConnected=!1}_requestRender(){this._renderPromise||(this._renderPromise=Promise.resolve().then((()=>{this._render()})))}_render(t=!1,e=!1){(t||Object.keys(this._triggers).length)&&(this._renderPromise=Promise.resolve().then((()=>{e&&(this.firstRender(this.shadowRoot,this._triggers),this.$=[...this.shadowRoot.querySelectorAll("[id]")].reduce(((t,e)=>({...t,[e.id]:e})),{}),this.firstRendered(this.shadowRoot,this._triggers)),this.render(this.shadowRoot,this._triggers),this.rendered(this.shadowRoot,this._triggers),this._renderPromise=null,this._triggers={}})))}forceRender(){this._render(!0)}firstRender(){}render(){}firstRendered(){}rendered(){}setter(t){const e=this.propToAttr[t];return i=>{if(this._props[t]===i)return;t in this._triggers||(this._triggers[t]=this._props[t]),this._props[t]=i;const s=this.constructor.props[t];if(this._isConnected&&this.constructor.observedAttributes.includes(e)){let t=i;s.type===Boolean?(t=t||""===t,t?this.setAttribute(e,""):this.removeAttribute(e)):([Array,Object].includes(s.type)&&(t=JSON.stringify(t)),this.getAttribute(e)!==t&&([null,void 0].includes(t)?this.removeAttribute(e):this.setAttribute(e,t)))}this._isConnected&&this._requestRender()}}getter(t){return()=>this._props[t]}attributeChangedCallback(t,e,i){const s=this.attrToProp[t];let n=i;switch(this.constructor.props[s].type){case Boolean:n=""===n;break;case Number:n=Number(n);break;case Array:case Object:try{n=JSON.parse(n)}catch(t){}}this[s]!==n&&(this[s]=n)}}const Jt=Yt;const Zt=class extends Jt{static get props(){return{date:{type:String},time:{type:String},value:{type:Object},showTime:{type:Boolean},confirmOnDate:{type:Boolean},locale:{type:String},dateStyle:{type:Object},startYear:{type:Number},endYear:{type:Number},startDay:{type:Number},defaultDate:{type:String},defaultTime:{type:String},hasNative:{type:Boolean},useNative:{type:Boolean},alignTop:{type:Boolean},alignRight:{type:Boolean}}}constructor(){super();const t=new Date;this.showTime=!1,this.confirmOnDate=!1,this.alignTop=!1,this.alignRight=!1,this.dateStyle={},this.startYear=t.getFullYear()-100,this.endYear=t.getFullYear()+5,this.startDay=1;try{const t=document.createElement("input");t.type="date",this.hasNative="date"===t.type}catch(t){this.hasNative=!1}this.onLabelClick=this.onLabelClick.bind(this),this.onClickOutside=this.onClickOutside.bind(this)}connectedCallback(){super.connectedCallback(),document.addEventListener("click",this.onClickOutside)}disconnectedCallback(){super.disconnectedCallback(),this._dateInput&&[...this._dateInput.labels||[]].forEach((t=>{t.removeEventListener("click",this.onLabelClick)})),document.removeEventListener("click",this.onClickOutside)}firstRender(t){const e=document.createElement("template");e.innerHTML='\n      <style>\n        :host {\n          position: relative;\n\n          --rgb: var(--aeon-rgb, 0, 0, 0);\n          --bgRgb: var(--aeon-bgRgb, 255, 255, 255);\n          --color: rgb(var(--rgb));\n          --hintColor: rgba(var(--rgb), 0.2);\n          --bgColor: rgb(var(--bgRgb));\n\n          color: var(--color);\n        }\n\n        ::slotted(input[type=date]),\n        ::slotted(input[type=time]) {\n          display: none;\n        }\n\n        :host([has-native][use-native]) ::slotted(input[type=date]),\n        :host([has-native][use-native]) ::slotted(input[type=time]) {\n          display: inline-flex;\n        }\n\n        :host([has-native][use-native]) slot[name=output] {\n          display: none;\n        }\n\n        aeon-calendar {\n            position: absolute;\n            top: 100%;\n            left: 0;\n            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);\n            border: 1px solid rgba(0, 0, 0, 0.15);\n            border-radius: 4px;\n            background-clip: padding-box;\n            padding: 12px;\n        }\n\n        :host([align-top]) aeon-calendar {\n          top: auto;\n          bottom: 100%;\n        }\n\n        :host([align-right]) aeon-calendar {\n          left: auto;\n          right: 0;\n        }\n\n        @media (max-width: 640px) {\n          aeon-calendar,\n          :host([align-top]) aeon-calendar,\n          :host([align-right]) aeon-calendar {\n            position: fixed;\n            top: 0;\n            left: 0;\n            bottom: 0;\n            right: 0;\n          }\n        }\n      </style>\n\n      <slot></slot>\n      <slot name="output"></slot>\n\n      <aeon-calendar id="calendar"></aeon-calendar>\n    ',t.appendChild(e.content.cloneNode(!0))}firstRendered(t){const e=t.querySelector("slot");e.addEventListener("slotchange",(()=>{const t=e.assignedNodes().filter((t=>t.nodeType!==Node.TEXT_NODE));this._dateInput=t.find((t=>"date"===t.getAttribute("type"))),this._dateInput&&(this._output.placeholder=this._dateInput.placeholder,(this._dateInput.labels||[]).forEach((t=>{t.addEventListener("click",this.onLabelClick)})),this.date=this._dateInput.value),this._timeInput=t.find((t=>"time"===t.getAttribute("type"))),this._timeInput&&(this.showTime=!0,this.time=this._timeInput.value)})),this._output=document.createElement("input"),this._output.slot="output",this._output.readOnly=!0,this._output.addEventListener("click",(()=>{this.openCalendar()})),this.appendChild(this._output),this.addEventListener("keyup",(t=>{if(t.stopPropagation(),"Enter"===t.key)this.$.calendar.open||this.openCalendar()})),this.$.calendar.addEventListener("change",(t=>{this.date=t.target.value.date,this.time=t.target.value.time,this.closeCalendar()})),this.$.calendar.addEventListener("clear",(()=>{this.date=""})),this.$.calendar.addEventListener("close",(()=>{this._dontFocus||this._output.focus(),this._dontFocus=!1}))}render(t,e){("date"in e||"time"in e)&&(this.value={date:this.date,time:this.time},this.updateFromString(this.date,this.time),this.dispatchEvent(new Event("change",{bubbles:!0}))),("locale"in e||"startYear"in e||"endYear"in e||"startDay"in e||"showTime"in e||"confirmOnDate"in e)&&this.updateFromString(this.date,this.time)}update(t=null){const e=t&&!isNaN(t);let i=t;if(!e){t=this.defaultDate;const e=this.defaultTime;i=this.parseDate(t,e)}const s=this.$.calendar;if(s.year=i.getFullYear(),s.month=i.getMonth(),s.day=i.getDate(),s.hours=i.getHours(),s.minutes=i.getMinutes(),s.locale=this.locale,s.startYear=this.startYear,s.endYear=this.endYear,s.startDay=this.startDay,s.showTime=this.showTime,s.confirmOnDate=this.confirmOnDate,e){const e=new Intl.DateTimeFormat(this.locale||void 0,{year:"numeric",month:"numeric",day:"numeric",...this.showTime?{hour:"numeric",minute:"numeric"}:{},...this.dateStyle}).format(t);this._output.value=e,this._dateInput&&(this._dateInput.value=this.date),this._timeInput&&(this._timeInput.value=this.time)}else this._output.value="",this._dateInput&&(this._dateInput.value=""),this._timeInput&&(this._timeInput.value="")}openCalendar(){const t=this.getBoundingClientRect(),e=t.top,i=window.innerHeight-t.bottom;this.alignTop=i<e,this.$.calendar.open=!0}closeCalendar(t=!1){this.$.calendar.open=!1,this._dontFocus=t}parseDate(t,e){try{const i=t.split("-"),s=(e||this.defaultTime||"00:00").split(":");return new Date(i[0],parseInt(i[1],10)-1,i[2],s[0],s[1])}catch(t){return new Date}}updateFromString(t,e){this.update(this.parseDate(t,e))}onLabelClick(t){this.useNative&&this.hasNative||(t.preventDefault(),this._output.focus())}onClickOutside(t){if(this.$.calendar.open){!t.composedPath().some((t=>t===this))&&this.closeCalendar(!0)}}};const Xt=class extends Jt{static get props(){return{value:{type:Number},items:{type:Array}}}constructor(){super(),this.items=[]}firstRender(t){const e=document.createElement("template");e.innerHTML='\n      <style>\n        select {\n          -webkit-appearance: none;\n          -moz-appearance: none;\n          padding: 0.5rem;\n          padding-right: 1.5rem;\n          font-family: inherit;\n          font-size: inherit;\n          border-radius: 0;\n          border: 1px solid var(--hintColor);\n          background-color: transparent;\n          color: var(--color);\n          width: 100%;\n        }\n\n        select::-ms-expand {\n          display: none;\n        }\n\n        .select {\n          position: relative;\n        }\n\n        .select .indicator {\n          position: absolute;\n          top: 0;\n          bottom: 0;\n          right: 0.2rem;\n          pointer-events: none;\n          display: flex;\n          align-items: center;\n        }\n      </style>\n\n      <div class="select">\n        <select id="select">\n        </select>\n        <span class="indicator">\n          <svg width="24" height="24">\n            <g><path fill="currentColor" d="M7 10l5 5 5-5z"></path></g>\n          </svg>\n        </span>\n      </div>\n    ',t.appendChild(e.content.cloneNode(!0))}focus(){this.$.select.focus()}firstRendered(){this.$.select.addEventListener("change",(t=>{this.value=t.target.value}))}render(t,e){"value"in e&&this.dispatchEvent(new Event("change",{bubbles:!0})),this.$.select.innerHTML=this.items.map((t=>`<option value="${t.value}">${t.name}</option>`)).join(""),this.$.select.value=this.value}};const te=class extends Jt{static get props(){return{date:{type:String},time:{type:String},value:{type:Object},showTime:{type:Boolean},confirmOnDate:{type:Boolean},locale:{type:String},startYear:{type:Number},endYear:{type:Number},startDay:{type:Number},year:{type:Number},month:{type:Number},day:{type:Number},hours:{type:Number},minutes:{type:Number},open:{type:Boolean}}}constructor(){super(),this.showTime=!1,this.confirmOnDate=!1,this.open=!1}connectedCallback(){super.connectedCallback(),this.addEventListener("keydown",this.onKeyDown.bind(this))}firstRender(t){const e=document.createElement("template");e.innerHTML='\n      <style>\n        :host {\n          display: none;\n          flex-direction: column;\n          align-items: center;\n          justify-content: center;\n          position: relative;\n          z-index: 3;\n          padding: 0.2rem;\n          background-color: var(--bgColor);\n        }\n\n        :host([open]) {\n          display: flex;\n        }\n\n        .week {\n          display: flex;\n          align-items: center;\n          justify-content: center;\n        }\n\n        .day, .date, button {\n          color: var(--color);\n          background-color: transparent;\n          border: 0;\n          box-sizing: border-box;\n          width: 33px;\n          height: 33px;\n          padding: 0;\n          font-family: inherit;\n          font-size: calc(2.8em / 3);\n\n          text-transform: uppercase;\n\n          flex-grow: 0;\n          display: flex;\n          flex-direction: column;\n          align-items: center;\n          justify-content: center;\n          cursor: pointer;\n        }\n\n        .date {\n          border: 1px solid var(--hintColor);\n          border-width: 0 0 1px 1px;\n        }\n\n        .date:last-child {\n          border-right-width: 1px;\n        }\n\n        .date.last + .spacer {\n          border-left-width: 1px;\n        }\n\n        .week:nth-child(2) .date:not(.spacer) {\n          border-top-width: 1px;\n        }\n\n        .week:last-child .spacer {\n          border-right-width: 0;\n          border-bottom-width: 0;\n        }\n\n        .date.today {\n            font-weight: bold;\n            background-image: linear-gradient(to bottom, #0088cc, #0044cc);\n            background-repeat: repeat-x;\n            border-color: #0044cc #0044cc #002a80;\n            color: #fff;\n            font-size: 1.3rem;\n        }\n\n        .date.spacer {\n          border-left-width: 0;\n          pointer-events: none;\n        }\n\n        #buttons {\n          width: 100%;\n          display: flex;\n          justify-content: space-between;\n          margin-top: 0.5em;\n          padding-top: 0.5em;\n          border-top: 1px solid var(--hintColor);\n        }\n\n        #year-month, #hours-minutes {\n          display: flex;\n          width: 100%;\n        }\n\n        #year-month aeon-select {\n          width: 50%;\n        }\n\n        #year-month aeon-select + aeon-select {\n          margin-left: 0.5em;\n        }\n\n        #hours-minutes {\n          padding-top: 0.5em;\n          margin-top: 0.5em;\n          border-top: 1px solid var(--hintColor);\n          display: none;\n          justify-content: center;\n          align-items: center;\n        }\n\n        #hours-minutes aeon-select {\n          width: 3.5em;\n        }\n\n        #hours-minutes aeon-select#hours {\n          margin-right: 0.2em;\n        }\n\n        #hours-minutes aeon-select#minutes {\n          margin-left: 0.2em;\n        }\n\n        :host([show-time]) #hours-minutes {\n          display: flex;\n        }\n      </style>\n\n      <div id="container">\n        <div id="year-month">\n          <aeon-select id="month"></aeon-select>\n          <aeon-select id="year"></aeon-select>\n        </div>\n        <div id="calendar"></div>\n        <div id="hours-minutes">\n          <aeon-select id="hours"></aeon-select>:<aeon-select id="minutes"></aeon-select>\n        </div>\n        <div id="buttons">\n          <button id="confirm" title="Confirm">\n            <svg width="24" height="24">\n              <g><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></g>\n            </svg>\n          </button>\n          <button id="clear" title=\'Clear\'>\n            Clear\n          </button>\n          <button id="cancel" title="Cancel">\n            <svg width="24" height="24">\n              <g><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></g>\n            </svg>\n          </button>\n        </div>\n      </div>\n    ',t.appendChild(e.content.cloneNode(!0))}firstRendered(){this.addEventListener("keyup",(t=>{if(t.stopPropagation(),"Escape"===t.key)this.open=!1})),this.$.year.addEventListener("change",(t=>{this.year=t.target.value})),this.$.month.addEventListener("change",(t=>{this.month=t.target.value})),this.$.hours.items=[];for(let t=0;t<24;t++)this.$.hours.items.push({name:`${t}`.padStart(2,"0"),value:t});this.$.hours.addEventListener("change",(t=>{this.hours=t.target.value})),this.$.minutes.items=[];for(let t=0;t<60;t++)this.$.minutes.items.push({name:`${t}`.padStart(2,"0"),value:t});this.$.minutes.addEventListener("change",(t=>{this.minutes=t.target.value})),this.$.calendar.addEventListener("click",this.onDateClick.bind(this)),this.$.cancel.addEventListener("click",(()=>{this.open=!1})),this.$.confirm.addEventListener("click",(()=>{this.confirm()})),this.$.clear.addEventListener("click",(()=>{this.dispatchEvent(new Event("clear",{bubbles:!0})),this.open=!1}))}render(t,e){"open"in e&&!1===this.open&&!0===e.open&&this.dispatchEvent(new Event("close",{bubbles:!0})),("year"in e||"month"in e||"day"in e)&&(this.date=this.formatAsDate(this.year,this.month,this.day)),("hours"in e||"minutes"in e)&&(this.time=this.formatAsTime(this.hours,this.minutes));const i=new Date;i.setMonth(0),i.setDate(1),this.$.year.value=this.year,this.$.year.items=[];for(let t=this.startYear;t<=this.endYear;t++)this.$.year.items.push({value:t,name:t});this.$.month.value=this.month,this.$.month.items=[];for(let t=0;t<12;t++){const e=i.getMonth();this.$.month.items.push({value:e,name:i.toLocaleString(this.locale||void 0,{month:"short"})}),i.setMonth(t+1)}this.$.month.items.sort(((t,e)=>t.num-e.num)),i.setMonth(0),i.setDate(1);const s=[];for(let t=0;t<7;t++){const e=i.getDay();s.push({num:e,name:i.toLocaleString(this.locale||void 0,{weekday:"short"})}),i.setDate(t+2)}const n=7-this.startDay;s.sort(((t,e)=>(t.num+n)%7-(e.num+n)%7)),this.$.hours.value=this.hours,this.$.minutes.value=this.minutes;let r=new Date(this.year,this.month,1,12);const o=r.getDay();r.setMonth(r.getMonth()+1),r.setDate(0);const a=r.getDate();r=new Date(this.year,this.month,1,12);let h=!1,l=!1,c=0;this.$.calendar.innerHTML=`\n      <div class="week">\n        ${s.map((t=>`<div class="day">${t.name}</div>`)).join("")}\n      </div>\n\n      ${[0,1,2,3,4,5].map((()=>c>=a?null:`\n          <div class="week">\n            ${s.map((t=>{t.num%7===o&&(h=!0);let e="";h&&(c+=1,c<=a?(e=c,r.setDate(e)):l=!0);return`\n                  <button class="date ${c===this.day?"today":""} ${!h||l?"spacer":""} ${c===a?"last":""}" data-day="${c}" ${!h||l?'tabindex="-1" disabled':""}>${e}</button>\n              `})).join("")}\n          </div>\n         `)).join("")}\n    `;const u=t.querySelectorAll("button:not([disabled]), aeon-select");this._firstFocusableEl=u[0],this._lastFocusableEl=u[u.length-1]}rendered(t,e){!0===this.open&&("open"in e&&!1===e.open||"day"in e)&&t.querySelector(".today").focus()}confirm(){this.date=this.formatAsDate(this.year,this.month,this.day),this.time=this.formatAsTime(this.hours,this.minutes),this.value={date:this.date,time:this.time},this.dispatchEvent(new Event("change",{bubbles:!0}))}handleTabKey(t){const e=this.shadowRoot.activeElement;t.shiftKey&&e===this._firstFocusableEl?(this._lastFocusableEl.focus(),t.preventDefault()):t.shiftKey||e!==this._lastFocusableEl||(this._firstFocusableEl.focus(),t.preventDefault())}handleArrowKeys(t){let e=0;switch(t.key){case"ArrowUp":e=-7;break;case"ArrowRight":e=1;break;case"ArrowLeft":e=-1;break;case"ArrowDown":e=7}const i=new Date(this.year,this.month,this.day);i.setDate(this.day+e),this.year=i.getFullYear(),this.month=i.getMonth(),this.day=i.getDate()}onKeyDown(t){"Enter"===t.key?this.confirm():"Tab"===t.key?this.handleTabKey(t):["ArrowUp","ArrowRight","ArrowDown","ArrowLeft"].includes(t.key)&&this.handleArrowKeys(t)}onDateClick(t){if(t.target.classList.contains("date")){const e=t.target;this.day=parseInt(e.dataset.day,10),this.confirmOnDate&&!this.showTime&&this.confirm()}}formatAsDate(t,e,i){return`${t}-${`${e+1}`.padStart(2,"0")}-${`${i}`.padStart(2,"0")}`}formatAsTime(t,e){return`${`${t}`.padStart(2,"0")}:${`${e}`.padStart(2,"0")}`}};customElements.get("aeon-select")||customElements.define("aeon-select",Xt),customElements.get("aeon-calendar")||customElements.define("aeon-calendar",te),customElements.get("aeon-datepicker")||customElements.define("aeon-datepicker",Zt);class ee{constructor({type:t=0,start:e=null,end:i=null,offhours:s=null,captchaAlwaysOn:n=!1,libauth_enabled:r=!1}){this.type=t,this.start=e,this.end=i,this.offhours=s,this.captchaAlwaysOn=n,this.libauth_enabled=r}isCaptchaEnabled(){return!this.libauth_enabled&&(!!this.captchaAlwaysOn||this.isAutoReplyEnabled())}isAutoReplyEnabled(){return 0!==this.type&&(1===this.type||(3===this.type?this._isBetweenDates():2===this.type&&this._isNowOffHours()))}getAutoReplyType(){return this.type}_isBetweenDates(){if(!this.end||!this.start)return!1;const t=Math.floor(Date.now()/1e3);return t>=this.start&&t<=this.end}_isNowOffHours(){return!0}}const ie=Object.freeze({RULE_OPERATOR_EQUALS:0,RULE_OPERATOR_NOTEQUALS:1,RULE_OPERATOR_INCLUDES:2,RULE_OPERATOR_INCLUDES_ALL:3,RULE_ACTION_SHOW:0,RULE_ACTION_HIDE:1,RULE_ACTION_NONE:-1});class se{constructor({field1:t=0,operator:e=ie.RULE_OPERATOR_EQUALS,value:i=[],field2:s=0,action:n=ie.RULE_ACTION_SHOW}){this.field1=t,this.operator=e,this.value=Array.isArray(i)?i:[],this.field2=s,this.action=n}get oppositeAction(){return this.action===ie.RULE_ACTION_SHOW?ie.RULE_ACTION_HIDE:ie.RULE_ACTION_SHOW}getFieldAction(t){if(0===t||0===t.length)return ie.RULE_ACTION_HIDE;switch(this.operator){case ie.RULE_OPERATOR_EQUALS:return this.value.includes(t)?this.action:this.oppositeAction;case ie.RULE_OPERATOR_NOTEQUALS:return this.value.includes(t)?this.oppositeAction:this.action;case ie.RULE_OPERATOR_INCLUDES:return Array.isArray(t)?t.filter((t=>this.value.includes(t))).length>0?this.action:this.oppositeAction:ie.RULE_ACTION_NONE;case ie.RULE_OPERATOR_INCLUDES_ALL:return Array.isArray(t)?t.filter((t=>this.value.includes(t))).length===this.value.length?this.action:this.oppositeAction:ie.RULE_ACTION_NONE}return ie.RULE_ACTION_NONE}}class ne{constructor({form_action:t="",content_id:e=0,queue_id:i=0,errormsg:s={},translations:n={},libauth_authed:r=!1,libauth_enabled:o=!1,autoReplySettings:a={},rules:h=[]}){this.form_action=t,this.divselector=`#s-la-askform-${e}`,this.queue_id=Number(i),this.errormsg=s,this.translations=n,this.libauth_authed=!!r,this.libauth_enabled=!!o,this.autoReplySettings=a instanceof ee?a:new ee(a),this.successCallback=null,this.failureCallback=null,Array.isArray(h)&&(this.rules=h.map((t=>new se(t))))}setSuccessCallback(t){"function"==typeof t&&(this.successCallback=t)}setFailureCallback(t){"function"==typeof t&&(this.failureCallback=t)}handleRequiredCheckBoxes(t){const e=t.target.name;if(!0===t.target.checked){const t=this.form.querySelectorAll(`input[type=checkbox][name="${e}"]`);return void(t.length>0&&t.forEach((t=>{t.removeAttribute("required")})))}const i=t.target.closest("fieldset");if(null===i)return;i.querySelectorAll("input[type=checkbox]:checked").length>0||i.querySelectorAll("input[type=checkbox]").forEach((t=>{t.setAttribute("required","")}))}markError(t,e){if(!t)return;const i=document.createElement("div");i.classList.add("error-message"),i.innerHTML=e;const s=t.closest("div.form-group");if(null===s)return;t.setAttribute("aria-invalid","true"),s.classList.add("has-error");const n=s.querySelector("label");n&&n.appendChild(i)}loadCaptcha(){const t=new URL(this.form_action,`https://${window.location.hostname}`),e=new URLSearchParams;e.append("queue_id",this.queue_id),e.append("auto_type",this.autoReplySettings.type),fetch(`https://${t.hostname}/form/libcpt?${e}`,{method:"GET",mode:"cors",credentials:"omit",cache:"no-cache"}).then((t=>t.json())).then((({html:t="",isNowOffHours:e=!1,isCaptchaAlwaysOn:i=!1})=>{if(2===this.autoreply_type&&(e||(this.autoreply_enabled=!1,this.confirmEmailDiv&&(this.confirmEmailDiv.querySelector('input[type="checkbox"]').disabled=!1,this.confirmEmailDiv.classList.remove("hidden"))),!t||!i&&!this.autoreply_enabled))return void this.captchaDiv.classList.add("hidden");this.captchaDiv.innerHTML=t,this.captchaDiv.classList.add("active"),this.captchaDiv.classList.remove("hidden");const s=this.captchaDiv.querySelector(".btn-cptreload");s&&s.addEventListener("click",this.loadCaptcha.bind(this))})).catch((()=>{this.captchaDiv.classList.add("hidden")}))}validateField(t){if(!t||t.disabled)return;if("SELECT"===t.tagName){const e=t.options[t.selectedIndex]||null;if(!e)return;const i=e.value;return void(""!==i&&"0"!==i||this.markError(t,this.errormsg.reqfields))}if("TEXTAREA"===t.tagName)return void(""===t.value.trim()&&this.markError(t,this.errormsg.reqfields));if("INPUT"!==t.tagName)return;const e=t.type;if("radio"!==e&&"checkbox"!==e)if("email"!==e)""===t.value.trim()&&this.markError(t,this.errormsg.reqfields);else if(t.checkValidity()||this.markError(t,this.errormsg.emailaddress),"confirm_pemail"===t.name){const e=this.form.querySelector('input[name="pemail"]');t.value.trim()!==e.value.trim()&&this.markError(t,this.errormsg.emailnotmatch)}}validateFieldSet(t){const e=t.querySelectorAll("input");let i=!0;if(e.forEach((t=>{t.checkValidity()||(i=!1,t.setAttribute("aria-invalid","true"))})),i)return;const s=document.createElement("div");s.classList.add("error-message"),s.innerHTML=this.errormsg.reqfields,t.classList.add("has-error");const n=t.querySelector("legend");n&&n.appendChild(s)}validate(){return!(this.libauth_enabled&&!this.libauth_authed)&&(this.form.setAttribute("action",this.form_action),this.form.querySelectorAll("label .error-message, legend .error-message").forEach((t=>{t.remove()})),this.form.querySelectorAll(".form-group").forEach((t=>{t.classList.remove("has-error")})),this.form.querySelectorAll(".form-control, input[type=radio], input[type=checkbox]").forEach((t=>{t.setAttribute("aria-invalid",!1)})),this.form.querySelectorAll("[required]").forEach((t=>{this.validateField(t)})),this.form.querySelectorAll("fieldset[data-required]").forEach((t=>{this.validateFieldSet(t)})),!(this.form.querySelectorAll(".has-error").length>0)||(this.form.querySelector("*[aria-invalid=true]")?.focus(),!1))}createDismissableAlert(t,e){const i=document.createElement("div");i.classList.add("alert",`alert-${e}`,"alert-dismissable"),i.setAttribute("role","alert");const s=document.createElement("button");return s.type="button",s.classList.add("close"),s.setAttribute("aria-label","close"),s.innerHTML='<span aria-hidden="true">&times;</span>',i.appendChild(s),i.insertAdjacentHTML("beforeend",t),s.addEventListener("click",(t=>{t.preventDefault(),i.remove()})),i}setName(t){const e=this.form?.querySelector('input[name="pname"]');e&&(e.value=t)}setEmail(t){const e=this.form?.querySelector('input[name="pemail"]');e&&(e.value=t)}resetRules(){this.rules.forEach((t=>{this.form.querySelectorAll(`*[name="${t.field1}"], *[name="${t.field1}[]"]`).forEach((t=>{t.dispatchEvent(new Event("change"))}))}))}instantiateForm(){this.questionform=new zt({form:this.form,max_files:5,max_upload_size:20971520,max_file_size:20971520,batch_files:!1,autoupload:!1,translations:this.translations,callback:({message:t="",errors:e=[],ticket_id:i=0})=>{const s=this.createDismissableAlert(t,"success");this.form.querySelector("#s-la-askform-buttons").insertAdjacentElement("beforebegin",s),this.questionform.reset(),this.resetRules(),this.captcha_enabled&&this.loadCaptcha(),this.autoreply_enabled&&this.confirmEmailDiv&&(this.confirmEmailDiv.querySelector('input[type="checkbox"]').disabled=!0,this.confirmEmailDiv.classList.add("hidden")),this.successCallback&&this.successCallback({message:t,errors:e,ticket_id:i})},error_callback:t=>{let e="Error";const i=449===t.status;if(t.responseText)try{const i=JSON.parse(t.responseText);i.error&&(e=i.error)}catch(t){e="Invalid response received"}const s=this.createDismissableAlert(e,"danger");let n=null,r="beforebegin";i&&(n=this.form.querySelector(".formlibcpt"),n&&(r="afterbegin")),n||(n=this.form.querySelector("#s-la-askform-buttons")),n.insertAdjacentElement(r,s),this.failureCallback&&this.failureCallback()},validate:this.validate.bind(this)}),this.questionform.init()}showField(t){t.classList.remove("hidden"),t.querySelectorAll("select, input, textarea").forEach((t=>{t.disabled=!1}))}hideField(t){t.classList.add("hidden"),t.querySelectorAll("select, input, textarea").forEach((t=>{["checkbox","radio"].includes(t.type)?t.checked=!1:t.value="",t.dispatchEvent(new Event("change")),t.disabled=!0}))}getMultiCheckValue(t){const e=new FormData(this.form);return Array.from(e.getAll(t)).map((t=>Number(t)))}getRadioValue(t){const e=new FormData(this.form);return Number(e.get(t))}setUpRules(){this.rules.forEach((t=>{this.form.querySelectorAll(`*[name="${t.field1}"], *[name="${t.field1}[]"]`).forEach((e=>{const i=this.form.querySelector(`.${t.field2}_wrap`);i&&e.addEventListener("change",(e=>{let s=Number(e.target.value);"checkbox"===e.target.type?s=this.getMultiCheckValue(e.target.name):"radio"===e.target.type&&(s=this.getRadioValue(e.target.name));const n=t.getFieldAction(s);n===ie.RULE_ACTION_SHOW?this.showField(i):n===ie.RULE_ACTION_HIDE&&this.hideField(i)}))}))}))}setUp(t=null){if(this.container=t||document.querySelector(this.divselector),!this.container)return;if(this.form=this.container.querySelector("form"),!this.form)return;if(this.captcha_enabled=this.autoReplySettings.isCaptchaEnabled(),this.autoreply_enabled=this.autoReplySettings.isAutoReplyEnabled(),this.captchaDiv=this.form.querySelector(".formlibcpt"),this.confirmEmailDiv=this.form.querySelector(".confem_wrap"),this.autoreply_type=this.autoReplySettings.getAutoReplyType(),this.captcha_enabled&&this.captchaDiv.classList.remove("hidden"),this.instantiateForm(),this.libauth_enabled&&!this.libauth_authed){if(this.form.querySelectorAll("input,select,button,textarea").forEach((t=>{t.disabled=!0})),this.form.querySelectorAll('[tabindex="0"],a').forEach((t=>{t.setAttribute("tabindex","-1")})),this.form.setAttribute("aria-hidden","true"),window!==window.top){const t=this.container.querySelector(".btn-libauth");t&&t.setAttribute("target","_blank")}return}this.setUpRules();const e=this.form.querySelectorAll("input[type=checkbox][required]");e.length>0&&e.forEach((t=>{t.addEventListener("change",this.handleRequiredCheckBoxes.bind(this))})),this.captcha_enabled&&this.loadCaptcha(),this.autoreply_enabled&&this.confirmEmailDiv&&(this.confirmEmailDiv.querySelector('input[type="checkbox"]').disabled=!0,this.confirmEmailDiv.classList.add("hidden"))}}const re=Object.create(Mt);re.events={keydown:"trapFocus"},re.initialize=function({model:t,patronSession:e,emitter:i}){this.patronSession=e,this.emitter=i,this.init({model:t,el:document.getElementById("qform")})},re.showView=function(){this.el.classList.remove("hidden"),Pt(this.el)},re.render=function({html:t,errormsg:e,translations:i,autoReplySettings:s,action:n,rules:r}){this.$el.empty(),this.el.innerHTML=t,this.questionform=new ne({form_action:`/chat/bot/session/${this.patronSession.getChannel()}/formticket`,queue_id:n.subType,errormsg:e,translations:i,autoReplySettings:s,rules:r}),this.questionform.setSuccessCallback((({ticket_id:t=0})=>{this.emitter.trigger("changeView","chat"),this.emitter.trigger("bot:ticket:success",{action:n,ticket_id:t})})),this.questionform.setUp(),this.questionform.setName(this.patronSession.get("name")),this.questionform.setEmail(this.patronSession.get("client_contact"));const o=this.model.get("auth_id");if(o>0){const t=this.el.querySelector('input[name="alt_auth_id"]');t&&(t.value=o)}return this.el.querySelectorAll(".btn-cancel").forEach((t=>{t.addEventListener("click",(()=>{this.emitter.trigger("changeView","chat"),this.emitter.trigger("bot:ticket:cancel",{action:n})}))})),this};const oe=re,ae=Object.create(Mt);ae.submitted=!1,ae.preview=!1,ae.events={keydown:"trapFocus"},ae.initialize=function({model:t,patronSession:e,emitter:i,preview:s=!1}){this.patronSession=e,this.emitter=i,this.init({model:t,el:document.getElementById("bform")}),this.preview=s},ae.showView=function(){this.el.classList.remove("hidden");const t=this.el.querySelector("input, textarea, select, a, button, [tabindex]");t&&t.focus()},ae.handleRequiredCheckBoxes=function(t){const e=t.target.name;if(!0===t.target.checked){const t=this.el.querySelectorAll(`input[type=checkbox][name="${e}"]`);return void(t.length>0&&t.forEach((t=>{t.removeAttribute("required")})))}const i=t.target.closest("fieldset");if(null===i)return;i.querySelectorAll("input[type=checkbox]:checked").length>0||i.querySelectorAll("input[type=checkbox]").forEach((t=>{t.setAttribute("required","")}))},ae.markError=function(t,e){if(!t)return;const i=document.createElement("div");i.classList.add("error-message"),i.innerHTML=e;const s=t.closest("div.form-group");if(null===s)return;t.setAttribute("aria-invalid","true"),s.classList.add("has-error");const n=s.querySelector("label");n&&n.appendChild(i)},ae.validateField=function(t){if(!t||t.disabled)return;if("SELECT"===t.tagName){const e=t.options[t.selectedIndex]||null;if(!e)return;const i=e.value;return void(""!==i&&"0"!==i||this.markError(t,this.model.get("translation").ch_required_field))}if("TEXTAREA"===t.tagName)return void(""===t.value.trim()&&this.markError(t,this.model.get("translation").ch_required_field));if("INPUT"!==t.tagName)return;const e=t.type;"radio"!==e&&"checkbox"!==e&&""===t.value.trim()&&this.markError(t,this.model.get("translation").ch_required_field)},ae.validateFieldSet=function(t){const e=t.querySelectorAll("input");let i=!0;if(e.forEach((t=>{t.checkValidity()||(i=!1,t.setAttribute("aria-invalid","true"))})),i)return;const s=document.createElement("div");s.classList.add("error-message"),s.innerHTML=this.model.get("translation").ch_required_field,t.classList.add("has-error");const n=t.querySelector("legend");n&&n.appendChild(s)},ae.validate=function(){return this.el.querySelectorAll("label .error-message, legend .error-message").forEach((t=>{t.remove()})),this.el.querySelectorAll(".form-group").forEach((t=>{t.classList.remove("has-error")})),this.el.querySelectorAll(".form-control, input[type=radio], input[type=checkbox]").forEach((t=>{t.setAttribute("aria-invalid",!1)})),this.el.querySelectorAll("[required]").forEach((t=>{this.validateField(t)})),this.el.querySelectorAll("fieldset[data-required]").forEach((t=>{this.validateFieldSet(t)})),!(this.el.querySelectorAll(".has-error").length>0)||(this.el.querySelector("*[aria-invalid=true]")?.focus(),!1)},ae.createDismissableAlert=function(t,e){const i=document.createElement("div");i.classList.add("alert",`alert-${e}`,"alert-dismissable"),i.setAttribute("role","alert");const s=document.createElement("button");return s.classList.add("close"),s.setAttribute("aria-label","close"),s.innerHTML='<span aria-hidden="true">&times;</span>',i.appendChild(s),i.insertAdjacentHTML("beforeend",t),s.addEventListener("click",(t=>{t.preventDefault(),i.remove()})),i},ae.submitBooking=function(t,e){if(t.preventDefault(),this.submitted)return;if(!this.validate())return;this.submitted=!0;const i=t.target;if(this.preview)return this.emitter.trigger("bot:booking:success",{action:e}),void this.emitter.trigger("changeView","chat");fetch(i.action,{method:"POST",mode:"no-cors",credentials:"omit",cache:"no-cache",body:new FormData(i)}).then((t=>t.json())).then((({id:t=0,error:i=""})=>{if(i||0===t)throw new Error(i);this.emitter.trigger("bot:booking:success",{action:e}),this.emitter.trigger("changeView","chat")})).catch((t=>{const e=this.createDismissableAlert(t.message,"danger");this.el.querySelector('button[type="submit"]').parentElement.insertAdjacentElement("beforebegin",e),this.submitted=!1}))},ae.render=function({action:t,html:e=""}){this.$el.empty(),this.el.innerHTML=e,this.el.querySelector("form")?.addEventListener("submit",(e=>{this.submitBooking(e,t)}));const i=this.patronSession.get("client_contact");if(i){const t=this.el.querySelector('form input[name="email"]');t&&(t.value=i)}return this.el.querySelector(".btn-cancel").addEventListener("click",(()=>{this.emitter.trigger("bot:booking:cancel",{action:t}),this.emitter.trigger("changeView","chat")})),this.el.querySelectorAll("input[type=checkbox][required]").forEach((t=>{t.addEventListener("change",this.handleRequiredCheckBoxes.bind(this))})),this};const he=ae,le={model:null,socketIoUrl:null,cascadeServer:"",altCascadeServer:"",cascade:null,eventEmitter:null,nunjucks:null,patronSession:null,attemptedFallbackCoops:[],operatorsList:[],views:{},departments:{},botController:null,typing_end_timeout:null,is_typing_currently:!1,disconnects:[],disconnectTimeThreshold:15,disconnectCountThreshold:2,transports:["websocket"],saveSessionId:function(){const t=this.patronSession.get("sessionId");if(""===t)return;const e={sessionId:t,date:Math.floor(Date.now()/1e3),iid:Number(this.patronSession.get("iid")),widgetId:this.model.get("id"),url:this.patronSession.get("referer")};Et.set("libchat_session",JSON.stringify(e))},getSessionId:function(){let t=Et.get("libchat_session");if(""===t)return"";try{if(t=JSON.parse(t),!t.sessionId||""===t.sessionId)return this.deleteSessionId(),"";return Math.floor(Date.now()/1e3)-t.date>120||t.iid!==Number(this.model.get("iid"))?(this.deleteSessionId(),""):t.widgetId!==this.model.get("id")||t.url.replace("&amp;","&")!==this.patronSession.get("referer").replace("&amp;","&")?"":t.sessionId}catch(t){this.deleteSessionId()}return""},deleteSessionId:function(){Et.remove("libchat_session")},postWindowMessage:function(t,e){const i={libchat_widget:this.model.get("id"),action:t};if(void 0!==e){Object.keys(e).forEach((t=>{i[t]=e[t]}))}window.parent.postMessage(i,"*")},adjustWidgetHeight:function(){window.innerHeight>0&&window.$("body").css("height",window.innerHeight)},findFirstFocusable:function(t){return void 0===t&&(t=document),t.querySelector("input, textarea, select, a, button, [tabindex]")},closeChat:function(){this.saveAutoPopDeny(),this.postWindowMessage("closeWidget")},changeViewTo:function(t){this.views[t]&&(window.$(".chatpane").addClass("hidden"),this.views[t].showView(),this.adjustWidgetHeight())},reloadWidget:function(){this.deleteSessionId();const t=new URL(window.location);t.searchParams.delete("peelKey"),window.location=t},renderLibAuthOverlay:function(){if(this.model.isAuthValidOrNotSet())return;this.views.libauth=Object.create(Dt);const t={model:this.model,patronSession:this.patronSession,templateEng:this.nunjucks};this.views.libauth.initialize(t),this.views.libauth.render()},denyAutopopRequest:function(){this.postWindowMessage("closeWidget"),this.saveAutoPopDeny()},acceptAutopopRequest:function(){this.postWindowMessage("chatStarted"),this.model.isOnline()?!1!==this.model.get("skip_login")||this.botController.isBotActiveOnline()?(this.renderChatView(),this.botController.isBotActiveOnline()&&this.model.isAuthValidOrNotSet()&&this.botController.startBot(!0)):this.renderLogin():this.botController.isBotActiveOffline()&&(this.renderChatView(),this.model.isAuthValidOrNotSet()&&this.botController.startBot(!1))},renderAutoload:function(t){if(!this.views.auto){this.views.auto=Object.create($t);const e={botname:"",botimage:""};(t&&this.botController.isBotActiveOnline()||!t&&this.botController.isBotActiveOffline())&&(e.botname=this.botController.flow.getName(),e.botimage=this.botController.flow.profile_url);const i={model:this.model,events:{"click #s-lch-autoload-yes":this.acceptAutopopRequest.bind(this),"click #s-lch-autoload-no":this.denyAutopopRequest.bind(this)},templateEng:this.nunjucks};this.views.auto.initialize(i),this.views.auto.render(e)}this.views.auto.isShowing()||(this.changeViewTo("auto"),this.postWindowMessage("autopop"),setTimeout((()=>{let t=window.$("#autoload")[0].scrollHeight;t+=3*parseInt(window.$("body").css("padding-top"),10),this.postWindowMessage("height",{height:t})}),100))},resetOnlineStatus:function(){this.model.set("online_rule",!1),this.patronSession.set({uid:0,did:0,coopId:""})},setPatronDataFromOnlineRule:function(t){const e=t.getFirstDept(),i={uid:t.opId,did:e.id?e.id:0,coopId:""};0===i.uid&&0===i.did&&(i.coopId=t.coopId),this.patronSession.set(i)},handleStatusCheck:function(t){const e=new ct(t,this.departments);if(e.isOffline){this.resetOnlineStatus();const t=this.botController.isBotActiveOffline();if(t&&this.model.get("autopop"))return void this.renderAutoload(!1);this.renderOffline();let e=!1;return t&&(e=!0),void this.postWindowMessage("changeStatus",{online:e})}this.model.set("online_rule",e),this.setPatronDataFromOnlineRule(e),this.postWindowMessage("changeStatus",{online:!0}),this.startWidget()},getOnlineStatus:function(){const t=bt(this.model.get("onlinerules"));window.$.ajax({url:`${this.cascadeServer}/widget_status`,dataType:"json",data:{iid:this.model.get("iid"),rules:JSON.stringify(t)},success:this.handleStatusCheck.bind(this),timeout:1e4}).fail((()=>{this.resetOnlineStatus(),this.renderOffline()}))},renderOffline:function(){if(this.botController.isBotActiveOffline())return this.renderChatView(),this.model.isAuthValidOrNotSet()&&this.botController.startBot(!1),void this.postWindowMessage("expandWidget");if(!this.views.offline){this.views.offline=Object.create(Bt);const t={model:this.model,patronSession:this.patronSession,emitter:this.eventEmitter,templateEng:this.nunjucks};this.views.offline.initialize(t),this.views.offline.render()}this.changeViewTo("offline"),this.postWindowMessage("expandWidget"),this.deleteSessionId()},handleMessageSubmit:function(t){if(""!==t)return null===this.cascade?(this.patronSession.set("client_question",t),this.model.set("client_question",t),this.views.chat.clearTextarea(),""===this.patronSession.get("client_contact")&&this.model.get("contact_request")&&this.model.get("contact_required")?void this.eventEmitter.trigger("requestContact"):void this.startSession()):document.getElementById("s-lch-msg-followup")?""===this.patronSession.get("client_contact")?void this.eventEmitter.trigger("requestContact"):void this.createTicket(t):void(!this.cascade.disconnected&&this.model.get("chatting")?this.postChatMsg(t):this.eventEmitter.trigger("chatMsgNotSendable"))},handleFileUpload:function(t){const e={room:this.patronSession.getRoom(),message:t};this.cascade.emit("newMessage",e),this.eventEmitter.trigger("changeView","chat"),this.views.chat.showFileUpload(t)},renderLogin:function(){if(!this.views.login){this.views.login=Object.create(Wt);const t={model:this.model,patronSession:this.patronSession,templateEng:this.nunjucks};this.views.login.initialize(t)}this.views.login.render(),this.changeViewTo("login"),this.renderLibAuthOverlay()},renderChatView:function(){if(!this.views.chat){this.views.chat=Object.create(Kt);const t={model:this.model,events:{"click .s-lch-btn-file":this.renderFileView.bind(this),"click .s-lch-btn-peel":this.peelOut.bind(this),"click .s-lch-btn-end":this.endChat.bind(this),"click .s-lch-btn-close":this.closeChat.bind(this)},patronSession:this.patronSession,emitter:this.eventEmitter,operatorsList:this.operatorsList,templateEng:this.nunjucks};this.views.chat.initialize(t),this.views.chat.render()}this.changeViewTo("chat"),this.renderLibAuthOverlay()},renderFileView:function(){if(!this.views.file){this.views.file=Object.create(Gt);const t={model:this.model,patronSession:this.patronSession,emitter:this.eventEmitter,templateEng:this.nunjucks};this.views.file.initialize(t),this.views.file.render()}this.changeViewTo("file")},renderQuestionFormView:function({html:t,errormsg:e,translations:i,autoReplySettings:s,action:n,rules:r}){if(!this.views.qform){this.views.qform=Object.create(oe);const t={model:this.model,patronSession:this.patronSession,emitter:this.eventEmitter};this.views.qform.initialize(t)}this.views.qform.render({errormsg:e,translations:i,html:t,autoReplySettings:s,action:n,rules:r}),this.changeViewTo("qform")},renderBookingFormView:function({html:t,action:e}){if(!this.views.bform){this.views.bform=Object.create(he);const t={model:this.model,patronSession:this.patronSession,emitter:this.eventEmitter};this.views.bform.initialize(t)}this.views.bform.render({html:t,action:e}),this.changeViewTo("bform")},startWidget:function(){let t=this.getSessionId();if(""===t&&(t=this.patronSession.get("peel")),""===t){if(this.model.get("autopop")&&!this.model.isEmbed()&&!this.model.isButton()){if(!1===this.autoPopDenied())return void this.renderAutoload(!0);this.model.set("autologin",!1)}if(this.postWindowMessage("expandWidget"),!1!==this.model.get("skip_login")||this.botController.isBotActiveOnline()){if(this.renderChatView(),this.botController.isBotActiveOnline())return void(this.model.isAuthValidOrNotSet()&&this.botController.startBot(!0));if(this.model.get("online_rule").away)return void this.eventEmitter.trigger("chatAway")}else this.renderLogin();if(!0===this.model.get("autologin")){if(""===this.patronSession.get("client_contact")&&this.model.get("contact_request")&&this.model.get("contact_required"))return void this.eventEmitter.trigger("requestContact");this.startSession()}}else this.startPeel(t)},startPeel:function(t){this.patronSession.set("sessionId",t),this.patronSession.set("peel",t),this.model.set("peel",t),this.loadSocketIo(),this.postWindowMessage("expandWidget")},startSessionSuccess:function(t){this.patronSession.set(t.session);const e=this.patronSession.get("fallbacks");if(e){const t=bt(e);this.patronSession.set("fallbacks",t)}this.loadSocketIo()},startSessionError:function(t){const e=At(t);let i="chatError";t&&403===t.status&&(i="chatBlockedError"),this.model.emitter.trigger(i,e)},validateSession:function(){""===this.patronSession.get("name")&&this.patronSession.set("name",this.model.generateAnonName())},startSession:function(){this.validateSession();const t=this.patronSession.toJSON();t.key=this.model.get("key"),t.widget_id=this.model.get("id"),t.unit_id=this.model.get("unit_id"),t.auth_id=this.model.get("auth_id"),window.$.ajax({url:"/chat/session",method:"POST",data:t}).done(this.startSessionSuccess.bind(this)).fail(this.startSessionError.bind(this))},startBotSession:function({nextActionId:t=0,flowUuid:e=""}){window.$.ajax({url:"/chat/bot/session",method:"POST",data:{widget_id:this.model.get("id"),auth_id:this.model.get("auth_id"),referer:this.patronSession.get("referer"),client_contact:this.patronSession.get("client_contact"),name:this.patronSession.get("name")}}).done((({session:i={},flow:s={}})=>{this.patronSession.set({sessionId:i.sessionId||"",flowUuid:e}),this.eventEmitter.trigger("bot:loadactions",{actionId:t,flow:s})})).fail(this.startSessionError.bind(this))},sendBotToChat:function({rule:t=null,actionId:e,fallbackAttempt:i=!1}){if(!t&&!i)return void this.eventEmitter.trigger("bot:chatfail",{actionId:e});let s=[];s=bt(i?this.model.get("onlinerules"):[t]),0!==s.length?window.$.ajax({method:"GET",url:`${this.cascadeServer}/widget_status`,dataType:"json",data:{iid:this.model.get("iid"),rules:JSON.stringify(s)},timeout:1e4}).done((t=>{const s=new ct(t,this.departments);if(s.isOffline)return this.resetOnlineStatus(),void this.eventEmitter.trigger("bot:chatoffline",{actionId:e,fallbackAttempt:i});this.model.set("online_rule",s),this.setPatronDataFromOnlineRule(s),this.postWindowMessage("changeStatus",{online:!0}),this.startSession()})).fail((()=>{this.resetOnlineStatus(),this.eventEmitter.trigger("bot:chatfail",{actionId:e})})):this.eventEmitter.trigger("bot:chatfail",{actionId:e})},removeOperator:function(t,e,i){if(!t.opId||"op"!==t.role||0===this.operatorsList.length)return;const s=this.operatorsList.findIndex((e=>Number(e.get("opId"))===t.opId));if(s<0)return;const n=this.operatorsList[s];this.eventEmitter.trigger("opLeave",n),this.operatorsList.splice(s,1),this.operatorsList.length>0&&!i||(this.model.set({chatting:!1,reconnect:!1}),this.cascade.emit("signout",{}),e||this.consolidateMsg(this.patronSession.getChannel()),this.cascade.disconnect(),this.cleanUpDisconnect(e))},setOperatorPending:function(t){if(!t.opId||"op"!==t.role||0===this.operatorsList.length)return;const e=this.operatorsList.find((e=>e.get("opId")===t.opId));void 0!==e&&!0!==e.get("isAway")&&(e.set("isAway",!0),e.setPendingTimeout(this.removeOperator.bind(this,e,!1,!1)),this.eventEmitter.trigger("opAway",e))},setOperatorReconnected:function(t){if(!t.opId||"op"!==t.role||0===this.operatorsList.length)return;let e=this.operatorsList.find((e=>e.get("opId")===t.opId));if(void 0===e)e=Object.create(It),e.set(t),this.operatorsList.push(e);else{if(e.clearPendingTimeout(),!1===e.get("isAway"))return;e.set("isAway",!1)}this.eventEmitter.trigger("opAway",e)},consolidateMsg:function(t){window.$.ajax({url:`/chat/session/${t}/consolidate`,type:"POST",dataType:"json",data:{iid:this.model.get("iid")},success:function(){},error:function(){}})},cleanUpDisconnect:function(t){try{this.deleteSessionId(),this.model.set({chatting:!1,peelingParent:!1}),this.eventEmitter.trigger("endChat",t),t&&(this.disconnects=[])}catch(t){}},openPeelWindow:function(t){let e=400;const i=this.model.get("height").toString();-1===i.indexOf("%")&&(e=parseInt(i,10));let s=375;const n=this.model.get("width").toString();-1===n.indexOf("%")&&(s=parseInt(n,10));const r=window.open(this.model.getPeelUrl(t),"name",`height=${e},width=${s},fullscreen=0,location=0,menubar=0,status=0`);window.focus&&r.focus()},peelOut:function(){window.$.ajax({url:`/chat/session/${this.patronSession.getChannel()}/peel`,method:"GET"}).done((({peelKey:t=""})=>{""!==t&&(this.model.set({peelingParent:!0,reconnect:!1}),this.openPeelWindow(t),this.postWindowMessage("peelout"))})).fail((()=>{}))},postChatMsg:function(t){t=this.model.sanitizeMessage(t),this.cascade.emit("newMessage",{room:this.patronSession.getRoom(),message:t}),this.eventEmitter.trigger("patronMessagePosted",t),this.setPatronTypingStatus(!1),this.saveSessionId()},postSystemMsg:function(t){const e=new ft({role:"system",room:this.patronSession.getRoom(),msg:this.model.sanitizeMessage(t)});this.cascade.emit("systemMessage",e)},timeoutTypingStatus:function(){this.setPatronTypingStatus(!1)},setPatronTypingStatus:function(t){if(window.clearTimeout(this.typing_end_timeout),this.is_typing_currently!==t){if(this.is_typing_currently=t,t&&(this.typing_end_timeout=setTimeout(this.timeoutTypingStatus.bind(this),5e3)),this.model.get("connected")){const e={id:this.patronSession.get("sessionId"),room:this.patronSession.getRoom(),isTyping:t};this.cascade.emit("typingStatus",e)}}else this.is_typing_currently&&(this.typing_end_timeout=setTimeout(this.timeoutTypingStatus.bind(this),5e3))},endChat:function(){try{this.deleteSessionId(),this.model.set("reconnect",!1),this.cascade&&this.cascade.connected?(this.cascade.emit("patronChatEnd",{}),this.cascade.disconnect(),this.cleanUpDisconnect(!0)):(this.reloadWidget(),this.closeChat())}catch(t){this.eventEmitter.trigger("chatError","",!0)}},resetBot:function(){try{if(this.cascade&&this.cascade.connected)return;this.reloadWidget()}catch(t){this.eventEmitter.trigger("chatError","",!0)}},messageHistorySuccess:function(t){this.views.chat.insertMessageHistory(t.content,t.which)},getMessageHistory:function(t){void 0!==t&&-1!==["op","all"].indexOf(t)||(t="op"),window.$.ajax({url:`/chat/session/${this.patronSession.getChannel()}/messages`,type:"GET",cache:!1,dataType:"json",data:{iid:this.model.get("iid"),which:t},success:this.messageHistorySuccess.bind(this),error:()=>{}})},saveAutoPopDeny:function(){const t={date:Math.floor(Date.now()/1e3)};Et.set("libchat_auto",JSON.stringify(t))},autoPopDenied:function(){let t=Et.get("libchat_auto");if(""===t)return!1;try{t=JSON.parse(t);return!(Math.floor(Date.now()/1e3)-t.date>3600)||(this.deleteAutoPopDeny(),!1)}catch(t){this.deleteAutoPopDeny()}return!1},deleteAutoPopDeny:function(){Et.remove("libchat_auto")},setupHeightResize:function(){try{(function(t,e,i){i=i||window;let s=!1;i.addEventListener(t,(function(){s||(s=!0,requestAnimationFrame((()=>{i.dispatchEvent(new CustomEvent(e)),s=!1})))}))})("resize","optimizedResize"),window.addEventListener("optimizedResize",this.adjustWidgetHeight.bind(this))}catch(t){}},contactSaveSuccess:function(){this.views.chat.contactFormSuccess(),this.cascade.connected&&this.cascade.emit("memberUpdate",{sessionId:this.patronSession.get("sessionId"),updates:{client_contact:this.patronSession.get("client_contact"),name:this.patronSession.get("name"),user1:this.patronSession.get("user1"),user2:this.patronSession.get("user2"),user3:this.patronSession.get("user3")}})},handleContactSave:function(t){window.$.ajax({url:t.action,type:"POST",dataType:"json",data:{channel:this.patronSession.getChannel(),client_contact:this.patronSession.get("client_contact"),name:this.patronSession.get("name"),user1:this.patronSession.get("user1"),user2:this.patronSession.get("user2"),user3:this.patronSession.get("user3")},success:this.contactSaveSuccess.bind(this)}).fail(this.views.chat.contactSaveError)},ticketSaveSuccess:function(t){this.views.chat.showPatronMessage(t.body),this.views.chat.enableForm(),this.views.chat.showChatSysMsg({msg:t.message}),this.model.set("ticketCreated",!0),this.cascade&&this.cascade.connected&&this.endChat()},ticketSaveError:function(t){this.views.chat.enableForm();let e="Sorry, an error occurred trying to create a Ticket.";400===t.status&&(e=At(t)),this.views.chat.showChatSysMsg({msg:e})},createTicket:function(t){this.views.chat.disableForm(),window.$.ajax({url:`/chat/session/${this.patronSession.getChannel()}/ticket`,type:"POST",dataType:"json",data:{msg:t,iid:this.model.get("iid"),queue_id:this.model.get("queue_id")},success:this.ticketSaveSuccess.bind(this)}).fail(this.ticketSaveError.bind(this))},setStateReconnecting:function(){this.model.hasSubscribed&&this.eventEmitter.trigger("chatReconnecting")},setStateCascadeError:function(){this.model.set("connected",!1),this.model.hasSubscribed&&this.eventEmitter.trigger("chatError","")},handleCascadeConnect:function(){let t=!1;if(this.model.get("hasConnected")&&this.patronSession.get("sessionId")&&(t=!0),this.model.set({connected:!0,reconnect:!0,hasConnected:!0}),t)return this.model.get("answered")&&this.getMessageHistory(),void(this.model.hasSubscribed&&this.eventEmitter.trigger("chatReconnected"));this.cascade.emit("subscribe",this.patronSession.toJSON())},getCurrentUnixSeconds:function(){return Math.floor(Date.now()/1e3)},checkDisconnects:function(t=!1){const e=this.getCurrentUnixSeconds(),i=this.disconnectTimeThreshold;if(this.disconnects=this.disconnects.filter((t=>e-t<=i)),t||!(this.disconnects.length<this.disconnectCountThreshold)){if(this.cascadeServer===this.altCascadeServer)return this.cascade.close(),Ot.hide(),this.setStateCascadeError(),void this.cleanUpDisconnect(!1);this.cascadeServer=this.altCascadeServer,this.cascade.close(),this.cascade=null,this.model.get("answered")||this.model.set("hasConnected",!1),this.transports.unshift("polling"),this.setupSocket()}},handleCascadeDisconnect:function(){this.model.set("connected",!1),this.cascade.io.opts.query+="&reconnect=true",this.model.get("reconnect")&&(this.disconnects.push(this.getCurrentUnixSeconds()),this.checkDisconnects())},handleCascadeReconnectRejection:function(){this.eventEmitter.trigger("chatError"),this.model.set({chatting:!1,reconnect:!1}),this.cascade.emit("signout",{}),this.cascade.disconnect(),this.cleanUpDisconnect(!1)},handleCascadeSubscribeFail:function(){Ot.hide(),this.model.set("reconnect",!1),this.cascade.disconnect(),this.reloadWidget()},handleCascadePeelSubscribe:function(t){Ot.hide(),Array.isArray(t.ops)&&t.ops.forEach((function(t){const e=Object.create(It);e.set(t),this.operatorsList.push(e),this.model.set("answered",!0)}),this),this.patronSession.set(t.patronData),this.model.set("referer",this.patronSession.get("referer")),this.model.hasSubscribed=!0,this.model.set("chatting",!0),this.views.chat.setConnectState(),this.getMessageHistory("all"),this.saveSessionId()},handleCascadeSubscribe:function(t){if(Ot.hide(),t.online_status===this.model.get("status_offline"))return this.views.chat.showChatSysMsg({msg:this.model.getOfflineMessage(),id:""}),this.model.set({chatting:!1,reconnect:!1}),this.cascade.emit("signout",{}),this.cascade.disconnect(),this.cleanUpDisconnect(!1),void window.clearTimeout(this.views.chat.missedChatTime);this.model.hasSubscribed=!0,this.eventEmitter.trigger("chatSubscribe",t.online_status)},handleOperatorJoin:function(t){let e;t.transferHist&&this.patronSession.set("transferHist",t.transferHist),this.model.set({chatting:!0,answered:!0});let i=!1;if(this.operatorsList.length>0&&(e=this.operatorsList.find((e=>e.get("opId")===t.op.opId))),void 0===e&&(e=Object.create(It),e.set(t.op),this.operatorsList.push(e),i=!0),1===this.operatorsList.length){let e="";if(t.patronUpdate&&t.patronUpdate.did>0){const i=this.departments[t.patronUpdate.did];i&&(e=i.name,this.eventEmitter.trigger("deptGreeting",e))}}if(this.eventEmitter.trigger("opJoin",e,i),1===this.operatorsList.length){const t=e.iid===this.model.get("iid");this.eventEmitter.trigger("showGreeting",t)}this.saveSessionId()},handleChatEnd:function(t){this.removeOperator(t.op,!0,!0)},handleOperatorLeave:function(t){this.removeOperator(t.op,!0,!1)},handleOperatorDisconnect:function(t){this.setOperatorPending(t)},handleOperatorPending:function(t){this.setOperatorPending(t)},handleOperatorReconnect:function(t){this.setOperatorReconnected(t)},handleNewMessage:function(t){const e=new ft(t);this.views.chat.showNewMessage(e),this.postWindowMessage("newMessage")},handleCascadeDeleteMessage:function({msgId:t=0}){this.views.chat.removeMessage(t)},handleScreenshareChange:function(t){const e=t.isEnd?"ended":"started",i=`This screensharing session has ${e}.`;this.views.chat.showChatSysMsg({msg:i,id:`screenshare_${e}`})},triggerFallback:function(){const t=this.patronSession.get("fallbacks"),e=this.patronSession.get("coopId");let i="",s=0;for(;s<t.length;s++){const n=t[s];if(!n.c)continue;if(this.attemptedFallbackCoops.indexOf(n.c)>-1)continue;if(e===n.c){this.attemptedFallbackCoops.push(n.c);continue}const r=Number(n.fallbackSeconds||this.model.get("timedFallback"));if(r&&!(r<=0)){i=n.c;break}}if(!i)return;if(this.attemptedFallbackCoops.push(i),this.cascade.emit("triggerFallback",{coopId:i}),s++,s>=t.length)return;let n=0;for(;s<t.length;s++){const e=t[s];if(n=Number(e.fallbackSeconds||this.model.get("timedFallback")),n>0)break}this.views.chat.setTimedFallbackTimeout(n)},setFirstFallBackTime:function(){const t=this.patronSession.get("fallbacks"),e=this.patronSession.get("coopId"),i=t.filter((t=>{const i=Number(t.fallbackSeconds||this.model.get("timedFallback"));return t.c&&i>0&&-1===this.attemptedFallbackCoops.indexOf(t.c)&&t.c!==e}));if(0===i.length)return;const s=i[0],n=Number(s.fallbackSeconds||this.model.get("timedFallback"));this.views.chat.setTimedFallbackTimeout(n)},handleFallbackOffline:function(){this.views.chat.clearFallbackTimeout(),this.patronSession.get("isAnswered")||this.triggerFallback()},handlePatronLogOut:function({who:t=""}){let e="chatError";"chatDismiss"===t&&(e="chatBlockedError"),this.model.emitter.trigger(e,"Disconnected")},loadSocketIo:function(){Ot.working();const t=document.createElement("script");document.body.appendChild(t),t.onerror=()=>{this.model.emitter.trigger("chatError")},t.onload=this.setupSocket.bind(this),t.src=this.socketIoUrl},handleError:function(){this.setStateCascadeError()},handleConnectError:function(t){console.log("cascade connect_error"),console.log(t),this.setStateCascadeError()},handleReconnectFailed:function(){console.log("cascade reconnect_failed"),this.setStateCascadeError(),this.checkDisconnects(!0)},registerCascadeListeners:function(){this.cascade.on("reconnect_attempt",this.setStateReconnecting.bind(this)),this.cascade.on("connect_error",this.handleError.bind(this)),this.cascade.io.on("error",this.handleConnectError.bind(this)),this.cascade.io.on("reconnect_failed",this.handleReconnectFailed.bind(this)),this.cascade.on("connect",this.handleCascadeConnect.bind(this)),this.cascade.on("disconnect",this.handleCascadeDisconnect.bind(this)),this.cascade.on("reconnectReject",this.handleCascadeReconnectRejection.bind(this)),this.cascade.on("subscribe_failed",this.handleCascadeSubscribeFail.bind(this)),this.cascade.on("peel_subscribed",this.handleCascadePeelSubscribe.bind(this)),this.cascade.on("subscribed",this.handleCascadeSubscribe.bind(this)),this.cascade.on("chatJoin",this.handleOperatorJoin.bind(this)),this.cascade.on("typingStatus",this.views.chat.setOperatorTypingStatus.bind(this.views.chat)),this.cascade.on("newMessage",this.handleNewMessage.bind(this)),this.cascade.on("deleteMessage",this.handleCascadeDeleteMessage.bind(this)),this.cascade.on("chatLeft",this.handleOperatorLeave.bind(this)),this.cascade.on("chatEnd",this.handleChatEnd.bind(this)),this.cascade.on("member_removed",this.handleOperatorDisconnect.bind(this)),this.cascade.on("member_pending",this.handleOperatorPending.bind(this)),this.cascade.on("member_reconnected",this.handleOperatorReconnect.bind(this)),this.cascade.on("requestContact",this.eventEmitter.trigger.bind(this.eventEmitter,"requestContact",!0)),this.cascade.on("screenshareChange",this.handleScreenshareChange.bind(this)),this.cascade.on("fallbackOffline",this.handleFallbackOffline.bind(this)),this.cascade.on("patron_log_out",this.handlePatronLogOut.bind(this))},setupSocket:function(){this.renderChatView(),this.botController.isBotEnabled()&&this.botController.isStarted&&this.botController.stopBot(),this.model.set("peelingParent",!1),this.deleteAutoPopDeny();const t={iid:this.patronSession.get("iid"),sessionId:this.patronSession.get("sessionId"),src:"user",peel:this.patronSession.get("peel")};this.model.get("hasConnected")&&this.model.get("answered")&&(t.reconnect=!0);const e=Object.keys(t).map((e=>`${e}=${encodeURIComponent(t[e])}`)).join("&");this.cascade=window.io(this.cascadeServer,{"force new connection":!1,reconnectionAttempts:10,reconnectionDelay:3e3,timeout:15e3,query:e,transports:this.transports,withCredentials:!0}),this.model.cascade=this.cascade,this.registerCascadeListeners()},registerEvents:function(){document.body.addEventListener("keydown",(t=>{"Escape"===t.key&&this.closeChat()})),this.model.emitter.on("change:loggedIn",this.startSession,this),this.model.emitter.on("isTyping",this.setPatronTypingStatus,this),this.model.emitter.on("messageSubmit",this.handleMessageSubmit,this),this.model.emitter.on("systemMessage",this.postSystemMsg.bind(this)),this.model.emitter.on("changeView",this.changeViewTo,this),this.model.emitter.on("fileUpload",this.handleFileUpload,this),this.model.emitter.on("contactSave",this.handleContactSave,this),this.model.emitter.on("startSession",this.startSession,this),this.model.emitter.on("closeWidget",this.closeChat,this),this.model.emitter.on("reloadWidget",this.reloadWidget,this),this.model.emitter.on("triggerFallback",this.triggerFallback,this),this.model.emitter.on("setFirstFallback",this.setFirstFallBackTime,this),this.eventEmitter.on("bot:startsession",this.startBotSession.bind(this)),this.eventEmitter.on("bot:sendtochat",this.sendBotToChat.bind(this)),this.eventEmitter.on("bot:reset",this.resetBot.bind(this)),this.eventEmitter.on("bot:ticket:form",this.renderQuestionFormView.bind(this)),this.eventEmitter.on("bot:booking:form",this.renderBookingFormView.bind(this)),document.addEventListener("visibilitychange",(()=>{if("visible"===document.visibilityState){if(this.model.get("chatting")||this.model.get("hasConnected")||this.model.get("answered")||this.model.get("loggedIn")||this.model.get("peel")||this.model.get("peelingParent")||this.botController.isStarted)return;this.getOnlineStatus()}}))},initNunjucks:function(){this.nunjucks=new mt.Environment({autoescape:!1}),this.nunjucks.addGlobal("translation",this.model.get("translation"))},init:function(t,e,i,s,n,r,o){this.model=t,this.patronSession=e,this.cascadeServer=i,this.altCascadeServer=o,this.socketIoUrl=s,this.departments=n,this.eventEmitter=new pt,this.model.emitter=this.eventEmitter,this.initNunjucks(),this.botController=new wt(new St(this.nunjucks,r),this.nunjucks,r,this.eventEmitter,this.patronSession,this.model),this.adjustWidgetHeight(),this.setupHeightResize();const a=this.model.get("custom_css");""!==a&&window.$("head").append(`<style>${a}</style>`),this.getOnlineStatus(),this.registerEvents()}},ce=le,ue=Object.create(lt);ue.defaults={sessionId:"",name:"",client_contact:"",local_id:"",role:"user",user_agent:"",isMobile:!1,ip:"",referer:"",client_question:"",did:-1,uid:0,coopId:"",widget:"",user1:"",user2:"",user3:"",consortium:"",peel:"",iid:0,joined:"",transferTarget:null,transferHist:[],isPending:!1,isConnected:!1,isAnswered:!1,ops:[],messages:[],isTyping:!1,isSelected:!1,newMessages:0,disconnectReason:"",popped:!1,region:"",site:{},fallbacks:[],flowUuid:"",answers:[]},ue.ticketId=0,ue.isInternal=!1,ue.pendingTimeout=null,ue.msgConsolidated=!1,ue.internalChatMsgs=null,ue.getChannel=function(){return this.getRoom()},ue.getRoom=function(){return""!==this.get("sessionId")?`chat-${this.get("sessionId")}`:""},ue.setContactInfo=function(t){let e=t.trim();""!==e?null===e.match(C)?(e=e.replace(/[\-\(\)\s\.]/g,""),null===e.match(k)||this.set("client_contact",e)):this.set("client_contact",e):this.set("client_contact","")},ue.setDisconnectReason=function(t){if("transport close"===t.toLowerCase())this.set("disconnectReason","Closed or left page.")},ue.addMessage=function(t){const e=this.get("messages");e.push(t);const i={messages:e};if(!this.get("isSelected")){let t=this.get("newMessages");t++,i.newMessages=t}this.set(i),this.trigger("chat:message",t)},ue.removeMessage=function(t){const e=this.get("messages"),i=e.findIndex((e=>e.msgId===t));-1!==i&&(e.splice(i,1),this.trigger("chat:removemsg",t))},ue.addInternalMessage=function(t){this.internalChatMsgs||(this.internalChatMsgs=[]),this.internalChatMsgs.push(t)},ue.resetContext=function(){this.set({newMessages:0,isSelected:!1,isTyping:!1},{silent:!0})},ue.updateFromServer=function(t){const e={transferHist:t.transferHist,transferTarget:t.transferTarget,isAnswered:t.isAnswered,did:t.did,uid:t.uid,iid:t.iid,coopId:t.coopId||"",isConnected:!0};if(t.ops&&Array.isArray(t.ops)&&(e.ops=t.ops),t.messages.length>0){const i=this.get("messages");if(0===i.length)t.messages.forEach((t=>{i.push(t),this.trigger("chat:message",t)}));else{const s=i[i.length-1];if(s.ts){const e=new Date(s.ts);t.messages.forEach((function(t){const s=new Date(t.ts);e>=s||(i.push(t),this.trigger("chat:message",t))}),this)}else e.messages=t.messages}}this.set(e),t.addOp&&this.addOp(t.addOp,!0),this.msgConsolidated=!1},ue.setPendingTimeout=function(t){window.clearTimeout(this.pendingTimeout),this.pendingTimeout=window.setTimeout(t,6e4)},ue.clearPendingTimeout=function(){window.clearTimeout(this.pendingTimeout)},ue.isOpChatting=function(t){return-1!==this.ops.indexOf(t)},ue.addOp=function(t,e=!1){const i=this.ops.indexOf(t);(-1===i||e)&&(0===this.ops.length&&(this.ops=[]),e?(-1!==i&&this.ops.splice(i,1),this.ops.unshift(t)):this.ops.push(t),this.trigger("change:ops"),this.trigger("change"))},ue.removeOp=function(t){const e=this.ops.indexOf(t);return-1!==e&&(this.ops.splice(e,1),this.trigger("change:ops"),this.trigger("change"),!0)},ue.addAnswer=function(t){if(!(t instanceof O))return;const e=this.get("answers");e.push(t),this.set("answers",e)},ue.getAnswerByQuestionId=function(t){return this.get("answers").find((e=>e.questionId===t))};const de=ue;window.initWidget=function({settings:t,sessionData:e,cascadeServer:i,socketIoUrl:s,departments:n,flowdata:r,altCascadeServer:o}){const a=Object.create(de);a.init(e);const h=Object.create(dt);h.initialize(t);const l=new ht(r);Object.create(ce).init(h,a,i,s,n,l,o)}})()})();
//# sourceMappingURL=libchatwidget.min.js.map
</script>

</body>
</html>
