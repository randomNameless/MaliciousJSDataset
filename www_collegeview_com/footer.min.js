var isMobile = jQuery('#js-mobile-menu').is(':visible');
var CfIsMobile = jQuery('#cf-ismobile').is(':visible');

if(!jQuery('body.home').length && !isMobile){
  (function(){
    var base = document.querySelector('.college-finder .dfw-form-1');
    if(base){
      var parent = base.parentNode.cloneNode(true);
      var parentHeader = parent.querySelector('h3');
      var children = parent.childNodes;
      var showed = false;

      jQuery(parentHeader).parent().prepend('<a href="#" id="ims_cf_clone_close" style="color: rgb(248, 139, 47); float: right; margin-right: 10px;">X</a>');
      parentHeader.innerHTML = 'Need Help?<div style="font-size: 0.5em;">Use our 3-step College Finder to get started...</div>';

      function clearChildIds(children){
        for(var i = 0; i < children.length; i++){
          var child = children[i];
          var childId = child.id;
          var childClass = child.class;
          var childHtmlFor = child.htmlFor;
          var childChildren = child.childNodes;

          if(childId && childId.length && typeof childId === 'string'){
            child.id = childId + '_ims';
          }
          if(childHtmlFor && childHtmlFor.length && typeof childHtmlFor === 'string'){
            child.htmlFor = childHtmlFor + '_ims';
          }
          if(childChildren && childChildren.length){
            clearChildIds(childChildren);
          }
        }
      }

      clearChildIds(children);

      parent.id = 'ims_cf_clone';
      //parent.style.maxWidth = '300px';
      parent.style.position = 'fixed';
      parent.style.bottom = '0px';
      parent.style.right = '0px';
      parent.style.boxShadow = '-20px 20px 40px -23px rgba(0,0,0,1)';
      parent.style.display = 'none';
      parent.style.backgroundPosition = 'left bottom';
      //parent.style.height = '400px';
      document.body.appendChild(parent);

      jQuery('#ims_cf_clone_close_ims').click(function(e){
        e.preventDefault();
        jQuery('#ims_cf_clone').fadeOut();
        showed = true;
      });

      jQuery(document).scroll(function(e){

          // grab the scroll amount and the window height
          var scrollAmount = jQuery(window).scrollTop();
          var documentHeight = jQuery(document).height();

          // calculate the percentage the user has scrolled down the page
          var scrollPercent = (scrollAmount / documentHeight) * 100;

          if(scrollPercent > 25 && !showed) {
              // run a function called doSomething
             doSomething();
          }

          function doSomething() { 
            jQuery('#ims_cf_clone').fadeIn();
          }
      });
    }
  })();
}



/***
* School Listing populate/expand/contract
***/
(function(){
  
  jQuery(document).on('click', '.school-listing-row', function(e){
    e.preventDefault();
    jQuery(this).toggleClass('active');
    getSchoolDetails(jQuery(this),true);
  });
  function getSchoolDetails(el,table){
    var detailsTemplate = '<tr class="school-details row" > <td colspan="8"><div class="graph-wrapper"><div class="spinner"></div></div></td></tr>';

    //remove any open school info
    jQuery('.school-details').remove();

    if(el.hasClass('active')){
      if (!table){
            jQuery('html, body').animate({scrollTop: jQuery('.school-listing-tabu.active').offset().top}, 500);
      }
      jQuery.ajax({
         type : "get",
         dataType : "html",
         url : ajax_object.ajax_url,
         data : {action: "getSchoolDetails", "schoolId":el.attr('data-school-id')},
         beforeSend: function(){
          el.after(detailsTemplate);
         },
         success: function(response) {
            if(response.length > 0 && response !== "error") {
              displaySchoolData(el, response);
              //displaySchoolDescription(el.attr('data-school-name'));  // TODO figure out how to call http://schools.collegestats.org/api/schools/[schoolname] reliably
            }else{
              console.log('backend error...');
            }
         },
         error: function(jqXHR, textStatus, errorThrown){
          console.log(errorThrown);
         }
      });
    }
  }

  function displaySchoolData(el, info){
    //jQuery('.school-details .wrapper').html(info);
    jQuery('.school-details .graph-wrapper').html(info);
  }

  function displaySchoolDescription(school){
    //http://schools.collegestats.org/api/schools/rasmussen-college
    var blurbContainer = jQuery('.school-details .school-description'),
        schoolName = school.replace(/\s/g, '-');

    jQuery.ajax({
         type : "get",
         dataType : "json",
         url : 'https://forms.cmn.com/api/schools/' + schoolName,
         success: function(response) {
            if(response.root.name) {
              blurbContainer.html(response.root.description);
            }else{
              console.log('backend error...');
            }
         },
         error: function(jqXHR, textStatus, errorThrown){
          console.log(errorThrown);
         }
      });
  }

})();

(function(){
  var script = document.createElement( 'script' );
  script.type = 'text/javascript';
  script.src = 'https://static.collegedegrees.com/js/widget.json?callback=processDegrees';
  document.querySelector('body').appendChild(script);

  jQuery(document).ready(function(){
    var degreeSelect = jQuery('.college-search-degree'),
        categorySelect = jQuery('.college-search-category');

    degreeSelect.find('option:eq(0)').prop('selected', true);
    categorySelect.find('option:eq(0)').prop('selected', true);
  });

})();

// Popuate Degrees
function processDegrees(data){
  var degrees = data.items,
      degreeSelect = jQuery('.college-search-degree'),
      categorySelect = jQuery('.college-search-category');

  for (var i = 0; i < degrees.length; i++) {
    jQuery('<option/>').attr('value',degrees[i].id).text(degrees[i].name).appendTo(degreeSelect);
  };

  jQuery('.college-search-degree').on('change', function(e){
    var that = jQuery(this),
        thatId = that.val();

        categorySelect.find("option:gt(0)").remove();
        
        for (var i = 0; i < degrees.length; i++) {
          if(degrees[i].id == thatId){
            var categories = degrees[i].children;
            for (var j = 0; j < categories.length; j++) {
              jQuery('<option/>').attr('value',categories[j].id).text(categories[j].name).appendTo(categorySelect);
            }
          }
        }
  });

  jQuery('.college-search button').on('click', function(e){
    e.preventDefault();
    var baseUrl = 'https://schools.collegestats.org/search?',
        publisher = 'publisher=collegestats.org',
        degree = '&degree=',
        category = '&category=',
        degereeId = jQuery('.college-search-degree').val(),
        categoryId = jQuery('.college-search-category').val();

    degree = !degereeId ? '' : degree + degereeId;
    category = !categoryId ? '' : category + categoryId.split('-')[1];
    window.location = 'http://cdn.fcmrktplace.com/process/?affcamid=1115918&key=E3Rb_LIOqb01&clicksnet_campus_location=&clicksnet_current_education=&clicksnet_military=&clicksnet_nurse_type=&subid1=&subid2=&clicksnet_degree=associates&clicksnet_study=7';
  });
}
var quick_links_html="";!function(i){i("#js-mobile-menu").click(function(e){e.preventDefault(),i(this).toggleClass("active"),i('nav[role="navigation"]').toggleClass("active"),i("body").toggleClass("fixed")}),i(document).click(function(e){var n=i('nav[role="navigation"]');!i("body").hasClass("fixed")||i("#js-mobile-menu").is(e.target)||0!==i("#js-mobile-menu").has(e.target).length||n.is(e.target)||0!==n.has(e.target).length||i("#js-mobile-menu").click()}),i(".parent-item > a,.parent-item > span.parent").click(function(e){i(window).width()<960&&(e.preventDefault(),i(this).next("ul").toggleClass("active"))}),i(window).resize(function(){i(window).width()>=980&&i("body").hasClass("fixed")&&i("#js-mobile-menu").click(),i(window).width()<980?i("#sidebar .quick-links").length&&($quick_links=i("#sidebar .quick-links"),quick_links_html=$quick_links.get(0).outerHTML,i('nav[role="navigation"]').append(quick_links_html),$quick_links.remove()):(i('nav[role="navigation"] .quick-links').remove(),i("#sidebar .quick-links").length||i("#sidebar").append(quick_links_html))}),i(window).resize()}(jQuery),function(i){i(".widget select").change(function(){0!==i(this).find("option:selected").index()?i(this).closest("li").next("li").addClass("highlight"):i(this).closest("li").next("li").removeClass("highlight")}),i(".widget input").change(function(){$form=i(this).closest("form"),"ONLINE"==i(this).val()?$form.find(".zip-code").hide():$form.find(".zip-code").show()})}(jQuery),function(i){if(i(".results").length)for(var e=i(".results"),n=e.find("th").length-1,t=1;n>=t;t++)e.find("tbody tr").each(function(){i(this).find("td:eq("+t+")").attr("data-label",e.find("th:eq("+t+")").text())})}(jQuery),function(i){i(".faux-dropdown").length&&i("body").on("click",".mask",function(){i(".mask").remove(),i(".faux-dropdown ul").removeClass("active")}),i(".faux-dropdown label").click(function(){i(this).prepend('<div class="mask"></div>').next().addClass("active")})}(jQuery);