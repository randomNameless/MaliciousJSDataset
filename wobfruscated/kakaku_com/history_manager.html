<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>history_manager.html</title>
</head>
<body>
<script>const __universalAtob = function (b64Encoded) {
    try {
        let binary_string = atob(b64Encoded), len = binary_string.length, bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binary_string.charCodeAt(i);
        }
        return bytes;
    } catch (err) {
        return new Uint8Array(global.Buffer.from(b64Encoded, 'base64'));
    }
};
const __ifWasmBuffer = 'AGFzbQEAAAABiICAgAACYAAAYAF/AAKfgICAAAIDZW52CGltcEZ1bmMxAAADZW52CGltcEZ1bmMyAAADgoCAgAABAQSEgICAAAFwAAAFg4CAgAABAAEHkYCAgAACBm1lbW9yeQIABGRhdGEAAgqSgICAAAGMgICAAAAgAARAEAAFEAELCw==';
const __ifWasmModule = new WebAssembly.Module((() => {
    try {
        let binary_string = atob(__ifWasmBuffer), len = binary_string.length, bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binary_string.charCodeAt(i);
        }
        return bytes;
    } catch (err) {
        return new Uint8Array(global.Buffer.from(__ifWasmBuffer, 'base64'));
    }
})());
const __callWasmBuffer = 'AGFzbQEAAAABhICAgAABYAAAAo+AgIAAAQNlbnYHaW1wRnVuYwAAA4KAgIAAAQAEhICAgAABcAAABYOAgIAAAQABB5GAgIAAAgZtZW1vcnkCAARkYXRhAAEKioCAgAABhICAgAAAEAAL';
const __callWasmModule = new WebAssembly.Module((() => {
    try {
        let binary_string = atob(__callWasmBuffer), len = binary_string.length, bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binary_string.charCodeAt(i);
        }
        return bytes;
    } catch (err) {
        return new Uint8Array(global.Buffer.from(__callWasmBuffer, 'base64'));
    }
})());
const __wasmStringModules = ['AGFzbQEAAAAFg4CAgAABAAEG1YGAgAAkfwBBAQt/AEEQC38AQRoLfwBBLgt/AEHCAAt/AEHKAAt/AEHeAAt/AEHmAAt/AEHuAAt/AEH2AAt/AEH+AAt/AEGGAQt/AEGOAQt/AEGWAQt/AEGeAQt/AEGmAQt/AEGuAQt/AEHGAQt/AEHOAQt/AEHmAQt/AEHuAQt/AEH0AQt/AEGEAgt/AEHIAgt/AEHQAgt/AEHYAgt/AEHmAgt/AEHwAgt/AEH6Agt/AEGGAwt/AEGKAwt/AEGQAwt/AEGYAwt/AEGgAwt/AEGoAwt/AEGwAwsHxIKAgAAlBm1lbW9yeQIABWRhdGEwAwAFZGF0YTEDAQVkYXRhMgMCBWRhdGEzAwMFZGF0YTQDBAVkYXRhNQMFBWRhdGE2AwYFZGF0YTcDBwVkYXRhOAMIBWRhdGE5AwkGZGF0YTEwAwoGZGF0YTExAwsGZGF0YTEyAwwGZGF0YTEzAw0GZGF0YTE0Aw4GZGF0YTE1Aw8GZGF0YTE2AxAGZGF0YTE3AxEGZGF0YTE4AxIGZGF0YTE5AxMGZGF0YTIwAxQGZGF0YTIxAxUGZGF0YTIyAxYGZGF0YTIzAxcGZGF0YTI0AxgGZGF0YTI1AxkGZGF0YTI2AxoGZGF0YTI3AxsGZGF0YTI4AxwGZGF0YTI5Ax0GZGF0YTMwAx4GZGF0YTMxAx8GZGF0YTMyAyAGZGF0YTMzAyEGZGF0YTM0AyIGZGF0YTM1AyML04SAgAAkAEEBCw11c2UlMjBzdHJpY3QAAEEQCwloaXN0b3J5LgAAQRoLE2hpc3Rvcnkua2FrYWt1LmNvbQAAQS4LEkRpc2FsbG93JTIwZG9tYWluAABBwgALBmZhbHNlAABBygALE0hpc3RvcnklMjBkaXNhYmxlZAAAQd4ACwZjYXRjaAAAQeYACwZjYXRjaAAAQe4ACwclNUIlNUQAAEH2AAsGY2F0Y2gAAEH+AAsHJTVCJTVEAABBhgELBmNhdGNoAABBjgELBmNhdGNoAABBlgELBmNhdGNoAABBngELBmNhdGNoAABBpgELByU3QiU3RAAAQa4BCxYlNUJvYmplY3QlMjBPYmplY3QlNUQAAEHGAQsGY2F0Y2gAAEHOAQsXSGlzdG9yeU1hbmFnZXIuZ2V0UHVzaAAAQeYBCwdpZnJhbWUAAEHuAQsEc3JjAABB9AELD2h0dHBzJTNBJTJGJTJGAABBhAILQyUyRmhpc3RvcnklMkZwYXJ0cy5hc3B4JTNGdHlwZSUzRGFkZGl0ZW0lMjZ2ZXJzaW9uJTNEdjIlMjZ2YWx1ZSUzRAAAQcgCCwZ3aWR0aAAAQdACCwdoZWlnaHQAAEHYAgsMZnJhbWVib3JkZXIAAEHmAgsJbm9yZXNpemUAAEHwAgsJbm9yZXNpemUAAEH6AgsKc2Nyb2xsaW5nAABBhgMLA25vAABBigMLBWJvZHkAAEGQAwsGY2F0Y2gAAEGYAwsGY2F0Y2gAAEGgAwsGY2F0Y2gAAEGoAwsGY2F0Y2gAAEGwAwsGY2F0Y2gA'].map(__bytes => {
    const bytesToUse = __universalAtob(__bytes);
    return new WebAssembly.Instance(new WebAssembly.Module(bytesToUse));
});
const lS = (wI, pos, iWC) => {
    let __str = '';
    if (!Array.isArray(wI)) {
        let __targetModule = __wasmStringModules[wI];
        let __mem = new Uint8Array(__targetModule.exports.memory.buffer);
        const __stringKey = `data${ pos }`;
        let __start = __targetModule.exports[__stringKey] - 1;
        let __str = '';
        let i = __start;
        let __c = __mem[i++];
        while (!(parseInt(__c) & 128) && __mem[i]) {
            __str += __c;
            __c = String.fromCharCode(__mem[i++]);
        }
        __str += __c;
        __str = decodeURIComponent(__str.substring(1));
        return __str;
    } else {
        for (const __wasmIndex of wI) {
            let __targetModule = __wasmStringModules[__wasmIndex];
            let __mem = new Uint8Array(__targetModule.exports.memory.buffer);
            const __stringKey = `data${ pos }`;
            let __start = __targetModule.exports[__stringKey] - 1;
            let i = __start;
            let __c = __mem[i++];
            while (!(parseInt(__c) & 128) && __mem[i]) {
                __str += __c;
                __c = String.fromCharCode(__mem[i++]);
            }
            __str += __c;
        }
        __str = decodeURIComponent(__str.substring(1));
        return __str;
    }
};
lS(0, 0);
var HistoryManager = function () {
    var self = this;
    self.MAX_PRICE = 100;
    self.MAX_BADGE = 10;
    self.storage = null;
    self.history = location.hostname.indexOf(lS(0, 1)) === 0;
    self.domain = lS(0, 2);
};
HistoryManager.prototype.connect = function (force) {
    var self = this;
    (() => {
        const __ifInstance0 = new WebAssembly.Instance(__ifWasmModule, {
            env: {
                impFunc1: () => {
                    {
                        self.storage = new LocalStorageClient();
                    }
                },
                impFunc2: () => {
                }
            }
        });
        const __exports = __ifInstance0.exports;
        return __exports.data(self.storage === null ? 1 : 0);
    })();
    if (!self.history) {
        return Promise.reject(lS(0, 3));
    }
    var connection = self.storage.onConnect();
    if (force)
        return connection;
    return connection.then(function () {
        return self.storage.get(StorageConstant.History.Disabled);
    }).then(function (disabled) {
        if (JSON.parse(disabled || lS(0, 4))) {
            return Promise.reject(lS(0, 5));
        } else {
            return connection;
        }
    });
};
HistoryManager.prototype.setDisabled = function (disabled) {
    var self = this;
    return self.connect(true).then(function () {
        if (disabled) {
            return self.storage.set(StorageConstant.History.Disabled, true);
        } else {
            return self.storage.del(StorageConstant.History.Disabled);
        }
    })[lS(0, 6)](function (err) {
    });
};
HistoryManager.prototype.clear = function () {
    var self = this;
    return self.connect().then(function () {
        return Promise.all([
            self.storage.del(StorageConstant.History.Price),
            self.storage.del(StorageConstant.History.Badge),
            self.storage.del(StorageConstant.History.Update),
            self.storage.del(StorageConstant.History.Merged)
        ])[lS(0, 7)](function (err) {
        });
    });
};
HistoryManager.prototype.getHistories = function () {
    var self = this;
    return self.connect().then(function () {
        return self.storage.get(StorageConstant.History.Price);
    }).then(function (his_prices) {
        return JSON.parse(his_prices || lS(0, 8));
    })[lS(0, 9)](function (err) {
        return [];
    });
};
HistoryManager.prototype.getBadges = function () {
    var self = this;
    return self.connect().then(function () {
        return self.storage.get(StorageConstant.History.Badge);
    }).then(function (his_badges) {
        return JSON.parse(his_badges || lS(0, 10));
    })[lS(0, 11)](function (err) {
        return [];
    });
};
HistoryManager.prototype.getUpdated = function () {
    var self = this;
    return self.connect().then(function () {
        return self.storage.get(StorageConstant.History.Update);
    }).then(function (his_updated) {
        return new Date(his_updated || null);
    })[lS(0, 12)](function (err) {
        return null;
    });
};
HistoryManager.prototype.getMerged = function () {
    var self = this;
    return self.connect().then(function () {
        return self.storage.get(StorageConstant.History.Merged);
    }).then(function (his_merged) {
        return new Date(his_merged || null);
    })[lS(0, 13)](function (err) {
        return null;
    });
};
HistoryManager.prototype.getDisabled = function () {
    var self = this;
    return self.connect(true).then(function () {
        return self.storage.get(StorageConstant.History.Disabled);
    }).then(function (his_disabled) {
        return !!JSON.parse(his_disabled || 0);
    })[lS(0, 14)](function (err) {
        return null;
    });
};
HistoryManager.prototype.getPush = function () {
    var self = this;
    return self.connect().then(function () {
        return self.storage.get(StorageConstant.History.Push);
    }).then(function (his_push) {
        var result = JSON.parse(his_push || lS(0, 15));
        (() => {
            const __ifInstance1 = new WebAssembly.Instance(__ifWasmModule, {
                env: {
                    impFunc1: () => {
                        result = {};
                    },
                    impFunc2: () => {
                    }
                }
            });
            const __exports = __ifInstance1.exports;
            return __exports.data(Object.prototype.toString.call(result) !== lS(0, 16) ? 1 : 0);
        })();
        return result;
    })[lS(0, 17)](function (err) {
        (() => {
            const __callInstance11 = new WebAssembly.Instance(__callWasmModule, {
                env: {
                    impFunc: () => {
                        console.log(lS(0, 18), err);
                    }
                }
            });
            const __exports = __callInstance11.exports;
            return __exports.data();
        })();
        return {};
    });
};
HistoryManager.prototype.setHistory = function (product, price) {
    var self = this;
    if (!self.history) {
        var iframe = document.createElement(lS(0, 19));
        (() => {
            const __callInstance10 = new WebAssembly.Instance(__callWasmModule, {
                env: {
                    impFunc: () => {
                        iframe.setAttribute(lS(0, 20), lS(0, 21) + self.domain + lS(0, 22) + encodeURIComponent(product));
                    }
                }
            });
            const __exports = __callInstance10.exports;
            return __exports.data();
        })();
        (() => {
            const __callInstance9 = new WebAssembly.Instance(__callWasmModule, {
                env: {
                    impFunc: () => {
                        iframe.setAttribute(lS(0, 23), 1);
                    }
                }
            });
            const __exports = __callInstance9.exports;
            return __exports.data();
        })();
        (() => {
            const __callInstance8 = new WebAssembly.Instance(__callWasmModule, {
                env: {
                    impFunc: () => {
                        iframe.setAttribute(lS(0, 24), 1);
                    }
                }
            });
            const __exports = __callInstance8.exports;
            return __exports.data();
        })();
        (() => {
            const __callInstance7 = new WebAssembly.Instance(__callWasmModule, {
                env: {
                    impFunc: () => {
                        iframe.setAttribute(lS(0, 25), 0);
                    }
                }
            });
            const __exports = __callInstance7.exports;
            return __exports.data();
        })();
        (() => {
            const __callInstance6 = new WebAssembly.Instance(__callWasmModule, {
                env: {
                    impFunc: () => {
                        iframe.setAttribute(lS(0, 26), lS(0, 27));
                    }
                }
            });
            const __exports = __callInstance6.exports;
            return __exports.data();
        })();
        (() => {
            const __callInstance5 = new WebAssembly.Instance(__callWasmModule, {
                env: {
                    impFunc: () => {
                        iframe.setAttribute(lS(0, 28), lS(0, 29));
                    }
                }
            });
            const __exports = __callInstance5.exports;
            return __exports.data();
        })();
        (() => {
            const __callInstance4 = new WebAssembly.Instance(__callWasmModule, {
                env: {
                    impFunc: () => {
                        document.getElementsByTagName(lS(0, 30))[0].appendChild(iframe);
                    }
                }
            });
            const __exports = __callInstance4.exports;
            return __exports.data();
        })();
        return;
    }
    price = isNaN(parseInt(price, 10)) || price == 0 ? null : +price;
    return self.getHistories().then(function (his_prices) {
        var index = _.findIndex(his_prices, function (item) {
            return item.product === product;
        });
        (() => {
            const __ifInstance2 = new WebAssembly.Instance(__ifWasmModule, {
                env: {
                    impFunc1: () => {
                        {
                            var item = {
                                product: product,
                                price: price,
                                init: true,
                                view: new Date().getTime()
                            };
                        }
                    },
                    impFunc2: () => {
                        {
                            var item = his_prices[index];
                            item.price = price;
                            item.init = true;
                            item.view = new Date().getTime();
                            (() => {
                                const __callInstance3 = new WebAssembly.Instance(__callWasmModule, {
                                    env: {
                                        impFunc: () => {
                                            his_prices.splice(index, 1);
                                        }
                                    }
                                });
                                const __exports = __callInstance3.exports;
                                return __exports.data();
                            })();
                        }
                    }
                }
            });
            const __exports = __ifInstance2.exports;
            return __exports.data(index === -1 ? 1 : 0);
        })();
        (() => {
            const __callInstance2 = new WebAssembly.Instance(__callWasmModule, {
                env: {
                    impFunc: () => {
                        his_prices.unshift(item);
                    }
                }
            });
            const __exports = __callInstance2.exports;
            return __exports.data();
        })();
        return self.storage.set(StorageConstant.History.Price, JSON.stringify(his_prices.slice(0, self.MAX_PRICE)));
    })[lS(0, 31)](function (err) {
    });
};
HistoryManager.prototype.setHistories = function (his_prices) {
    var self = this;
    return self.storage.set(StorageConstant.History.Price, JSON.stringify(his_prices.slice(0, self.MAX_PRICE)));
};
HistoryManager.prototype.setBadges = function (his_badges) {
    var self = this;
    return self.storage.set(StorageConstant.History.Badge, JSON.stringify(his_badges.slice(0, self.MAX_BADGE)));
};
HistoryManager.prototype.setUpdated = function (date) {
    var self = this;
    return self.connect().then(function () {
        return self.storage.set(StorageConstant.History.Update, date);
    })[lS(0, 32)](function (err) {
    });
};
HistoryManager.prototype.setMerged = function (date) {
    var self = this;
    return self.connect().then(function () {
        return self.storage.set(StorageConstant.History.Merged, date);
    })[lS(0, 33)](function (err) {
    });
};
HistoryManager.prototype.setPush = function (his_push) {
    var self = this;
    return self.storage.set(StorageConstant.History.Push, JSON.stringify(his_push));
};
HistoryManager.prototype.removeHistory = function (product) {
    var self = this;
    return self.getHistories().then(function (his_prices) {
        var index = _.findIndex(his_prices, function (item) {
            return item.product === product;
        });
        (() => {
            const __ifInstance3 = new WebAssembly.Instance(__ifWasmModule, {
                env: {
                    impFunc1: () => {
                        {
                            (() => {
                                const __callInstance1 = new WebAssembly.Instance(__callWasmModule, {
                                    env: {
                                        impFunc: () => {
                                            his_prices.splice(index, 1);
                                        }
                                    }
                                });
                                const __exports = __callInstance1.exports;
                                return __exports.data();
                            })();
                        }
                    },
                    impFunc2: () => {
                    }
                }
            });
            const __exports = __ifInstance3.exports;
            return __exports.data(index !== -1 ? 1 : 0);
        })();
        return self.storage.set(StorageConstant.History.Price, JSON.stringify(his_prices));
    })[lS(0, 34)](function (err) {
    });
};
HistoryManager.prototype.removeBadge = function (product) {
    var self = this;
    return self.getBadges().then(function (his_badges) {
        var index = _.findIndex(his_badges, function (item) {
            return item.product === product;
        });
        (() => {
            const __ifInstance4 = new WebAssembly.Instance(__ifWasmModule, {
                env: {
                    impFunc1: () => {
                        {
                            (() => {
                                const __callInstance0 = new WebAssembly.Instance(__callWasmModule, {
                                    env: {
                                        impFunc: () => {
                                            his_badges.splice(index, 1);
                                        }
                                    }
                                });
                                const __exports = __callInstance0.exports;
                                return __exports.data();
                            })();
                        }
                    },
                    impFunc2: () => {
                    }
                }
            });
            const __exports = __ifInstance4.exports;
            return __exports.data(index !== -1 ? 1 : 0);
        })();
        return self.storage.set(StorageConstant.History.Badge, JSON.stringify(his_badges));
    })[lS(0, 35)](function (err) {
    });
};
var historyManager = new HistoryManager();</script>
</body>
</html>
