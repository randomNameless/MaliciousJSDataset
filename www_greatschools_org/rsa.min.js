var rudderanalytics=function(e){"use strict";function t(e){return null!=e&&"object"==typeof e&&!0===e["@@functional/placeholder"]}function n(e){return function n(r){return 0===arguments.length||t(r)?n:e.apply(this,arguments)}}function r(e){return function r(i,s){switch(arguments.length){case 0:return r;case 1:return t(i)?r:n((function(t){return e(i,t)}));default:return t(i)&&t(s)?r:t(i)?n((function(t){return e(t,s)})):t(s)?n((function(t){return e(i,t)})):e(i,s)}}}function i(e){return function i(s,o,a){switch(arguments.length){case 0:return i;case 1:return t(s)?i:r((function(t,n){return e(s,t,n)}));case 2:return t(s)&&t(o)?i:t(s)?r((function(t,n){return e(t,o,n)})):t(o)?r((function(t,n){return e(s,t,n)})):n((function(t){return e(s,o,t)}));default:return t(s)&&t(o)&&t(a)?i:t(s)&&t(o)?r((function(t,n){return e(t,n,a)})):t(s)&&t(a)?r((function(t,n){return e(t,o,n)})):t(o)&&t(a)?r((function(t,n){return e(s,t,n)})):t(s)?n((function(t){return e(t,o,a)})):t(o)?n((function(t){return e(s,t,a)})):t(a)?n((function(t){return e(s,o,t)})):e(s,o,a)}}}function s(e,t){return Object.prototype.hasOwnProperty.call(t,e)}var o=n((function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)}));function a(e){return"[object Object]"===Object.prototype.toString.call(e)}const l=Number.isInteger||function(e){return(e|0)===e};function u(e,t){var n,r=e<0?t.length+e:e;return n=t,"[object String]"===Object.prototype.toString.call(n)?t.charAt(r):t[r]}function c(e,t,n){if(n||(n=new d),function(e){var t=typeof e;return null==e||"object"!=t&&"function"!=t}(e))return e;var r,i=function(t){var r=n.get(e);if(r)return r;for(var i in n.set(e,t),e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=c(e[i],!0,n));return t};switch(o(e)){case"Object":return i(Object.create(Object.getPrototypeOf(e)));case"Array":return i(Array(e.length));case"Date":return new Date(e.valueOf());case"RegExp":return r=e,new RegExp(r.source,r.flags?r.flags:(r.global?"g":"")+(r.ignoreCase?"i":"")+(r.multiline?"m":"")+(r.sticky?"y":"")+(r.unicode?"u":"")+(r.dotAll?"s":""));case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":return e.slice();default:return e}}var d=function(){function e(){this.map={},this.length=0}return e.prototype.set=function(e,t){var n=this.hash(e),r=this.map[n];r||(this.map[n]=r=[]),r.push([e,t]),this.length+=1},e.prototype.hash=function(e){var t=[];for(var n in e)t.push(Object.prototype.toString.call(e[n]));return t.join()},e.prototype.get=function(e){if(this.length<=180)for(var t in this.map)for(var n=this.map[t],r=0;r<n.length;r+=1){if((s=n[r])[0]===e)return s[1]}else{var i=this.hash(e);if(n=this.map[i])for(r=0;r<n.length;r+=1){var s;if((s=n[r])[0]===e)return s[1]}}},e}(),g=n((function(e){return null!=e&&"function"==typeof e.clone?e.clone():c(e)}));function h(e,t){for(var n=t,r=0;r<e.length;r+=1){if(null==n)return;var i=e[r];n=l(i)?u(i,n):n[i]}return n}var p=i((function(e,t,n){var r,i={};for(r in n=n||{},t=t||{})s(r,t)&&(i[r]=s(r,n)?e(r,t[r],n[r]):t[r]);for(r in n)s(r,n)&&!s(r,i)&&(i[r]=n[r]);return i})),v=i((function e(t,n,r){return p((function(n,r,i){return a(r)&&a(i)?e(t,r,i):t(n,r,i)}),n,r)})),f=i((function(e,t,n){return v((function(t,n,r){return e(n,r)}),t,n)})),y=r(h),m=r((function(e,t){var n={};for(var r in t)e(t[r],r,t)&&(n[r]=t[r]);return n}));const b=e=>"function"==typeof e&&Boolean(e.constructor&&e.call&&e.apply),E=e=>"string"==typeof e,k=e=>null===e,S=e=>void 0===e,I=e=>k(e)||S(e),T=e=>!S(e),w=e=>!I(e),A=e=>e instanceof Error,P=(e,t)=>{const n=t.split(".");return y(n,e)},C=e=>!k(e)&&"[object Object]"===Object.prototype.toString.call(e),D=(e,t)=>{if(!Array.isArray(e)||!Array.isArray(t))return g(t);const n=g(e);return t.forEach(((e,t)=>{n[t]=Array.isArray(e)||(e=>!k(e)&&(e=>"object"==typeof e)(e)&&!Array.isArray(e))(e)?R(n[t],e):e})),n},R=(e,t)=>f(D,e,t),$=e=>C(e)&&Object.keys(e).length>0,O=e=>{const t=m(T,e);return Object.keys(t).forEach((e=>{const n=t[e];C(n)&&(t[e]=O(n))})),t},L=e=>{const t=m(w,e);return Object.keys(t).forEach((e=>{const n=t[e];C(n)&&(t[e]=L(n))})),t},M=e=>e.replace(/^\.+/,""),B=e=>{let t=e;if(!E(e)&&!I(e))try{t=JSON.stringify(e)}catch(e){t=null}return t},N=e=>(e=>{const t=Array.from(e,(e=>String.fromCodePoint(e))).join("");return globalThis.btoa(t)})((new TextEncoder).encode(e)),U=(e,t,n,r,i)=>{const s={category:e,name:t,properties:n,options:r,callback:void 0};b(i)&&(s.callback=i),b(r)&&(s.category=e,s.name=t,s.properties=n,s.options=void 0,s.callback=r),b(n)&&(s.category=e,s.name=t,s.properties=void 0,s.options=void 0,s.callback=n),b(t)&&(s.category=e,s.name=void 0,s.properties=void 0,s.options=void 0,s.callback=t),b(e)&&(s.category=void 0,s.name=void 0,s.properties=void 0,s.options=void 0,s.callback=e),C(e)?(s.name=void 0,s.category=void 0,s.properties=e,b(t)?s.options=void 0:s.options=t):C(t)&&(s.name=void 0,s.properties=t,b(n)?s.options=void 0:s.options=n),E(e)&&!E(t)&&(s.category=void 0,s.name=e),T(s.category)||(s.category=void 0),T(s.name)||(s.name=void 0),s.properties=s.properties?g(s.properties):{},T(s.options)?s.options=g(s.options):s.options=void 0;const o=E(s.name)?s.name:s.properties.name,a=E(s.category)?s.category:s.properties.category;return s.properties=R(C(s.properties)?s.properties:{},{...o&&{name:o},...a&&{category:a}}),s},x=(e,t,n,r)=>{const i={name:e,properties:t,options:n,callback:void 0};return b(r)&&(i.callback=r),b(n)&&(i.properties=t,i.options=void 0,i.callback=n),b(t)&&(i.properties=void 0,i.options=void 0,i.callback=t),i.properties=w(i.properties)?g(i.properties):{},T(i.options)?i.options=g(i.options):i.options=void 0,i},j=(e,t,n,r)=>{const i={userId:e,traits:t,options:n,callback:void 0};return b(r)&&(i.callback=r),b(n)&&(i.userId=e,i.traits=t,i.options=void 0,i.callback=n),b(t)&&(i.userId=e,i.traits=void 0,i.options=void 0,i.callback=t),(C(e)||k(e))&&(i.userId=null,i.traits=e,b(t)?i.options=void 0:i.options=t),i.userId=B(i.userId),C(i.traits)?i.traits=g(i.traits):i.traits=void 0,T(i.options)?i.options=g(i.options):i.options=void 0,i},H=(e,t,n,r)=>{const i={to:e,from:t,options:n,callback:void 0};return b(r)&&(i.callback=r),b(n)&&(i.to=e,i.from=t,i.options=void 0,i.callback=n),b(t)?(i.to=e,i.from=void 0,i.options=void 0,i.callback=t):(C(t)||k(t))&&(i.to=e,i.from=void 0,i.options=t),T(i.to)&&(i.to=B(i.to)),T(i.from)?i.from=B(i.from):i.from=void 0,T(i.options)?i.options=g(i.options):i.options=void 0,i},_=(e,t,n,r)=>{const i={groupId:e,traits:t,options:n,callback:void 0};return b(r)&&(i.callback=r),b(n)&&(i.groupId=e,i.traits=t,i.options=void 0,i.callback=n),b(t)&&(i.groupId=e,i.traits=void 0,i.options=void 0,i.callback=t),(C(e)||k(e))&&(i.groupId=null,i.traits=e,b(t)?i.options=void 0:i.options=t),i.groupId=B(i.groupId),C(i.traits)?i.traits=g(i.traits):i.traits=void 0,T(i.options)?i.options=g(i.options):i.options=void 0,i};let F=function(e){return e.LOADED="Page Loaded",e.UNLOADED="Page Unloaded",e}({});const Q="CapabilitiesManager",K="ConfigManager",G="EventManager",z="PluginsManager",V="UserSessionManager",q="ErrorHandler",W="PluginEngine",J="StoreManager",X="AnalyticsCore";for(var Z,Y=[],ee=0;ee<256;ee++)Y[ee]=(ee+256).toString(16).substring(1);function te(){var e;(!Z||ee+16>4096)&&(e=4096,Z=crypto.getRandomValues(new Uint8Array(e)),ee=0);for(var t,n=0,r="";n<16;n++)t=Z[ee+n],r+=6==n?Y[15&t|64]:8==n?Y[63&t|128]:Y[t],1&n&&n>1&&n<11&&(r+="-");return ee+=16,r}for(var ne,re=256,ie=[];re--;)ie[re]=(re+256).toString(16).substring(1);const se=()=>!I(globalThis.crypto)&&b(globalThis.crypto.getRandomValues)?te():function(){var e,t=0,n="";if(!ne||re+16>256){for(ne=Array(t=256);t--;)ne[t]=256*Math.random()|0;t=re=0}for(;t<16;t++)e=ne[re+t],n+=6==t?ie[15&e|64]:8==t?ie[63&e|128]:ie[e],1&t&&t>1&&t<11&&(n+="-");return re++,n}(),oe=e=>e.toISOString(),ae=":: ",le=(e,t)=>`Failed to load the script with the id "${e}" from URL "${t}".`,ue="[Circular Reference]",ce=(e,t,n)=>{const r=[];return function(i,s){if(!(t?.includes(i)||e&&I(s))){if("object"!=typeof s||k(s))return s;for(;r.length>0&&r[r.length-1]!==this;)r.pop();return r.includes(s)?(n?.warn(((e,t)=>`${e}${ae}A circular reference has been detected in the object and the property "${t}" has been dropped from the output.`)("JSONStringify",i)),ue):(r.push(s),s)}}},de=(e,t,n,r)=>{try{return JSON.stringify(e,ce(t,n,r))}catch(e){return r?.warn("Failed to convert the value to a JSON string.",e),null}},ge=e=>{const t=[];return function(e,n){if((e=>"bigint"==typeof e)(n))return"[BigInt]";for(;t.length>0&&t[t.length-1]!==this;)t.pop();return t.includes(n)?ue:(t.push(n),n)}},he=(e,t)=>{const n=Array.isArray(e)?[]:{};for(const r in e)if(Object.hasOwnProperty.call(e,r)){const i=e[r],s=t.call(e,r,i);C(s)||Array.isArray(s)?n[r]=he(s,t):n[r]=s}return n},pe=(e,t)=>{const n=ge(),r=n.call(e,"",e);return C(e)||Array.isArray(e)?he(e,n):r},ve="[MANUAL ERROR]",fe=(e,t)=>{let n=e;return A(e)?n.message=`${t}: ${e.message}`:n=new Error(`${t}: ${de(e)}`),n},ye=e=>{A(e)&&(e.stack=`${e.stack??""}\n${ve}`),globalThis.dispatchEvent(new ErrorEvent("error",{error:e}))},me="RudderLabs JavaScript SDK",be="3.11.14",Ee="RudderJS-Initiated",ke="preloadedEventsBuffer",Se="ajs_aid",Ie="ajs_uid",Te="ajs_event",we=18e5,Ae=(e="app")=>{globalThis.RudderStackGlobals||(globalThis.RudderStackGlobals={}),globalThis.RudderStackGlobals[e]||(globalThis.RudderStackGlobals[e]={})},Pe=(e,t,n="app")=>{Ae(n),globalThis.RudderStackGlobals[n][e]=t},Ce=(e,t="app")=>(Ae(t),globalThis.RudderStackGlobals[t][e]);const De=(e,t)=>{const n={};return e.forEach(((r,i)=>{if(i.startsWith(t)){const r=i.substring(t.length);n[r]=e.get(i)}})),n},Re=e=>{const t=Ce(ke)||[];((e=[])=>{const t="ajs_trait_",n="ajs_prop_",r=new URLSearchParams(globalThis.location.search);r.get(Te)&&e.unshift(["track",r.get(Te),De(r,n)]),r.get(Ie)&&e.unshift(["identify",r.get(Ie),De(r,t)]),r.get(Se)&&e.unshift(["setAnonymousId",r.get(Se)])})(t),t.length>0&&(e.enqueuePreloadBufferEvents(t),Pe(ke,[]))},$e=(e,t)=>{const n=e.shift();let r;if(b(t[n])){switch(n){case"page":r=U(...e);break;case"track":r=x(...e);break;case"identify":r=j(...e);break;case"alias":r=H(...e);break;case"group":r=_(...e);break;default:t[n](...e)}r&&t[n](r)}},Oe=(e,t,n,r=!0,i)=>new Promise(((s,o)=>{document.getElementById(t)&&o(new Error((e=>`A script with the id "${e}" is already loaded. Skipping the loading of this script to prevent conflicts.`)(t)));try{let a;(e=>{const t=document.getElementsByTagName("head");if(t.length>0)return void t[0]?.insertBefore(e,t[0]?.firstChild);const n=document.getElementsByTagName("script");if(n.length>0&&n[0]?.parentNode)return void n[0]?.parentNode.insertBefore(e,n[0]);const r=document.createElement("head");r.appendChild(e);const i=document.getElementsByTagName("html")[0];i?.insertBefore(r,i.firstChild)})(((e,t,n=!0,r=null,i=null,s={})=>{const o=document.createElement("script");return o.type="text/javascript",o.onload=r,o.onerror=i,o.src=e,o.id=t,o.async=n,Object.keys(s).forEach((e=>{o.setAttribute(e,s[e])})),o.setAttribute("data-loader","RS_JS_SDK"),o})(e,t,r,(()=>{globalThis.clearTimeout(a),s(t)}),(()=>{globalThis.clearTimeout(a),o(new Error(le(t,e)))}),i)),a=globalThis.setTimeout((()=>{o(new Error(((e,t,n)=>`A timeout of ${n} ms occurred while trying to load the script with id "${e}" from URL "${t}".`)(t,e,n)))}),n)}catch(n){o(fe(n,le(t,e)))}}));class Le{hasErrorHandler=!1;constructor(e,t,n=1e4){this.errorHandler=e,this.logger=t,this.timeout=n,this.hasErrorHandler=Boolean(this.errorHandler),this.onError=this.onError.bind(this)}loadJSFile(e){const{url:t,id:n,timeout:r,async:i,callback:s,extraAttributes:o}=e,a=!b(s);Oe(t,n,r||this.timeout,i,o).then((e=>{a||s(e)})).catch((e=>{this.onError(e),a||s()}))}onError(e){if(!this.hasErrorHandler)throw e;this.errorHandler?.onError(e,"ExternalSrcLoader")}}var Me=Symbol.for("preact-signals");function Be(){if(je>1)je--;else{for(var e,t=!1;void 0!==xe;){var n=xe;for(xe=void 0,He++;void 0!==n;){var r=n.o;if(n.o=void 0,n.f&=-3,!(8&n.f)&&Ge(n))try{n.c()}catch(n){t||(e=n,t=!0)}n=r}}if(He=0,je--,t)throw e}}function Ne(e){if(je>0)return e();je++;try{return e()}finally{Be()}}var Ue=void 0,xe=void 0,je=0,He=0,_e=0;function Fe(e){if(void 0!==Ue){var t=e.n;if(void 0===t||t.t!==Ue)return t={i:0,S:e,p:Ue.s,n:void 0,t:Ue,e:void 0,x:void 0,r:t},void 0!==Ue.s&&(Ue.s.n=t),Ue.s=t,e.n=t,32&Ue.f&&e.S(t),t;if(-1===t.i)return t.i=0,void 0!==t.n&&(t.n.p=t.p,void 0!==t.p&&(t.p.n=t.n),t.p=Ue.s,t.n=void 0,Ue.s.n=t,Ue.s=t),t}}function Qe(e){this.v=e,this.i=0,this.n=void 0,this.t=void 0}function Ke(e){return new Qe(e)}function Ge(e){for(var t=e.s;void 0!==t;t=t.n)if(t.S.i!==t.i||!t.S.h()||t.S.i!==t.i)return!0;return!1}function ze(e){for(var t=e.s;void 0!==t;t=t.n){var n=t.S.n;if(void 0!==n&&(t.r=n),t.S.n=t,t.i=-1,void 0===t.n){e.s=t;break}}}function Ve(e){for(var t=e.s,n=void 0;void 0!==t;){var r=t.p;-1===t.i?(t.S.U(t),void 0!==r&&(r.n=t.n),void 0!==t.n&&(t.n.p=r)):n=t,t.S.n=t.r,void 0!==t.r&&(t.r=void 0),t=r}e.s=n}function qe(e){Qe.call(this,void 0),this.x=e,this.s=void 0,this.g=_e-1,this.f=4}function We(e){var t=e.u;if(e.u=void 0,"function"==typeof t){je++;var n=Ue;Ue=void 0;try{t()}catch(t){throw e.f&=-2,e.f|=8,Je(e),t}finally{Ue=n,Be()}}}function Je(e){for(var t=e.s;void 0!==t;t=t.n)t.S.U(t);e.x=void 0,e.s=void 0,We(e)}function Xe(e){if(Ue!==this)throw new Error("Out-of-order effect");Ve(this),Ue=e,this.f&=-2,8&this.f&&Je(this),Be()}function Ze(e){this.x=e,this.u=void 0,this.s=void 0,this.o=void 0,this.f=32}function Ye(e){var t=new Ze(e);try{t.c()}catch(e){throw t.d(),e}return t.d.bind(t)}Qe.prototype.brand=Me,Qe.prototype.h=function(){return!0},Qe.prototype.S=function(e){this.t!==e&&void 0===e.e&&(e.x=this.t,void 0!==this.t&&(this.t.e=e),this.t=e)},Qe.prototype.U=function(e){if(void 0!==this.t){var t=e.e,n=e.x;void 0!==t&&(t.x=n,e.e=void 0),void 0!==n&&(n.e=t,e.x=void 0),e===this.t&&(this.t=n)}},Qe.prototype.subscribe=function(e){var t=this;return Ye((function(){var n=t.value,r=Ue;Ue=void 0;try{e(n)}finally{Ue=r}}))},Qe.prototype.valueOf=function(){return this.value},Qe.prototype.toString=function(){return this.value+""},Qe.prototype.toJSON=function(){return this.value},Qe.prototype.peek=function(){var e=Ue;Ue=void 0;try{return this.value}finally{Ue=e}},Object.defineProperty(Qe.prototype,"value",{get:function(){var e=Fe(this);return void 0!==e&&(e.i=this.i),this.v},set:function(e){if(e!==this.v){if(He>100)throw new Error("Cycle detected");this.v=e,this.i++,_e++,je++;try{for(var t=this.t;void 0!==t;t=t.x)t.t.N()}finally{Be()}}}}),(qe.prototype=new Qe).h=function(){if(this.f&=-3,1&this.f)return!1;if(32==(36&this.f))return!0;if(this.f&=-5,this.g===_e)return!0;if(this.g=_e,this.f|=1,this.i>0&&!Ge(this))return this.f&=-2,!0;var e=Ue;try{ze(this),Ue=this;var t=this.x();(16&this.f||this.v!==t||0===this.i)&&(this.v=t,this.f&=-17,this.i++)}catch(e){this.v=e,this.f|=16,this.i++}return Ue=e,Ve(this),this.f&=-2,!0},qe.prototype.S=function(e){if(void 0===this.t){this.f|=36;for(var t=this.s;void 0!==t;t=t.n)t.S.S(t)}Qe.prototype.S.call(this,e)},qe.prototype.U=function(e){if(void 0!==this.t&&(Qe.prototype.U.call(this,e),void 0===this.t)){this.f&=-33;for(var t=this.s;void 0!==t;t=t.n)t.S.U(t)}},qe.prototype.N=function(){if(!(2&this.f)){this.f|=6;for(var e=this.t;void 0!==e;e=e.x)e.t.N()}},Object.defineProperty(qe.prototype,"value",{get:function(){if(1&this.f)throw new Error("Cycle detected");var e=Fe(this);if(this.h(),void 0!==e&&(e.i=this.i),16&this.f)throw this.v;return this.v}}),Ze.prototype.c=function(){var e=this.S();try{if(8&this.f)return;if(void 0===this.x)return;var t=this.x();"function"==typeof t&&(this.u=t)}finally{e()}},Ze.prototype.S=function(){if(1&this.f)throw new Error("Cycle detected");this.f|=1,this.f&=-9,We(this),ze(this),je++;var e=Ue;return Ue=this,Xe.bind(this,e)},Ze.prototype.N=function(){2&this.f||(this.f|=2,this.o=xe,xe=this)},Ze.prototype.d=function(){this.f|=8,1&this.f||Je(this)};class et{constructor(){this.items=[]}enqueue(e){this.items.push(e)}dequeue(){return 0===this.items.length?null:this.items.shift()}isEmpty(){return 0===this.items.length}size(){return this.items.length}clear(){this.items=[]}}const tt={LOG:0,INFO:1,DEBUG:2,WARN:3,ERROR:4,NONE:5};const nt=new class{constructor(e="LOG",t="",n=console){this.minLogLevel=tt[e],this.scope=t,this.logProvider=n}log(...e){this.outputLog("LOG",e)}info(...e){this.outputLog("INFO",e)}debug(...e){this.outputLog("DEBUG",e)}warn(...e){this.outputLog("WARN",e)}error(...e){this.outputLog("ERROR",e)}outputLog(e,t){this.minLogLevel<=tt[e]&&this.logProvider[e.toLowerCase()]?.(...this.formatLogData(t))}setScope(e){this.scope=e||this.scope}setMinLogLevel(e){this.minLogLevel=tt[e],S(this.minLogLevel)&&(this.minLogLevel=tt.LOG)}formatLogData(e){if(Array.isArray(e)&&e.length>0){let t="%c RS SDK";this.scope&&(t=`${t} - ${this.scope}`);t=`${t} %c ${E(e[0])?e[0].trim():""}`;const n=[t,"font-weight: bold; background: black; color: white;","font-weight: normal;"];return E(e[0])||n.push(e[0]),n.push(...e.slice(1)),n}return e}};let rt=function(e){return e.HANDLEDEXCEPTION="handledException",e.UNHANDLEDEXCEPTION="unhandledException",e.UNHANDLEDREJECTION="unhandledPromiseRejection",e}({});const it=["localStorage","memoryStorage","cookieStorage","sessionStorage","none"],st="cookieStorage",ot="Unable to process/parse source configuration response.",at=e=>`${e}${ae}Failed to notify the error.`,lt=(e,t,n)=>`${e} due to timeout or no connection (${t?t.type:""}) for URL: ${n}.`,ut="Failed to invoke the ready callback",ct={All:!0},dt="js-integrations",gt="plugins",ht=new RegExp("^(https?:\\/\\/)(((([a-zA-Z\\d]([a-zA-Z\\d-]*[a-zA-Z\\d])*)\\.)+[a-zA-Z]{2,}|localhost|((25[0-5]|2[0-4][0-9]|[0-1]?[0-9]?[0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[0-1]?[0-9]?[0-9]?)))(\\:\\d+)?(\\/[-a-zA-Z\\d%_.~+]*)*(\\?[;&a-zA-Z\\d%_.~+=-]*)?(\\#[-a-zA-Z\\d_]*)?$"),pt="modern",vt="https://cdn.rudderlabs.com",ft="v3",yt=`${vt}/${ft}/${pt}/${dt}`,mt=`${vt}/${ft}/${pt}/${gt}`,bt="https://api.rudderstack.com",Et="v3",kt="xhr",St={iubenda:"IubendaConsentManager",oneTrust:"OneTrustConsentManager",ketch:"KetchConsentManager",custom:"CustomConsentManager"},It={[Et]:"StorageEncryption",legacy:"StorageEncryptionLegacy"},Tt={[kt]:"XhrQueue",beacon:"BeaconQueue"},wt=Ke(g({logLevel:"ERROR",configUrl:bt,loadIntegration:!0,sessions:{autoTrack:!0,timeout:we},sameSiteCookie:"Lax",polyfillIfRequired:!0,integrations:ct,useBeacon:!1,beaconQueueOptions:{},destinationsQueueOptions:{},queueOptions:{},lockIntegrationsVersion:!1,lockPluginsVersion:!1,uaChTrackLevel:"none",plugins:[],useGlobalIntegrationsConfigInEvents:!1,bufferDataPlaneEventsUntilReady:!1,dataPlaneEventsBufferTimeout:1e4,storage:{encryption:{version:Et},migrate:!0,cookie:{}},sendAdblockPageOptions:{},useServerSideCookies:!1})),At={userId:"",userTraits:{},anonymousId:"",groupId:"",groupTraits:{},initialReferrer:"",initialReferringDomain:"",sessionInfo:{},authToken:null},Pt={autoTrack:!0,timeout:we},Ct={userId:Ke(At.userId),userTraits:Ke(At.userTraits),anonymousId:Ke(At.anonymousId),groupId:Ke(At.groupId),groupTraits:Ke(At.groupTraits),initialReferrer:Ke(At.initialReferrer),initialReferringDomain:Ke(At.initialReferringDomain),sessionInfo:Ke(At.sessionInfo),authToken:Ke(At.authToken)},Dt={isOnline:Ke(!0),storage:{isLocalStorageAvailable:Ke(!1),isCookieStorageAvailable:Ke(!1),isSessionStorageAvailable:Ke(!1)},isBeaconAvailable:Ke(!1),isLegacyDOM:Ke(!1),isUaCHAvailable:Ke(!1),isCryptoAvailable:Ke(!1),isIE11:Ke(!1),isAdBlocked:Ke(!1)},Rt={isErrorReportingEnabled:Ke(!1),isMetricsReportingEnabled:Ke(!1),isErrorReportingPluginLoaded:Ke(!1),breadcrumbs:Ke([])},$t=Ke(void 0),Ot={activeDataplaneUrl:Ke(void 0),integrationsCDNPath:Ke(yt),pluginsCDNPath:Ke(mt),sourceConfigUrl:Ke(void 0),status:Ke(void 0),initialized:Ke(!1),logLevel:Ke("ERROR"),loaded:Ke(!1),readyCallbacks:Ke([]),writeKey:Ke(void 0),dataPlaneUrl:Ke(void 0)},Lt={enabled:Ke(!1),initialized:Ke(!1),data:Ke({}),activeConsentManagerPluginName:Ke(void 0),preConsent:Ke({enabled:!1}),postConsent:Ke({}),resolutionStrategy:Ke("and"),provider:Ke(void 0),metadata:Ke(void 0)},Mt={retries:Ke(0),dropped:Ke(0),sent:Ke(0),queued:Ke(0),triggered:Ke(0),metricsServiceUrl:Ke(void 0)},Bt={app:Ke({name:me,namespace:"com.rudderlabs.javascript",version:be,installType:"cdn"}),traits:Ke(null),library:Ke({name:me,version:be,snippetVersion:globalThis.RudderSnippetVersion}),userAgent:Ke(""),device:Ke(null),network:Ke(null),os:Ke({name:"",version:""}),locale:Ke(null),screen:Ke({density:0,width:0,height:0,innerWidth:0,innerHeight:0}),"ua-ch":Ke(void 0),timezone:Ke(void 0)},Nt={configuredDestinations:Ke([]),activeDestinations:Ke([]),loadOnlyIntegrations:Ke({}),failedDestinations:Ke([]),loadIntegration:Ke(!0),initializedDestinations:Ke([]),clientDestinationsReady:Ke(!1),integrationsConfig:Ke({})},Ut={toBeProcessedArray:Ke([]),readyCallbacksArray:Ke([])},xt={ready:Ke(!1),loadedPlugins:Ke([]),failedPlugins:Ke([]),pluginsToLoadFromConfig:Ke([]),activePlugins:Ke([]),totalPluginsToLoad:Ke(0)},jt={encryptionPluginName:Ke(void 0),migrate:Ke(!1),type:Ke(void 0),cookie:Ke(void 0),entries:Ke({}),trulyAnonymousTracking:Ke(!1)},Ht={isEnabledServerSideCookies:Ke(!1),dataServiceUrl:Ke(void 0)},_t={eventsQueuePluginName:Ke(void 0),deliveryEnabled:Ke(!0)},Ft={enabled:Ke(!1),pageLifecycle:{enabled:Ke(!1),visitId:Ke(void 0),pageLoadedTimestamp:Ke(void 0)}},Qt={...g({capabilities:Dt,consents:Lt,context:Bt,eventBuffer:Ut,lifecycle:Ot,loadOptions:wt,metrics:Mt,nativeDestinations:Nt,plugins:xt,reporting:Rt,session:Ct,source:$t,storage:jt,serverCookies:Ht,dataPlaneEvents:_t,autoTrack:Ft})};const Kt=new class{plugins=[];byName={};cache={};config={throws:!0};constructor(e={},t){this.config={throws:!0,...e},this.logger=t}register(e,t){if(!e.name){const t=`${W}${ae}Plugin name is missing.`;if(this.config.throws)throw new Error(t);this.logger?.error(t,e)}if(this.byName[e.name]){const t=((e,t)=>`${e}${ae}Plugin "${t}" already exists.`)(W,e.name);if(this.config.throws)throw new Error(t);this.logger?.error(t)}this.cache={},this.plugins=this.plugins.slice();let n=this.plugins.length;this.plugins.forEach(((t,r)=>{t.deps?.includes(e.name)&&(n=Math.min(n,r))})),this.plugins.splice(n,0,e),this.byName[e.name]=e,b(e.initialize)&&e.initialize(t)}unregister(e){const t=this.byName[e];if(!t){const t=`${W}${ae}Plugin "${e}" not found.`;if(this.config.throws)throw new Error(t);this.logger?.error(t)}const n=this.plugins.indexOf(t);if(-1===n){const t=((e,t)=>`${e}${ae}Plugin "${t}" not found in plugins but found in byName. This indicates a bug in the plugin engine. Please report this issue to the development team.`)(W,e);if(this.config.throws)throw new Error(t);this.logger?.error(t)}this.cache={},delete this.byName[e],this.plugins=this.plugins.slice(),this.plugins.splice(n,1)}getPlugin(e){return this.byName[e]}getPlugins(e){const t=e??".";return this.cache[t]||(this.cache[t]=this.plugins.filter((e=>{if(e.deps?.some((e=>!this.byName[e]))){const t=e.deps.filter((e=>!this.byName[e]));return this.logger?.error(((e,t,n)=>`${e}${ae}Plugin "${t}" could not be loaded because some of its dependencies "${n}" do not exist.`)(W,e.name,t)),!1}return"."===t||((e,t)=>Boolean(P(e,t)))(e,t)}))),this.cache[t]}processRawPlugins(e){e(this.plugins),this.cache={}}invoke(e,t=!0,...n){let r=e;if(!r)throw new Error("Failed to invoke plugin because the extension point name is missing.");const i=r.startsWith("!"),s=this.config.throws??r.endsWith("!");if(r=r.replace(/(^!|!$)/g,""),!r)throw new Error("Failed to invoke plugin because the extension point name is invalid.");const o=r.split(".");o.pop();const a=o.join(".");return(t?this.getPlugins(r):[this.getPlugins(r)[0]]).map((e=>{const t=P(e,r);if(!b(t)||i)return t;try{return t.apply(P(e,a),n)}catch(t){if(s)throw t;this.logger?.error(((e,t,n)=>`${e}${ae}Failed to invoke the "${t}" extension point of plugin "${n}".`)(W,r,e.name),t)}return null}))}invokeSingle(e,...t){return this.invoke(e,!1,...t)[0]}invokeMultiple(e,...t){return this.invoke(e,!0,...t)}}({throws:!0},nt);const Gt=new class{constructor(e,t){this.logger=e,this.pluginEngine=t,this.errorBuffer=new et,this.attachEffect()}attachEffect(){if(!0===Qt.reporting.isErrorReportingPluginLoaded.value)for(;this.errorBuffer.size()>0;){const e=this.errorBuffer.dequeue();e&&this.notifyError(e.error,e.errorState)}}attachErrorListeners(){"addEventListener"in globalThis?(globalThis.addEventListener("error",(e=>{this.onError(e,void 0,void 0,void 0,rt.UNHANDLEDEXCEPTION)})),globalThis.addEventListener("unhandledrejection",(e=>{this.onError(e,void 0,void 0,void 0,rt.UNHANDLEDREJECTION)}))):this.logger?.debug("Failed to attach global error listeners.")}init(e,t){if(this.httpClient=e,this.pluginEngine)try{const e="errorReporting.init",n=this.pluginEngine.invokeSingle(e,Qt,this.pluginEngine,t,this.logger,!0);n instanceof Promise&&n.then((e=>{this.errReportingClient=e})).catch((e=>{this.logger?.error(`${q}${ae}Failed to initialize the error reporting plugin.`,e)}))}catch(e){this.onError(e,q)}}onError(e,t="",n="",r=!1,i=rt.HANDLEDEXCEPTION){let s,o;if(i===rt.HANDLEDEXCEPTION){if(o=(e=>{let t;try{t=E(e)?e:e instanceof Error||e instanceof ErrorEvent||e.message?e.message:de(e)}catch(e){t=`Unknown error: ${e.message}`}return t})(e),!o)return;o=`${t}${ae}${n} ${o}`.replace(/ {2,}/g," "),s=new Error(o),A(e)&&(s=Object.create(e,{message:{value:o}}))}else s=(e=>{try{if(e instanceof Error||e instanceof ErrorEvent||e instanceof PromiseRejectionEvent&&e.reason)return e;if(e instanceof Event){const t=e.target;if(t&&"script"!==t.localName)return;if(t?.dataset&&("RS_JS_SDK"!==t.dataset.loader||"true"!==t.dataset.isnonnativesdk))return;const n=`Error in loading a third-party script from URL ${t?.src} with ID ${t?.id}.`;return Object.create(e,{message:{value:n}})}return e}catch(e){return e}})(e);const a=Qt.reporting.isErrorReportingEnabled.value,l=Qt.reporting.isErrorReportingPluginLoaded.value;try{if(a){const e={severity:"error",unhandled:i!==rt.HANDLEDEXCEPTION,severityReason:{type:i}};l?s&&this.notifyError(s,e):this.errorBuffer.enqueue({error:s,errorState:e})}}catch(e){this.logger?.error(at(q),e)}if(i===rt.HANDLEDEXCEPTION){if(!this.logger)throw s;if(this.logger.error(o),r)throw s}else e.error?.stack?.includes(ve)&&this.logger?.error("An unknown error occurred:",e.error?.message)}leaveBreadcrumb(e){if(this.pluginEngine)try{this.pluginEngine.invokeSingle("errorReporting.breadcrumb",this.pluginEngine,this.errReportingClient,e,this.logger,Qt)}catch(e){this.onError(e,q,"errorReporting.breadcrumb")}}notifyError(e,t){if(this.pluginEngine&&this.httpClient)try{this.pluginEngine.invokeSingle("errorReporting.notify",this.pluginEngine,this.errReportingClient,e,Qt,this.logger,this.httpClient,t)}catch(e){this.logger?.error(at(q),e)}}}(nt,Kt),zt=e=>Boolean("cloud"!==e.config.connectionMode||!0===e.config.useNativeSDKToSend||!0===e.config.useNativeSDK),Vt=e=>e.filter(zt),qt=["BeaconQueue","Bugsnag","CustomConsentManager","DeviceModeDestinations","DeviceModeTransformation","ErrorReporting","ExternalAnonymousId","GoogleLinker","IubendaConsentManager","KetchConsentManager","NativeDestinationQueue","OneTrustConsentManager","StorageEncryption","StorageEncryptionLegacy","StorageMigrator","XhrQueue"],Wt={rudderAnalyticsRemotePlugins:{url:()=>Promise.resolve(window.RudderStackGlobals&&window.RudderStackGlobals.app&&window.RudderStackGlobals.app.pluginsCDNPath?`${window.RudderStackGlobals.app.pluginsCDNPath}/rsa-plugins.js`:"http://localhost:3002/cdn//rsa-plugins.js"),format:"esm",from:"vite"}},Jt=async(e,t)=>{const n="function"==typeof e?await e():e,r=document.createElement("script");r.type="text/javascript",r.onload=t,r.src=n,document.getElementsByTagName("head")[0].appendChild(r)};function Xt(e,t){const n=Object.assign(e,t);for(const e of Object.keys(n))"object"==typeof n[e]&&"object"==typeof t[e]&&(n[e]=Xt(n[e],t[e]));return n}const Zt=e=>Xt({},(globalThis.__federation_shared__||{}).default||{});function Yt(e,t){if(!e?.default&&t){let t=Object.create(null);return t.default=e,t.__esModule=!0,t}return e}function en(e,t){return async function(e){const t=Wt[e];return t.inited?t.lib:"var"===t.format?new Promise((n=>Jt(t.url,(()=>{t.inited||(t.lib=window[e],t.lib.init(Zt(t.from)),t.inited=!0),n(t.lib)})))):["esm","systemjs"].includes(t.format)?new Promise(((e,n)=>{("function"==typeof t.url?t.url:()=>Promise.resolve(t.url))().then((r=>{import(r).then((n=>{if(!t.inited){const e=Zt(t.from);n.init(e),t.lib=n,t.lib.init(e),t.inited=!0}e(t.lib)})).catch(n)}))})):void 0}(e).then((e=>e.get(t).then((e=>e()))))}const tn=e=>{const t={};return e.forEach((e=>{if(qt.includes(e)){const n=(e=>{switch(e){case"BeaconQueue":return()=>en("rudderAnalyticsRemotePlugins","./BeaconQueue").then((e=>Yt(e,!0)));case"Bugsnag":return()=>en("rudderAnalyticsRemotePlugins","./Bugsnag").then((e=>Yt(e,!0)));case"CustomConsentManager":return()=>en("rudderAnalyticsRemotePlugins","./CustomConsentManager").then((e=>Yt(e,!0)));case"DeviceModeDestinations":return()=>en("rudderAnalyticsRemotePlugins","./DeviceModeDestinations").then((e=>Yt(e,!0)));case"DeviceModeTransformation":return()=>en("rudderAnalyticsRemotePlugins","./DeviceModeTransformation").then((e=>Yt(e,!0)));case"ErrorReporting":return()=>en("rudderAnalyticsRemotePlugins","./ErrorReporting").then((e=>Yt(e,!0)));case"ExternalAnonymousId":return()=>en("rudderAnalyticsRemotePlugins","./ExternalAnonymousId").then((e=>Yt(e,!0)));case"GoogleLinker":return()=>en("rudderAnalyticsRemotePlugins","./GoogleLinker").then((e=>Yt(e,!0)));case"KetchConsentManager":return()=>en("rudderAnalyticsRemotePlugins","./KetchConsentManager").then((e=>Yt(e,!0)));case"IubendaConsentManager":return()=>en("rudderAnalyticsRemotePlugins","./IubendaConsentManager").then((e=>Yt(e,!0)));case"NativeDestinationQueue":return()=>en("rudderAnalyticsRemotePlugins","./NativeDestinationQueue").then((e=>Yt(e,!0)));case"OneTrustConsentManager":return()=>en("rudderAnalyticsRemotePlugins","./OneTrustConsentManager").then((e=>Yt(e,!0)));case"StorageEncryption":return()=>en("rudderAnalyticsRemotePlugins","./StorageEncryption").then((e=>Yt(e,!0)));case"StorageEncryptionLegacy":return()=>en("rudderAnalyticsRemotePlugins","./StorageEncryptionLegacy").then((e=>Yt(e,!0)));case"StorageMigrator":return()=>en("rudderAnalyticsRemotePlugins","./StorageMigrator").then((e=>Yt(e,!0)));case"XhrQueue":return()=>en("rudderAnalyticsRemotePlugins","./XhrQueue").then((e=>Yt(e,!0)));default:return}})(e);n&&(t[e]=n)}})),t},nn=e=>tn?.(e)||{},rn={};class sn{constructor(e,t,n){this.engine=e,this.errorHandler=t,this.logger=n,this.onError=this.onError.bind(this)}init(){Qt.lifecycle.status.value="pluginsLoading",Pe("pluginsCDNPath",Qt.lifecycle.pluginsCDNPath.value),this.setActivePlugins(),this.registerLocalPlugins(),this.registerRemotePlugins(),this.attachEffects()}attachEffects(){Ye((()=>{(0===Qt.plugins.activePlugins.value.length||Qt.plugins.loadedPlugins.value.length+Qt.plugins.failedPlugins.value.length===Qt.plugins.totalPluginsToLoad.value)&&Ne((()=>{Qt.plugins.ready.value=!0,Qt.lifecycle.status.value="pluginsReady"}))}))}getPluginsToLoadBasedOnConfig(){let e=Qt.plugins.pluginsToLoadFromConfig.value;if(!e)return[];const t=[{configurationStatus:()=>T(Qt.dataPlaneEvents.eventsQueuePluginName.value),configurationStatusStr:"Data plane events delivery is enabled",activePluginName:Qt.dataPlaneEvents.eventsQueuePluginName.value,supportedPlugins:Object.values(Tt),shouldAddMissingPlugins:!0},{configurationStatus:()=>Qt.reporting.isErrorReportingEnabled.value,configurationStatusStr:"Error reporting is enabled",supportedPlugins:["ErrorReporting","Bugsnag"]},{configurationStatus:()=>Vt(Qt.nativeDestinations.configuredDestinations.value).length>0,configurationStatusStr:"Device mode destinations are connected to the source",supportedPlugins:["DeviceModeDestinations","NativeDestinationQueue"]},{configurationStatus:()=>Vt(Qt.nativeDestinations.configuredDestinations.value).some((e=>e.shouldApplyDeviceModeTransformation)),configurationStatusStr:"Device mode transformations are enabled for at least one destination",supportedPlugins:["DeviceModeTransformation"]},{configurationStatus:()=>T(Qt.consents.activeConsentManagerPluginName.value),configurationStatusStr:"Consent management is enabled",activePluginName:Qt.consents.activeConsentManagerPluginName.value,supportedPlugins:Object.values(St)},{configurationStatus:()=>T(Qt.storage.encryptionPluginName.value),configurationStatusStr:"Storage encryption is enabled",activePluginName:Qt.storage.encryptionPluginName.value,supportedPlugins:Object.values(It)},{configurationStatus:()=>Qt.storage.migrate.value,configurationStatusStr:"Storage migration is enabled",supportedPlugins:["StorageMigrator"]}];return t.forEach((t=>{t.configurationStatus()?(e=e.filter(t.activePluginName?e=>!(e!==t.activePluginName&&t.supportedPlugins.includes(e)):e=>T(e)),this.addMissingPlugins(t,false,e)):e=e.filter(void 0!==t.basePlugins?e=>!(t.basePlugins.includes(e)||t.supportedPlugins.includes(e)):e=>!t.supportedPlugins.includes(e))})),[...Object.keys({}),...e]}addMissingPlugins(e,t,n){const r=e.shouldAddMissingPlugins||t;let i;i=e.activePluginName?[...e.basePlugins||[],e.activePluginName]:[...e.supportedPlugins];const s=i.filter((e=>!n.includes(e)));s.length>0&&(r&&n.push(...s),this.logger?.warn(((e,t,n,r)=>{const i=1===n.length,s=i?` '${n[0]}' plugin was`:` ['${n.join("', '")}'] plugins were`,o=`${e}${ae}${t}, but${s} not configured to load.`;return r?`${o} So, ${i?"the plugin":"those plugins"} will be loaded automatically.`:`${o} Ignore if this was intentional. Otherwise, consider adding ${i?"it":"them"} to the 'plugins' load API option.`})(z,e.configurationStatusStr,s,r)))}setActivePlugins(){const e=this.getPluginsToLoadBasedOnConfig(),t=[...Object.keys(rn),...qt],n=[],r=[];e.forEach((e=>{t.includes(e)?n.push(e):r.push(e)})),r.length>0&&this.onError(new Error(`Ignoring loading of unknown plugins: ${r.join(",")}. Mandatory plugins: ${Object.keys({}).join(",")}. Load option plugins: ${Qt.plugins.pluginsToLoadFromConfig.value.join(",")}`)),Ne((()=>{Qt.plugins.totalPluginsToLoad.value=e.length,Qt.plugins.activePlugins.value=n,Qt.plugins.failedPlugins.value=r}))}registerLocalPlugins(){Object.values(rn).forEach((e=>{b(e)&&Qt.plugins.activePlugins.value.includes(e().name)&&this.register([e()])}))}registerRemotePlugins(){const e=(t=Qt.plugins.activePlugins.value,{...nn(t)});var t;Promise.all(Object.keys(e).map((async t=>{await e[t]().then((e=>this.register([e.default()]))).catch((e=>{Qt.plugins.failedPlugins.value=[...Qt.plugins.failedPlugins.value,t],this.onError(e,t)}))}))).catch((e=>{this.onError(e)}))}invokeMultiple(e,...t){try{return this.engine.invokeMultiple(e,...t)}catch(t){return this.onError(t,e),[]}}invokeSingle(e,...t){try{return this.engine.invokeSingle(e,...t)}catch(t){return this.onError(t,e),null}}register(e){e.forEach((e=>{try{this.engine.register(e,Qt)}catch(t){Qt.plugins.failedPlugins.value=[...Qt.plugins.failedPlugins.value,e.name],this.onError(t)}}))}unregisterLocalPlugins(){Object.values(rn).forEach((e=>{try{this.engine.unregister(e().name)}catch(e){this.onError(e)}}))}onError(e,t){if(!this.errorHandler)throw e;this.errorHandler.onError(e,z,t)}}const on=(e,t)=>{try{return JSON.parse(e||"")}catch(e){const n=fe(e,"Failed to parse response data");if(!b(t))throw n;t(n)}},an="The request failed",ln={headers:{Accept:"application/json","Content-Type":"application/json;charset=UTF-8"},method:"GET"},un=(e,t,n)=>{const r=R(ln,t||{});return n&&(r.headers=R(r.headers,{Authorization:n})),r.url=e,r},cn=(e,t=1e4,n)=>new Promise(((r,i)=>{let s;if(!0===e.sendRawData)s=e.data;else if(s=de(e.data,!1,[],n),k(s))return void i({error:new Error("Failed to prepare data for the request."),undefined:void 0,options:e});const o=new XMLHttpRequest,a=t=>{i({error:new Error(lt(an,t,e.url)),xhr:o,options:e})};o.ontimeout=a,o.onerror=a,o.onload=()=>{var t,n,s,a;o.status>=200&&o.status<400?r({response:o.responseText,xhr:o,options:e}):i({error:new Error((t=an,n=o.status,s=o.statusText,a=e.url,`${t} with status: ${n}, ${s} for URL: ${a}.`)),xhr:o,options:e})},o.open(e.method,e.url,!0),!0===e.withCredentials&&(o.withCredentials=!0),o.timeout=t,Object.keys(e.headers).forEach((t=>{e.headers[t]&&o.setRequestHeader(t,e.headers[t])}));try{o.send(s)}catch(t){i({error:fe(t,(l=an,u=e.url,`${l} for URL: ${u}`)),xhr:o,options:e})}var l,u}));class dn{hasErrorHandler=!1;constructor(e,t){this.errorHandler=e,this.logger=t,this.hasErrorHandler=Boolean(this.errorHandler),this.onError=this.onError.bind(this)}async getData(e){const{url:t,options:n,timeout:r,isRawResponse:i}=e;try{const e=await cn(un(t,n,this.basicAuthHeader),r,this.logger);return{data:i?e.response:on(e.response,this.onError),details:e}}catch(e){return this.onError(e.error??e),{data:void 0,details:e}}}getAsyncData(e){const{callback:t,url:n,options:r,timeout:i,isRawResponse:s}=e,o=!b(t);cn(un(n,r,this.basicAuthHeader),i,this.logger).then((e=>{o||t(s?e.response:on(e.response,this.onError),e)})).catch((e=>{this.onError(e.error??e),o||t(void 0,e)}))}onError(e){if(!this.hasErrorHandler)throw e;this.errorHandler?.onError(e,"HttpClient")}setAuthHeader(e,t=!1){const n=t?e:N(`${e}:`);this.basicAuthHeader=`Basic ${n}`}resetAuthHeader(){this.basicAuthHeader=void 0}}const gn=new dn(Gt,nt),hn="cookieStorage",pn="localStorage",vn="sessionStorage",fn="memoryStorage",yn="none",mn={userId:"rl_user_id",userTraits:"rl_trait",anonymousId:"rl_anonymous_id",groupId:"rl_group_id",groupTraits:"rl_group_trait",initialReferrer:"rl_page_init_referrer",initialReferringDomain:"rl_page_init_referring_domain",sessionInfo:"rl_session",authToken:"rl_auth_token"},bn="clientDataInCookie",En="clientDataInLocalStorage",kn="clientDataInSessionStorage",Sn=["userId","userTraits","anonymousId","groupId","groupTraits","initialReferrer","initialReferringDomain","sessionInfo","authToken"],In={[hn]:bn,[pn]:En,[fn]:"clientDataInMemory",[vn]:kn},Tn=(e,t)=>{try{return encodeURIComponent(e)}catch(e){return void t?.error("Failed to encode the cookie data.",e)}},wn=e=>{try{return decodeURIComponent(e)}catch(e){return}},An=()=>(e=>{const t={},n=e.split(/\s*;\s*/);let r;return n[0]?(n.forEach((e=>{r=e.split("=");const n=r[0]?wn(r[0]):void 0;n&&(t[n]=r[1]?wn(r[1]):void 0)})),t):t})(globalThis.document.cookie),Pn=function(e,t,n,r){switch(arguments.length){case 4:case 3:case 2:return((e,t,n,r)=>{const i={...n||{}};let s=`${Tn(e,r)}=${Tn(t,r)}`;k(t)&&(i.maxage=-1),i.maxage&&(i.expires=new Date(+new Date+i.maxage)),i.path&&(s+=`; path=${i.path}`),i.domain&&(s+=`; domain=${i.domain}`),i.expires&&(s+=`; expires=${i.expires.toUTCString()}`),i.samesite&&(s+=`; samesite=${i.samesite}`),i.secure&&(s+="; secure"),globalThis.document.cookie=s})(e,t,n,r);case 1:return e?(e=>An()[e])(e):An();default:return An()}},Cn=()=>!I(globalThis.navigator.userAgentData),Dn={URL:()=>!b(globalThis.URL)||!b(globalThis.URLSearchParams),Promise:()=>!b(globalThis.Promise),"Number.isNaN":()=>!b(globalThis.Number.isNaN),"Number.isInteger":()=>!b(globalThis.Number.isInteger),"Array.from":()=>!b(globalThis.Array.from),"Array.prototype.find":()=>!b(globalThis.Array.prototype.find),"Array.prototype.includes":()=>!b(globalThis.Array.prototype.includes),"String.prototype.endsWith":()=>!b(globalThis.String.prototype.endsWith),"String.prototype.startsWith":()=>!b(globalThis.String.prototype.startsWith),"String.prototype.includes":()=>!b(globalThis.String.prototype.includes),"String.prototype.replaceAll":()=>!b(globalThis.String.prototype.replaceAll),"String.fromCodePoint":()=>!b(globalThis.String.fromCodePoint),"Object.entries":()=>!b(globalThis.Object.entries),"Object.values":()=>!b(globalThis.Object.values),"Object.assign":()=>!b(globalThis.Object.assign),"Object.fromEntries":()=>!b(globalThis.Object.fromEntries),"Element.prototype.dataset":()=>!(()=>{const e=globalThis.document.createElement("div");return e.setAttribute("data-a-b","c"),!!e.dataset&&"c"===e.dataset.aB})(),TextEncoder:()=>!b(globalThis.TextEncoder)||!b(globalThis.TextDecoder),requestAnimationFrame:()=>!b(globalThis.requestAnimationFrame)||!b(globalThis.cancelAnimationFrame),CustomEvent:()=>!b(globalThis.CustomEvent),"navigator.sendBeacon":()=>!b(globalThis.navigator.sendBeacon),ArrayBuffer:()=>!b(globalThis.Uint8Array),Set:()=>!b(globalThis.Set),atob:()=>!b(globalThis.atob)},Rn=()=>{let e={density:0,width:0,height:0,innerWidth:0,innerHeight:0};return e={width:globalThis.screen.width,height:globalThis.screen.height,density:globalThis.devicePixelRatio,innerWidth:globalThis.innerWidth,innerHeight:globalThis.innerHeight},e},$n=e=>{const t=["QuotaExceededError","NS_ERROR_DOM_QUOTA_REACHED"].includes(e.name)||[22,1014].includes(e.code);return e instanceof DOMException&&t},On=(e=pn,t,n)=>{let r,i;const s=`${Q}${ae}The "${e}" storage type is `;let o,a="unavailable",l=!0;try{switch(e){case fn:return!0;case hn:r=t,i="test_rudder_cookie";break;case pn:r=t??globalThis.localStorage,i="test_rudder_ls";break;case vn:r=t??globalThis.sessionStorage,i="test_rudder_ss";break;default:return!1}if(r&&(r.setItem(i,"true"),r.getItem(i)))return r.removeItem(i),!0;l=!1}catch(e){l=!1,o=e,$n(e)&&(a="full")}return l||n?.warn(`${s}${a}.`,o),!1},Ln=e=>{const t="function"!=typeof globalThis.URL?(e=>{const t=document.createElement("a");return t.href=e,t.hostname})(e):new URL(e).hostname,n=t?.split(".")??[],r=n[n.length-1],i=[];if(4===n.length&&r&&r===parseInt(r,10).toString())return i;if(n.length<=1)return n[0]&&-1!==n[0].indexOf("localhost")?["localhost"]:i;for(let e=n.length-2;e>=0;e-=1)i.push(n.slice(e).join("."));return i},Mn=()=>{const e=`.${(e=>{const t=Ln(e);for(let e=0;e<t.length;e+=1){const n=t[e],r="__tld__",i={domain:`${-1!==n.indexOf("localhost")?"":"."}${n}`};if(Pn(r,1,i),Pn(r))return Pn(r,null,i),n}return""})(globalThis.location.href)}`;return{maxage:31536e6,path:"/",domain:e&&"."!==e?e:void 0,samesite:"Lax",enabled:!0}};class Bn{static globalSingleton=null;isSupportAvailable=!0;isEnabled=!0;length=0;constructor(e={},t){if(Bn.globalSingleton)return Bn.globalSingleton;this.options=Mn(),this.logger=t,this.configure(e),Bn.globalSingleton=this}configure(e){return this.options=R(this.options??{},e),e.sameDomainCookiesOnly&&delete this.options.domain,this.isSupportAvailable=On(hn,this),this.isEnabled=Boolean(this.options.enabled&&this.isSupportAvailable),this.options}setItem(e,t){return Pn(e,t,this.options,this.logger),this.length=Object.keys(Pn()).length,!0}getItem(e){const t=Pn(e);return S(t)?null:t}removeItem(e){const t=this.setItem(e,null);return this.length=Object.keys(Pn()).length,t}clear(){}key(e){return this.keys()[e]??null}keys(){return Object.keys(Pn())}}const Nn=new class{isEnabled=!0;length=0;data={};constructor(e,t){this.options={enabled:!0},this.logger=t,this.configure(e??{})}configure(e){return this.options=R(this.options,e),this.isEnabled=Boolean(this.options.enabled),this.options}setItem(e,t){return this.data[e]=t,this.length=Object.keys(this.data).length,t}getItem(e){return e in this.data?this.data[e]:null}removeItem(e){return e in this.data&&delete this.data[e],this.length=Object.keys(this.data).length,null}clear(){this.data={},this.length=0}key(e){return this.keys()[e]??null}keys(){return Object.keys(this.data)}}({},nt);function Un(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var xn,jn={exports:{}};var Hn=(xn||(xn=1,jn.exports=function(){function e(e){return e=JSON.stringify(e),!!/^\{[\s\S]*\}$/.test(e)}function t(e){return void 0===e||"function"==typeof e?e+"":JSON.stringify(e)}function n(e){if("string"==typeof e)try{return JSON.parse(e)}catch(t){return e}}function r(e){return"[object Function]"==={}.toString.call(e)}function i(e){return"[object Array]"===Object.prototype.toString.call(e)}function s(e){var t="_Is_Incognit",n="yes";try{e||(e=window.localStorage),e.setItem(t,n),e.removeItem(t)}catch(t){var r={_data:{},setItem:function(e,t){return r._data[e]=String(t)},getItem:function(e){return r._data.hasOwnProperty(e)?r._data[e]:void 0},removeItem:function(e){return delete r._data[e]},clear:function(){return r._data={}}};e=r}finally{e.getItem(t)===n&&e.removeItem(t)}return e}var o=s();function a(){if(!(this instanceof a))return new a}a.prototype={set:function(n,r){if(n&&!e(n))o.setItem(n,t(r));else if(e(n))for(var i in n)this.set(i,n[i]);return this},get:function(e){if(void 0===e){var t={};return this.forEach((function(e,n){return t[e]=n})),t}if("?"===e.charAt(0))return this.has(e.substr(1));var r=arguments;if(r.length>1){for(var i={},s=0,a=r.length;s<a;s++){var l=n(o.getItem(r[s]));this.has(r[s])&&(i[r[s]]=l)}return i}return n(o.getItem(e))},clear:function(){return o.clear(),this},remove:function(e){var t=this.get(e);return o.removeItem(e),t},has:function(e){return{}.hasOwnProperty.call(this.get(),e)},keys:function(){var e=[];return this.forEach((function(t){e.push(t)})),e},forEach:function(e){for(var t=0,n=o.length;t<n;t++){var r=o.key(t);e(r,this.get(r))}return this},search:function(e){for(var t=this.keys(),n={},r=0,i=t.length;r<i;r++)t[r].indexOf(e)>-1&&(n[t[r]]=this.get(t[r]));return n},len:function(){return o.length}};var l=null;function u(t,n){var s=arguments,o=null;if(l||(l=a()),0===s.length)return l.get();if(1===s.length){if("string"==typeof t)return l.get(t);if(e(t))return l.set(t)}if(2===s.length&&"string"==typeof t){if(!n)return l.remove(t);if(n&&"string"==typeof n)return l.set(t,n);n&&r(n)&&(o=null,o=n(t,l.get(t)),u.set(t,o))}if(2===s.length&&i(t)&&r(n))for(var c=0,d=t.length;c<d;c++)o=n(t[c],l.get(t[c])),u.set(t[c],o);return u}for(var c in a.prototype)u[c]=a.prototype[c];return u}()),jn.exports);const _n=Un(Hn);const Fn=new class{isSupportAvailable=!0;isEnabled=!0;length=0;constructor(e={},t){this.options={enabled:!0},this.logger=t,this.configure(e)}configure(e){return this.options=R(this.options,e),this.isSupportAvailable=On(pn),this.isEnabled=Boolean(this.options.enabled&&this.isSupportAvailable),this.options}setItem(e,t){_n.set(e,t),this.length=_n.len()}getItem(e){const t=_n.get(e);return S(t)?null:t}removeItem(e){_n.remove(e),this.length=_n.len()}clear(){_n.clear(),this.length=0}key(e){return this.keys()[e]??null}keys(){return _n.keys()}}({},nt);const Qn=new class{isSupportAvailable=!0;isEnabled=!0;length=0;constructor(e={},t){this.options={enabled:!0},this.logger=t,this.configure(e)}configure(e){return this.options=R(this.options,e),this.isSupportAvailable=On(vn),this.isSupportAvailable&&(this.store=globalThis.sessionStorage),this.isEnabled=Boolean(this.options.enabled&&this.isSupportAvailable),this.options}setItem(e,t){this.store&&(this.store.setItem(e,t),this.length=this.store.length)}getItem(e){if(!this.store)return null;const t=this.store.getItem(e);return S(t)?null:t}removeItem(e){this.store&&(this.store.removeItem(e),this.length=this.store.length)}clear(){this.store?.clear(),this.length=0}key(e){return this.store?.key(e)??null}keys(){const e=[];if(!this.store)return e;for(let t=0;t<this.store.length;t+=1){const n=this.store.key(t);null!==n&&e.push(n)}return e}}({},nt),Kn=e=>{switch(e){case pn:return Fn;case vn:return Qn;case fn:return Nn;case hn:return new Bn({},nt);default:return Nn}},Gn=(e={},t={},n={},r={})=>{var i;(e=>{const t=new Bn({},nt).configure(e);Qt.storage.cookie.value={maxage:t.maxage,path:t.path,domain:t.domain,samesite:t.samesite,expires:t.expires,secure:t.secure}})(e),i=t,Fn.configure(i),(e=>{Nn.configure(e)})(n),(e=>{Qn.configure(e)})(r)};class zn{hasErrorHandler=!1;constructor(e,t,n){this.id=e.id,this.name=e.name,this.isEncrypted=e.isEncrypted??!1,this.validKeys=e.validKeys??{},this.engine=t??Kn(pn),this.noKeyValidation=0===Object.keys(this.validKeys).length,this.noCompoundKey=e.noCompoundKey,this.originalEngine=this.engine,this.errorHandler=e.errorHandler??Gt,this.hasErrorHandler=Boolean(this.errorHandler),this.logger=e.logger??nt,this.pluginsManager=n}createValidKey(e){const{name:t,id:n,validKeys:r,noKeyValidation:i,noCompoundKey:s}=this;if(i)return s?e:[t,n,e].join(".");let o;return Object.values(r).forEach((r=>{r===e&&(o=s?e:[t,n,e].join("."))})),o}swapQueueStoreToInMemoryEngine(){const{name:e,id:t,validKeys:n,noCompoundKey:r}=this,i=Kn(fn);Object.keys(n).forEach((s=>{const o=this.get(n[s]),a=r?s:[e,t,s].join(".");i.setItem(a,o),this.remove(s)})),this.engine=i}set(e,t){const n=this.createValidKey(e);if(n)try{this.engine.setItem(n,this.encrypt(de(t,!1,[],this.logger)))}catch(n){$n(n)?(this.logger?.warn(`${`Store ${this.id}`}${ae}The storage is either full or unavailable, so the data will not be persisted. Switching to in-memory storage.`),this.swapQueueStoreToInMemoryEngine(),this.set(e,t)):this.onError(fe(n,(e=>`Failed to save the value for "${e}" to storage`)(e)))}}get(e){const t=this.createValidKey(e);let n;try{return t?(n=this.decrypt(this.engine.getItem(t)),I(n)?null:JSON.parse(n)):null}catch(t){return this.onError(new Error(`${(e=>`Failed to retrieve or parse data for "${e}" from storage`)(e)}: ${t.message}`)),E(n)&&n.startsWith("RudderEncrypt:")&&this.logger?.warn((e=>`The cookie data for ${e} seems to be encrypted using SDK versions < v3. The data is dropped. This can potentially stem from using SDK versions < v3 on other sites or web pages that can share cookies with this webpage. We recommend using the same SDK (v3) version everywhere or avoid disabling the storage data migration.`)(e)),null}}remove(e){const t=this.createValidKey(e);t&&this.engine.removeItem(t)}getOriginalEngine(){return this.originalEngine}decrypt(e){return I(e)?null:this.crypto(e,"decrypt")}encrypt(e){return this.crypto(e,"encrypt")}crypto(e,t){const n=!this.isEncrypted||!e||"string"!=typeof e||""===(e=>e.replace(/^\s+|\s+$/gm,""))(e);if(n)return e;const r=`storage.${t}`,i=this.pluginsManager?this.pluginsManager.invokeSingle(r,e):e;return void 0===i?e:i??""}onError(e){if(!this.hasErrorHandler)throw e;this.errorHandler?.onError(e,`Store ${this.id}`)}}class Vn{stores={};isInitialized=!1;hasErrorHandler=!1;constructor(e,t,n){this.errorHandler=t,this.logger=n,this.hasErrorHandler=Boolean(this.errorHandler),this.pluginsManager=e,this.onError=this.onError.bind(this)}init(){if(this.isInitialized)return;const e=Qt.loadOptions.value,t={cookieStorageOptions:{samesite:e.sameSiteCookie,secure:e.secureCookie,domain:e.setCookieDomain,sameDomainCookiesOnly:e.sameDomainCookiesOnly,enabled:!0},localStorageOptions:{enabled:!0},inMemoryStorageOptions:{enabled:!0},sessionStorageOptions:{enabled:!0}};Gn(O(R(t.cookieStorageOptions??{},Qt.storage.cookie?.value??{})),O(t.localStorageOptions),O(t.inMemoryStorageOptions),O(t.sessionStorageOptions)),this.initClientDataStores(),this.isInitialized=!0}initClientDataStores(){this.initializeStorageState();[fn,pn,hn,vn].forEach((e=>{Kn(e)?.isEnabled&&this.setStore({id:In[e],name:In[e],isEncrypted:!0,noCompoundKey:!0,type:e})}))}initializeStorageState(){let e=Qt.storage.type.value,t=Qt.loadOptions.value.storage?.entries;const n=Qt.consents.postConsent.value.storage;(T(n?.type)||T(n?.entries))&&(e=n?.type,t=n?.entries);let r=!0,i={};Sn.forEach((n=>{const s=n,o=n,a=t?.[s]?.type,l=((e,t)=>{let n;if(e.consents.preConsent.value.enabled)switch(e.consents.preConsent.value.storage?.strategy){case"none":n=yn;break;case"session":"sessionInfo"!==t&&(n=yn);break;case"anonymousId":"anonymousId"!==t&&(n=yn)}return n})(Qt,n),u=l??a??e??st,c=this.getResolvedStorageTypeForEntry(u,n);c!==yn&&(r=!1),i={...i,[n]:{type:c,key:mn[o]}}})),Ne((()=>{Qt.storage.type.value=e,Qt.storage.entries.value=i,Qt.storage.trulyAnonymousTracking.value=r}))}getResolvedStorageTypeForEntry(e,t){let n=e;switch(e){case pn:Kn(pn)?.isEnabled||(n=fn);break;case vn:Kn(vn)?.isEnabled||(n=fn);break;case fn:case yn:break;default:n=Kn(hn)?.isEnabled?hn:Kn(pn)?.isEnabled?pn:Kn(vn)?.isEnabled?vn:fn}return n!==e&&this.logger?.warn(((e,t,n,r)=>`${e}${ae}The storage type "${n}" is not available for entry "${t}". The SDK will initialize the entry with "${r}" storage type instead.`)(J,t,e,n)),n}setStore(e){const t=Kn(e.type);return this.stores[e.id]=new zn(e,t,this.pluginsManager),this.stores[e.id]}getStore(e){return this.stores[e]}onError(e){if(!this.hasErrorHandler)throw e;this.errorHandler?.onError(e,J)}}const qn=e=>{const t=new URL(e),{host:n,protocol:r}=t,i=n.split(".");let s;return s=i.length>2?`${i[i.length-2]}.${i[i.length-1]}`:n,{topDomain:s,protocol:r}},Wn=(e,t)=>`${t?window.location.origin:(e=>{const{topDomain:t,protocol:n}=qn(e);return`${n}//${t}`})(window.location.href)}/${e.startsWith("/")?e.substring(1):e}`,Jn=e=>e?.endsWith("/")?Jn(e.substring(0,e.length-1)):e,Xn=e=>{try{return new URL(e).host}catch(e){return null}},Zn=e=>Xn(e)??"",Yn=e=>{const t={};try{const n=new URL(e),r="utm_";n.searchParams.forEach(((e,n)=>{if(n.startsWith(r)){let i=n.substring(r.length);"campaign"===i&&(i="name"),t[i]=e}}))}catch(e){}return t},er=e=>{if(!E(e))return!1;try{return b(globalThis.URL)&&new URL(e),ht.test(e)}catch(e){return!1}},tr="none",nr="immediate",rr=e=>$(e)||Array.isArray(e),ir=(e,t)=>{let{provider:n}=e;const r=n?St[n]:void 0;var i;return n&&!r&&(t?.error((i=St,`${K}${ae}The consent manager "${n}" is not supported. Please choose one of the following supported consent managers: "${Object.keys(i)}".`)),n=void 0),{provider:n,consentManagerPluginName:r}},sr=(e,t)=>{let n,r,i=[],s=[],o=!1,a=!0===e?.enabled;$(e)&&a&&(({provider:r,consentManagerPluginName:n}=ir(e,t)),rr(e.allowedConsentIds)&&(i=e.allowedConsentIds,o=!0),rr(e.deniedConsentIds)&&(s=e.deniedConsentIds,o=!0));const l={allowedConsentIds:i,deniedConsentIds:s};return a=a&&Boolean(n),{provider:r,consentManagerPluginName:n,initialized:o,enabled:a,consentsData:l}},or=e=>{var t;Qt.reporting.isErrorReportingEnabled.value=!(t=e.source.config,!0!==t?.statsCollection?.errors?.enabled||window.chrome&&window.chrome.runtime&&window.chrome.runtime.id),Qt.reporting.isMetricsReportingEnabled.value=(e=>!0===e?.statsCollection?.metrics?.enabled)(e.source.config)},ar=e=>{const{useServerSideCookies:t,dataServiceEndpoint:n,storage:r,setCookieDomain:i,sameDomainCookiesOnly:s}=Qt.loadOptions.value;let o,a=r?.cookie,l=!1;if(t){l=t;const r=a.domain??i,u=T(r)&&!(e=>{const{topDomain:t}=qn(window.location.href);return t===e})(M(r))||s,c=Wn(n??"rsaRequest",u);if(er(c)){o=Jn(c);const t=Xn(window.location.href),n=Xn(c);t!==n&&(a={...a,samesite:"None",secure:!0}),!s&&u&&n!==M(r)&&(l=!1,e?.warn(((e,t,n)=>`${e}${ae}The provided cookie domain (${t}) does not match the current webpage's domain (${n}). Hence, the cookies will be set client-side.`)(K,r,n)))}else l=!1}return{sscEnabled:l,cookieOptions:a,finalDataServiceUrl:o}},lr=e=>{const{storage:t}=Qt.loadOptions.value;let n=t?.type;T(n)&&!(e=>"string"==typeof e&&it.includes(e))(n)&&(e?.warn(((e,t,n)=>`${e}${ae}The storage type "${t}" is not supported. Please choose one of the following supported types: "${it}". The default type "${n}" will be used instead.`)(K,n,st)),n=st);let r=t?.encryption?.version;const i=r&&It[r];var s,o;!S(r)&&S(i)?(e?.warn((s=It,o=Et,`${K}${ae}The storage encryption version "${r}" is not supported. Please choose one of the following supported versions: "${Object.keys(s)}". The default version "${o}" will be used instead.`)),r=Et):S(r)&&(r=Et);const a=t?.migrate,l=a&&r===Et;!0===a&&l!==a&&e?.warn(((e,t,n)=>`${e}${ae}The storage data migration has been disabled because the configured storage encryption version (${t}) is not the latest (${n}). To enable storage data migration, please update the storage encryption version to the latest version.`)(K,r,Et));const{sscEnabled:u,finalDataServiceUrl:c,cookieOptions:d}=ar(e);Ne((()=>{Qt.storage.type.value=n,Qt.storage.cookie.value=d,Qt.serverCookies.isEnabledServerSideCookies.value=u,Qt.serverCookies.dataServiceUrl.value=c,Qt.storage.encryptionPluginName.value=It[r],Qt.storage.migrate.value=l}))},ur=e=>{const{provider:t,consentManagerPluginName:n,initialized:r,enabled:i,consentsData:s}=sr(Qt.loadOptions.value.consentManagement,e),o=Qt.loadOptions.value.preConsent;let a=o?.storage?.strategy??tr;var l,u;T(a)&&!["none","session","anonymousId"].includes(a)&&(a=tr,e?.warn((l=K,u=o?.storage?.strategy,`${l}${ae}The pre-consent storage strategy "${u}" is not supported. Please choose one of the following supported strategies: "none, session, anonymousId". The default strategy "${tr}" will be used instead.`)));let c=o?.events?.delivery??nr;T(c)&&!["immediate","buffer"].includes(c)&&(c=nr,e?.warn(((e,t,n)=>`${e}${ae}The pre-consent events delivery type "${t}" is not supported. Please choose one of the following supported types: "immediate, buffer". The default type "${n}" will be used instead.`)(K,o?.events?.delivery,nr))),Ne((()=>{Qt.consents.activeConsentManagerPluginName.value=n,Qt.consents.initialized.value=r,Qt.consents.enabled.value=i,Qt.consents.data.value=s,Qt.consents.provider.value=t,Qt.consents.preConsent.value={enabled:!0===Qt.loadOptions.value.preConsent?.enabled&&!1===r&&!0===i,storage:{strategy:a},events:{delivery:c}}}))},cr=e=>{if(Qt.dataPlaneEvents.deliveryEnabled.value){const t="XhrQueue";let n=t;Qt.loadOptions.value.useBeacon&&(Qt.capabilities.isBeaconAvailable.value?n="BeaconQueue":(n=t,e?.warn(`${K}${ae}The Beacon API is not supported by your browser. The events will be sent using XHR instead.`))),Ne((()=>{Qt.dataPlaneEvents.eventsQueuePluginName.value=n}))}},dr=(e,t,n,r,i)=>{const s=new URLSearchParams({p:"cdn",v:be,build:pt,writeKey:t,lockIntegrationsVersion:n.toString(),lockPluginsVersion:r.toString()});let o=bt,a=s,l="/sourceConfig/",u="";if(er(e)){const t=new URL(e);Jn(t.pathname).endsWith("/sourceConfig")||(t.pathname=`${Jn(t.pathname)}/sourceConfig/`),t.pathname=t.pathname.replace(/\/{2,}/g,"/"),s.forEach(((e,n)=>{null===t.searchParams.get(n)&&t.searchParams.set(n,e)})),o=t.origin,l=t.pathname,a=t.searchParams,u=t.hash}else i?.warn(((e,t)=>`${e}${ae}The provided source config URL "${t}" is invalid. Using the default source config URL instead.`)(K,e));return`${o}${l}?${a}${u}`},gr=(e,t,n,r,i,s)=>{let o="";if(s){if(!er(s))throw new Error(`Failed to load the SDK as the base URL for ${e} is not valid.`);return Jn(s)}const a=(()=>{const e=document.getElementsByTagName("script"),t=/(?:^|\/)rsa(\.min)?\.js$/;for(const n of e){const e=n.getAttribute("src");if(e&&t.test(e))return e}})();return o=a?a.split("/").slice(0,-1).concat(t).join("/"):n,i&&(o=o.replace(`/${ft}/${pt}/${t}`,`/${r}/${pt}/${t}`)),o};class hr{hasErrorHandler=!1;constructor(e,t,n){this.errorHandler=t,this.logger=n,this.httpClient=e,this.hasErrorHandler=Boolean(this.errorHandler),this.onError=this.onError.bind(this),this.processConfig=this.processConfig.bind(this)}attachEffects(){Ye((()=>{this.logger?.setMinLogLevel(Qt.lifecycle.logLevel.value)}))}init(){this.attachEffects();const{logLevel:e,configUrl:t,lockIntegrationsVersion:n,lockPluginsVersion:r,destSDKBaseURL:i,pluginsSDKBaseURL:s,integrations:o}=Qt.loadOptions.value;Qt.lifecycle.activeDataplaneUrl.value=Jn(Qt.lifecycle.dataPlaneUrl.value);const a=((e,t,n)=>gr("integrations",dt,yt,e,t,n))(be,n,i),l=((e,t,n)=>gr("plugins",gt,mt,e,t,n))(be,r,s);lr(this.logger),ur(this.logger),cr(this.logger),Ne((()=>{Qt.lifecycle.integrationsCDNPath.value=a,Qt.lifecycle.pluginsCDNPath.value=l,e&&(Qt.lifecycle.logLevel.value=e),Qt.lifecycle.sourceConfigUrl.value=dr(t,Qt.lifecycle.writeKey.value,n,r,this.logger),Qt.metrics.metricsServiceUrl.value=`${Qt.lifecycle.activeDataplaneUrl.value}/rsaMetrics`,Qt.nativeDestinations.loadOnlyIntegrations.value=o})),this.getConfig()}onError(e,t,n){if(!this.hasErrorHandler)throw e;this.errorHandler?.onError(e,K,t,n)}processConfig(e,t){if(!e)return void this.onError((n=t?.error,`Failed to fetch the source config. Reason: ${n}`));var n;let r;try{r=E(e)?JSON.parse(e):e}catch(e){return void this.onError(e,ot,!0)}if(!(e=>C(e)&&C(e.source)&&!I(e.source.id)&&C(e.source.config)&&Array.isArray(e.source.destinations))(r))return void this.onError(new Error(ot),void 0,!0);if(!1===r.source.enabled)return void this.logger?.error("The source is disabled. Please enable the source in the dashboard to send events.");or(r);const i=r.source.destinations.length>0?(e=>{const t=[];return e.forEach((e=>{e.enabled&&!e.deleted&&t.push({id:e.id,displayName:e.destinationDefinition.displayName,config:e.config,shouldApplyDeviceModeTransformation:e.shouldApplyDeviceModeTransformation||!1,propagateEventsUntransformedOnError:e.propagateEventsUntransformedOnError||!1,userFriendlyId:`${e.destinationDefinition.displayName.replaceAll(" ","-")}___${e.id}`})})),t})(r.source.destinations):[];Ne((()=>{Qt.source.value={config:r.source.config,id:r.source.id,workspaceId:r.source.workspaceId},Qt.nativeDestinations.configuredDestinations.value=i,Qt.plugins.pluginsToLoadFromConfig.value=Qt.loadOptions.value.plugins??[],(e=>{let t,n=Qt.consents.resolutionStrategy.value;C(e.consentManagementMetadata)&&(Qt.consents.provider.value&&(n=e.consentManagementMetadata.providers.find((e=>e.provider===Qt.consents.provider.value))?.resolutionStrategy??Qt.consents.resolutionStrategy.value),t=e.consentManagementMetadata),"custom"===Qt.consents.provider.value&&(n=void 0),Ne((()=>{Qt.consents.metadata.value=g(t),Qt.consents.resolutionStrategy.value=n}))})(r),Qt.lifecycle.status.value="configured"}))}getConfig(){const e=Qt.loadOptions.value.getSourceConfig;if(e){if(!b(e))throw new Error('"getSourceConfig" must be a function. Please make sure that it is defined and returns a valid source configuration object.');const t=e();t instanceof Promise?t.then((e=>this.processConfig(e))).catch((e=>{this.onError(e,"SourceConfig")})):this.processConfig(t)}else this.httpClient.getAsyncData({url:Qt.lifecycle.sourceConfigUrl.value,options:{headers:{"Content-Type":void 0}},callback:this.processConfig})}}const pr=()=>document?.referrer||"$direct",vr=()=>{const e=(()=>{const e=document.getElementsByTagName("link");let t="";for(let n=0;e[n];n+=1){const r=e[n];if("canonical"===r.getAttribute("rel")&&!t){t=r.getAttribute("href")??"";break}}return t})();let t=globalThis.location.pathname;const{href:n}=globalThis.location;let r=n;const{search:i}=globalThis.location;if(e)try{const n=new URL(e);r=""===n.search?e+i:e,t=n.pathname}catch(e){}const s=(e=>{let t=e;try{const n=new URL(e);t=n.origin+n.pathname+n.search}catch(e){}return t})(r),{title:o}=document,a=pr();return{path:t,referrer:a,referring_domain:Zn(a),search:i,title:o,url:s,tab_url:n}},fr=`https://polyfill-fastly.io/v3/polyfill.min.js?version=3.111.0&features=${Object.keys(Dn).join("%2C")}`,yr="rudderstackPolyfill";class mr{constructor(e,t){this.logger=t,this.errorHandler=e,this.externalSrcLoader=new Le(this.errorHandler,this.logger),this.onError=this.onError.bind(this),this.onReady=this.onReady.bind(this)}init(){try{this.prepareBrowserCapabilities(),this.attachWindowListeners()}catch(e){this.onError(e)}}detectBrowserCapabilities(){Ne((()=>{Qt.capabilities.storage.isCookieStorageAvailable.value=On(hn,Kn(hn),this.logger),Qt.capabilities.storage.isLocalStorageAvailable.value=On(pn,void 0,this.logger),Qt.capabilities.storage.isSessionStorageAvailable.value=On(vn,void 0,this.logger),Qt.capabilities.isBeaconAvailable.value=!I(globalThis.navigator.sendBeacon)&&b(globalThis.navigator.sendBeacon),Qt.capabilities.isUaCHAvailable.value=Cn(),Qt.capabilities.isCryptoAvailable.value=!I(globalThis.crypto)&&b(globalThis.crypto.getRandomValues),Qt.capabilities.isIE11.value=Boolean(globalThis.navigator.userAgent.match(/Trident.*rv:11\./)),Qt.capabilities.isOnline.value=globalThis.navigator.onLine,Qt.context.userAgent.value=(()=>{if(S(globalThis.navigator))return null;let{userAgent:e}=globalThis.navigator;const{brave:t}=globalThis.navigator;if(t&&Object.getPrototypeOf(t).isBrave){const t=e.match(/(chrome)\/([\w.]+)/i);t&&(e=`${e} Brave/${t[2]}`)}return e})(),Qt.context.locale.value=S(globalThis.navigator)?null:globalThis.navigator.language??globalThis.navigator.browserLanguage,Qt.context.screen.value=Rn(),Qt.context.timezone.value=(()=>{const e=(new Date).toString().match(/([A-Z]+[+-]\d+)/);return e&&e[1]?e[1]:"NA"})(),Cn()&&((e,t="none")=>{"none"===t&&e(void 0),"default"===t&&e(navigator.userAgentData),"full"===t&&navigator.userAgentData?.getHighEntropyValues(["architecture","bitness","brands","mobile","model","platform","platformVersion","uaFullVersion","fullVersionList","wow64"]).then((t=>{e(t)})).catch((()=>{e()}))})((e=>{Qt.context["ua-ch"].value=e}),Qt.loadOptions.value.uaChTrackLevel)})),Ye((()=>{!0===Qt.loadOptions.value.sendAdblockPage&&void 0!==Qt.lifecycle.sourceConfigUrl.value&&((e,t)=>{const n=new URL(Qt.lifecycle.sourceConfigUrl.value),r=`${n.origin}${n.pathname}?view=ad`,i=new dn(e,t);i.setAuthHeader(Qt.lifecycle.writeKey.value),i.getAsyncData({url:r,options:{method:"HEAD",headers:{"Content-Type":void 0}},isRawResponse:!0,callback:(e,t)=>{Qt.capabilities.isAdBlocked.value=void 0!==t?.error||t?.xhr?.responseURL!==r}})})(this.errorHandler,this.logger)}))}prepareBrowserCapabilities(){Qt.capabilities.isLegacyDOM.value=(()=>{const e=Object.keys(Dn);let t=!1;for(let n=0;n<e.length;n++){const r=Dn[e[n]];if(b(r)&&r()){t=!0;break}}return t})();const e=Qt.loadOptions.value.polyfillURL;let t=fr;w(e)&&(er(e)?t=e:this.logger?.warn(((e,t)=>`${e}${ae}The provided polyfill URL "${t}" is invalid. The default polyfill URL will be used instead.`)(Q,e)));if(Qt.loadOptions.value.polyfillIfRequired&&Qt.capabilities.isLegacyDOM.value&&er(t)){const e=t!==Qt.loadOptions.value.polyfillURL;if(e){const e=`RS_polyfillCallback_${Qt.lifecycle.writeKey.value}`,n=()=>{this.onReady(),delete globalThis[e]};globalThis[e]=n,t=`${t}&callback=${e}`}this.externalSrcLoader.loadJSFile({url:t,id:yr,async:!0,timeout:1e4,callback:n=>{n?e||this.onReady():this.onError(new Error(((e,t)=>`Failed to load the polyfill script with ID "${e}" from URL ${t}.`)(yr,t)))}})}else this.onReady()}attachWindowListeners(){globalThis.addEventListener("offline",(()=>{Qt.capabilities.isOnline.value=!1})),globalThis.addEventListener("online",(()=>{Qt.capabilities.isOnline.value=!0})),globalThis.addEventListener("resize",function(e,t,n=250){let r;return(...i)=>{globalThis.clearTimeout(r),r=globalThis.setTimeout((()=>{e.apply(t,i)}),n)}}((()=>{Qt.context.screen.value=Rn()}),this))}onReady(){this.detectBrowserCapabilities(),Qt.lifecycle.status.value="browserCapabilitiesReady"}onError(e){if(!this.errorHandler)throw e;this.errorHandler.onError(e,Q)}}const br=["integrations","anonymousId","originalTimestamp"],Er=["library","consentManagement","userAgent","ua-ch","screen"],kr=["id","anonymous_id","user_id","sent_at","timestamp","received_at","original_timestamp","event","event_text","channel","context_ip","context_request_ip","context_passed_ip","group_id","previous_id"],Sr=e=>"number"==typeof e&&!Number.isNaN(e),Ir=e=>Sr(e)&&e>=0&&Number.isInteger(e),Tr=e=>{const t=Date.now();return Boolean(!e||t>e)},wr=(e,t)=>{return!!(e&&Ir(e)&&(n=10,r=e,r.toString().length>=n))||(t?.warn(((e,t,n)=>`${e}${ae}The provided session ID (${t}) is either invalid, not a positive integer, or not at least "${n}" digits long. A new session ID will be auto-generated instead.`)(V,e,10)),!1);var n,r},Ar=(e,t)=>({id:wr(e,t)?e:Date.now(),sessionStart:void 0,manualTrack:!0}),Pr=e=>Boolean(e===hn||e===pn||e===vn||e===fn),Cr=()=>se(),Dr=e=>{const t=vr(),n={};return Object.keys(t).forEach((r=>{n[r]=e?.[r]||t[r]})),n.initial_referrer=e?.initial_referrer||Qt.session.initialReferrer.value,n.initial_referring_domain=e?.initial_referring_domain||Qt.session.initialReferringDomain.value,n},Rr=(e,t,n)=>{C(e)&&Object.keys(e).forEach((e=>{(kr.includes(e)||kr.includes(e.toLowerCase()))&&n?.warn(((e,t,n,r)=>`${e}${ae}The "${t}" property defined under "${n}" is a reserved keyword. Please choose a different property name to avoid conflicts with reserved keywords (${r}).`)(G,e,t,kr))}))},$r=(e,t)=>{C(t)&&(((e,t)=>{t.anonymousId&&E(t.anonymousId)&&(e.anonymousId=t.anonymousId),$(t.integrations)&&(e.integrations=t.integrations),t.originalTimestamp&&E(t.originalTimestamp)&&(e.originalTimestamp=t.originalTimestamp)})(e,t),e.context=((e,t,n)=>{let r=e;return Object.keys(t).forEach((e=>{if(!br.includes(e)&&!Er.includes(e))if("context"!==e)r=R(r,{[e]:t[e]});else if(!S(t[e])&&C(t[e])){const n={};Object.keys(t[e]).forEach((r=>{Er.includes(r)||(n[r]=t[e][r])})),r=R(r,{...n})}})),r})(e.context,t))},Or=(e,t,n,r)=>{const i={channel:"web",context:{traits:g(Qt.session.userTraits.value),sessionId:Qt.session.sessionInfo.value.id||void 0,sessionStart:Qt.session.sessionInfo.value.sessionStart||void 0,...Qt.consents.enabled.value&&{consentManagement:{deniedConsentIds:g(Qt.consents.data.value.deniedConsentIds),allowedConsentIds:g(Qt.consents.data.value.allowedConsentIds),provider:Qt.consents.provider.value,resolutionStrategy:Qt.consents.resolutionStrategy.value}},"ua-ch":Qt.context["ua-ch"].value,app:Qt.context.app.value,library:Qt.context.library.value,userAgent:Qt.context.userAgent.value,os:Qt.context.os.value,locale:Qt.context.locale.value,screen:Qt.context.screen.value,campaign:Yn(globalThis.location.href),page:Dr(n),timezone:Qt.context.timezone.value,...Qt.autoTrack.enabled.value&&{autoTrack:{...Qt.autoTrack.pageLifecycle.enabled.value&&{page:{visitId:Qt.autoTrack.pageLifecycle.visitId.value}}}}},originalTimestamp:oe(new Date),messageId:se(),userId:e.userId||Qt.session.userId.value};Pr(Qt.storage.entries.value.anonymousId?.type)?i.anonymousId=Qt.session.anonymousId.value:i.anonymousId=Cr(),Qt.storage.trulyAnonymousTracking.value&&(i.context.trulyAnonymousTracking=!0),"identify"===e.type&&(i.context.traits=Qt.storage.entries.value.userTraits?.type!==yn?g(Qt.session.userTraits.value):e.context.traits),"group"===e.type&&((e.groupId||Qt.session.groupId.value)&&(i.groupId=e.groupId||Qt.session.groupId.value),(e.traits||Qt.session.groupTraits.value)&&(i.traits=Qt.storage.entries.value.groupTraits?.type!==yn?g(Qt.session.groupTraits.value):e.traits));const s=R(e,i);return void 0===s.event&&(s.event=null),void 0===s.properties&&(s.properties=null),$r(s,t),((e,t)=>{const{properties:n,traits:r,context:i}=e,{traits:s}=i;Rr(n,"properties",t),Rr(r,"traits",t),Rr(s,"context.traits",t)})(s,r),s.integrations=(e=>{let t;return t=Qt.loadOptions.value.useGlobalIntegrationsConfigInEvents?Qt.consents.postConsent.value.integrations??Qt.nativeDestinations.loadOnlyIntegrations.value:e||ct,g(t)})(s.integrations),s};class Lr{constructor(e){this.logger=e}generatePageEvent(e,t,n,r){let i=n??{};i=((e,t)=>{const n=t?.page||{},r=e,i=vr();return Object.keys(i).forEach((e=>{S(r[e])&&(r[e]=n[e]||i[e])})),S(r.initial_referrer)&&(r.initial_referrer=n.initial_referrer||Qt.session.initialReferrer.value),S(r.initial_referring_domain)&&(r.initial_referring_domain=n.initial_referring_domain||Qt.session.initialReferringDomain.value),r})(i,r);return Or({properties:i,name:t,category:e,type:"page"},r,i,this.logger)}generateTrackEvent(e,t,n){return Or({properties:t,event:e,type:"track"},n,void 0,this.logger)}generateIdentifyEvent(e,t,n){return Or({userId:e,type:"identify",context:{traits:t}},n,void 0,this.logger)}generateAliasEvent(e,t,n){const r=Or({previousId:t,type:"alias"},n,void 0,this.logger);return r.userId=e??r.userId,r}generateGroupEvent(e,t,n){const r={type:"group"};return e&&(r.groupId=e),t&&(r.traits=t),Or(r,n,void 0,this.logger)}create(e){let t;switch(e.type){case"page":t=this.generatePageEvent(e.category,e.name,e.properties,e.options);break;case"track":t=this.generateTrackEvent(e.name,e.properties,e.options);break;case"identify":t=this.generateIdentifyEvent(e.userId,e.traits,e.options);break;case"alias":t=this.generateAliasEvent(e.to,e.from,e.options);break;case"group":t=this.generateGroupEvent(e.groupId,e.traits,e.options)}return t}}class Mr{constructor(e,t,n,r){this.eventRepository=e,this.userSessionManager=t,this.errorHandler=n,this.logger=r,this.eventFactory=new Lr(this.logger),this.onError=this.onError.bind(this)}init(){this.eventRepository.init()}resume(){this.eventRepository.resume()}addEvent(e){this.userSessionManager.refreshSession();const t=this.eventFactory.create(e);t?this.eventRepository.enqueue(t,e.callback):this.onError(new Error("Failed to generate the event object."))}onError(e,t,n){if(!this.errorHandler)throw e;this.errorHandler.onError(e,G,t,n)}}class Br{constructor(e,t,n,r,i){this.storeManager=r,this.pluginsManager=n,this.logger=t,this.errorHandler=e,this.httpClient=i,this.onError=this.onError.bind(this),this.serverSideCookieDebounceFuncs={}}init(){this.syncStorageDataToState(),this.registerEffects()}syncStorageDataToState(){this.migrateStorageIfNeeded(),this.migrateDataFromPreviousStorage(),this.setUserId(this.getUserId()),this.setUserTraits(this.getUserTraits()),this.setGroupId(this.getGroupId()),this.setGroupTraits(this.getGroupTraits());const{externalAnonymousIdCookieName:e,anonymousIdOptions:t}=Qt.loadOptions.value;let n;w(e)&&"string"==typeof e&&(n=this.getExternalAnonymousIdByCookieName(e)),this.setAnonymousId(n??this.getAnonymousId(t)),this.setAuthToken(this.getAuthToken()),this.setInitialReferrerInfo(),this.configureSessionTracking()}configureSessionTracking(){let e=this.getSessionInfo();if(this.isPersistenceEnabledForStorageEntry("sessionInfo")){const t=this.getConfiguredSessionTrackingInfo(),n=e??Pt;e={...n,...t,autoTrack:t.autoTrack&&!0!==n.manualTrack},e.autoTrack||!0===e.manualTrack||(e=At.sessionInfo)}else e=At.sessionInfo;Qt.session.sessionInfo.value=e,Qt.session.sessionInfo.value.autoTrack&&this.startOrRenewAutoTracking(Qt.session.sessionInfo.value)}setInitialReferrerInfo(){const e=this.getInitialReferrer(),t=this.getInitialReferringDomain();if(e&&t)this.setInitialReferrer(e),this.setInitialReferringDomain(t);else{const t=e||pr();this.setInitialReferrer(t),this.setInitialReferringDomain(Zn(t))}}isPersistenceEnabledForStorageEntry(e){return Pr(Qt.storage.entries.value[e]?.type)}migrateDataFromPreviousStorage(){const e=Qt.storage.entries.value,t=[hn,pn,vn];Object.keys(e).forEach((n=>{const r=n,i=e[r]?.type,s=this.storeManager?.getStore(In[i]);s&&t.forEach((e=>{const t=this.storeManager?.getStore(In[e]);if(t&&e!==i){const e=t.get(mn[r]);(e=>w(e)&&""!==e)(e)&&s.set(mn[r],e),t.remove(mn[r])}}))}))}migrateStorageIfNeeded(){if(!Qt.storage.migrate.value)return;const e=[];[bn,En,kn].forEach((t=>{const n=this.storeManager?.getStore(t);n&&e.push(n)})),Object.keys(mn).forEach((t=>{const n=mn[t];e.forEach((e=>{const t=this.pluginsManager?.invokeSingle("storage.migrate",n,e.engine,this.errorHandler,this.logger);I(t)||e.set(n,t)}))}))}getConfiguredSessionTrackingInfo(){let e,t=!1!==Qt.loadOptions.value.sessions?.autoTrack;if(!t)return{autoTrack:t};const n=Qt.loadOptions.value.sessions?.timeout;return Ir(n)?e=n:(this.logger?.warn(((e,t,n)=>`${e}${ae}The session timeout value "${t}" is not a number. The default timeout of ${n} ms will be used instead.`)(V,n,we)),e=we),0===e&&(this.logger?.warn(`${V}${ae}The session timeout value is 0, which disables the automatic session tracking feature. If you want to enable session tracking, please provide a positive integer value for the timeout.`),t=!1),e>0&&e<1e4&&this.logger?.warn(((e,t,n)=>`${e}${ae}The session timeout value ${t} ms is less than the recommended minimum of ${n} ms. Please consider increasing the timeout value to ensure optimal performance and reliability.`)(V,e,1e4)),{timeout:e,autoTrack:t}}onError(e,t){if(!this.errorHandler)throw e;this.errorHandler.onError(e,V,t)}getEncryptedCookieData(e,t){const n=[];return e.forEach((e=>{const r=t?.encrypt(de(e.value,!1,[],this.logger));w(r)&&n.push({name:e.name,value:r})})),n}makeRequestToSetCookie(e,t){this.httpClient?.getAsyncData({url:Qt.serverCookies.dataServiceUrl.value,options:{method:"POST",data:de({reqType:"setCookies",workspaceId:Qt.source.value?.workspaceId,data:{options:{maxAge:Qt.storage.cookie.value?.maxage,path:Qt.storage.cookie.value?.path,domain:Qt.storage.cookie.value?.domain,sameSite:Qt.storage.cookie.value?.samesite,secure:Qt.storage.cookie.value?.secure,expires:Qt.storage.cookie.value?.expires},cookies:e}}),sendRawData:!0,withCredentials:!0},isRawResponse:!0,callback:t})}setServerSideCookies(e,t,n){try{const r=this.getEncryptedCookieData(e,n);r.length>0&&this.makeRequestToSetCookie(r,((r,i)=>{var s;200===i?.xhr?.status?e.forEach((e=>{const r=n?.get(e.name),i=de(e.value,!1,[]);de(r,!1,[])!==i&&(this.logger?.error(`The server failed to set the ${e.name} cookie. As a fallback, the cookies will be set client side.`),t&&t(e.name,e.value))})):(this.logger?.error((s=i?.xhr?.status,`The server responded with status ${s} while setting the cookies. As a fallback, the cookies will be set client side.`)),e.forEach((e=>{t&&t(e.name,e.value)})))}))}catch(n){this.onError(n,"Failed to set/remove cookies via server. As a fallback, the cookies will be managed client side."),e.forEach((e=>{t&&t(e.name,e.value)}))}}syncValueToStorage(e,t){const n=Qt.storage.entries.value,r=n[e]?.type;if(Pr(r)){const i=this.storeManager?.getStore(In[r]),s=n[e]?.key;t&&(E(t)||$(t))?Qt.serverCookies.isEnabledServerSideCookies.value&&r===hn?(this.serverSideCookieDebounceFuncs[e]&&globalThis.clearTimeout(this.serverSideCookieDebounceFuncs[e]),this.serverSideCookieDebounceFuncs[e]=globalThis.setTimeout((()=>{this.setServerSideCookies([{name:s,value:t}],((e,t)=>{i?.set(e,t)}),i)}),10)):i?.set(s,t):i?.remove(s)}}registerEffects(){Sn.forEach((e=>{Ye((()=>{this.syncValueToStorage(e,Qt.session[e].value)}))}))}setAnonymousId(e,t){let n=e;if(E(e)&&n||(n=void 0),this.isPersistenceEnabledForStorageEntry("anonymousId")){if(!n&&t){const e=this.pluginsManager?.invokeSingle("userSession.anonymousIdGoogleLinker",t);n=e}n=n||Cr()}else n=At.anonymousId;Qt.session.anonymousId.value=n}getAnonymousId(e){const t=Qt.storage.entries.value.anonymousId?.type;if(Pr(t)){let t=this.getEntryValue("anonymousId");if(!t&&e){const n=this.pluginsManager?.invokeSingle("storage.getAnonymousId",Kn,e);t=n}Qt.session.anonymousId.value=t||Cr()}return Qt.session.anonymousId.value}getEntryValue(e){const t=Qt.storage.entries.value,n=t[e]?.type;if(Pr(n)){const r=this.storeManager?.getStore(In[n]),i=t[e]?.key;return r?.get(i)??null}return null}getExternalAnonymousIdByCookieName(e){const t=Kn(hn);return t?.isEnabled?t.getItem(e)??null:null}getUserId(){return this.getEntryValue("userId")}getUserTraits(){return this.getEntryValue("userTraits")}getGroupId(){return this.getEntryValue("groupId")}getGroupTraits(){return this.getEntryValue("groupTraits")}getInitialReferrer(){return this.getEntryValue("initialReferrer")}getInitialReferringDomain(){return this.getEntryValue("initialReferringDomain")}getSessionInfo(){return this.getEntryValue("sessionInfo")}getAuthToken(){return this.getEntryValue("authToken")}getSessionId(){const e=this.getSessionInfo()??At.sessionInfo;return e.autoTrack&&!Tr(e.expiresAt)||e.manualTrack?e.id??null:null}refreshSession(){let e=this.getSessionInfo()??At.sessionInfo;(e.autoTrack||e.manualTrack)&&(e.autoTrack&&(this.startOrRenewAutoTracking(e),e=Qt.session.sessionInfo.value),void 0===e.sessionStart?e={...e,sessionStart:!0}:e.sessionStart&&(e={...e,sessionStart:!1})),Qt.session.sessionInfo.value=e,"readyExecuted"!==Qt.lifecycle.status.value&&this.syncValueToStorage("sessionInfo",e)}reset(e,t){const{session:n}=Qt,{manualTrack:r,autoTrack:i}=n.sessionInfo.value;Ne((()=>{n.userId.value=At.userId,n.userTraits.value=At.userTraits,n.groupId.value=At.groupId,n.groupTraits.value=At.groupTraits,n.authToken.value=At.authToken,!0===e&&this.setAnonymousId(),t||(i?(n.sessionInfo.value=At.sessionInfo,this.startOrRenewAutoTracking(n.sessionInfo.value)):r&&this.startManualTrackingInternal())}))}setUserId(e){Qt.session.userId.value=this.isPersistenceEnabledForStorageEntry("userId")&&e?e:At.userId}setUserTraits(e){Qt.session.userTraits.value=this.isPersistenceEnabledForStorageEntry("userTraits")&&C(e)?R(Qt.session.userTraits.value??At.userTraits,e):At.userTraits}setGroupId(e){Qt.session.groupId.value=this.isPersistenceEnabledForStorageEntry("groupId")&&e?e:At.groupId}setGroupTraits(e){Qt.session.groupTraits.value=this.isPersistenceEnabledForStorageEntry("groupTraits")&&C(e)?R(Qt.session.groupTraits.value??At.groupTraits,e):At.groupTraits}setInitialReferrer(e){Qt.session.initialReferrer.value=this.isPersistenceEnabledForStorageEntry("initialReferrer")&&e?e:At.initialReferrer}setInitialReferringDomain(e){Qt.session.initialReferringDomain.value=this.isPersistenceEnabledForStorageEntry("initialReferringDomain")&&e?e:At.initialReferringDomain}startOrRenewAutoTracking(e){if(Tr(e.expiresAt))Qt.session.sessionInfo.value=(e=>{const t=Date.now(),n=e||we;return{id:t,expiresAt:t+n,timeout:n,sessionStart:void 0,autoTrack:!0}})(e.timeout);else{const t=Date.now(),n=e.timeout;Qt.session.sessionInfo.value=R(e,{expiresAt:t+n})}}start(e){Qt.session.sessionInfo.value=Ar(e,this.logger)}startManualTrackingInternal(){this.start(Date.now())}end(){Qt.session.sessionInfo.value=At.sessionInfo}setAuthToken(e){Qt.session.authToken.value=this.isPersistenceEnabledForStorageEntry("authToken")&&e?e:At.authToken}}const Nr=["BeaconQueue","Bugsnag","CustomConsentManager","DeviceModeDestinations","DeviceModeTransformation","ErrorReporting","ExternalAnonymousId","GoogleLinker","IubendaConsentManager","KetchConsentManager","NativeDestinationQueue","OneTrustConsentManager","StorageEncryption","StorageEncryptionLegacy","StorageMigrator","XhrQueue"],Ur="dataplaneEventsQueue",xr="destinationsEventsQueue",jr=(e,t)=>{const n=g(e),r=t.nativeDestinations.integrationsConfig.value,i=((e,t)=>Object.keys(e).filter((n=>!0!==e[n]||!t[n])).reduce(((t,n)=>{const r=g(t);return r[n]=e[n],r}),{}))(e.integrations,r);return n.integrations=R(r,i),n};class Hr{constructor(e,t,n,r){this.pluginsManager=e,this.errorHandler=n,this.logger=r,this.httpClient=new dn(n,r),this.storeManager=t,this.onError=this.onError.bind(this)}init(){try{this.dataplaneEventsQueue=this.pluginsManager.invokeSingle(`${Ur}.init`,Qt,this.httpClient,this.storeManager,this.errorHandler,this.logger)}catch(e){this.onError(e,"XhrQueuePlugin initialization failed")}try{this.dmtEventsQueue=this.pluginsManager.invokeSingle("transformEvent.init",Qt,this.pluginsManager,this.httpClient,this.storeManager,this.errorHandler,this.logger)}catch(e){this.onError(e,"DeviceModeTransformationPlugin initialization failed")}try{this.destinationsEventsQueue=this.pluginsManager.invokeSingle(`${xr}.init`,Qt,this.pluginsManager,this.storeManager,this.dmtEventsQueue,this.errorHandler,this.logger)}catch(e){this.onError(e,"NativeDestinationQueuePlugin initialization failed")}Ye((()=>{!0===Qt.nativeDestinations.clientDestinationsReady.value&&(this.destinationsEventsQueue?.start(),this.dmtEventsQueue?.start())}));const e=(e=>e.consents.preConsent.value.enabled&&"buffer"===e.consents.preConsent.value.events?.delivery&&("session"===e.consents.preConsent.value.storage?.strategy||"none"===e.consents.preConsent.value.storage?.strategy))(Qt);let t;Ye((()=>{const n=!0===Qt.loadOptions.value.bufferDataPlaneEventsUntilReady&&!1===Qt.nativeDestinations.clientDestinationsReady.value;!1!==Qt.nativeDestinations.activeDestinations.value.some((e=>{return t=e,Boolean("hybrid"===t.config.connectionMode||!0===t.config.useNativeSDKToSend);var t}))&&!1!==n||e||!0===this.dataplaneEventsQueue?.scheduleTimeoutActive||(globalThis.clearTimeout(t),this.dataplaneEventsQueue?.start())})),!0===Qt.loadOptions.value.bufferDataPlaneEventsUntilReady&&(t=globalThis.setTimeout((()=>{!0!==this.dataplaneEventsQueue?.scheduleTimeoutActive&&this.dataplaneEventsQueue?.start()}),Qt.loadOptions.value.dataPlaneEventsBufferTimeout))}resume(){!0!==this.dataplaneEventsQueue?.scheduleTimeoutActive&&(Qt.consents.postConsent.value.discardPreConsentEvents&&(this.dataplaneEventsQueue?.clear(),this.destinationsEventsQueue?.clear()),this.dataplaneEventsQueue?.start())}enqueue(e,t){let n;try{n=jr(e,Qt),this.pluginsManager.invokeSingle(`${Ur}.enqueue`,Qt,this.dataplaneEventsQueue,n,this.errorHandler,this.logger)}catch(e){this.onError(e,"XhrQueuePlugin event enqueue failed")}try{const t=g(e);this.pluginsManager.invokeSingle(`${xr}.enqueue`,Qt,this.destinationsEventsQueue,t,this.errorHandler,this.logger)}catch(e){this.onError(e,"NativeDestinationQueuePlugin event enqueue failed")}try{t?.(n)}catch(e){this.onError(e,"API Callback Invocation Failed")}}onError(e,t,n){if(!this.errorHandler)throw e;this.errorHandler.onError(e,"EventRepository",t,n)}}const _r=e=>{const t=new CustomEvent(e,{detail:{analyticsInstance:globalThis.rudderanalytics},bubbles:!0,cancelable:!0,composed:!0});globalThis.document.dispatchEvent(t)};class Fr{constructor(){this.preloadBuffer=new et,this.initialized=!1,this.errorHandler=Gt,this.logger=nt,this.externalSrcLoader=new Le(this.errorHandler,this.logger),this.capabilitiesManager=new mr(this.errorHandler,this.logger),this.httpClient=gn}load(e,t,n={}){Qt.lifecycle.status.value||((e=>E(e)&&e.trim().length>0)(e)?(e=>er(e))(t)?(Ne((()=>{Qt.lifecycle.writeKey.value=g(e),Qt.lifecycle.dataPlaneUrl.value=g(t),Qt.loadOptions.value=((e,t)=>{const n=g(t);return E(n.setCookieDomain)||delete n.setCookieDomain,["Strict","Lax","None"].includes(n.sameSiteCookie)||delete n.sameSiteCookie,n.secureCookie=!0===n.secureCookie,n.sameDomainCookiesOnly=!0===n.sameDomainCookiesOnly,["none","default","full"].includes(n.uaChTrackLevel)||delete n.uaChTrackLevel,$(n.integrations)||delete n.integrations,n.plugins=n.plugins??Nr,n.useGlobalIntegrationsConfigInEvents=!0===n.useGlobalIntegrationsConfigInEvents,n.bufferDataPlaneEventsUntilReady=!0===n.bufferDataPlaneEventsUntilReady,n.sendAdblockPage=!0===n.sendAdblockPage,n.useServerSideCookies=!0===n.useServerSideCookies,n.dataServiceEndpoint&&"string"!=typeof n.dataServiceEndpoint&&delete n.dataServiceEndpoint,C(n.sendAdblockPageOptions)||delete n.sendAdblockPageOptions,T(n.loadIntegration)?n.loadIntegration=!0===n.loadIntegration:delete n.loadIntegration,C(n.storage)?(n.storage=L(n.storage),n.storage.migrate=!0===n.storage?.migrate):delete n.storage,C(n.beaconQueueOptions)?n.beaconQueueOptions=L(n.beaconQueueOptions):delete n.beaconQueueOptions,C(n.destinationsQueueOptions)?n.destinationsQueueOptions=L(n.destinationsQueueOptions):delete n.destinationsQueueOptions,C(n.queueOptions)?n.queueOptions=L(n.queueOptions):delete n.queueOptions,n.lockIntegrationsVersion=!0===n.lockIntegrationsVersion,n.lockPluginsVersion=!0===n.lockPluginsVersion,Sr(n.dataPlaneEventsBufferTimeout)||delete n.dataPlaneEventsBufferTimeout,C(n.storage?.cookie)?n.storage.cookie=L(n.storage?.cookie):delete n.storage?.cookie,C(n.preConsent)?n.preConsent=L(n.preConsent):delete n.preConsent,R(e,n)})(Qt.loadOptions.value,n),Qt.lifecycle.status.value="mounted"})),this.logger?.setMinLogLevel(Qt.loadOptions.value.logLevel??"ERROR"),Pe("state",Qt,e),this.startLifecycle()):this.logger.error(((e,t)=>`${e}${ae}The data plane URL "${t}" is invalid. It must be a valid URL string. Please check that the data plane URL is correct and try again.`)(X,t)):this.logger.error(((e,t)=>`${e}${ae}The write key "${t}" is invalid. It must be a non-empty string. Please check that the write key is correct and try again.`)(X,e)))}startLifecycle(){Ye((()=>{try{switch(Qt.lifecycle.status.value){case"mounted":this.onMounted();break;case"browserCapabilitiesReady":this.onBrowserCapabilitiesReady();break;case"configured":this.onConfigured();break;case"pluginsLoading":case"destinationsLoading":case"readyExecuted":default:break;case"pluginsReady":this.onPluginsReady();break;case"initialized":this.onInitialized();break;case"loaded":this.onLoaded();break;case"destinationsReady":this.onDestinationsReady();break;case"ready":this.onReady()}}catch(e){const t="Failed to load the SDK";this.errorHandler.onError(fe(e,t),X)}}))}onBrowserCapabilitiesReady(){Re(this),this.prepareInternalServices(),this.loadConfig()}onLoaded(){this.processBufferedEvents(),!0===Qt.consents.preConsent.value.enabled?Qt.lifecycle.status.value="ready":this.loadDestinations()}onMounted(){this.capabilitiesManager.init()}enqueuePreloadBufferEvents(e){Array.isArray(e)&&e.forEach((e=>this.preloadBuffer.enqueue(g(e))))}processDataInPreloadBuffer(){for(;this.preloadBuffer.size()>0;){const e=this.preloadBuffer.dequeue();e&&$e([...e],this)}}prepareInternalServices(){this.pluginsManager=new sn(Kt,this.errorHandler,this.logger),this.storeManager=new Vn(this.pluginsManager,this.errorHandler,this.logger),this.configManager=new hr(this.httpClient,this.errorHandler,this.logger),this.userSessionManager=new Br(this.errorHandler,this.logger,this.pluginsManager,this.storeManager,this.httpClient),this.eventRepository=new Hr(this.pluginsManager,this.storeManager,this.errorHandler,this.logger),this.eventManager=new Mr(this.eventRepository,this.userSessionManager,this.errorHandler,this.logger)}loadConfig(){Qt.lifecycle.writeKey.value&&this.httpClient.setAuthHeader(Qt.lifecycle.writeKey.value),this.configManager?.init()}onPluginsReady(){this.errorHandler.init(this.httpClient,this.externalSrcLoader),this.storeManager?.init(),this.userSessionManager?.init(),Qt.consents.enabled.value&&!Qt.consents.initialized.value&&(this.pluginsManager?.invokeSingle("consentManager.init",Qt,this.logger),!1===Qt.consents.preConsent.value.enabled&&this.pluginsManager?.invokeSingle("consentManager.updateConsentsInfo",Qt,this.storeManager,this.logger)),this.eventManager?.init(),Qt.lifecycle.status.value="initialized"}onConfigured(){this.pluginsManager?.init()}onInitialized(){this.processDataInPreloadBuffer(),b(Qt.loadOptions.value.onLoaded)&&Qt.loadOptions.value.onLoaded(globalThis.rudderanalytics),Ne((()=>{Qt.lifecycle.loaded.value=!0,Qt.lifecycle.status.value="loaded"})),this.initialized=!0,_r("RSA_Initialised")}onReady(){Qt.lifecycle.status.value="readyExecuted",Qt.eventBuffer.readyCallbacksArray.value.forEach((e=>{try{e()}catch(e){this.errorHandler.onError(e,X,ut)}})),_r("RSA_Ready")}processBufferedEvents(){let e=Qt.eventBuffer.toBeProcessedArray.value;for(;e.length>0;){const t=e.shift();if(Qt.eventBuffer.toBeProcessedArray.value=e,t){const e=t[0];b(this[e])&&this[e](...t.slice(1),!0)}e=Qt.eventBuffer.toBeProcessedArray.value}}loadDestinations(){if(Qt.nativeDestinations.clientDestinationsReady.value)return;this.pluginsManager?.invokeSingle("nativeDestinations.setActiveDestinations",Qt,this.pluginsManager,this.errorHandler,this.logger);const e=Qt.nativeDestinations.activeDestinations.value.length;0!==e?(Qt.lifecycle.status.value="destinationsLoading",this.pluginsManager?.invokeSingle("nativeDestinations.load",Qt,this.externalSrcLoader,this.errorHandler,this.logger),Ye((()=>{(0===e||Qt.nativeDestinations.initializedDestinations.value.length+Qt.nativeDestinations.failedDestinations.value.length===e)&&Ne((()=>{Qt.lifecycle.status.value="destinationsReady",Qt.nativeDestinations.clientDestinationsReady.value=!0}))}))):Qt.lifecycle.status.value="destinationsReady"}onDestinationsReady(){"ready"!==Qt.lifecycle.status.value&&(Qt.lifecycle.status.value="ready")}ready(e,t=!1){const n="ready";if(Qt.lifecycle.loaded.value)if(this.errorHandler.leaveBreadcrumb(`New ${n} invocation`),b(e))if("readyExecuted"===Qt.lifecycle.status.value)try{e()}catch(e){this.errorHandler.onError(e,X,ut)}else Qt.eventBuffer.readyCallbacksArray.value=[...Qt.eventBuffer.readyCallbacksArray.value,e];else this.logger.error(`${"readyApi"}${ae}The provided callback is not a function.`);else Qt.eventBuffer.toBeProcessedArray.value=[...Qt.eventBuffer.toBeProcessedArray.value,[n,e]]}page(e,t=!1){const n="page";Qt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} event`),Qt.metrics.triggered.value+=1,this.eventManager?.addEvent({type:"page",category:e.category,name:e.name,properties:e.properties,options:e.options,callback:e.callback}),!0===Qt.capabilities.isAdBlocked.value&&e.category!==Ee&&this.page(U(Ee,"ad-block page request",{path:"/ad-blocked"},Qt.loadOptions.value.sendAdblockPageOptions))):Qt.eventBuffer.toBeProcessedArray.value=[...Qt.eventBuffer.toBeProcessedArray.value,[n,e]]}track(e,t=!1){const n="track";Qt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} event - ${e.name}`),Qt.metrics.triggered.value+=1,this.eventManager?.addEvent({type:n,name:e.name||void 0,properties:e.properties,options:e.options,callback:e.callback})):Qt.eventBuffer.toBeProcessedArray.value=[...Qt.eventBuffer.toBeProcessedArray.value,[n,e]]}identify(e,t=!1){const n="identify";if(!Qt.lifecycle.loaded.value)return void(Qt.eventBuffer.toBeProcessedArray.value=[...Qt.eventBuffer.toBeProcessedArray.value,[n,e]]);this.errorHandler.leaveBreadcrumb(`New ${n} event`),Qt.metrics.triggered.value+=1;Boolean(e.userId&&Qt.session.userId.value&&e.userId!==Qt.session.userId.value)&&this.reset(),k(e.userId)||this.userSessionManager?.setUserId(e.userId),this.userSessionManager?.setUserTraits(e.traits),this.eventManager?.addEvent({type:n,userId:e.userId,traits:e.traits,options:e.options,callback:e.callback})}alias(e,t=!1){const n="alias";if(!Qt.lifecycle.loaded.value)return void(Qt.eventBuffer.toBeProcessedArray.value=[...Qt.eventBuffer.toBeProcessedArray.value,[n,e]]);this.errorHandler.leaveBreadcrumb(`New ${n} event`),Qt.metrics.triggered.value+=1;const r=e.from??this.userSessionManager?.getUserId()??this.userSessionManager?.getAnonymousId();this.eventManager?.addEvent({type:n,to:e.to,from:r,options:e.options,callback:e.callback})}group(e,t=!1){const n="group";Qt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} event`),Qt.metrics.triggered.value+=1,k(e.groupId)||this.userSessionManager?.setGroupId(e.groupId),this.userSessionManager?.setGroupTraits(e.traits),this.eventManager?.addEvent({type:n,groupId:e.groupId,traits:e.traits,options:e.options,callback:e.callback})):Qt.eventBuffer.toBeProcessedArray.value=[...Qt.eventBuffer.toBeProcessedArray.value,[n,e]]}reset(e,t=!1){const n="reset";Qt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} invocation, resetAnonymousId: ${e}`),this.userSessionManager?.reset(e)):Qt.eventBuffer.toBeProcessedArray.value=[...Qt.eventBuffer.toBeProcessedArray.value,[n,e]]}getAnonymousId(e){return this.userSessionManager?.getAnonymousId(e)}setAnonymousId(e,t,n=!1){const r="setAnonymousId";Qt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${r} invocation`),this.userSessionManager?.setAnonymousId(e,t)):Qt.eventBuffer.toBeProcessedArray.value=[...Qt.eventBuffer.toBeProcessedArray.value,[r,e,t]]}getUserId(){return Qt.session.userId.value}getUserTraits(){return Qt.session.userTraits.value}getGroupId(){return Qt.session.groupId.value}getGroupTraits(){return Qt.session.groupTraits.value}startSession(e,t=!1){const n="startSession";Qt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} invocation`),this.userSessionManager?.start(e)):Qt.eventBuffer.toBeProcessedArray.value=[...Qt.eventBuffer.toBeProcessedArray.value,[n,e]]}endSession(e=!1){const t="endSession";Qt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${t} invocation`),this.userSessionManager?.end()):Qt.eventBuffer.toBeProcessedArray.value=[...Qt.eventBuffer.toBeProcessedArray.value,[t]]}getSessionId(){const e=this.userSessionManager?.getSessionId();return e??null}consent(e,t=!1){Qt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb("New consent invocation"),Ne((()=>{Qt.consents.preConsent.value={...Qt.consents.preConsent.value,enabled:!1},Qt.consents.postConsent.value=(e=>{const t={sendPageEvent:!1,trackConsent:!1,discardPreConsentEvents:!1};if(C(e)){const n=g(e);t.storage=n.storage,$(n.integrations)&&(t.integrations=n.integrations),t.discardPreConsentEvents=!0===n.discardPreConsentEvents,t.sendPageEvent=!0===n.sendPageEvent,t.trackConsent=!0===n.trackConsent,$(n.consentManagement)&&(t.consentManagement=R(n.consentManagement,{enabled:Qt.consents.enabled.value}))}return t})(e);const{initialized:t,consentsData:n}=sr(Qt.consents.postConsent.value.consentManagement,this.logger);Qt.consents.initialized.value=t||Qt.consents.initialized.value,Qt.consents.data.value=n})),Qt.consents.enabled.value&&!Qt.consents.initialized.value&&this.pluginsManager?.invokeSingle("consentManager.updateConsentsInfo",Qt,this.storeManager,this.logger),this.storeManager?.initializeStorageState(),this.userSessionManager?.syncStorageDataToState(),this.eventManager?.resume(),this.loadDestinations(),this.sendTrackingEvents(t)):Qt.eventBuffer.toBeProcessedArray.value=[...Qt.eventBuffer.toBeProcessedArray.value,["consent",e]]}sendTrackingEvents(e){if(Qt.consents.postConsent.value.trackConsent){const t=x("Consent Management Interaction");e?Qt.eventBuffer.toBeProcessedArray.value=[...Qt.eventBuffer.toBeProcessedArray.value,["track",t]]:this.track(t)}if(Qt.consents.postConsent.value.sendPageEvent){const t=U();e?Qt.eventBuffer.toBeProcessedArray.value=[...Qt.eventBuffer.toBeProcessedArray.value,["page",t]]:this.page(t)}}setAuthToken(e){this.userSessionManager?.setAuthToken(e)}}class Qr{static globalSingleton=null;analyticsInstances={};defaultAnalyticsKey="";logger=(()=>nt)();constructor(){try{if(Qr.globalSingleton)return Qr.globalSingleton;Gt.attachErrorListeners(),this.setDefaultInstanceKey=this.setDefaultInstanceKey.bind(this),this.getAnalyticsInstance=this.getAnalyticsInstance.bind(this),this.load=this.load.bind(this),this.ready=this.ready.bind(this),this.triggerBufferedLoadEvent=this.triggerBufferedLoadEvent.bind(this),this.page=this.page.bind(this),this.track=this.track.bind(this),this.identify=this.identify.bind(this),this.alias=this.alias.bind(this),this.group=this.group.bind(this),this.reset=this.reset.bind(this),this.getAnonymousId=this.getAnonymousId.bind(this),this.setAnonymousId=this.setAnonymousId.bind(this),this.getUserId=this.getUserId.bind(this),this.getUserTraits=this.getUserTraits.bind(this),this.getGroupId=this.getGroupId.bind(this),this.getGroupTraits=this.getGroupTraits.bind(this),this.startSession=this.startSession.bind(this),this.endSession=this.endSession.bind(this),this.getSessionId=this.getSessionId.bind(this),this.setAuthToken=this.setAuthToken.bind(this),this.consent=this.consent.bind(this),Qr.globalSingleton=this,Qt.autoTrack.pageLifecycle.visitId.value=se(),Qt.autoTrack.pageLifecycle.pageLoadedTimestamp.value=Date.now(),this.triggerBufferedLoadEvent(),globalThis.rudderanalytics=this}catch(e){ye(e)}}setDefaultInstanceKey(e){E(e)&&e&&(this.defaultAnalyticsKey=e)}getAnalyticsInstance(e){try{let t=e;E(t)&&t||(t=this.defaultAnalyticsKey);return Boolean(this.analyticsInstances[t])||(this.analyticsInstances[t]=new Fr),this.analyticsInstances[t]}catch(e){return void ye(e)}}load(e,t,n){try{if(this.analyticsInstances[e])return;this.setDefaultInstanceKey(e);const r=Ce(ke);this.trackPageLifecycleEvents(r,n),(e=>{const t="consent",n=e.filter((e=>e[0]===t)),r=e.filter((e=>e[0]!==t));e.splice(0,e.length,...n,...r)})(r),Pe(ke,g(r)),this.analyticsInstances[e]=new Fr,this.getAnalyticsInstance(e)?.load(e,t,pe(n))}catch(e){ye(e)}}trackPageLifecycleEvents(e,t){const{autoTrack:n,useBeacon:r}=t??{},{enabled:i=!1,options:s={},pageLifecycle:o}=n??{},{events:a=[F.LOADED,F.UNLOADED],enabled:l=i,options:u=s}=o??{};Qt.autoTrack.pageLifecycle.enabled.value=l,Qt.autoTrack.enabled.value=i||l,l&&(this.trackPageLoadedEvent(a,u,e),this.setupPageUnloadTracking(a,r,u))}trackPageLoadedEvent(e,t,n){(0===e.length||e.includes(F.LOADED))&&n.unshift(["track",F.LOADED,{},{...t,originalTimestamp:oe(new Date(Qt.autoTrack.pageLifecycle.pageLoadedTimestamp.value))}])}setupPageUnloadTracking(e,t,n){(0===e.length||e.includes(F.UNLOADED))&&(!0===t?(e=>{let t=!1,n=!1;function r(){t||(t=!0,e(n),setTimeout((()=>{t=!1}),0))}globalThis.addEventListener("beforeunload",(()=>{n=!1,r()})),globalThis.addEventListener("blur",(()=>{n=!0,r()})),globalThis.addEventListener("focus",(()=>{t=!1})),document.addEventListener("pagehide",(()=>{n="hidden"===document.visibilityState,r()})),document.addEventListener("visibilitychange",(()=>{n=!0,"hidden"===document.visibilityState?r():t=!1}))})((e=>{if(!1===e&&Qt.lifecycle.loaded.value){const e=Date.now(),t=e-Qt.autoTrack.pageLifecycle.pageLoadedTimestamp.value;this.track(F.UNLOADED,{visitDuration:t},{...n,originalTimestamp:oe(new Date(e))})}})):this.logger.warn(`${"RudderStackAnalytics"}${ae}Page Unloaded event can only be tracked when the Beacon transport is active. Please enable "useBeacon" load API option.`))}triggerBufferedLoadEvent(){const e=Array.isArray(globalThis.rudderanalytics)?globalThis.rudderanalytics:[],t=(e=>{let t=[],n=0;for(;n<e.length;){if(e[n]&&"load"===e[n][0]){t=g(e[n]),e.splice(n,1);break}n+=1}return t})(e);Pe(ke,g([...e])),t.length>0&&(t.shift(),this.load.apply(null,t))}ready(e){try{this.getAnalyticsInstance()?.ready(pe(e))}catch(e){ye(e)}}page(e,t,n,r,i){try{this.getAnalyticsInstance()?.page(U(pe(e),pe(t),pe(n),pe(r),pe(i)))}catch(e){ye(e)}}track(e,t,n,r){try{this.getAnalyticsInstance()?.track(x(pe(e),pe(t),pe(n),pe(r)))}catch(e){ye(e)}}identify(e,t,n,r){try{this.getAnalyticsInstance()?.identify(j(pe(e),pe(t),pe(n),pe(r)))}catch(e){ye(e)}}alias(e,t,n,r){try{this.getAnalyticsInstance()?.alias(H(pe(e),pe(t),pe(n),pe(r)))}catch(e){ye(e)}}group(e,t,n,r){try{this.getAnalyticsInstance()?.group(_(pe(e),pe(t),pe(n),pe(r)))}catch(e){ye(e)}}reset(e){try{this.getAnalyticsInstance()?.reset(pe(e))}catch(e){ye(e)}}getAnonymousId(e){try{return this.getAnalyticsInstance()?.getAnonymousId(pe(e))}catch(e){return void ye(e)}}setAnonymousId(e,t){try{this.getAnalyticsInstance()?.setAnonymousId(pe(e),pe(t))}catch(e){ye(e)}}getUserId(){try{return this.getAnalyticsInstance()?.getUserId()}catch(e){return void ye(e)}}getUserTraits(){try{return this.getAnalyticsInstance()?.getUserTraits()}catch(e){return void ye(e)}}getGroupId(){try{return this.getAnalyticsInstance()?.getGroupId()}catch(e){return void ye(e)}}getGroupTraits(){try{return this.getAnalyticsInstance()?.getGroupTraits()}catch(e){return void ye(e)}}startSession(e){try{this.getAnalyticsInstance()?.startSession(pe(e))}catch(e){ye(e)}}endSession(){try{this.getAnalyticsInstance()?.endSession()}catch(e){ye(e)}}getSessionId(){try{return this.getAnalyticsInstance()?.getSessionId()}catch(e){return void ye(e)}}setAuthToken(e){try{this.getAnalyticsInstance()?.setAuthToken(pe(e))}catch(e){ye(e)}}consent(e){try{this.getAnalyticsInstance()?.consent(pe(e))}catch(e){ye(e)}}}const{setDefaultInstanceKey:Kr,getAnalyticsInstance:Gr,load:zr,ready:Vr,page:qr,track:Wr,identify:Jr,alias:Xr,group:Zr,reset:Yr,getAnonymousId:ei,setAnonymousId:ti,getUserId:ni,getUserTraits:ri,getGroupId:ii,getGroupTraits:si,startSession:oi,endSession:ai,getSessionId:li,consent:ui,setAuthToken:ci}=new Qr;return e.alias=Xr,e.consent=ui,e.endSession=ai,e.getAnalyticsInstance=Gr,e.getAnonymousId=ei,e.getGroupId=ii,e.getGroupTraits=si,e.getSessionId=li,e.getUserId=ni,e.getUserTraits=ri,e.group=Zr,e.identify=Jr,e.load=zr,e.page=qr,e.ready=Vr,e.reset=Yr,e.setAnonymousId=ti,e.setAuthToken=ci,e.setDefaultInstanceKey=Kr,e.startSession=oi,e.track=Wr,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),e}({});
//# sourceMappingURL=rsa.min.js.map
