var e=function(e){"use strict";var t,s,i,r,n,o,a,l,u,c,d=Object.defineProperty,_=Object.defineProperties,h=Object.getOwnPropertyDescriptors,g=Object.getOwnPropertySymbols,p=Object.prototype.hasOwnProperty,m=Object.prototype.propertyIsEnumerable,S=(e,t,s)=>t in e?d(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,E=(e,t)=>{for(var s in t||(t={}))p.call(t,s)&&S(e,s,t[s]);if(g)for(var s of g(t))m.call(t,s)&&S(e,s,t[s]);return e},f=(e,t)=>_(e,h(t)),b=(e,t)=>{var s={};for(var i in e)p.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&g)for(var i of g(e))t.indexOf(i)<0&&m.call(e,i)&&(s[i]=e[i]);return s},v=(e,t,s)=>(S(e,"symbol"!=typeof t?t+"":t,s),s),y=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},I=(e,t,s)=>(y(e,t,"read from private field"),s?s.call(e):t.get(e)),P=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},D=(e,t,s,i)=>(y(e,t,"write to private field"),i?i.call(e,s):t.set(e,s),s),w=(e,t,s)=>new Promise(((i,r)=>{var n=e=>{try{a(s.next(e))}catch(t){r(t)}},o=e=>{try{a(s.throw(e))}catch(t){r(t)}},a=e=>e.done?i(e.value):Promise.resolve(e.value).then(n,o);a((s=s.apply(e,t)).next())})),O=(e=>(e.VERBOSE="verbose",e.DEBUG="debug",e.INFO="info",e.WARN="warn",e.ERROR="error",e.CRITICAL="critical",e.NONE="none",e))(O||{}),N="prod",C="@pushly/push-sdk-web",k="3.0.24",T="cdn.p-n.io",R="k.p-n.io",A="PushlySDK";let L=class{static get _env(){return N}static get _libraryName(){return C}static get _libraryVersion(){return k}static get _cdnDomain(){return T}static get _kApiDomain(){return R}static get _publicNamespace(){return A}static get _kApiEventsUrl(){return`https://${this._kApiDomain}/event-stream`}static get _kApiAllowUrl(){return`https://${this._kApiDomain}/allow`}static get _cdnDomainSettingsUrl(){return`https://${this._cdnDomain}/domain-settings`}static get _isDev(){return"development"===this._env}static get _isProd(){return"production"===this._env}static get _sdkHasEventsOnlyDomainsFlag(){return"FEAT_SDK_EVENT_ONLY_DOMAINS"}static get _sdkHasForceDebugLogsEnabledFlag(){return"FEAT_WEB_FORCE_DEBUG_LOGS"}static get _sdkDebugEventsEnabledFlag(){return"SDK_DEBUG_EVENTS"}static get _pnCookieStorageKey(){return"_pn"}static get _pnCookieStorageKeyRegex(){return new RegExp(`^${this._pnCookieStorageKey}(_[0-9A-Za-z]{8})?=`)}static get _pnCookieStorageLegacyKeyPrefix(){return"_pn"}static get _pnCookieStorageLegacyKeyPrefixRegex(){return new RegExp(`^((${this._pnCookieStorageLegacyKeyPrefix}.+)|(pushly.+))`)}static get _pnStorageTypeLuaKey(){return"lua"}static get _pnStorageUpdatedAtKey(){return"ts"}static get _pnSessionStorageKey(){return"_ps"}static get _pnCookieStorageMaxDays(){return 180}static get _pnDomainConfigCacheTtlSeconds(){return 60}static get _eventQueueMaxSize(){return 100}static get _eventQueueFlushIntervalMS(){return 1e3}static get _eventMaxSendAttempts(){return 8}static get _eventQueueFlushTriggerSize(){return 10}static get _eventPriorityHeader(){return"X-Event-Priority"}static get _eventPriorityHeaderImmFlag(){return"1"}static get _tevChannel(){return"WEB"}static get _tevVapidProvider(){return"VAPID"}static get _tevFieldErrorCode(){return"error_code"}static get _tevFieldErrorDescription(){return"error_description"}static get _tevFieldErrorMessage(){return"error_message"}static get _tevFieldErrorStack(){return"error_stack"}static get _tevFieldErrorContext(){return"context"}};function M(e){try{const t=parseInt(String(e));return isNaN(t)?e:t}catch(t){return e}}const U={V8:{signature:/^\s*at\s+\S+\s+\(?\S+\)?$/,split:/:(?!\/)|\s+/},SpiderMonkeyOrJSCore:{signature:/^[^@]*@\S*$/,split:/:(?!\/)|@+/}};function x(e,t){if(!e)return[];let s=e.replace(/(.*?\()(?:eval\s)?(at(?!.+at).*?)\),\s?(.*)/gm,"$1$3\n$2").split(/[\n\r]\s*/).map((e=>[e,Object.keys(U).find((t=>U[t].signature.test(e)))])).filter((([,e])=>e)).map((([e,t])=>e.split(U[t].split).filter((e=>"at"!==e)).map((e=>e.replace(/^\(|\)$/g,""))))).map((([e,t,s,i])=>({function:e||"unknown",file:t||"unknown",line:void 0===s?0:M(s),column:void 0===i?0:M(i)})));return null==t||t.forEach((e=>{s=e(s)})),s}function $(e){return{message:e}}function K(e){return{message:e,isExitException:!0}}var W=(e=>(e.EXCEPTION="exception",e.DUPLICATE_SDK_DETECTED="duplicate_sdk_detected",e.SDK_ALREADY_LOADED="sdk_already_loaded",e.DOMAIN_CONFIGURATION_LOAD_FAILED="domain_config_load_failed",e.HOST_NOT_ALLOWED="host_not_allowed",e.PROMPTS_LOAD_FAILED="prompts_load_failed",e.WEB_PUSH_NOT_SUPPORTED="web_push_not_supported",e.WEB_PUSH_CONFIGURATION_MISSING="web_push_config_missing",e.WEB_PUSH_SUBSCRIPTION_FAILED="web_push_subscription_failed",e.PUSH_WORKER_NOT_FOUND_EXCEPTION="push_worker_not_found_exception",e.PUSH_WORKER_REGISTRATION_EXCEPTION="push_worker_registration_exception",e.PUSH_WORKER_SUBSCRIPTION_EXCEPTION="push_worker_subscription_exception",e.STORAGE_NOT_AVAILABLE="storage_not_available",e.STORAGE_FAILED_TO_OPEN="storage_failed_to_open",e.STORAGE_NS_REQUIRED="storage_ns_required",e.STORAGE_KEY_EMPTY="storage_key_empty",e.IDB_INVALID_STORE_NAME="idb_invalid_store_name",e.IDB_BLOCKED="idb_blocked",e.REQUEST_FAILED="request_failed",e.REQUEST_URL_INVALID="request_url_invalid",e.REQUEST_NO_RESULT="request_no_result",e.REQUEST_DESERIALIZATION_FAILED="request_deserialization_failed",e.UNKNOWN_CONTEXT_KEY="unknown_context_key",e.UNKNOWN_CONFIG_KEYS="unknown_config_keys",e.UNKNOWN_ASYNC_COMMAND="unknown_async_command",e.UNKNOWN_PROMPT_MESSAGE="unknown_prompt_message",e.WORKER_MISSING_PUSH_DATA="worker_missing_push_data",e.UNKNOWN_WORKER_PUSH="unknown_worker_push",e.UNKNOWN_WORKER_PUSHLY_INTERACTION="unknown_worker_pushly_interaction",e.UNKNOWN_WORKER_3P_INTERACTION="unknown_worker_3p_interaction",e))(W||{});const F={exception:$("Unknown exception"),duplicate_sdk_detected:K("Another instance of the SDK is already running"),sdk_already_loaded:K("The SDK has already been loaded"),domain_config_load_failed:K("Failed to load Domain configuration from remote"),host_not_allowed:K("Current host is not allowed for use"),prompts_load_failed:$("Failed to load Prompts from remote"),web_push_not_supported:K("Web push not supported"),web_push_subscription_failed:$("Error encountered during subscription"),web_push_config_missing:K("Web push configuration missing"),push_worker_not_found_exception:$("Service Worker file not found"),push_worker_registration_exception:$("Service Worker registration exception encountered"),push_worker_subscription_exception:$("Web push subscription exception encountered"),storage_not_available:$("Storage not available"),storage_failed_to_open:$("Storage failed to open"),storage_ns_required:$("Store name is required"),storage_key_empty:$("No data for storage key"),idb_invalid_store_name:$("IndexedDB requires a valid store name; `null` provided"),idb_blocked:$("IndexedDB is blocked"),request_failed:$("Request exception encountered"),request_url_invalid:$("Invalid URL"),request_no_result:$("No result"),request_deserialization_failed:$("Failed to decode response"),unknown_context_key:$("Unknown context key"),unknown_config_keys:$("Unknown configuration key"),unknown_async_command:$("Unknown pushly() command"),unknown_prompt_message:$("Unknown prompt message"),worker_missing_push_data:$("Push event data missing"),unknown_worker_push:$("Unknown worker push event"),unknown_worker_pushly_interaction:$("Unknown worker pushly interaction"),unknown_worker_3p_interaction:$("Unknown worker 3rd-party interaction")};function B(e,t){let s=new Error(null!=t?t:"Unknown error");if(e instanceof Error)s=e;else if(null!=e)try{s=new Error(String(e))}catch(i){}return s}const V=class e extends Error{constructor(t,s,i,r=!1){null!=t||(t=W.EXCEPTION);const n=[F[t].message];i&&n.push(i),super(n.join(" - ")),v(this,"originalError"),v(this,"code"),this.details=i,this.isSuppressed=r,this.originalError=null!=s?s:void 0,this.code=t,Object.setPrototypeOf(this,e.prototype),this.name="PNException"}static _from(t,s,i,r=!1){return t instanceof e?t:s?s(t):new e(i,null===t?null:B(t),void 0,r)}static _filterBuilderStackEntry(t){return t.filter((t=>t.function!==`${e.name}.${e._from.name}`))}static _isSuppressed(t){const s=t instanceof e?t._name:t.name,i=t instanceof e?t._compositeMessage:t.message,r=t instanceof e&&t.isSuppressed,n=e.KNOWN_NAMES.includes(s),o=e.KNOWN_NAMES.some((e=>new RegExp(e).test(i)));return!e.FORCE_ALLOW_MESSAGE_PATTERNS.some((e=>e.test(i)))&&(r||n||o)}get _compositeMessage(){var t,s,i;let r=this.message;return this.originalError instanceof e?r=`${r.replace(/\.$/,"")}. ${this.originalError._compositeMessage}`:(null==(t=this.originalError)?void 0:t.message)&&(null==(s=this.originalError)?void 0:s.message)!==r&&(r=`${r.replace(/\.$/,"")}. ${null==(i=this.originalError)?void 0:i.message}`),r}get _isExitException(){return!!F[this.code].isExitException}get _name(){var e,t;return null!=(t=null==(e=this.originalError)?void 0:e.name)?t:this.name}get _stack(){var t;const s=x(null==(t=this.originalError)?void 0:t.stack,[e._filterBuilderStackEntry]),i=x(this.stack,[e._filterBuilderStackEntry]);return s.length?s:i}toString(){return this._compositeMessage}};v(V,"KNOWN_NAMES",["AbortError","SecurityError","NetworkError"]),v(V,"FORCE_ALLOW_MESSAGE_PATTERNS",[/no active service worker/i]);let G=V;function H(e){return Object.keys(e).filter((t=>(isNaN(Number(t))||/^0\d+/.test(t))&&("string"==typeof e[t]||"number"==typeof e[t])))}function j(e,t){const s=function(e){return H(e).map((t=>e[t]))}(e).includes(t)?t:void 0;if(void 0===s)throw new Error(`Invalid enum member ${"string"==typeof t?`"${t}"`:t}. ${JSON.stringify(function(e){return Object.fromEntries(H(e).map((t=>[t,e[t]])))}(e))}`);return s}function Q(e,t){try{return j(e,t)}catch(s){}}const Y={[O.VERBOSE]:{intValue:0,label:"Verbose",logMethod:"debug"},[O.DEBUG]:{intValue:1,label:"Debug",logMethod:"debug"},[O.INFO]:{intValue:2,label:"Info",logMethod:"info"},[O.WARN]:{intValue:3,label:"Warn",logMethod:"warn"},[O.ERROR]:{intValue:4,label:"Error",logMethod:"error"},[O.CRITICAL]:{intValue:5,label:"Critical",logMethod:"error"},[O.NONE]:{intValue:6,label:"None",logMethod:"info"}},q="pn_ll",z=[],X={},Z={};class J{constructor(e){v(this,"_logLevel"),this.name=e,this._logLevel=O.NONE,this._restorePrevLogLevel()}static _getInstance(e){return e||(e=L._publicNamespace),X[e]||(X[e]=new J(e)),X[e]}get logLevel(){return this._logLevel}set logLevel(e){this._logLevel=e,this.persistLogLevel(e)}_restorePrevLogLevel(){if("localStorage"in self)try{const e=self.localStorage.getItem(q);e&&Q(O,e)?(this._log("Logger",O.VERBOSE,["Restoring previous log level",this.logLevel]),this.logLevel=e):(this._log("Logger",O.VERBOSE,["Previous log level not found - setting default",this.logLevel]),this.persistLogLevel(this.logLevel))}catch(e){this._log("Logger",O.VERBOSE,["Unable to restore previous log level",e])}else this._log("Logger",O.VERBOSE,["Skipping log level restore in worker global scope"])}persistLogLevel(e){if("localStorage"in self)try{self.localStorage.setItem(q,e)}catch(t){}}_log(e,t,s){const i=Y[t],r=Y[this.logLevel];e&&(s=s.slice()).unshift(`[${e}]`);let n=i.label[0];if(t===O.CRITICAL&&(n="!"+n),z.push([new Date,n,...s]),this.logLevel!=O.NONE&&t!=O.NONE&&i.intValue>=r.intValue)try{"console"in self&&"object"==typeof console&&i.logMethod in console&&"function"==typeof console[i.logMethod]&&console[i.logMethod](`[${this.name}: ${n}]`,...s)}catch(o){z.push([new Date,`!${Y[O.CRITICAL].label[0]}`,o])}}}class ee{constructor(e,t){v(this,"_globalLogger"),v(this,"_tag"),this._globalLogger=J._getInstance(t),this._tag=null!=e?e:null}static _getInstance(e,t){const s=null!=e?e:"root";return X[s]||(Z[s]=new ee(e,t)),Z[s]}get logLevel(){return this._globalLogger.logLevel}set logLevel(e){this._globalLogger.logLevel=e}_getLogs(e=!1){return e?z.map((([e,t,...s])=>[`${e.toISOString()} [${this._globalLogger.name}: ${t}]`,...s].map((e=>{if(e&&!Array.isArray(e)&&"object"==typeof e)try{return e instanceof G?e._compositeMessage:e instanceof Error?e.message:JSON.stringify(e)}catch(t){}return e})).join(" "))):z.map((([,...e])=>e))}verbose(...e){this._log(O.VERBOSE,...e)}debug(...e){this._log(O.DEBUG,...e)}info(...e){this._log(O.INFO,...e)}warn(...e){this._log(O.WARN,...e)}error(...e){this._log(O.ERROR,...e)}critical(...e){this._log(O.CRITICAL,...e)}_log(e,...t){this._globalLogger._log(this._tag,e,t)}}var te=(e=>(e.LOAD="load",e.SHOW_PROMPT="show_prompt",e.PROFILE="profile",e.PROFILE_APPEND="profile_append",e.PROFILE_REMOVE="profile_remove",e.PAGE_TAG_VISIT="page_tag_visit",e.EXTERNAL_ID="external_id",e.DEREGISTER_EXTERNAL_ID="deregister_external_id",e.REQUEST_USER_DELETION="request_user_deletion",e.VIEW_ITEM="view_item",e.ADD_TO_CART="add_to_cart",e.PURCHASE="purchase",e.UPDATE_CART="update_cart",e.DEBUG="debug",e.CONFIRM_CONSENT="confirm_consent",e))(te||{}),se=(e=>(e.WEB_PUSH_SUPPORTED="web_push_supported",e.WEB_PUSH_UNSUPPORTED="web_push_unsupported",e.LOADED="loaded",e.READY="ready",e.PROMPT_ELIGIBLE="prompt_eligible",e.PROMPT_INELIGIBLE="prompt_ineligible",e.PROMPT_SHOWN="prompt_shown",e.PROMPT_DISMISSED="prompt_dismissed",e.PROMPT_ALLOWED="prompt_allowed",e.PERMISSION_SHOWN="permission_shown",e.PERMISSION_ALLOWED="permission_allowed",e.PERMISSION_DENIED="permission_denied",e.PERMISSION_DISMISSED="permission_dismissed",e.LEGACY_PERMISSION_SHOWN="permission_prompted",e.LEGACY_PERMISSION_ALLOWED="permission_accepted",e))(se||{});const ie=["subscribe"];var re=(e=>(e.ERROR="error",e.SDK_IMPRESSION="sdk_impression",e.DEBUG="debug",e.PROFILE="profile",e.PROFILE_APPEND="profile_append",e.PROFILE_REMOVE="profile_remove",e.EXTERNAL_ID="external_id",e.DEREGISTER_EXTERNAL_ID="deregister_external_id",e.USER_DELETION_REQUEST="udr",e.VIEW_PAGE="view_page",e.VIEW_SCREEN="view_screen",e.ANONYMOUS_VIEW_PAGE="anonymous_view_page",e.PAGE_TAG_VISIT="page_tag_visit",e.ADD_TO_CART="add_to_cart",e.UPDATE_CART="update_cart",e.PURCHASE="purchase",e.VIEW_ITEM="view_item",e.PROMPT_SHOWN="prompt_shown",e.PROMPT_ACCEPTED="prompt_allow",e.PROMPT_DISMISSED="prompt_dismiss",e.PROMPT_NOT_SHOWN="prompt_not_shown",e.PERMISSION_SHOWN="permission_prompted",e.PERMISSION_ACCEPTED="permission_accepted",e.PERMISSION_DISMISSED="permission_dismissed",e.PERMISSION_DENIED="permission_denied",e.PERMISSION_CHANGED="permission_changed",e.IAM_IMPRESSION="iam_impression",e.IAM_CLICK="iam_click",e.IAM_SUBSCRIBE="iam_subscribe",e.IAM_CLOSE="iam_close",e.IAM_NOT_SHOWN="iam_not_shown",e.TOKEN_RECEIVED="subscribed",e.TOKEN_REFRESHED="subscription_change",e.UNSUBSCRIBED="unsubscribed",e.MANUAL_UNSUBSCRIBED="manual_unsubscribed",e.SOFT_UNSUBSCRIBE="soft_unsubscribe",e.SOFT_RESUBSCRIBE="soft_resubscribe",e.NOTIFICATION_IMPRESSION="notification_impression",e.NOTIFICATION_CLICK="notification_click",e.NOTIFICATION_CLOSE="notification_close",e.LIVE_ACTIVITY_REGISTER="la_register",e.LIVE_ACTIVITY_END="la_end",e.SESSION_START="session_start",e.SESSION_HEARTBEAT="session_heartbeat",e))(re||{});const ne=e=>["debug","sdk_impression","prompt_not_shown"].includes(e),oe=e=>{let t=null==e?"":e;if("string"!=typeof e)try{t=JSON.stringify(e)}catch(r){t=""}let s=5381,i=Uint8Array.from(Array.from(t).map((e=>e.charCodeAt(0))));for(let n of i)s=(s<<5)+s+n&4294967295;return s};function ae(e=32){let t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",s="";for(let i=0;i<e;i++)s+=t[Math.floor(62*Math.random())];return/undefined/i.test(s)&&"crypto"in self&&"getRandomValues"in crypto&&"Uint32Array"in self&&(s=crypto.getRandomValues(new Uint32Array(4)).join("")),/undefined/i.test(s)&&(s="INVALID_RANDOM_STRING"),s}const le=e=>Object.assign(Object.create(null),e);function ue(e){return e.replace(/([A-Z]+)/g,(e=>`_${e.toLowerCase()}`)).replace(/^_|_$/,"")}function ce(e){if(!e||Array.isArray(e)||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(ce);const t={};return Object.keys(e).sort().forEach((s=>{t[s]=ce(e[s])})),t}const de=class{static _build(e,t,s){return w(this,null,(function*(){var i,r;const n=le({sendAttemptCount:0,event_id:ae(5),channel:L._tevChannel,provider:L._tevVapidProvider,action:e,domain_id:this._domainId,domain_key:this._domainKey,pushly_unique_user_id:this._anonymousId,token:this._token,meta:le({sdk:{name:L._libraryName,version:L._libraryVersion,library:L._libraryName,library_version:L._libraryVersion},event:{version:3}}),data:null!=t?t:{}});return s&&(n.jxms=s),(null==(i=this._loadConfig)?void 0:i.externalId)&&!n.data[re.EXTERNAL_ID]&&(n.data[re.EXTERNAL_ID]=null==(r=this._loadConfig)?void 0:r.externalId),n}))}static _getErrorEvent(e,t){return w(this,null,(function*(){return this._build(re.ERROR,E({[L._tevFieldErrorCode]:e instanceof G?(s=e.code,s.replace(/^.|_+[a-z]/gi,(e=>e.replace(/_+/,"").toUpperCase()))):e.name,[L._tevFieldErrorDescription]:e instanceof G?e._name:e.name,[L._tevFieldErrorMessage]:e instanceof G?e._compositeMessage:e.message,[L._tevFieldErrorStack]:e instanceof G?e._stack:x(e.stack,[G._filterBuilderStackEntry]),page_url:location.href},null!=t?t:{}));var s}))}static _getProfileExternalIdEvent(e){return w(this,null,(function*(){return this._build(re.PROFILE,{external_id:e})}))}static _getProfileLanguageEvent(e){return w(this,null,(function*(){return this._build(re.PROFILE,{language:e})}))}static _getProfileTimeZoneEvent(e){return w(this,null,(function*(){return this._build(re.PROFILE,{time_zone:e})}))}static _isEqual(e,t){return((e,t)=>oe(e)===oe(t))(this._getEventHashParts(e),this._getEventHashParts(t))}static _prepareSendEvent(e){e.sendAttemptCount+=1,this._ensureLateInitValues(e)}static _ensureLateInitValues(e){!e.pushly_unique_user_id&&this._anonymousId&&(e.pushly_unique_user_id=this._anonymousId),!e.domain_id&&this._domainId&&(e.domain_id=this._domainId),e.domain_id||e.domain_key||!this._domainKey||(e.domain_key=this._domainKey),e.domain_id&&e.domain_key&&delete e.domain_key,!e.token&&this._token&&(e.token=this._token)}static _clone(e){let t;if("structuredClone"in self)try{t=structuredClone(e)}catch(s){}if(!t){const s=e,{sendAttemptCount:i,event_id:r,data:n}=s,o=b(s,["sendAttemptCount","event_id","data"]);t=le(E({},o))}return t.sendAttemptCount=0,t.event_id=ae(5),t.data=le(e.data),t}static _getEventHashParts(e){var t,s;return le({a:e.action,di:null!=(t=e.domain_id)?t:"unknown",dk:null!=(s=e.domain_key)?s:"unknown",puuid:e.pushly_unique_user_id,t:e.token?Object.fromEntries(Object.keys(e.token).sort().entries()):"none",d:ce(e.data)})}};v(de,"_domainKey"),v(de,"_domainId"),v(de,"_anonymousId"),v(de,"_loadConfig"),v(de,"_token"),de._domainKey=null,de._domainId=null,de._anonymousId=null,de._loadConfig=null,de._token=null;let _e=de;class he{constructor(e,i){P(this,t,void 0),P(this,s,void 0),D(this,t,e),D(this,s,null!=i?i:ee._getInstance("UserProfile"))}getAnonymousId(){return w(this,null,(function*(){return I(this,t).userStore._getAnonymousId()}))}getToken(){return w(this,null,(function*(){if(!I(this,t).notificationPermissionService)return null;return(yield I(this,t).notificationPermissionService._getCurrentPermissions()).token}))}setExternalId(e){return w(this,null,(function*(){if(!I(this,t).isLoaded)return void I(this,t)._registerOnLoadedCallback((()=>this.setExternalId(e)));const s=yield I(this,t).userStore._getExternalId();if(!s||e!==s){yield I(this,t).userStore._setExternalId(e);const s=yield _e._getProfileExternalIdEvent(e);I(this,t).eventManager._track(s)}}))}getExternalId(){return w(this,null,(function*(){return I(this,t).userStore._getExternalId()}))}unsetExternalId(){return w(this,null,(function*(){(()=>{w(this,null,(function*(){if(null!==this.getExternalId()){yield I(this,t).userStore._removeExternalId();const e=yield _e._build(re.DEREGISTER_EXTERNAL_ID);I(this,t).eventManager._track(e)}}))})()}))}getSubscriberStatus(){return w(this,null,(function*(){return I(this,t).userStore._getSubscriberStatus()}))}getIsDeleted(){return w(this,null,(function*(){return I(this,t).userStore._getIsInDeletedState()}))}requestUserDeletion(){I(this,t)._executeWhenConfigured((()=>{I(this,s).verbose("Requesting user deletion"),I(this,t).eventManager._track(re.USER_DELETION_REQUEST)}))}set(e,i){const r="string"==typeof e?{[e]:i}:e;I(this,t)._executeWhenConfiguredIfEnabled((()=>{I(this,s).verbose(`Setting to profile: ${r}`),I(this,t).eventManager._track(re.PROFILE,r)}))}append(e,i){I(this,t)._executeWhenConfiguredIfEnabled((()=>{I(this,s).verbose(`Appending to profile ${e}: ${i}`),I(this,t).eventManager._track(re.PROFILE_APPEND,{[e]:i})}))}remove(e,i){I(this,t)._executeWhenConfiguredIfEnabled((()=>{I(this,s).verbose(`Removing from profile ${e}: ${i}`),I(this,t).eventManager._track(re.PROFILE_REMOVE,{[e]:i})}))}trackActivity(e,s){I(this,t)._executeWhenConfiguredIfEnabled((()=>{const i={page_url:e};(null==s?void 0:s.length)&&(i.tags=s),I(this,t).eventManager._track(re.VIEW_PAGE,i)}))}}t=new WeakMap,s=new WeakMap;var ge=(e=>(e.SUBSCRIBED="subscribed",e.DISMISSED="dismissed",e.DENIED="denied",e.NOT_DETERMINED="not_determined",e))(ge||{});const pe={not_determined:0,dismissed:1,subscribed:2,denied:-1},me=e=>{switch("string"==typeof e&&(e=e.toLowerCase()),e){case"subscribed":case pe.subscribed:return"subscribed";case"dismissed":case pe.dismissed:return"dismissed";case"blocked":case"denied":case pe.denied:return"denied";default:return"not_determined"}},Se=e=>"not_determined"===e?"not determined":e;class Ee{constructor(e,t){P(this,i,void 0),P(this,r,void 0),D(this,i,e),D(this,r,null!=t?t:ee._getInstance("Notifications"))}showPermissionPrompt(e,t){I(this,i)._executeWhenConfiguredIfEnabled((()=>{var s;null==(s=I(this,i).promptsController)||s._showPrompt(e,t)}))}getIsEligibleToPrompt(){return w(this,null,(function*(){const e=yield I(this,i).userStore._getIsInDeletedState(),t=yield I(this,i).userStore._getIsSubscribed(),s=yield I(this,i).userStore._getIsUserInSoftUnsubscribedState(),r=yield I(this,i).userStore._getSubscriberStatus();return I(this,i).isLoaded&&I(this,i).isEnabled&&!e&&!t&&r!=ge.DENIED&&r!=ge.DISMISSED&&!s}))}pause(){return w(this,null,(function*(){this._executeIfSubscribed((()=>w(this,null,(function*(){(yield I(this,i).userStore._getIsUserInSoftUnsubscribedState())?I(this,r).info("The user is already in soft unsubscribe status."):(I(this,i).userStore._setIsUserInSoftUnsubscribedState(),I(this,i).eventManager._track(re.SOFT_UNSUBSCRIBE),I(this,r).info("The user's notifications have been paused."))}))))}))}resume(){return w(this,null,(function*(){this._executeIfSubscribed((()=>w(this,null,(function*(){(yield I(this,i).userStore._getIsUserInSoftUnsubscribedState())?(I(this,i).userStore._unsetIsUserInSoftUnsubscribedState(),I(this,i).eventManager._track(re.SOFT_RESUBSCRIBE),I(this,r).info("The user's notifications have been resumed.")):I(this,r).info("The user is not in a soft unsubscribe status.")}))))}))}getIsPaused(){return w(this,null,(function*(){return I(this,i).userStore._getIsUserInSoftUnsubscribedState()}))}getIsSubscribed(){return w(this,null,(function*(){return I(this,i).userStore._getIsSubscribed()}))}_executeIfSubscribed(e){return w(this,null,(function*(){yield I(this,i)._executeWhenConfigured((()=>w(this,null,(function*(){if(yield this.getIsSubscribed())try{yield e()}catch(t){const e=B(t);I(this,r).error(e),I(this,i).eventManager._track(e)}else I(this,r).warn("User is not currently subscribed and can not use this method")}))))}))}}i=new WeakMap,r=new WeakMap;class fe extends L{static get _dynamicDomainKey(){var e,t,s;return null!=(s=null!=(t=fe._injectedDomainKey)?t:null==(e=fe._injectedDomainConfig)?void 0:e.domain_key)?s:fe._requestingScriptDomainKey}static get _requestingScriptDomainKey(){var e,t,s,i;try{const r=new URLSearchParams(null!=(s=null==(t=null==(e=document.currentScript)?void 0:e.getAttribute("src"))?void 0:t.split("?")[1])?s:"");return null!=(i=r.get("domain_key"))?i:r.get("domainKey")}catch(r){}return null}static get _swUseRootScopeFlag(){return"USE_ROOT_SW_SCOPE"}static get _swUsePathWithoutDomainKeyFlag(){return"SW_NO_DOMAIN_KEY_PARAM"}static get _swShouldReplaceExistingWorkerInPushlyScopeFlag(){return"REPLACE_EXISTING_WORKERS"}static get _swShouldUnregisterNonPushlyWorkersFlag(){return"UNREGISTER_ALL_NON_PUSHLY_WORKERS"}static get _domainFeatInformedContentFlag(){return"FEAT_INFORMED_CONTENT"}static get _domainFeatIntegrationsECommFlag(){return"FEAT_DOMAIN_INTEGRATIONS_ECOMM"}static get _domainFeatUseIsolatedCookiesFlag(){return"USE_ISOLATED_COOKIE_STORAGE_LOCATION"}static get _pnPromptsCacheTtlSeconds(){return 60}static get _defaultDismissedStatusExpirationSeconds(){return 604800}static get _injectedDomainKey(){try{return self._PN_IDK_&&"string"==typeof self._PN_IDK_?self._PN_IDK_:null}catch(e){return null}}static get _injectedDomainConfig(){try{return self._PN_IDC_&&"object"==typeof self._PN_IDC_&&!Array.isArray(self._PN_IDC_)&&"domain_key"in self._PN_IDC_?self._PN_IDC_:null}catch(e){return null}}static get _injectedPromptGroups(){try{return self._PN_IPG_&&Array.isArray(self._PN_IPG_)&&self._PN_IPG_.length&&self._PN_IPG_.every((e=>"prompts"in e))?self._PN_IPG_:null}catch(e){return null}}static get _tevSubscribedUrlKey(){return"subscribed_url"}static get _tevDataPageUrlKey(){return"page_url"}static get _tevDataPageTagsKey(){return"page_tags"}static get _tevDataPromptNotShownKey(){return"prompt_not_shown_reason"}}var be=(e=>(e.PRODUCT="product",e.EVENT="event",e))(be||{});function ve(e,t){let s;try{s={item_type:"item_type"in e?Q(be,e.item_type):"event_id"in e?be.EVENT:"product_id"in e?be.PRODUCT:t,id:"id"in e?e.id:"event_id"in e?String(e.event_id):"product_id"in e?String(e.product_id):"",quantity:"quantity"in e?e.quantity:void 0}}catch(i){throw new TypeError(`ECommItem could not be parsed: ${B(i).message}. ${JSON.stringify(e)}`)}if(!s.item_type)throw new TypeError(`ECommItem.item_type could not be parsed. ${JSON.stringify(e)}`);if(!s.id)throw new TypeError(`ECommItem.id could not be parsed. ${JSON.stringify(e)}`);if(s.id!==String(s.id))throw new TypeError(`ECommItem.id is not a string. ${JSON.stringify(e)}`);if(null!==s.quantity&&void 0!==s.quantity&&isNaN(s.quantity))throw new TypeError(`ECommItem.quantity is not numeric. ${JSON.stringify(e)}`);return s}class ye{constructor(e,t){P(this,n,void 0),P(this,o,void 0),D(this,n,e),D(this,o,null!=t?t:ee._getInstance("ECommModule"))}trackViewedItems(e){return w(this,null,(function*(){I(this,n)._executeWhenConfiguredIfEnabled((()=>{this._withECommConfig("trackViewedItems",(t=>{const s={[t.item_type]:e.map((e=>ve(e,t.item_type)))};I(this,o).verbose(`Adding ${e.length} item${e.length>1?"s":""} to viewed items`),I(this,n).eventManager._track(re.VIEW_ITEM,s)}))}))}))}addToCart(e){return w(this,null,(function*(){I(this,n)._executeWhenConfiguredIfEnabled((()=>{this._withECommConfig("addToCart",(t=>{const s={[t.item_type]:e.map((e=>ve(e,t.item_type)))};I(this,o).verbose(`Adding ${e.length} item${e.length>1?"s":""} to cart`),I(this,n).eventManager._track(re.ADD_TO_CART,s)}))}))}))}updateCart(e){return w(this,null,(function*(){I(this,n)._executeWhenConfiguredIfEnabled((()=>{this._withECommConfig("updateCart",(t=>{const s={[t.item_type]:e.map((e=>ve(e,t.item_type)))};I(this,o).verbose(`Updating cart with ${e.length} item${e.length>1?"s":""}.`),I(this,n).eventManager._track(re.UPDATE_CART,s)}))}))}))}clearCart(){return w(this,null,(function*(){I(this,n)._executeWhenConfiguredIfEnabled((()=>{this._withECommConfig("clearCart",(e=>{const t={[e.item_type]:[]};I(this,o).verbose("Clearing cart"),I(this,n).eventManager._track(re.UPDATE_CART,t)}))}))}))}trackPurchase(e,t,s){return w(this,null,(function*(){I(this,n)._executeWhenConfiguredIfEnabled((()=>{this._withECommConfig(`trackPurchase(${e?"items":""}${t?":purchaseId":""}${s?":priceValue":""})`,(i=>{if(void 0===e)return I(this,o).verbose("Tracking purchase"),void I(this,n).eventManager._track(re.PURCHASE);const r={[i.item_type]:e.map((e=>ve(e,i.item_type)))};t&&(r.purchase_id=t),s&&(r.price_value=s),I(this,o).verbose(`Tracking purchase of ${e.length} item${e.length>1?"s":""}${t?" Purchase ID: "+t:""}${s?" Total value: "+s:""}.`),I(this,n).eventManager._track(re.PURCHASE,r)}))}))}))}_withECommConfig(e,t){return w(this,null,(function*(){I(this,n)._executeWhenConfigured((()=>w(this,null,(function*(){const s=yield I(this,n).domainConfigProvider._get();if(s.isErr())return I(this,o).warn(s.getErr()),void I(this,o).warn(`${e} Unable to load Domain Config`);const i=s.unwrap(),r=i.ecomm_config;r?"unknown"!==function(e){switch(e){case"product":return"products";case"event":return"events";default:return"unknown"}}(r.item_type)?i.flags.includes(fe._domainFeatIntegrationsECommFlag)?t(r):I(this,o).warn("E-Commerce support is not currently enabled for this domain"):I(this,o).warn(`E-Commerce configuration has unrecognized item type: ${r.item_type}`):I(this,o).warn("E-Commerce configuration is not defined for this domain")}))))}))}}n=new WeakMap,o=new WeakMap;class Ie{constructor(e,t){P(this,a,void 0),P(this,l,void 0),D(this,a,e),D(this,l,null!=t?t:ee._getInstance("Prompts"))}dispatch(e){return w(this,null,(function*(){var t;e.prompt_action?yield null==(t=I(this,a).promptsController)?void 0:t._processDispatchMessage(e):I(this,l).debug("Received unknown Prompt message:",e)}))}}a=new WeakMap,l=new WeakMap;const Pe=["domainKey","sw","swScope","externalId","classNames","consentRequired","requireConsent","frameMessenger"];class De{constructor(e,t=null){v(this,"ok"),v(this,"err",null),v(this,"toString",(()=>{if(this.isErr()){const e=this.getErr();return`Result.Err: ${e instanceof Error?e.message:e}`}return`Result.Ok: ${this.unwrapOrNull()}`})),null!==t?this.err=t:void 0!==e&&(this.ok=e)}static Ok(e){return new De(e)}static Err(e){return new De(void 0,e)}unwrap(){if(this.isOk())return this.ok;if(this.isErr())throw this.err;throw new Error("Unknown error")}unwrapOr(e){var t;return null!=(t=this.ok)?t:e}unwrapOrNull(){var e;return null!=(e=this.ok)?e:null}isOk(){return null===this.err&&void 0!==this.ok}isErr(){return null!==this.err}getErr(){return this.err}}function we(){const e=window.PushlySDK;return(t=e)&&"object"==typeof t&&"iid"in t&&"string"==typeof t.iid?e:null;var t}const Oe=e=>new G(W.REQUEST_URL_INVALID,null,e),Ne=()=>new G(W.REQUEST_NO_RESULT),Ce=(e,t)=>new G(W.REQUEST_DESERIALIZATION_FAILED,t,e),ke=e=>new G(W.REQUEST_FAILED,e);class Te{constructor(e,t,s=null,i={},r){var n,o;v(this,"_id"),v(this,"_method"),v(this,"_requestUrl"),v(this,"_data"),v(this,"_headers"),v(this,"_parameters"),v(this,"_logger"),v(this,"jitterMillis"),this._logger=null!=r?r:ee._getInstance("Request"),this._id=ae(5),this._method=e,this._requestUrl=t,this._data=s,this._headers={},this._parameters=null!=(n=i.parameters)?n:{},this.jitterMillis=null!=(o=i.jitterMillis)?o:null,i.isPriorityRequest&&this._setIsPriority(!0)}_getParameter(e){var t;return null!=(t=this._parameters[e])?t:null}_setParameter(e,t){this._parameters[e]=t}_removeParameter(e){delete this._parameters[e]}_getHeader(e){var t;return null!=(t=this._headers[e])?t:null}_setHeader(e,t){this._headers[e]=t}_removeHeader(e){delete this._headers[e]}_setIsPriority(e){e?this._headers[L._eventPriorityHeader]=L._eventPriorityHeaderImmFlag:delete this._headers[L._eventPriorityHeader]}_getJitterMillis(){var e;return null!=(e=this.jitterMillis)?e:null}_setJitterMillis(e){this.jitterMillis=e}get _url(){try{let e=new URL(this._requestUrl);return Object.keys(this._parameters).length&&Object.entries(this._parameters).forEach((([t,s])=>{e.searchParams.append(t,s)})),De.Ok(e)}catch(e){return De.Err(Oe(this._requestUrl))}}get _requestOptions(){const e=this._url;return e.isErr()?e:De.Ok([e.unwrap(),{method:this._method,headers:this._headers,body:this._data?JSON.stringify(this._data):void 0,keepalive:!0}])}_perform(){return w(this,null,(function*(){return new Promise((e=>{let t,s=0;const i=()=>`(${this._id}-${s})`,r=()=>{t=new Date,s+=1,this._logger.verbose(`${i()} Opening ${this._requestUrl}`)},n=()=>{const e=((new Date).getTime()-t.getTime())/1e3;this._logger.verbose(`${i()} Closed (${e.toFixed(4)}) ${this._requestUrl}`)},o=()=>!(s>=L._eventMaxSendAttempts)&&(n(),setTimeout((()=>a()),.2*s),!0),a=()=>w(this,null,(function*(){r();try{const[s,r]=this._requestOptions.unwrap();this.jitterMillis&&(yield function(e){return w(this,null,(function*(){return new Promise((t=>setTimeout(t,e)))}))}(this.jitterMillis));const a=yield fetch(s,r);if(!a.ok&&o())return;if(204===a.status)return n(),void e(De.Ok({response:a}));const l=yield a.text();if(!l)return n(),void e(De.Err(Ne()));try{n(),e(De.Ok({data:JSON.parse(l),response:a}))}catch(t){this._logger.warn(`${i()} Unable to decode response: ${l}`),e(De.Err(Ce(l,B(t))))}}catch(s){if(!o()){n();const t=B(s);e(De.Err(ke(t)))}}}));a()}))}))}}var Re=(e=>(e.GET="GET",e.POST="POST",e))(Re||{});const Ae=e=>{const t="number"==typeof e?new Date(e):e,s=new Date;return t.getTime()-s.getTime()};class Le{constructor(e,t,s){v(this,"logger"),v(this,"cached",null),this.domainKey=e,this.settingsStore=t,this.logger=null!=s?s:ee._getInstance("DomainConfigProvider")}_get(){return w(this,null,(function*(){const e=yield this._getFromCache();return e?(this.logger.verbose("Hydrated from cache"),De.Ok(e)):this._getFromRemote()}))}get _injectedDomainConfig(){return fe._injectedDomainConfig}_getFromCache(){return w(this,null,(function*(){const e=yield this.settingsStore._getDomainConfig();if(e){const t=1e3*fe._pnDomainConfigCacheTtlSeconds-Math.abs(Ae(e.ts));if(t>0)return this.logger.verbose(`${(t/1e3).toFixed(2)}s until next fetch from remote`),this.cached=e,e.value}return null}))}_getCachedSync(){if(this._injectedDomainConfig)return this._injectedDomainConfig;if(this.cached){if(1e3*fe._pnPromptsCacheTtlSeconds-Math.abs(Ae(this.cached.ts))>0)return this.cached.value;this.cached=null}return null}_getFromRemote(){return w(this,null,(function*(){let e=this._injectedDomainConfig;if(e)this.logger.debug("Using injected domain settings");else{const t=`${fe._cdnDomainSettingsUrl}/${this.domainKey}/web/config`,s=new Te(Re.GET,t),i=yield s._perform();if(i.isErr())return i;const r=i.unwrap().data;if(!r)return De.Err(new G(W.DOMAIN_CONFIGURATION_LOAD_FAILED));e=le(r),this.logger.verbose("Hydrated from remote")}return yield this.settingsStore._setDomainConfig(e).catch((e=>this.logger.error(e))),this.settingsStore._getDomainConfig().then((e=>this.cached=e)),De.Ok(e)}))}}var Me=(e=>(e.VAPID="VAPID",e.APNS="APNS",e))(Me||{});let Ue=class e{static get _scope(){return this._isInSourcelessIFrame?top:this._isInWorkerGlobalScope?self:window}static get _location(){return this._scope.location}static get _navigator(){return this._scope.navigator}static get _document(){return this._scope.document}static get _isInWorkerGlobalScope(){return self&&"WorkerGlobalScope"in self}static get _isInSourcelessIFrame(){return!this._isInWorkerGlobalScope&&window&&"object"==typeof window&&!!top&&top!==window.self&&!!window.frameElement&&"about:blank"===window.frameElement.src}static get _devicePlacement(){let e;if(this._navigator.userAgentData)e=this._navigator.userAgentData.mobile?"mobile":"desktop";else try{e=this._scope.matchMedia("only screen and (max-device-width: 768px)").matches?"mobile":"desktop"}catch(t){e=[/Android/i,/webOS/i,/iPhone|iPad|iPod/i,/Blackberry/i,/Windows Phone/i].some((e=>e.test(this._navigator.userAgent)))?"mobile":"desktop"}return e}static get _isSafari(){const t=this._navigator,s="safari"in e._scope&&!t.userAgent.match(/crios/i)&&!t.userAgent.match(/fxios/i)&&!t.userAgent.match(/Opera|OPT\//),i="vendor"in t?!!t.vendor.match(/apple/i):"userAgentData"in t&&/macos/i.test(navigator.userAgentData.platform);return s&&i}static get _requires2Step(){if(this._isSafari)return!0;if(!navigator.userAgentData)return!0;for(const e of navigator.userAgentData.brands){if(/firefox/i.test(e.brand))return!0;if("Microsoft Edge"===e.brand)return!0}return!1}static get _isPushManagerInScope(){return"PushManager"in this._scope}static get _pushProvider(){return this._isInWorkerGlobalScope||!this._isSafari||this._isPushManagerInScope?Me.VAPID:Me.APNS}static get _isLocal(){return"localhost"===this._location.hostname||"127.0.0.1"===this._location.hostname}static get _isHttps(){return"https:"===this._location.protocol}static get _isArrayFullySupported(){return"Array"in this._scope&&"from"in Array&&"some"in[]}static _getIsUserAgentSupported(){try{if(!("userAgent"in this._navigator))return[!1,"self.userAgent not accessible"];const e=/bot|spider|crawl|xwarler|disqus|hatena|okhttp|headless|flipboard|linkcheck|coccoc|kddi|ichiro|libwww|wget|apache-http|miniflux|digg|bingpreview|sleuth|pcore|pingdom|snacktory|ning|opengraph|woorank|validator|python|steamchat|whatsapp|slurp|feedbin|appengine|php-curl|meta(insp|-ext)|internet-measure|gb\.gy|findlinks|heritrix|ec2link|facebook(ext|cat)|analyzer|ichigo|europarchive|curl|tiny\stiny|feedfetch|mediapartner|google(other|-(inspect|ext)|\sfav)/im;if(e.test(this._navigator.userAgent))return[!1,"self.navigator.userAgent is recognizedBot"];if("appVersion"in this._navigator&&e.test(this._navigator.appVersion))return[!1,"self.navigator.appVersion is recognizedBot"];if("appCodeName"in this._navigator&&e.test(this._navigator.appCodeName))return[!1,"self.navigator.appCodeName is recognizedBot"];if("product"in this._navigator&&e.test(this._navigator.product))return[!1,"self.navigator.product is recognizedBot"];if("vendor"in this._navigator&&e.test(this._navigator.vendor))return[!1,"self.navigator.vendor is recognizedBot"];return/fb(ios|an)|instagram|twitter|pinterest|micromessenger/i.test(this._navigator.userAgent)?[!1,"self.navigator.userAgent is not supported"]:[!0]}catch(e){return[!1,B(e).message]}}static _getIsEnvBaseSupported(){try{if(!this._isLocal&&!this._isHttps)return[!1,"self.location.protocol is not secure context (http:)"];if(!("location"in this._scope))return[!1,"self.location not accessible"];if(!("navigator"in this._scope))return[!1,"self.navigator not accessible"];if(!("Notification"in this._scope))return[!1,"self.Notification not accessible"];if(!this._isArrayFullySupported)return[!1,"required Array functionality not accessible"];if(!this._location.host)return[!1,"self.location.host is undefined"];if(!this._location.hostname)return[!1,"self.location.hostname is undefined"];try{if(!this._location.hostname.split("").length)return[!1,"self.location.hostname is empty"]}catch(e){return[!1,"self.location.hostname is not a valid String"]}const[t,s]=this._getIsUserAgentSupported();if(!t)return[!1,s];if(!this._isPushManagerInScope){const e=/iphone|ipad/i;return e.test(this._navigator.userAgent)?[!1,"self.navigator.userAgent is iDevice"]:"platform"in this._navigator&&e.test(this._navigator.platform)?[!1,"self.navigator.platform is iDevice"]:[!1,"self.PushManager is not accessible"]}if(!("PushSubscription"in this._scope))return[!1,"self.PushSubscription is not accessible"];const i=this._scope.PushSubscription;if(!(null==i?void 0:i.prototype.hasOwnProperty("getKey")))return[!1,"self.PushSubscription.prototype.getKey is not accessible"];if(!("ServiceWorker"in this._scope))return[!1,"self.ServiceWorker is not accessible"];if(!("serviceWorker"in this._navigator))return[!1,"self.navigator.serviceWorker is not accessible"];if(!("ServiceWorkerRegistration"in this._scope))return[!1,"self.ServiceWorkerRegistration is not accessible"];const r=this._scope.ServiceWorkerRegistration;if(!(null==r?void 0:r.prototype.hasOwnProperty("showNotification")))return[!1,"self.ServiceWorkerRegistration.prototype.showNotification is not accessible"]}catch(t){return[!1,B(t).message]}return[!0]}};function xe(e){var t,s;const i=null!=(t=e.whitelist_domains)?t:[],r=null!=(s=e.sdk_event_only_domains)?s:[],n=e.flags.includes(L._sdkHasEventsOnlyDomainsFlag),o=i.some($e),a=r.some($e);return n&&o&&a}function $e(e){const t=Ue._location,s=`${t.protocol}//${t.hostname}`,i=`${t.protocol}//${t.host}`,r=t.href;/^\*/.test(e)&&(e=`.${e}`);const n=new RegExp(`^(http[s]?://)?${e}$`,"i");return n.test(s)||n.test(i)||n.test(r)}class Ke extends Ue{static get _isDevMode(){return"development"===L._env}static _getIsWebPushSupported(){return w(this,null,(function*(){try{const[t,s]=this._getIsEnvBaseSupported();if(!t)return[!1,s];if(this._pushProvider===Me.APNS)return[!1,"APNS subscriptions are not supported"];if(!this._navigator.cookieEnabled)return[!1,"self.navigator.cookieEnabled is FALSE"];try{yield this._navigator.serviceWorker.getRegistration()}catch(e){return[!1,"call to self.navigator.serviceWorker.getRegistration() failed"]}}catch(e){return[!1,B(e).message]}return[!0]}))}static get _isSafariPushCapable(){return this._isSafari&&"object"==typeof this._scope.safari&&"object"==typeof this._scope.safari.pushNotification}static isAnimationApiSupported(){try{return!!this._document.getAnimations()&&!!this._scope.navigator.userAgentData}catch(e){return!1}}}class We{constructor(e,t,s){this.delegate=e,this.domain=t,this.logger=s}static get _defaultPermissions(){return{permission:"default",token:null}}}class Fe extends We{constructor(e,t,s,i){super(t,s,null!=i?i:ee._getInstance("WebPushRegistrationService")),this.workerService=e}get _permissionsApi(){return Ke._navigator.permissions}get _notificationApi(){return Ke._scope.Notification}_getToken(){return w(this,null,(function*(){return(yield this._getCurrentPermissions()).token}))}_getCurrentPermissions(){return w(this,null,(function*(){let e=We._defaultPermissions;try{const t=yield this._permissionsApi.query({name:"notifications"});e.permission="prompt"===t.state?"default":t.state}catch(t){this._notificationApi&&(e.permission=this._notificationApi.permission)}if("granted"===e.permission)try{const t=yield this.workerService._getSubscription();t&&(e.token=t.toJSON())}catch(s){this.logger.warn("Unable to read current subscription.",B(s).message)}return e}))}_requestNotificationPermission(){return w(this,null,(function*(){const e=yield this._getCurrentPermissions();if("denied"===e.permission||"granted"===e.permission&&e.token)return this.logger.debug(`Permissions already ${e.permission}`),e;"granted"===e.permission&&this.logger.info("Subscription not found. Attempting to resubscribe.");try{return this._requestWebPushPermissions()}catch(t){return this.logger.debug("RNP",t),this._getCurrentPermissions()}}))}_requestWebPushPermissions(){return w(this,null,(function*(){var e,t;const s=yield this._getCurrentPermissions();switch("default"===s.permission&&(null==(t=null==(e=this.delegate)?void 0:e._onPushPermissionRequested)||t.call(e),this.logger.info("Requesting permission")),s.permission=yield this._notificationApi.requestPermission(),s.permission){case"granted":yield this._handlePermissionGranted();break;case"denied":yield this._handlePermissionDenied();break;case"default":yield this._handlePermissionDismissed()}return s}))}_handlePermissionGranted(){return w(this,null,(function*(){var e,t,s,i,r,n;this.logger.verbose("Handling permission granted status"),null==(t=null==(e=this.delegate)?void 0:e._onPushPermissionGranted)||t.call(e);const o=yield this.workerService._subscribe();if(o.isOk())null==(i=null==(s=this.delegate)?void 0:s._onPushSubscriptionSucceeded)||i.call(s,o.unwrap().toJSON());else{const e=o.getErr();this.logger.error("Unable to perform subscription",e),null==(n=null==(r=this.delegate)?void 0:r._onPushSubscriptionFailed)||n.call(r,e)}}))}_handlePermissionDenied(){return w(this,null,(function*(){var e,t;null==(t=null==(e=this.delegate)?void 0:e._onPushPermissionDenied)||t.call(e)}))}_handlePermissionDismissed(){return w(this,null,(function*(){var e,t;null==(t=null==(e=this.delegate)?void 0:e._onPushPermissionDismissed)||t.call(e)}))}}var Be=(e=>(e.GRANTED="granted",e.DENIED="denied",e.DISMISSED="dismissed",e))(Be||{}),Ve=(e=>(e.WEB_PUSH_UNSUPPORTED="web_push_unsupported",e.HOST_NOT_WHITELISTED="host_not_whitelisted",e.SW_INSTALL_FAILED="sw_install_failed",e.PROMPTS_LOAD_FAILED="load_failed",e.NO_ELIGIBLE_PROMPTS="no_eligible_prompts",e.USER_PERMISSION_DENIED="user_permission_denied",e.USER_PERMISSION_DISMISSED="user_permission_dismissed",e.USER_PERMISSION_GRANTED="user_permission_granted",e.PROMPT_INELIGIBLE_FCAP="prompt_ineligible_fcap",e.USER_DELETED="user_deleted",e))(Ve||{});class Ge{constructor(e,t,s,i,r,n,o){v(this,"registrationService"),v(this,"additionalEventData",{}),v(this,"logger"),this.domain=e,this.workerService=t,this.eventManager=s,this.userStore=i,this.lifecycleCallbacks=r,this.delegate=n,this.logger=null!=o?o:ee._getInstance("NotificationPermissionService"),this.registrationService=new Fe(this.workerService,this,this.domain)}static _getWebPushSupport(){return w(this,null,(function*(){const[e,t]=yield Ke._getIsWebPushSupported();return e?De.Ok(!0):De.Err(new G(W.WEB_PUSH_NOT_SUPPORTED,null,t))}))}get _provider(){return Ke._pushProvider}get _currentHref(){return Ke._location.href}_init(){return w(this,null,(function*(){return this.domain.vapid_public_key?De.Ok(!0):De.Err(new G(W.WEB_PUSH_CONFIGURATION_MISSING))}))}_getCurrentPermissions(){return w(this,null,(function*(){const e=yield this.registrationService._getCurrentPermissions();return E({provider:this._provider},e)}))}_synchronize(){return w(this,null,(function*(){var e,t;if(xe(this.domain))return this.logger.debug("[Event Only Mode] Skipping notification permission check"),null;if((yield Ge._getWebPushSupport()).isErr())return this.logger.warn("Permission synchronization failed - WebPush is not supported"),null;this._provider===Me.VAPID&&(yield this.workerService._ready(200)),this.logger.debug("Checking current notification permissions");const s=yield this._getCurrentPermissions(),i=yield this.userStore._getSubscriberStatus();if(s.token&&(_e._token=s.token),"default"===s.permission&&i===ge.NOT_DETERMINED||"granted"===s.permission&&i===ge.SUBSCRIBED&&s.token||"denied"===s.permission&&i===ge.DENIED)this.logger.info("Current notification permissions:",Se(i));else if("denied"===s.permission&&i===ge.DISMISSED||"denied"===s.permission&&i===ge.NOT_DETERMINED)this.logger.debug("Updating subscriber status to",Se(ge.DENIED)),yield this.userStore._setSubscriberStatus(ge.DENIED);else if("granted"===s.permission&&i===ge.DENIED||"granted"===s.permission&&i===ge.DISMISSED||"granted"===s.permission&&i===ge.NOT_DETERMINED||"granted"===s.permission&&!s.token){this.logger.verbose(`Granted permissions mismatch found - current: ${s.permission}, cached: ${Se(i)}`);const e=yield this._attemptSilentSubscription();i!==ge.SUBSCRIBED&&e&&(this.logger.debug("Updating subscriber status to",Se(ge.SUBSCRIBED)),yield this.userStore._setSubscriberStatus(ge.SUBSCRIBED))}else"default"===s.permission&&i===ge.DISMISSED?this.logger.info(`User has recently ${Se(ge.DISMISSED)} permissions`):"default"===s.permission&&i===ge.DENIED?(this.logger.debug("Updating subscriber status to",Se(ge.NOT_DETERMINED)),yield this.userStore._setSubscriberStatus(ge.NOT_DETERMINED)):"denied"===s.permission&&i===ge.SUBSCRIBED?(yield this.userStore._setSubscriberStatus(ge.DENIED),yield this._revokePermission()):"default"===s.permission&&i===ge.SUBSCRIBED?(this.logger.debug("Updating subscriber status to",Se(ge.NOT_DETERMINED)),yield this.userStore._setSubscriberStatus(ge.NOT_DETERMINED),yield this._revokePermission()):this.logger.warn("Unhandled permission and subscription status combination:",{provider:s.provider,permission:s.permission,token:s.token,subscriptionStatus:i});const r=yield this._getCurrentPermissions();return"granted"!==r.permission?_e._token=null:r.token?(_e._token=r.token,this.logger.info("Current token:",r.token)):this.logger.warn("Unable to resolve current token"),r.permission===s.permission&&r.token===s.token||null==(t=null==(e=this.delegate)?void 0:e._onPermissionChanged)||t.call(e,r,s),r}))}_requestPermission(){return w(this,null,(function*(){var e,t,s;const i=yield this._getCurrentPermissions();if("denied"===i.permission)return this.logger.info("Permission already denied"),i;if("granted"===i.permission)return this.logger.info("Permission already granted"),i;const r=yield null==(e=this.registrationService)?void 0:e._requestNotificationPermission(),n=f(E({},r),{provider:this._provider});return n.permission===i.permission&&n.token===i.token||null==(s=null==(t=this.delegate)?void 0:t._onPermissionChanged)||s.call(t,n,i),n}))}_revokePermission(){return w(this,null,(function*(){(yield this.workerService._unsubscribe())&&this.eventManager._track(re.MANUAL_UNSUBSCRIBED)}))}_attemptSilentSubscription(){return w(this,null,(function*(){this.logger.verbose("Attempting silent subscription");const e=yield this.workerService._subscribe();if(e.isErr())return this.logger.warn(e.getErr()),this.eventManager._track(e.getErr()),!1;let t=null;return e.isOk()&&(t=e.unwrap().toJSON()),t?(this.logger.debug("Silent subscription succeeded:",t),_e._token=t,this.eventManager._track(yield this._getBaseSubscriptionEvent()),!0):(this.logger.debug("Silent subscription failed"),!1)}))}_getIsEligibleToPrompt(){return w(this,null,(function*(){const e=yield this.userStore._getIsInDeletedState(),t=yield this.userStore._getIsSubscribed(),s=yield this.userStore._getIsUserInSoftUnsubscribedState(),i=yield this.userStore._getSubscriberStatus();return e?De.Err(Ve.USER_DELETED):t?De.Err(Ve.USER_PERMISSION_GRANTED):s||i===ge.DENIED?De.Err(Ve.USER_PERMISSION_DENIED):i===ge.DISMISSED?De.Err(Ve.USER_PERMISSION_DISMISSED):De.Ok(!0)}))}_setAdditionalPermissionEventData(e){this.additionalEventData=e}_onPushPermissionRequested(){return w(this,null,(function*(){var e,t;this.eventManager._track(re.PERMISSION_SHOWN,E({},this.additionalEventData)),null==(t=null==(e=this.lifecycleCallbacks)?void 0:e.onPushSDKDidRequestNotificationPermissions)||t.call(e)}))}_onPushPermissionDenied(){return w(this,null,(function*(){var e,t;yield this.userStore._setSubscriberStatus(ge.DENIED),null==(t=null==(e=this.lifecycleCallbacks)?void 0:e.onPushSDKDidReceivePermissionResponse)||t.call(e,Be.DENIED),this.eventManager._track(re.PERMISSION_DENIED,E({},this.additionalEventData))}))}_onPushPermissionDismissed(){return w(this,null,(function*(){var e,t;yield this.userStore._setSubscriberStatus(ge.DISMISSED),null==(t=null==(e=this.lifecycleCallbacks)?void 0:e.onPushSDKDidReceivePermissionResponse)||t.call(e,Be.DISMISSED),this.eventManager._track(re.PERMISSION_DISMISSED,E({},this.additionalEventData))}))}_onPushPermissionGranted(){return w(this,null,(function*(){var e,t;yield this.userStore._setSubscriberStatus(ge.SUBSCRIBED),null==(t=null==(e=this.lifecycleCallbacks)?void 0:e.onPushSDKDidReceivePermissionResponse)||t.call(e,Be.GRANTED),this.eventManager._track(re.PERMISSION_ACCEPTED,E({},this.additionalEventData))}))}_onPushSubscriptionSucceeded(e){return w(this,null,(function*(){var t,s;_e._token=e,null==(s=null==(t=this.lifecycleCallbacks)?void 0:t.onPushSDKDidRegisterForRemoteNotificationsWithDeviceToken)||s.call(t,e);const i=yield this._getBaseSubscriptionEvent();i.data=E(E({},this.additionalEventData),i.data),this.eventManager._track(i)}))}_getBaseSubscriptionEvent(){return w(this,null,(function*(){return _e._build(re.TOKEN_RECEIVED,{[fe._tevDataPageUrlKey]:this._currentHref,[fe._tevSubscribedUrlKey]:this._currentHref})}))}_onPushSubscriptionFailed(e){return w(this,null,(function*(){var t,s;_e._token=null,this.logger.info(`event:${re.ERROR}`,e),null==(s=null==(t=this.lifecycleCallbacks)?void 0:t.onPushSDKDidFailToRegisterForRemoteNotificationsWithError)||s.call(t,new G(W.WEB_PUSH_SUBSCRIPTION_FAILED,e)),e&&this.eventManager._track(e)}))}}const He=e=>{let t="";try{if(t=window.atob(e),"string"==typeof t)return t}catch(a){}t="";const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(e=String(e).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(e))throw new TypeError("Failed to execute 'atob' on 'Window': The string to be decoded is not correctly encoded.");e+="==".slice(2-(3&e.length));let i,r,n,o=0;for(;o<e.length;)i=s.indexOf(e.charAt(o++))<<18|s.indexOf(e.charAt(o++))<<12|(r=s.indexOf(e.charAt(o++)))<<6|(n=s.indexOf(e.charAt(o++))),t+=64===r?String.fromCharCode(i>>16&255):64===n?String.fromCharCode(i>>16&255,i>>8&255):String.fromCharCode(i>>16&255,i>>8&255,255&i);return t},je=e=>{const t=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),s=He(t),i=new Uint8Array(s.length);for(let r=0;r<s.length;++r)i[r]=s.charCodeAt(r);return i},Qe=e=>{let t;try{"TextEncoder"in self&&"function"==typeof self.TextEncoder&&"encode"in self.TextEncoder.prototype?(s=(new self.TextEncoder).encode(e),t=window.btoa(String.fromCharCode.apply(null,Array.from(new Uint8Array(s)))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")):(t=window.btoa(e),"string"!=typeof t&&(t=void 0))}catch(i){console.warn("Unable to encode base64 string",i)}var s;return null!=t?t:e};function Ye(e,t){return Promise.race(["function"==typeof t?t():Promise.resolve(t),new Promise((t=>{setTimeout((()=>t()),e)}))])}var qe=(e=>(e[e.ERROR=1]="ERROR",e))(qe||{});const ze=class{static _setEventManager(e){this.eventManager=e}static _dispatch(e,t){try{if(!this.eventManager)return void this.logger.verbose("Received",t);if(1===e)this.logger.verbose("Received",t)}catch(s){this.logger.warn(B(s))}}};v(ze,"eventManager"),v(ze,"logger"),ze.logger=ee._getInstance("Dispatch"),v(ze,"EventType",qe);let Xe=ze;const Ze=(e,t=!1)=>{const s=e?B(e):void 0;return G._from(s,null,W.PUSH_WORKER_REGISTRATION_EXCEPTION,t)},Je=e=>{const t=e?B(e):void 0;return G._from(t,null,W.PUSH_WORKER_NOT_FOUND_EXCEPTION)},et=(e,t=!1)=>{const s=e?B(e):void 0;return G._from(s,null,W.PUSH_WORKER_SUBSCRIPTION_EXCEPTION,t)};class tt{constructor(e,t,s){v(this,"logger"),this.pushSdkConfig=e,this.domain=t,this.logger=null!=s?s:ee._getInstance("PushWorkerService")}get _worker(){return Ke._navigator.serviceWorker}get _location(){return Ke._location}_ready(e){return w(this,null,(function*(){return Ye(null!=e?e:50,this._worker.ready)}))}_getRegistration(){return w(this,null,(function*(){var e;try{const t=yield this._worker.getRegistrations();if(!t||!t.length)return null;let s=null;const[i,r]=this._getRegistrationOptions();for(let n of t){yield this._ready(50);const t=(null==(e=n.active)?void 0:e.scriptURL)||"",o=e=>e.replace(/\/+$/,""),a=o(n.scope)===(r.scope?o(r.scope):void 0),l=t.includes(i.split("?")[0]),u=this.domain.flags.includes(fe._swShouldUnregisterNonPushlyWorkersFlag);if(a&&l){if(s=n,!u)break}else if(a||!u){if(a&&!l&&!this.domain.flags.includes(fe._swShouldReplaceExistingWorkerInPushlyScopeFlag)){this.logger.warn(`Implementation Error. An existing, non-push, service worker was found at scope: ${r.scope}.`);break}}else yield n.unregister(),this.logger.info(`Removed worker ${t} at scope ${n.scope}`)}return s}catch(t){const e=B(t);Xe._dispatch(Xe.EventType.ERROR,e),this.logger.error(e)}return null}))}_register(){return w(this,null,(function*(){let e=yield this._getRegistration();if(e)return e;const[t,s]=this._getRegistrationOptions();this.logger.info(`Installing new registration: ${t}`);try{e=yield this._worker.register(t,s)}catch(i){throw yield this._sanitizeRegistrationError(B(i),t)}return yield Ye(500,(()=>w(this,null,(function*(){const t=new Date,s=()=>new Promise((i=>{if(null==e?void 0:e.active)return this.logger.verbose("New registration is ready",((new Date).getTime()-t.getTime())/1e3+"s"),i();setTimeout(s,10)}));return s()})))),e}))}_getSubscription(){return w(this,null,(function*(){const e=yield this._getRegistration();if(!e)return null;try{return e.pushManager.getSubscription()}catch(t){const e=B(t);Xe._dispatch(Xe.EventType.ERROR,e),this.logger.error(e)}return null}))}_subscribe(){return w(this,null,(function*(){const e=yield this._getSubscription();if(e)return this.logger.debug("Existing subscription found"),De.Ok(e);let t=yield this._getRegistration();if(!t)try{t=yield this._register()}catch(s){return De.Err(Ze(s))}this.logger.info("Subscribing");try{const e=yield t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:je(this.domain.vapid_public_key)});return De.Ok(e)}catch(s){return De.Err(this._sanitizeSubscriptionError(B(s)))}}))}_unsubscribe(){return w(this,null,(function*(){try{const e=yield this._getSubscription();if(e)return yield e.unsubscribe(),!0}catch(e){const t=B(e);Xe._dispatch(Xe.EventType.ERROR,t),this.logger.error(t.message)}return!1}))}_getRegistrationOptions(){const e=this._location,t=`${e.protocol}//${e.hostname}${e.port?`:${e.port}`:""}`,s=this.pushSdkConfig.sw,i=this.pushSdkConfig.swScope,r=e=>e.replace(/^https?:\/\/[^/]+/i,"").replace(/^\//,"");let n=s?r(s):null;n&&!n.includes(t)&&(n=`/${n}`);let o=i?r(i):null;o&&!o.includes(t)&&(o=`/${o}`);let a=n||"/pushly-sdk-worker.js";const l=a.substr(0,a.lastIndexOf("/")+1)||"/",u=this.domain.flags.includes(fe._swUseRootScopeFlag);let c=l;o?c=o:u&&(c="/");let d=c.includes(t)?c:`${t.replace(/\/$/,"")}${c}`;d=`${d.replace(/\/$/,"")}/`;return!this.domain.flags.includes(fe._swUsePathWithoutDomainKeyFlag)&&(a=`${a}${a.includes("?")?"&":"?"}domain_key=${this.pushSdkConfig.domainKey}`),[a,{updateViaCache:"none",scope:d}]}_tryFetchResourceStatus(e){return w(this,null,(function*(){try{return(yield fetch(e)).status}catch(t){return 0}}))}_sanitizeRegistrationError(e,t){return w(this,null,(function*(){if(G.KNOWN_NAMES.includes(e.name)||[/SSL certificate/i,/Failed to access storage/i,/Operation has been aborted/i,/unknown error occurred when fetching the script/i,/403/].some((t=>t.test(e.message))))return Ze(e,!0);if(/404/.test(e.message)||404===(yield this._tryFetchResourceStatus(t)))throw Je(e);return Ze(e)}))}_sanitizeSubscriptionError(e){const t=G.KNOWN_NAMES.includes(e.name)||[/push service error/i,/could not retrieve the public key/i].some((t=>t.test(e.message)));return et(e,t)}}class st{constructor(e,t,s){v(this,"_task"),v(this,"_intervalSeconds"),v(this,"_options"),v(this,"_timer"),v(this,"_isStarted"),v(this,"_isPaused"),v(this,"_runtimeMilliseconds"),v(this,"_delayStartMilliseconds"),v(this,"_timerDidIncrementListeners"),this._task=e,this._intervalSeconds=null!=t?t:1,this._options=null!=s?s:{},this._timer=null,this._isStarted=!1,this._isPaused=!1,this._runtimeMilliseconds=0,this._timerDidIncrementListeners=new Set,this._delayStartMilliseconds=this._options.delayStartSeconds?1e3*this._options.delayStartSeconds:0,!1!==(null==s?void 0:s.autoStart)&&this._start()}get repeats(){var e;return!1!==(null==(e=this._options)?void 0:e.repeats)}get runtimeSeconds(){return Math.floor(this._runtimeMilliseconds/1e3)}get isStarted(){return this._isStarted}get isPaused(){return this._isPaused}_addTimerDidIncrementListener(e){this._timerDidIncrementListeners.add(e)}_removeTimerDidIncrementListener(e){this._timerDidIncrementListeners.delete(e)}_start(){this.isStarted||(this._isStarted=!0,this._timer&&clearTimeout(this._timer),this._run())}_stop(){this.isStarted&&(this._isStarted=!1,this._timer&&clearTimeout(this._timer),this._timer=null)}_pause(){this.isStarted&&!this.isPaused&&(this._timer&&(clearTimeout(this._timer),this._isPaused=!0),this._timer=null)}_unpause(){this.isStarted&&this.isPaused&&(this._isPaused=!1,this._run())}_run(){const e=(t=250)=>{this.isPaused||(this._timer=setTimeout((()=>{this._runtimeMilliseconds+=t;this._runtimeMilliseconds%(1e3*this._intervalSeconds)==0&&this._runtimeMilliseconds>this._delayStartMilliseconds&&(this._timerDidIncrementListeners.forEach((e=>e.onIncrement(this.runtimeSeconds))),"function"==typeof this._task?this._task(this):this._task._run(this),!this.repeats)?this._stop():e()}),t))};e()}}const it=class e{constructor(e,t,s,i,r){v(this,"previousSubscriberState",null),this.domainConfig=e,this.eventManager=t,this.userStore=s,this.sessionStore=i,this.logger=r,this.evaluateInitialSubscriberStatus()}static _init(t,s,i,r,n){return null!=n||(n=ee._getInstance("PageViewProcessor")),new st(new e(t,s,i,r,n),this.PAGE_VIEW_INTERVAL_SECONDS,{autoStart:!1})}evaluateInitialSubscriberStatus(){return w(this,null,(function*(){const e=yield this.userStore._getSubscriberStatus();null!=this.previousSubscriberState||(this.previousSubscriberState=e)}))}_run(){return w(this,null,(function*(){try{const e=this._currentLocation.href,t=yield this.userStore._getLastPageViewed(),s=yield this.userStore._getSubscriberStatus(),i=s!==this.previousSubscriberState&&s===ge.SUBSCRIBED;this.previousSubscriberState=s,t&&t===e&&!i||(i||(yield this.userStore._setLastPageViewed(e),this.logger.verbose("Incrementing page views"),yield this.sessionStore._incrementSessionPageViewCount()),s===ge.SUBSCRIBED?(this.logger.verbose("Preparing page view event"),yield this._track(re.VIEW_PAGE,e)):this.domainConfig.flags.includes(fe._domainFeatInformedContentFlag)?(this.logger.verbose("Preparing anonymous page view event"),yield this._track(re.ANONYMOUS_VIEW_PAGE,e)):this.logger.debug("Page View tracking is not enabled"))}catch(e){const t=B(e);this.eventManager._track(t),this.logger.warn(t)}}))}get _currentLocation(){return Ue._location}_track(e,t){return w(this,null,(function*(){const s={[fe._tevDataPageUrlKey]:t};this.eventManager._track(e,s)}))}};v(it,"PAGE_VIEW_INTERVAL_SECONDS",1);let rt=it;class nt{constructor(e,t,s){v(this,"logger"),v(this,"cached",null),this.domainKey=e,this.settingsStore=t,this.logger=null!=s?s:ee._getInstance("PromptsProvider")}_get(){return w(this,null,(function*(){const e=yield this._getFromCache();return e?(this.logger.verbose("Hydrated from cache"),De.Ok(e)):this._getFromRemote()}))}get _injectedPromptGroups(){return fe._injectedPromptGroups}_getFromCache(){return w(this,null,(function*(){const e=yield this.settingsStore._getCachedPrompts();if(e){const t=1e3*fe._pnPromptsCacheTtlSeconds-Math.abs(Ae(e.ts));if(t>0)return this.logger.verbose(`${(t/1e3).toFixed(2)}s until next fetch from remote`),this.cached=e,e.value;this.cached=null}return null}))}_getCachedSync(){if(this._injectedPromptGroups)return this._injectedPromptGroups;if(this.cached){if(1e3*fe._pnPromptsCacheTtlSeconds-Math.abs(Ae(this.cached.ts))>0)return this.cached.value;this.cached=null}return null}_getFromRemote(){return w(this,null,(function*(){let e=this._injectedPromptGroups;if(e)this.logger.verbose("Using injected prompts");else{const t=`${fe._cdnDomainSettingsUrl}/${this.domainKey}/web/prompts`,s=new Te(Re.GET,t),i=yield s._perform();if(i.isErr())return i;const r=i.unwrap().data;if(!r)return De.Err(new G(W.PROMPTS_LOAD_FAILED));e=r.map((e=>le(e))),this.logger.verbose("Hydrated from remote")}return yield this.settingsStore._setCachedPrompts(e),De.Ok(e)}))}}var ot=(e=>(e.SLIDE="SLIDE",e.PUBLISHER_CUSTOM="PUBLISHER_CUSTOM",e.NATIVE="NATIVE",e))(ot||{}),at=(e=>(e.SECONDS="seconds",e.MINUTES="minutes",e.HOURS="hours",e.DAYS="days",e.MONTHS="months",e))(at||{}),lt=(e=>(e.TOP="top",e.BOTTOM="bottom",e))(lt||{}),ut=(e=>(e.SESSION_START="SESSION_START",e.SESSION_TIME_ON_SITE="SESSION_TIME_ON_SITE",e.SESSION_TIME_ON_PAGE="SESSION_TIME_ON_PAGE",e.SESSION_PAGE_VIEWS="SESSION_PAGE_VIEWS",e))(ut||{});function ct(e){if(e){if("session_page_views"in e.visitor)return{type:"SESSION_PAGE_VIEWS",minPageViews:e.visitor.session_page_views};if("session_time_on_site_seconds"in e.visitor||"time_on_page_seconds"in e.visitor)return{type:"session_time_on_site_seconds"in e.visitor?"SESSION_TIME_ON_SITE":"SESSION_TIME_ON_PAGE",timeInterval:{intervalSeconds:"session_time_on_site_seconds"in e.visitor?e.visitor.session_time_on_site_seconds:e.visitor.time_on_page_seconds,displayMetric:at.SECONDS}}}return{type:"SESSION_START"}}function dt({style:e,behavior:t}){var s;return e!==ot.PUBLISHER_CUSTOM&&(null==(s=t.is_auto_show)||s)}var _t=(e=>(e.CUT="CUT",e.FADE="FADE",e.ZOOM_IN="ZOOM_IN",e.ZOOM_OUT="ZOOM_OUT",e.SLIDE_UP="SLIDE_UP",e.SLIDE_DOWN="SLIDE_DOWN",e.SLIDE_RIGHT="SLIDE_RIGHT",e.SLIDE_LEFT="SLIDE_LEFT",e))(_t||{}),ht=(e=>(e.ENTRY="entry",e.EXIT="exit",e))(ht||{});function gt(e){return`matrix(${e.scaleX}, ${e.skewY}, ${e.skewX}, ${e.scaleY}, ${e.translateX}, ${e.translateY})`}class pt{constructor(e,t){var s;v(this,"currentOrientation"),this.prompt=e,this.logger=t,(null==(s=this._screen)?void 0:s.orientation)&&(this.currentOrientation=this._screen.orientation.type,this._screen.orientation.addEventListener("change",this._onOrientationChange.bind(this)))}static get ANIMATION_PREFIX(){return"pnax"}get _screen(){return"screen"in Ke._scope?Ke._scope.screen:null}get _document(){return Ke._document}get _promptPackageId(){return`push-sdk-prompt-${this.prompt.id}`}get _promptPackageElement(){const e=this._document.getElementById(this._promptPackageId);return e||(this.logger.error("Unable to find injected prompt element"),null)}get _promptElement(){const e=this._promptPackageElement;if(!e)return null;const t=e.querySelector(".push-sdk-prompt-container");return t||(this.logger.error("Unable to find prompt element"),null)}get _currentAnimationTransformConfig(){const e=this._promptElement,t=e?function(e){const t=e.match(new RegExp("matrix\\((?<scaleX>-?[0-9.]+),\\s?(?<skewY>-?[0-9.]+),\\s?(?<skewX>-?[0-9.]+),\\s?(?<scaleY>-?[0-9.]+),\\s?(?<translateX>-?[0-9.]+),\\s?(?<translateY>-?[0-9.]+)\\)"));try{return{scaleX:parseInt(t.groups.scaleX),scaleY:parseInt(t.groups.scaleY),skewX:parseInt(t.groups.skewX),skewY:parseInt(t.groups.skewY),translateX:parseInt(t.groups.translateX),translateY:parseInt(t.groups.translateY)}}catch(s){return{scaleX:1,scaleY:1,skewX:0,skewY:0,translateX:0,translateY:0}}}(getComputedStyle(e).transform):{scaleX:1,scaleY:1,skewX:0,skewY:0,translateX:0,translateY:0};return{curr:t,start:Object.assign(Object.create(null),t),end:Object.assign(Object.create(null),t)}}get _entryAnimationConfig(){var e,t,s;return null!=(s=null==(t=null==(e=this.prompt.behavior)?void 0:e.display_animations)?void 0:t.enter)?s:{enabled:!0,animations:[_t.FADE],duration_milliseconds:420}}get _exitAnimationConfig(){var e,t,s;return null!=(s=null==(t=null==(e=this.prompt.behavior)?void 0:e.display_animations)?void 0:t.exit)?s:{enabled:!0,animations:[_t.FADE],duration_milliseconds:420}}_generateAnimationId(){return`${pt.ANIMATION_PREFIX}_${this.prompt.id}_${ae(5)}`}_animateIn(e,t){this._applyAnimation(ht.ENTRY,e,t)}_animateOut(e,t){this._applyAnimation(ht.EXIT,e,t)}_onOrientationChange(){var e;if(!(null==(e=this._screen)?void 0:e.orientation))return;const t=this.currentOrientation,s=this._screen.orientation.type;this.currentOrientation=this._screen.orientation.type,this._handleOrientationChange(s,t)}_getAnimationSteps(e,t,s){const i={from:{},to:{}},r=this._currentAnimationTransformConfig,n=new Set;t.animations.includes(_t.FADE)&&(n.add("opacity"),i.from.opacity=e===ht.ENTRY?0:1,i.to.opacity=e===ht.ENTRY?1:0);t.animations.includes(_t.ZOOM_IN)&&(n.add("transform"),e===ht.ENTRY?(r.start.scaleX=0,r.start.scaleY=0):(r.end.scaleX=2,r.end.scaleY=2)),t.animations.includes(_t.ZOOM_OUT)&&(n.add("transform"),e===ht.ENTRY?(r.start.scaleX=2,r.start.scaleY=2):(r.end.scaleX=0,r.end.scaleY=0));const o=s.height/2,a=s.width/2;return t.animations.includes(_t.SLIDE_DOWN)&&(n.add("transform"),e===ht.ENTRY?r.start.translateY-=o:r.end.translateY+=o),t.animations.includes(_t.SLIDE_UP)&&(n.add("transform"),e===ht.ENTRY?r.start.translateY+=o:r.end.translateY-=o),t.animations.includes(_t.SLIDE_RIGHT)&&(n.add("transform"),e===ht.ENTRY?r.start.translateX-=a:r.end.translateX+=a),t.animations.includes(_t.SLIDE_LEFT)&&(n.add("transform"),e===ht.ENTRY?r.start.translateX+=a:r.end.translateX-=a),n.size&&(i.from.willChange=Array.from(n).join(","),i.to.willChange=Array.from(n).join(",")),i.from.transform=gt(r.start),i.to.transform=gt(r.end),i}}class mt extends pt{constructor(e,t){super(e,null!=t?t:ee._getInstance("CSSAnimationCoordinator")),v(this,"lastConfig")}_clearAnimationClassNames(e,t){const s=new RegExp(`^${pt.ANIMATION_PREFIX}_`);Array.from(e.classList).forEach((i=>{i!==t&&s.test(i)&&e.classList.remove(i)}))}_handleOrientationChange(e,t){this._promptElement&&this.lastConfig&&e!==t&&this._clearAnimationClassNames(this._promptElement)}_applyAnimation(e,t,s){const i=this._promptElement;if(!i)return;if("function"==typeof t&&(t=t()),this.lastConfig=t,null!=t||(t=this._exitAnimationConfig),!t.enabled)return void this.logger.debug(`${e} animation disabled for Prompt ${this.prompt.id}`);const r=this._generateAnimationId(),n=this._getAnimationSteps(e,t,i.getBoundingClientRect()),o=this._document.createElement("style");o.id=`${r}_style`,o.setAttribute(`data-${pt.ANIMATION_PREFIX}`,"true"),o.innerText=[[`@keyframes ${r} {`,`from { opacity: ${n.from.opacity}; transform: ${n.from.transform} }`,`to { opacity: ${n.to.opacity}; transform: ${n.to.transform} }`,"}"].join(" "),[`.push-sdk-prompt-container.${r} {`,`animation-name: ${r};`,`animation-duration: ${t.duration_milliseconds/1e3}s;`,"animation-fill-mode: forwards;","}"].join(" ")].join(" "),this._promptPackageElement.prepend(o),i.classList.add(r),this._clearAnimationClassNames(i,r);const a=Array.from(this._promptPackageElement.getElementsByTagName("style"));for(const l of a)l.id!==o.id&&l.dataset[pt.ANIMATION_PREFIX]&&l.remove();i.addEventListener("animationend",(()=>{try{null==s||s()}catch(e){}}))}}class St{constructor(e,t,s,i){v(this,"logger"),v(this,"animationCoordinator"),this.prompt=e,this.group=t,this.delegate=s,this.logger=null!=i?i:ee._getInstance("PromptView"),this.animationCoordinator=new mt(e)}get document(){return Ke._document}get isMobile(){return"mobile"===Ke._devicePlacement}get position(){var e,t;return this.isMobile?null!=(e=this.prompt.theme.position.mobile)?e:lt.TOP:null!=(t=this.prompt.theme.position.desktop)?t:lt.TOP}get promptElementId(){return`push-sdk-prompt-${this.prompt.id}`}get promptElement(){return this.document.getElementById(this.promptElementId)}_display(){if(this.promptElement)return void this.logger.warn(`Prompt ${this.prompt.id} is already displaying`);const e=this.document.createElement("div");if(e.innerHTML=this.prompt.template_html,!e.firstChild)return void this.logger.warn("Invalid Prompt template detected");const t=e.firstChild;Ke._document.body.append(t),this.animationCoordinator._animateIn({enabled:!0,animations:[_t.FADE,this.position===lt.TOP?_t.SLIDE_DOWN:_t.SLIDE_UP],duration_milliseconds:420}),this.logger.verbose(`Displaying Prompt ${this.prompt.id}`),this.delegate._onPromptDidShow(this.prompt)}_hide(){const e=this.promptElement;e?(this.logger.verbose(`Hiding ${this.prompt.id}`),this.delegate._onPromptDidHide(this.prompt),this.animationCoordinator._animateOut({enabled:!0,animations:[_t.FADE,this.position===lt.TOP?_t.SLIDE_UP:_t.SLIDE_DOWN],duration_milliseconds:420},(()=>{e.remove()}))):this.logger.warn(`Prompt ${this.prompt.id} is already hidden`)}}var Et=(e=>(e.ALLOW="allow",e.DISMISS="dismiss",e))(Et||{}),ft=(e=>(e.NOT_AVAILABLE="not_available",e.OTHER_PROMPT_SHOWING="other_prompt_showing",e.ALREADY_SHOWING="already_showing",e.USER_INELIGIBLE="user_eligible",e))(ft||{});const bt=Symbol("lazy_empty_value");function vt(e,t,s){if(!s||void 0===s.get)throw`@lazy ${t} must be a getter`;if(s.set)throw`@lazy ${t} must not have an associated setter`;const i=`_lazy_${t}`,r=s.get;Object.defineProperty(e,i,{enumerable:!1,configurable:!1,writable:!0,value:bt}),s.get=function(){return this[i]===bt&&(this[i]=r.call(this)),this[i]}}var yt=Object.defineProperty,It=Object.getOwnPropertyDescriptor,Pt=(e,t,s,i)=>{for(var r,n=i>1?void 0:i?It(t,s):t,o=e.length-1;o>=0;o--)(r=e[o])&&(n=(i?r(t,s,n):r(n))||n);return i&&n&&yt(t,s,n),n};const Dt="pushly-prompt-visible";class wt{constructor(e,t,s,i,r,n,o,a){v(this,"_promptElements",null),v(this,"logger"),this.prompt=e,this.group=t,this.isEligible=s,this.pushSdkConfig=i,this.userStore=r,this.eventManager=n,this.delegate=o,this.logger=null!=a?a:ee._getInstance("CustomPromptView"),this._locateAndConfigure()}get _document(){return Ke._document}get _defaultElementStub(){return this._document.createElement("div")}get _promptConfig(){let e=!1;const t=()=>{e||(e=!0,this.logger.warn("Custom prompt element has not been configured yet"),setTimeout((()=>{e=!1}),500))},s={actions:{allow:null,dismiss:null}};return Object.defineProperty(s,"element",{get:()=>{var e;return(null==(e=this._promptElements)?void 0:e.element)?this._promptElements.element:(t(),this._defaultElementStub)}}),s}_locateAndConfigure(){let e=null;const t=()=>w(this,null,(function*(){var s,i;try{clearTimeout(e);const r=this._document.getElementsByClassName("pushly-prompt-custom");if(!r.length)return void(e=setTimeout(t,500));const n=r[0],o={element:n,actions:{allow:null!=(s=n.getElementsByClassName("pushly-prompt-buttons-allow")[0])?s:null,dismiss:null!=(i=n.getElementsByClassName("pushly-prompt-buttons-dismiss")[0])?i:null}};o.actions.allow?o.actions.allow.addEventListener("click",this._allow.bind(this)):this.logger.warn("Prompt allow button cannot be located"),o.actions.dismiss?o.actions.dismiss.addEventListener("click",this._dismiss.bind(this)):this.logger.warn("Prompt dismiss button cannot be located"),this._promptElements=o,this.logger.info("Custom prompt located and configured"),this._setSupportedClassName(),yield this._setInitialSubscriptionClassName(),this.isEligible?this._setEligibleClassNames():this._setIneligibleClassNames()}catch(r){const e=B(r);this.logger.warn(e),this.eventManager._track(e)}}));t().then()}get _classNames(){const e=this.pushSdkConfig.classNames||{};return e.webPushUnsupported=e.webPushUnsupported||"pushly-web-push-unsupported",e.webPushSupported=e.webPushSupported||"pushly-web-push-supported",e.subscriptionNone=e.subscriptionNone||"pushly-subscription-none",e.subscriptionSubscribed=e.subscriptionSubscribed||"pushly-subscription-subscribed",e.subscriptionUnsubscribed=e.subscriptionUnsubscribed||"pushly-subscription-unsubscribed",e.subscriptionDenied=e.subscriptionDenied||"pushly-subscription-denied",e.subscriptionDismissed=e.subscriptionDismissed||"pushly-subscription-dismissed",e.promptIneligible=e.promptIneligible||"pushly-prompt-ineligible",e.promptEligible=e.promptEligible||"pushly-prompt-eligible",e}_display(){this.delegate._onPromptDidShow(this.prompt)}_hide(){this.delegate._onPromptDidHide(this.prompt)}_handlePermissionsResponse({permission:e}){switch(e){case"granted":this._setPromptCompositeSubscribedClassNames();break;case"denied":this._setSubscriptionDeniedClassNames();break;case"default":this._setSubscriptionDismissedClassNames()}}_allow(){return w(this,null,(function*(){yield this.delegate._processDispatchMessage({prompt_action:{id:this.prompt.id,type:Et.ALLOW,is_custom_prompt:!0}})}))}_dismiss(){return w(this,null,(function*(){this._setSubscriptionDismissedClassNames(),yield this.delegate._processDispatchMessage({prompt_action:{id:this.prompt.id,type:Et.DISMISS,is_custom_prompt:!0}})}))}_setInitialSubscriptionClassName(){return w(this,null,(function*(){const e=yield this.userStore._getSubscriberStatus();e===ge.DENIED?this._setDeniedClassNames():e===ge.DISMISSED?this._setDismissedClassNames():e===ge.SUBSCRIBED?this._setSubscribedClassNames():this._setNoSubscriptionClassNames()}))}_setPromptCompositeSubscribedClassNames(){this._setIneligibleClassNames(),this._setSubscribedClassNames(),this._promptConfig.element.classList.remove(Dt)}_setSubscriptionDismissedClassNames(){this._setIneligibleClassNames(),this._setDismissedClassNames(),this._promptConfig.element.classList.remove(Dt)}_setSubscriptionDeniedClassNames(){this._setIneligibleClassNames(),this._setDeniedClassNames(),this._promptConfig.element.classList.remove(Dt)}_setUnsupportedClassName(){const{element:e}=this._promptConfig;e.classList.add(this._classNames.webPushUnsupported),e.classList.remove(this._classNames.webPushSupported)}_setSupportedClassName(){const{element:e}=this._promptConfig;e.classList.add(this._classNames.webPushSupported),e.classList.remove(this._classNames.webPushUnsupported)}_setEligibleClassNames(){const{element:e}=this._promptConfig;e.classList.remove(this._classNames.promptIneligible),e.classList.add(this._classNames.promptEligible)}_setIneligibleClassNames(){const{element:e}=this._promptConfig;e.classList.remove(this._classNames.promptEligible),e.classList.add(this._classNames.promptIneligible)}_setNoSubscriptionClassNames(){const{element:e}=this._promptConfig;e.classList.add(this._classNames.subscriptionNone),e.classList.remove(this._classNames.subscriptionSubscribed,this._classNames.subscriptionDismissed,this._classNames.subscriptionDenied,this._classNames.subscriptionUnsubscribed)}_setSubscribedClassNames(){const{element:e}=this._promptConfig;e.classList.add(this._classNames.subscriptionSubscribed),e.classList.remove(this._classNames.subscriptionNone,this._classNames.subscriptionDismissed,this._classNames.subscriptionDenied,this._classNames.subscriptionUnsubscribed)}_setDismissedClassNames(){const{element:e}=this._promptConfig;e.classList.add(this._classNames.subscriptionDismissed),e.classList.remove(this._classNames.subscriptionNone,this._classNames.subscriptionSubscribed,this._classNames.subscriptionDenied,this._classNames.subscriptionUnsubscribed)}_setDeniedClassNames(){const{element:e}=this._promptConfig;e.classList.add(this._classNames.subscriptionDenied),e.classList.remove(this._classNames.subscriptionNone,this._classNames.subscriptionSubscribed,this._classNames.subscriptionDismissed,this._classNames.subscriptionUnsubscribed)}}Pt([vt],wt.prototype,"_document",1),Pt([vt],wt.prototype,"_defaultElementStub",1),Pt([vt],wt.prototype,"_promptConfig",1),Pt([vt],wt.prototype,"_classNames",1);var Ot=Object.defineProperty,Nt=Object.getOwnPropertyDescriptor,Ct=(e,t,s,i)=>{for(var r,n=i>1?void 0:i?Nt(t,s):t,o=e.length-1;o>=0;o--)(r=e[o])&&(n=(i?r(t,s,n):r(n))||n);return i&&n&&Ot(t,s,n),n};class kt{constructor(e,t,s,i,r,n,o,a,l,u,c){v(this,"logger"),v(this,"isDisplayEvaluationReady",!1),v(this,"isPromptLoadingCompleted",!1),v(this,"timeInSessionTimer"),v(this,"promptViewInitializedCallbacks",[]),v(this,"allPrompts",[]),v(this,"matchedPrompt"),v(this,"activeView"),v(this,"lastPageViewed",null),this.pushSdkConfig=e,this.domain=t,this.promptsProvider=s,this.notificationPermissionService=i,this.userStore=r,this.settingsStore=n,this.sessionManager=o,this.eventManager=a,this.debugController=l,this.promptLifecycleCallbacks=u,this.lastPageViewed=this._currentHref,this.timeInSessionTimer=new st(this._handleSessionTimerDidAdvance.bind(this),1),this.logger=null!=c?c:ee._getInstance("PromptsController"),this._load()}_load(){this._loadPrompts()}get _devicePlacement(){return Ke._devicePlacement}get _isTwoStepPromptsRequired(){return Ke._requires2Step}get _currentHref(){return Ke._location.href}get _isReady(){return this.isPromptLoadingCompleted&&this.isDisplayEvaluationReady}setPromptViewInitializedCallbacks(e){this.activeView?e(this.activeView):this.promptViewInitializedCallbacks.push(e)}_setIsWebPushSupported(e){var t;e.isErr()&&this.debugController._debugPromptNotShown(Ve.WEB_PUSH_UNSUPPORTED,null!=(t=e.getErr().details)?t:"unknown"),this.setPromptViewInitializedCallbacks((t=>{t instanceof wt&&(e?t._setSupportedClassName():t._setUnsupportedClassName())}))}_startDisplayEvaluations(){return w(this,null,(function*(){this.isDisplayEvaluationReady=!0,this._isReady&&!this.matchedPrompt&&(yield this._startMatchedPromptSelection()),this.timeInSessionTimer._start()}))}_enable(){this.logger.verbose("Enabling session timer"),this.timeInSessionTimer._unpause()}_disable(){this.logger.verbose("Disabling session timer"),this.timeInSessionTimer._pause()}_loadPrompts(){return w(this,null,(function*(){this.logger.verbose("Loading prompts");const e=yield this.promptsProvider._get();if(e.isErr())return this.logger.warn("No prompts available",e.getErr()),void this.debugController._debugPromptNotShown(Ve.PROMPTS_LOAD_FAILED);const t=e.unwrap();if(!t.length)return this.logger.warn("No prompts available"),void this.debugController._debugPromptNotShown(Ve.NO_ELIGIBLE_PROMPTS);this.allPrompts=t.flatMap((e=>e.prompts.map((t=>({prompt:t,group:e}))))),yield this._handlePromptsLoaded()}))}_handlePromptsLoaded(){return w(this,null,(function*(){this.logger.verbose("Prompts loaded"),this.isPromptLoadingCompleted=!0,this._isReady&&(yield this._startMatchedPromptSelection())}))}_handleSessionTimerDidAdvance(){return w(this,null,(function*(){if(!this._isReady)return;let e=this.matchedPrompt;e||this._currentHref===this.lastPageViewed||(this.lastPageViewed=this._currentHref,yield this._startMatchedPromptSelection(),this._enable()),e&&(!this.activeView&&dt(e.prompt)?yield this._attemptToShowPrompt(e):this._disable())}))}_setLastMatchedPrompt(e){return w(this,null,(function*(){var t;(null==(t=this.matchedPrompt)?void 0:t.prompt.id)!==e.prompt.id&&(this.logger.verbose(`Setting matched Prompt: ${e.prompt.id} (${e.prompt.style})`),this.matchedPrompt=yield this._buildMatchedPrompt(e),this.settingsStore._setLastMatchedPromptId(e.prompt.id).then(),this.notificationPermissionService._setAdditionalPermissionEventData({prompt_id:e.prompt.id}))}))}_clearLastMatchedPrompt(){return w(this,null,(function*(){this.matchedPrompt=void 0,yield this.settingsStore._setLastMatchedPromptId(null)}))}_showPrompt(e,t){return w(this,null,(function*(){var s,i,r,n;let o=null;if(void 0===e)this.logger.verbose("Show prompt invoked"),this.matchedPrompt||(yield this._startMatchedPromptSelection()),o=null!=(s=this.matchedPrompt)?s:null;else if(this.logger.verbose(`Show prompt invoked for ${e}`),(null==(i=this.matchedPrompt)?void 0:i.prompt.id)===e)o=this.matchedPrompt;else{const t=this.allPrompts.find((({prompt:t})=>t.id===e));t&&(o=yield this._buildMatchedPrompt(t))}if(!o)return this.logger.warn(`Prompt${void 0===e?"":` ${e}`} not found`),void(null==(n=null==(r=this.promptLifecycleCallbacks)?void 0:r.onPushSDKFailedToShowPrompt)||n.call(r,null!=e?e:null,ft.NOT_AVAILABLE));const a=yield this._hasMetGlobalAndUserConditions(o.prompt,t);if(o.prompt.style===ot.PUBLISHER_CUSTOM){const e=o.displayCoordinator;a?e._setEligibleClassNames():e._setIneligibleClassNames()}a&&(yield this._attemptToShowPrompt(o))}))}_attemptToShowPrompt(e){return w(this,null,(function*(){(e.prompt.style===ot.PUBLISHER_CUSTOM||(yield this._evaluatePromptConditions(e.prompt)))&&(yield this._showMatchedPrompt(e))}))}_showMatchedPrompt(e){return w(this,null,(function*(){this._disable();const t=e.displayCoordinator?e:yield this._buildMatchedPrompt(e),s=t.displayCoordinator;this.activeView=s,yield this.settingsStore._incrementViewedOccurrencesForPromptId(t.prompt.id),t.prompt.style!==ot.NATIVE?s._display():yield this.notificationPermissionService._requestPermission()}))}_processDispatchMessage(e){return w(this,null,(function*(){var t,s,i,r,n;let o=this.activeView;if(!o&&e.prompt_action.is_custom_prompt&&(null==(t=this.matchedPrompt)?void 0:t.prompt.id)===e.prompt_action.id&&(o=this.matchedPrompt.displayCoordinator),o&&e.prompt_action.id&&e.prompt_action.id===o.prompt.id)switch(o._hide(),e.prompt_action.type){case Et.ALLOW:{this.logger.debug("Received Prompt Allow"),this.eventManager._track(re.PROMPT_ACCEPTED,{prompt_id:e.prompt_action.id}),null==(i=null==(s=this.promptLifecycleCallbacks)?void 0:s.onPushSDKDidReceivePromptResponse)||i.call(s,o.prompt.id,!0);const t=yield this.notificationPermissionService._requestPermission();o instanceof wt&&o._handlePermissionsResponse(t);break}case Et.DISMISS:{this.logger.debug("Received Prompt Dismiss"),this.eventManager._track(re.PROMPT_DISMISSED,{prompt_id:e.prompt_action.id});const t=o.prompt.behavior.post_dismiss_redisplay,s=t.enabled?t.fcap.interval_seconds:fe._defaultDismissedStatusExpirationSeconds;0===s?(this.logger.debug("Setting subscriber status to NOT_DETERMINED"),yield this.userStore._setSubscriberStatus(ge.NOT_DETERMINED)):(this.logger.debug(`Setting subscriber status to DISMISSED for ${s}s`),yield this.userStore._setSubscriberStatusDismissed(s)),null==(n=null==(r=this.promptLifecycleCallbacks)?void 0:r.onPushSDKDidReceivePromptResponse)||n.call(r,o.prompt.id,!1);break}default:this.logger.warn("Received unknown prompt message: ",e),this.debugController._debugUnknownPromptMessage(e)}else this.logger.debug("Prompt not available to receive message",e)}))}_onPromptDidShow(e){return w(this,null,(function*(){var t,s;this.eventManager._track(re.PROMPT_SHOWN,{prompt_id:e.id}),null==(s=null==(t=this.promptLifecycleCallbacks)?void 0:t.onPushSDKDidShowPrompt)||s.call(t,e.id)}))}_onPromptDidHide(e){return w(this,null,(function*(){var t;e.style!==ot.PUBLISHER_CUSTOM&&e.id===(null==(t=this.activeView)?void 0:t.prompt.id)?this.activeView=void 0:this.logger.verbose("Hidden prompt does not match active prompt")}))}_startMatchedPromptSelection(){return w(this,null,(function*(){var e,t,s,i;let r;if(this.logger.verbose("Starting matched prompt selection"),this.matchedPrompt)r=this.allPrompts.find((({prompt:e})=>e.id===this.matchedPrompt.prompt.id));else{const e=yield this.settingsStore._getLastMatchedPromptId();e&&(r=this.allPrompts.find((({prompt:t})=>t.id===e)))}if(!r){const e=this.allPrompts.sort((({group:e},{group:t})=>-(e.priority-t.priority)));this._isTwoStepPromptsRequired&&this.logger.info("Browser requires 2-step prompt experience. Filtering prompts.");const t=e.reduce(((e,t)=>{const s=t.group.prompts.filter((e=>!this._isTwoStepPromptsRequired||e.style!==ot.NATIVE));return s.length?e.push([t.group,s]):this.logger.verbose(`Removing PromptGroup ${t.group.id} - no available prompts.`,t),e}),[]);for(const[s,i]of t){const e=this._evaluatePromptGroupConditions(s);if(e.isErr()){this.logger.debug(`Prompt not shown due to ${e.getErr()}`);break}e.unwrapOrNull()&&(r={group:s,prompt:1===i.length?i[0]:this._pickWeightedRandomPrompt(i)})}if(r&&void 0!==r.group.behavior.display_to_pct){const e=r.group.behavior.display_to_pct;if(e<100){Math.floor(100*Math.random())>e&&(r=void 0)}}}if(r&&(yield this._hasMetGlobalAndUserConditions(r.prompt))){if(this.logger.debug("Eligible prompt found",r),null==(t=null==(e=this.promptLifecycleCallbacks)?void 0:e.onPushSDKUserIsEligibleToPrompt)||t.call(e),yield this._setLastMatchedPrompt(r),!dt(r.prompt))return;!function({style:e,conditions:t}){return e!==ot.PUBLISHER_CUSTOM&&"SESSION_START"===ct(t).type}(r.prompt)?this.logger.verbose("Eligible prompt display delayed due to conditions",r.prompt.conditions):yield this._attemptToShowPrompt(r)}else this.logger.info("No matched prompts available"),this._disable(),yield this._clearLastMatchedPrompt(),null==(i=null==(s=this.promptLifecycleCallbacks)?void 0:s.onPushSDKUserIsIneligibleToPrompt)||i.call(s)}))}_hasMetGlobalAndUserConditions(e,t){return w(this,null,(function*(){if(null==t?void 0:t.skipEligibilityCheck)return e.style===ot.PUBLISHER_CUSTOM||(yield this.userStore._getSubscriberStatus())!==ge.DENIED;const s=yield this.notificationPermissionService._getIsEligibleToPrompt();if(s.isErr()){const e=s.getErr();return(e===Ve.USER_PERMISSION_DENIED||e===Ve.USER_PERMISSION_DISMISSED||e===Ve.USER_PERMISSION_GRANTED)&&this.debugController._debugPromptNotShown(e),!1}const i=yield this._evaluateGlobalConditions(e);return!i.isErr()||(this.logger.warn(`Prompt not shown due to: ${i.getErr()}`),!1)}))}_pickWeightedRandomPrompt(e){const t=e.reduce(((e,t)=>e.concat(new Array(t.weight).fill(t))),[]);return t[Math.floor(Math.random()*t.length)]}_buildMatchedPrompt(e){return w(this,null,(function*(){return f(E({},e),{displayCoordinator:"displayCoordinator"in e?e.displayCoordinator:e.prompt.style===ot.PUBLISHER_CUSTOM?yield this._buildCustomPromptView(e):this._buildPromptView(e)})}))}_buildPromptView({prompt:e,group:t,displayCoordinator:s}){if(s instanceof St)return s;const i=new St(e,t,this);return this.promptViewInitializedCallbacks.forEach((e=>e(i))),i}_buildCustomPromptView(e){return w(this,arguments,(function*({prompt:e,group:t,displayCoordinator:s}){if(s instanceof wt)return s;const i=new wt(e,t,yield this._hasMetGlobalAndUserConditions(e),this.pushSdkConfig,this.userStore,this.eventManager,this);return this.promptViewInitializedCallbacks.forEach((e=>e(i))),i}))}_evaluateGlobalConditions(e){return w(this,null,(function*(){var t,s,i,r,n;const o=e.id;if(this.activeView)return void 0!==o&&this.activeView.prompt.id===o?(null==(s=null==(t=this.promptLifecycleCallbacks)?void 0:t.onPushSDKFailedToShowPrompt)||s.call(t,o,ft.ALREADY_SHOWING),De.Err(`Prompt ${o} is already showing`)):(null==(r=null==(i=this.promptLifecycleCallbacks)?void 0:i.onPushSDKFailedToShowPrompt)||r.call(i,null,ft.OTHER_PROMPT_SHOWING),De.Err(`Another prompt, ${this.activeView.prompt.id}, is already showing.`));const a=null==(n=this.domain.frequency_caps)?void 0:n.prompts;if(a){const e=yield this._evaluateDomainPromptFCap(o,a);if(e.isErr())return this.debugController._debugPromptNotShown(Ve.PROMPT_INELIGIBLE_FCAP),e}return De.Ok(!0)}))}_evaluateDomainPromptFCap(e,t){return w(this,null,(function*(){var s,i;yield this.settingsStore._dropViewedPromptOccurrencesNotInInterval(t.interval_seconds);return(yield this.settingsStore._getViewedPromptOccurrencesCount())>=t.occurrences?(null==(i=null==(s=this.promptLifecycleCallbacks)?void 0:s.onPushSDKFailedToShowPrompt)||i.call(s,e,ft.USER_INELIGIBLE),De.Err(Ve.PROMPT_INELIGIBLE_FCAP)):De.Ok(!0)}))}_evaluatePromptGroupConditions({conditions:e}){if(null==e?void 0:e.display){const t=this._evaluatePromptGroupDisplayConditions(e.display);if(!t.unwrapOrNull())return t}return(null==e?void 0:e.page)?this._evaluatePromptGroupPageConditions(e.page):De.Ok(!0)}_evaluatePromptGroupDisplayConditions(e){switch(e[this._devicePlacement]){case"enabled":return De.Ok(!0);case"pass":return De.Ok(!1);case"disabled":return De.Err(`platform_disabled_${this._devicePlacement}`)}}_evaluatePromptGroupPageConditions({page_urls:e,excluded_page_urls:t}){const s=e=>{const t=e.replace(/\?/g,"\\?").replace(/\+|%20/g,"(?:\\+|%20)");return new RegExp(t,"i").test(this._currentHref)};return Array.isArray(t)&&t.length>0&&t.some(s)?De.Ok(!1):Array.isArray(e)&&e.length>0?De.Ok(e.some(s)):De.Ok(!0)}_evaluatePromptConditions(e){return w(this,arguments,(function*({conditions:e}){const t=ct(e);return function(e){return["SESSION_TIME_ON_SITE","SESSION_TIME_ON_PAGE"].includes(e.type)}(t)?this._evaluatePromptSessionTimeIntervalCondition(t):!function(e){return"SESSION_PAGE_VIEWS"===e.type}(t)||this._evaluatePromptPageViewsCondition(t)}))}_evaluatePromptPageViewsCondition(e){return w(this,arguments,(function*({minPageViews:e}){this.logger.info(`Prompt condition: Page views [at least ${e} pages]`);return(yield this.sessionManager.transient.store._getSessionPageViewCount())>=e}))}_evaluatePromptSessionTimeIntervalCondition(e){return w(this,arguments,(function*({type:e,timeInterval:t}){switch(e){case ut.SESSION_TIME_ON_SITE:this.logger.info(`Prompt condition: Time on site [at least ${t.intervalSeconds} seconds]`);return(yield this.sessionManager.transient.store._getSessionRuntimeSeconds())>=t.intervalSeconds;case ut.SESSION_TIME_ON_PAGE:{this.logger.info(`Prompt condition: Time on page [at least ${t.intervalSeconds} seconds]`);const e=yield this.sessionManager.transient.store._getCurrentPageViewStart();if(!e)return!1;return Math.abs(Ae(e.getTime()))/1e3>=t.intervalSeconds}}}))}}Ct([vt],kt.prototype,"_devicePlacement",1),Ct([vt],kt.prototype,"_isTwoStepPromptsRequired",1);var Tt=(e=>(e.sub="sub",e.sdk="sdk",e.WORKER="w",e))(Tt||{}),Rt=(e=>(e.IDB="idb",e.COOKIE="cookie",e.LEGACY_COOKIE="legacy_cookie",e.MEM="mem",e.SESSION="session",e))(Rt||{});class At{constructor(e,t,s){v(this,"_storageType"),v(this,"_storeName"),v(this,"_logger"),this._storageType=e,this._storeName=t,this._logger=null!=s?s:ee._getInstance(`${e}${t?`:${t}`:""}`)}get _isInWorkerGlobalScope(){return Ue._isInWorkerGlobalScope}_getLastUpdatedAt(){return w(this,null,(function*(){const e=yield this._getData(L._pnStorageTypeLuaKey);return e.isErr()?new Date(0):new Date(e.unwrap().ts)}))}_setLastUpdatedAt(e){return w(this,null,(function*(){const t=new Date(e),s=yield this._setData(L._pnStorageTypeLuaKey,t.getTime());return s.isErr()?s:De.Ok(t)}))}}const Lt=()=>new G(W.STORAGE_NOT_AVAILABLE,null," - Cookie"),Mt=e=>new G(W.STORAGE_KEY_EMPTY,null,e),Ut=e=>new G(W.STORAGE_FAILED_TO_OPEN,e," - Cookie"),xt=class e extends At{constructor(t,s=ee._getInstance("CookieStore")){super(Rt.COOKIE,t,s),v(this,"_preDomainConfigTempData"),e._domainKey=fe._dynamicDomainKey,e._domain=fe._injectedDomainConfig}static _setDomainKey(e){this._domainKey=e}static _setDomain(e){this._domain=e}get domainKey(){var t,s;return null!=(s=null==(t=e._domain)?void 0:t.domain_key)?s:e._domainKey}get allowedDomains(){var t;return null==(t=e._domain)?void 0:t.whitelist_domains}get isInIsolationMode(){var t;return!!(null==(t=e._domain)?void 0:t.flags.includes(fe._domainFeatUseIsolatedCookiesFlag))&&!!this.isolationKey}get isolationKey(){var e;return null==(e=this.domainKey)?void 0:e.slice(-8)}get _isAvailable(){return!Ke._isInWorkerGlobalScope&&"string"==typeof this._documentCookie}get _isUsingLegacyCookies(){return null===this._storeName}get _documentCookie(){return Ke._document.cookie}set _documentCookie(e){Ke._document.cookie=e}_getData(e){return w(this,null,(function*(){return this._getDataSync(e)}))}_setData(e,t){return w(this,null,(function*(){return this._setDataSync(e,t)}))}_removeData(e){return w(this,null,(function*(){return this._removeDataSync(e)}))}_getDataSync(e){var t,s,i;if(!this._isAvailable)return De.Err(Lt());const r=this._openCookie();if(r.isErr())return r;const n=r.unwrap();let o;return o=this._isUsingLegacyCookies?n[this._buildName(e)]:e===fe._pnStorageTypeLuaKey?null!=(t=n[fe._pnStorageTypeLuaKey])?t:null:null==(s=n[this._storeName])?void 0:s[e],null==o&&e!==fe._pnStorageTypeLuaKey?De.Err(Mt(e)):De.Ok({value:o,ts:null!=(i=n[fe._pnStorageTypeLuaKey])?i:0,sourceType:this._storageType})}_setDataSync(e,t){var s;const i=this._openCookie();if(i.isErr())return i;const r=i.unwrap();let n,o;return this._isUsingLegacyCookies?(n=e,o=t):(e===fe._pnStorageTypeLuaKey?r[e]=t:(null!=r[s=this._storeName]||(r[s]={}),r[this._storeName][e]=t),n=fe._pnCookieStorageKey,o=r),this._persist(n,o,void 0,e===fe._pnStorageTypeLuaKey),De.Ok(t)}_removeDataSync(e){const t=this._openCookie();if(t.isErr())return t;const s=t.unwrap();let i,r,n;return this._isUsingLegacyCookies?(i=e,r=null,n=-1):s[this._storeName]&&(delete s[this._storeName][e],i=fe._pnCookieStorageKey,r=s),i&&this._persist(i,r,n),De.Ok(null)}_openCookie(){var e;let t={};try{const i=fe._pnCookieStorageKeyRegex,r=fe._pnCookieStorageLegacyKeyPrefixRegex,n=this._isUsingLegacyCookies?"":"{}",o=this._documentCookie.split(";").map((e=>e.trim()));let a=this._isUsingLegacyCookies?Object.fromEntries(o.filter((e=>r.test(e))).map((e=>e.split(/=/)))):null!=(e=o.find((e=>i.test(e))))?e:"";if(this._isUsingLegacyCookies||(!a&&this._preDomainConfigTempData?a=this._preDomainConfigTempData:this._preDomainConfigTempData=void 0),a&&"string"==typeof a){const e=a.split(/=/);let i=2===e.length?""===e[1]?n:e[1]:n;if(!this._isUsingLegacyCookies)try{i=(e=>{let t;try{"TextDecoder"in self&&"function"==typeof self.TextDecoder&&"decode"in self.TextDecoder.prototype&&(t=(new self.TextDecoder).decode(je(e)))}catch(s){console.warn("Unable to decode base64 string",s)}return void 0===t&&(t=He(e)),t})(i)}catch(s){}const r=JSON.parse(i);r&&"object"==typeof r&&!Array.isArray(r)&&(t=r)}else t=a&&"object"==typeof a&&!Array.isArray(a)?a:{}}catch(i){const e=Ut(B(i));return this._logger.warn("Unable to open cookie",e.message),De.Err(e)}return De.Ok(t)}_persist(t,s,i,r){try{const o=null===this._storeName;o||!s||"object"!=typeof s||Array.isArray(s)||!0===r||(s[fe._pnStorageTypeLuaKey]=(new Date).getTime());let a=s;if("string"!=typeof s&&(a=JSON.stringify(s)),!o)try{a=Qe(a)}catch(n){}const l=`${this._buildName(t)}=${a}`;if(!e._domain)return void(this._preDomainConfigTempData=l);const u=new Date;u.setTime(u.getTime()+86400*(null!=i?i:fe._pnCookieStorageMaxDays)*1e3);const c=null===a?"-1":u.toUTCString(),d=this._getDomain();this._documentCookie=`${l};expires=${c};path=/;domain=${d};SameSite=Strict`}catch(o){this._logger.error(B(o))}}_buildName(e){return this.isInIsolationMode?`${e}_${this.isolationKey}`:e}_getDomain(){var e;let t=Ke._location.hostname;if(!this.isInIsolationMode){if(1==(null==(e=this.allowedDomains)?void 0:e.length))t=this.allowedDomains[0];else{const e=(()=>{const e=Ke._document;let t,s,i="_sw_tld_check=cookie",r=Ke._location.hostname.split(".");for(t=r.length-2;t>=0;t--)if(s=r.slice(t).join("."),e.cookie=i+";domain=."+s+";SameSite=strict;",e.cookie.indexOf(i)>-1)return e.cookie=i.split("=")[0]+"=;domain=."+s+";SameSite=strict;expires=Thu, 01 Jan 1970 00:00:01 GMT;",s})();e&&(t=e)}t||(t=Ke._location.hostname,"localhost"!==t&&(t=`.${t.split(".").splice(-2).join(".")}`))}return t}};v(xt,"_domainKey"),v(xt,"_domain");let $t=xt;class Kt{constructor(e,t){this.debugController=e,this.logger=t}get(e,t={}){return new Proxy(t,{get:(t,s,i)=>{var r;return s in t?t[s]:ue(String(s))in t?t[ue(String(s))]:void(["toJSON","children"].includes(String(s))||(this.logger.warn(`Unknown key: context.${e}.${String(s)}`),null==(r=this.debugController)||r._debugUnknownContextKey(`context.${e}.${String(s)}`)))}})}}class Wt{constructor(e,t,s,i,r,n){v(this,"iid",ae(5)),v(this,"domainConfigProvider"),v(this,"notificationPermissionService",null),v(this,"promptsController",null),v(this,"_logger"),v(this,"isLoading"),v(this,"_isLoaded"),v(this,"_isEnabled"),v(this,"_domainKey"),v(this,"_loadConfig"),v(this,"pageViewProcessor"),v(this,"_pushSdkLifecycleCallbacks"),v(this,"_permissionLifecycleCallbacks"),v(this,"_appMessageLifecycleCallbacks"),v(this,"promptLifecycleCallbacks"),v(this,"_onLoadedCallbacks"),v(this,"_postConfigActionsQueue"),v(this,"legacyEventCallbacks"),this.eventManager=e,this.settingsStore=t,this.userStore=s,this.sessionManager=i,this.debugController=r,this.settingsStore=t,this.userStore=s,this._logger=null!=n?n:ee._getInstance(),this.isLoading=!1,this._isLoaded=!1,this._isEnabled=!0,this.legacyEventCallbacks={},this._sendImpressionEvent()}_executeWhenConfigured(e){return w(this,null,(function*(){return this._isLoaded?Promise.resolve(e()).catch((e=>{const t=B(e);this._logger.error(t),this.eventManager._track(t)})).then((e=>null!=e?e:null)):(null!=this._postConfigActionsQueue||(this._postConfigActionsQueue=[]),this._postConfigActionsQueue.push(e),null)}))}_executeWhenConfiguredIfEnabled(e){return w(this,null,(function*(){return this._executeWhenConfigured((()=>this._isEnabled?e():null))}))}get loadConfig(){return this._loadConfig}get isLoaded(){return this._isLoaded}get isEnabled(){return this._isEnabled}get _legacyContext(){var e,t,s;const i=new Kt(this.debugController,this._logger),r=null!=(s=null!=(t=fe._injectedDomainConfig)?t:null==(e=this.domainConfigProvider)?void 0:e._getCachedSync())?s:{},n=this.userStore._getAnonymousIdSync(),o={puuid:n,externalId:this.userStore._getExternalIdSync(),subscriberState:"none",isSubscribed:!1,getId:()=>n};try{const e=this.userStore._getSubscriberStatusSync();o.isSubscribed=e===ge.SUBSCRIBED,e!==ge.NOT_DETERMINED&&(o.subscriberState=e)}catch(a){}return{domainKey:this.loadConfig.domainKey,env:i.get("env"),app:i.get("app"),domain:i.get("domain",E({},r)),user:i.get("user",o)}}get _currentLocation(){return Ke._location}_registerPushSdkLifecycleCallbacks(e){this._pushSdkLifecycleCallbacks=e}_registerPermissionLifecycleCallbacks(e){this._permissionLifecycleCallbacks=e}_registerAppMessageLifecycleCallbacks(e){this._appMessageLifecycleCallbacks=e}_registerPromptLifecycleCallbacks(e){this.promptLifecycleCallbacks=e}_registerLegacyEventCallback(e,t,s){var i;null!=(i=this.legacyEventCallbacks)[e]||(i[e]={});const r=ae(8);this.legacyEventCallbacks[e][r]=s?(...s)=>{delete this.legacyEventCallbacks[e][r],t(...s)}:t}_registerOnLoadedCallback(e){null!=this._onLoadedCallbacks||(this._onLoadedCallbacks=[]),this._onLoadedCallbacks.push(e)}_setConfiguration(e){return w(this,null,(function*(){if(this.isLoading)return void this._logger.warn("Initialization already started");this.isLoading=!0,$t._setDomainKey(e.domainKey),yield this.sessionManager._start();const t=function(e){const t=we();return void 0!==(null==t?void 0:t.iid)&&t.iid!==e.iid?De.Err(new G(W.DUPLICATE_SDK_DETECTED)):e.isLoaded?De.Err(new G(W.SDK_ALREADY_LOADED)):De.Ok(!0)}(this);if(t.isErr())return this._logger.warn("Unable to initialize PushSDK"),void this._handleExit(t.getErr());this._loadConfig=e,_e._loadConfig=e,function(e){return Object.keys(e).some((e=>!Pe.includes(e)))}(e)&&this.debugController._debugUnknownConfigurationKeys(e),this._domainKey=e.domainKey,this.domainConfigProvider=new Le(e.domainKey,this.settingsStore);try{yield this._load()}catch(s){const e=B(s);this._logger.error(e),this.eventManager._track(e)}}))}_handleExit(e){return w(this,null,(function*(){var t;this._logger.warn(`SDK Exited; ${e._compositeMessage}`),this._isEnabled=!1,null==(t=this.promptsController)||t._disable();try{const[e,t]=yield Promise.all([this.userStore._getSubscriberStatus(),this.userStore._getIsInDeletedState()]);this.onPushSDKDidExitWithSubscriberStatus(e,t)}catch(s){this._logger.error(B(s))}}))}_load(){return w(this,null,(function*(){yield this._logInitializingState();const e=yield this.domainConfigProvider._get();if(e.isErr()){const t=e.getErr();return void(yield this._handleExit(t.code===W.DOMAIN_CONFIGURATION_LOAD_FAILED?t:new G(W.DOMAIN_CONFIGURATION_LOAD_FAILED,e.getErr())))}const t=e.unwrap();$t._setDomain(t),_e._domainKey=this._domainKey,yield this._handleDomainConfigInitialLoadCompleted(t)}))}_logInitializingState(){return w(this,null,(function*(){this._logger.debug(`Initializing SDK v${fe._libraryVersion} (${fe._isProd?"P":"D"}-${this.iid})`),this._logger.info(`Loading key: ${this._domainKey}`)}))}_logUserInfo(){return w(this,null,(function*(){let e=yield this.userStore._getAnonymousId();e&&this._logger.info(`Anonymous ID: ${e}`);let t=yield this.userStore._getExternalId();t&&this._logger.info(`External ID: ${t}`)}))}_logCurrentSubscriptionStatus(){return w(this,null,(function*(){const[e,t]=yield Promise.all([this.userStore._getSubscriberStatus(),this.userStore._getSubscriberStatusDismissedExpiration()]);let s=`Current subscription status: ${Se(e)}`;e===ge.DISMISSED&&null!==t&&(s+=` - expires in ${Math.round((t-(new Date).getTime())/1e3)}s`),this._logger.info(s)}))}_handleDomainConfigInitialLoadCompleted(e){return w(this,null,(function*(){if(!this._validateHostAvailability(e))return this.debugController._debugPromptNotShown(Ve.HOST_NOT_WHITELISTED),void(yield this._handleExit(new G(W.HOST_NOT_ALLOWED)));if(yield this._dispatchLegacyEventCallbacks(se.LOADED),this.loadConfig.externalId&&(yield this.userStore._setExternalId(this.loadConfig.externalId)),xe(e))this._logger.debug("[Event Only Mode] Skipping notification & prompt services");else{this._logger.debug("Starting notification services"),this.notificationPermissionService=new Ge(e,new tt(this._loadConfig,e),this.eventManager,this.userStore,this),this.promptsController=new kt(this.loadConfig,e,new nt(e.domain_key,this.settingsStore),this.notificationPermissionService,this.userStore,this.settingsStore,this.sessionManager,this.eventManager,this.debugController,this);let s=null;const i=yield Ge._getWebPushSupport();if(i.isErr())s=i.getErr(),this.onPushSDKDidNotDetectWebPushSupport(s);else{this.onPushSDKDidDetectWebPushSupport(),yield this._logUserInfo(),yield this.userStore._synchronizeData(),yield this._logCurrentSubscriptionStatus();try{yield this.userStore._getAnonymousId().then((e=>{_e._anonymousId=e})).catch()}catch(t){}const e=yield this.notificationPermissionService._init();if(e.isErr()){const t=e.getErr();t instanceof G&&t._isExitException?(s=t,t.code===W.PUSH_WORKER_REGISTRATION_EXCEPTION&&this.debugController._debugPromptNotShown(Ve.SW_INSTALL_FAILED)):this._logger.warn(t.message)}}if(this.promptsController._setIsWebPushSupported(i),s)return void(yield this._handleExit(s));yield this.notificationPermissionService._synchronize(),this.promptsController._startDisplayEvaluations()}this.pageViewProcessor=rt._init(e,this.eventManager,this.userStore,this.sessionManager.transient.store),function(e){return e.flags.includes(L._sdkHasForceDebugLogsEnabledFlag)}(e)&&(this._logger.debug("Forcing DEBUG logs"),this._logger.logLevel=O.VERBOSE),this._evaluateUserLocaleAndTimeZoneSettings().then(),yield this._setIsLoaded(e)}))}_evaluateUserLocaleAndTimeZoneSettings(){return w(this,null,(function*(){const[e,t,s,i]=yield Promise.all([this.userStore._getLocale(),Intl.DateTimeFormat().resolvedOptions().locale,this.userStore._getTimeZone(),Intl.DateTimeFormat().resolvedOptions().timeZone]),r=[];(!e||t&&e!==t)&&r.push(this.userStore._setLocale(t).then((()=>_e._getProfileLanguageEvent(t))).then((e=>this.eventManager._track(e)))),(!s||i&&s!==i)&&r.push(this.userStore._setTimeZone(i).then((()=>_e._getProfileTimeZoneEvent(i))).then((e=>this.eventManager._track(e)))),yield Promise.all(r).catch((e=>this._logger.error(e)))}))}_getUserDetails(){return w(this,null,(function*(){var e,t,s;const i=yield this.userStore._getAnonymousId(),r=yield this.userStore._getSubscriberStatus(),n=yield this.userStore._getExternalId(),o=yield this._getBrowserPermissions();return{userId:i,subscriberStatus:r,externalId:n,browserPermission:null!=(e=null==o?void 0:o.permission)?e:null,endpoint:null!=(s=null==(t=null==o?void 0:o.token)?void 0:t.endpoint)?s:null}}))}_getBrowserPermissions(){return w(this,null,(function*(){return this.notificationPermissionService?yield this.notificationPermissionService._getCurrentPermissions():null}))}_toggleDebugPanel(e=!0){return w(this,null,(function*(){try{return e?this.debugController._showDebugPanel(yield this._getUserDetails()):this.debugController._hideDebugPanel()}catch(t){this.eventManager._track(B(t))}}))}_validateHostAvailability(e){let t=!1,s=e.whitelist_domains;if(s)if(Array.isArray(s)&&0!==s.length){const e=this._currentLocation,i=["localhost","127.0.0.1"],r=`${e.protocol}//${e.hostname}`,n=`${e.protocol}//${e.host}`,o=e.href;t=[...s,...i].some((e=>{/^\*/.test(e)&&(e=`.${e}`);const t=new RegExp(`^(http[s]?://)?${e}$`,"i");return t.test(r)||t.test(n)||t.test(o)}))}else t=!0;else t=!0;return t}_setIsLoaded(e){return w(this,null,(function*(){var t;if(this._isLoaded)return;this.isLoading=!1,this._isLoaded=!0,this.debugController._shouldShowDebugPanel()&&(yield this.debugController._showDebugPanel(yield this._getUserDetails())),this._executePostConfigActions().catch((e=>this._logger.error(e))),(null==(t=this._onLoadedCallbacks)?void 0:t.length)&&(yield Promise.all(this._onLoadedCallbacks.map((e=>Promise.resolve(e()).catch((e=>{this._logger.error(e)})))))),this._logger.debug("SDK load completed"),this._isEnabled||this._logger.debug("SDK has been disabled");const s=yield this.userStore._getSubscriberStatus();this.pageViewProcessor?this.pageViewProcessor._start():this._logger.warn("Page View timer not available"),this.onPushSDKDidFinishLoading(e,s)}))}_executePostConfigActions(){return w(this,null,(function*(){var e;const t=[...null!=(e=this._postConfigActionsQueue)?e:[]];if(this._postConfigActionsQueue=[],t.length)return Promise.all(t.map((e=>Promise.resolve(e()).catch((e=>this._logger.error(e)))))).then()}))}_dispatchLegacyEventCallbacks(e,...t){return w(this,null,(function*(){var s;const i=Object.values(null!=(s=this.legacyEventCallbacks[e])?s:{});i.length?(yield Promise.all(i.map((s=>Promise.resolve(s(...t)).catch((t=>{this._logger.error(`Error encountered in on_${e} handler:`,B(t).message)}))))),this._logger.verbose(`Completed ${i.length} on_${e} handler(s)`)):this._logger.verbose(`No on_${e} handlers found`)}))}_sendImpressionEvent(){(()=>w(this,null,(function*(){(yield this.userStore._getIsInDeletedState())||this.debugController._debug(re.SDK_IMPRESSION)})))().then()}onPushSDKDidDetectWebPushSupport(){var e,t;null==(t=null==(e=this._pushSdkLifecycleCallbacks)?void 0:e.onPushSDKDidDetectWebPushSupport)||t.call(e),this._dispatchLegacyEventCallbacks(se.WEB_PUSH_SUPPORTED)}onPushSDKDidNotDetectWebPushSupport(e){var t,s;null==(s=null==(t=this._pushSdkLifecycleCallbacks)?void 0:t.onPushSDKDidNotDetectWebPushSupport)||s.call(t),this._dispatchLegacyEventCallbacks(se.WEB_PUSH_UNSUPPORTED,null==e?void 0:e.message,this.loadConfig,Ke)}onPushSDKDidFinishLoading(e,t){var s,i;null==(i=null==(s=this._pushSdkLifecycleCallbacks)?void 0:s.onPushSDKDidFinishLoading)||i.call(s,e,t),this._dispatchLegacyEventCallbacks(se.READY,this._legacyContext)}onPushSDKDidExitWithSubscriberStatus(e,t,s){var i,r;null==(r=null==(i=this._pushSdkLifecycleCallbacks)?void 0:i.onPushSDKDidExitWithSubscriberStatus)||r.call(i,e,t)}onPushSDKUserIsEligibleToPrompt(){return w(this,null,(function*(){var e,t;null==(t=null==(e=this.promptLifecycleCallbacks)?void 0:e.onPushSDKUserIsEligibleToPrompt)||t.call(e),this._dispatchLegacyEventCallbacks(se.PROMPT_ELIGIBLE,{})}))}onPushSDKUserIsIneligibleToPrompt(){return w(this,null,(function*(){var e,t;null==(t=null==(e=this.promptLifecycleCallbacks)?void 0:e.onPushSDKUserIsIneligibleToPrompt)||t.call(e),this._dispatchLegacyEventCallbacks(se.PROMPT_INELIGIBLE,{})}))}onPushSDKDidShowPrompt(e){return w(this,null,(function*(){var t,s;null==(s=null==(t=this.promptLifecycleCallbacks)?void 0:t.onPushSDKDidShowPrompt)||s.call(t,e);const i=yield this._getLegacyPromptEventPayload(e);this._dispatchLegacyEventCallbacks(se.PROMPT_SHOWN,i)}))}onPushSDKFailedToShowPrompt(e,t){return w(this,null,(function*(){var s,i;null==(i=null==(s=this.promptLifecycleCallbacks)?void 0:s.onPushSDKFailedToShowPrompt)||i.call(s,e,t)}))}onPushSDKDidReceivePromptResponse(e,t){return w(this,null,(function*(){var s,i;null==(i=null==(s=this.promptLifecycleCallbacks)?void 0:s.onPushSDKDidReceivePromptResponse)||i.call(s,e,t);const r=yield this._getLegacyPromptEventPayload(e);t?this._dispatchLegacyEventCallbacks(se.PROMPT_ALLOWED,r):this._dispatchLegacyEventCallbacks(se.PROMPT_DISMISSED,r)}))}_getLegacyPromptEventPayload(e){return w(this,null,(function*(){return{prompt:{id:e},subscribed:yield this.userStore._getIsSubscribed()}}))}onPushSDKDidRequestNotificationPermissions(){return w(this,null,(function*(){var e,t;null==(t=null==(e=this._permissionLifecycleCallbacks)?void 0:e.onPushSDKDidRequestNotificationPermissions)||t.call(e),this._dispatchLegacyEventCallbacks(se.PERMISSION_SHOWN,{}),this._dispatchLegacyEventCallbacks(se.LEGACY_PERMISSION_SHOWN,{})}))}onPushSDKDidReceivePermissionResponse(e){return w(this,null,(function*(){var t,s;switch(null==(s=null==(t=this._permissionLifecycleCallbacks)?void 0:t.onPushSDKDidReceivePermissionResponse)||s.call(t,e),e){case Be.GRANTED:this._dispatchLegacyEventCallbacks(se.PERMISSION_ALLOWED,{}),this._dispatchLegacyEventCallbacks(se.LEGACY_PERMISSION_ALLOWED,{});break;case Be.DENIED:this._dispatchLegacyEventCallbacks(se.PERMISSION_DENIED,{});break;case Be.DISMISSED:this._dispatchLegacyEventCallbacks(se.PERMISSION_DISMISSED,{})}}))}onPushSDKDidReceivePermissionResponseWithError(e,t){return w(this,null,(function*(){var s,i;null==(i=null==(s=this._permissionLifecycleCallbacks)?void 0:s.onPushSDKDidReceivePermissionResponseWithError)||i.call(s,e,t)}))}onPushSDKDidRegisterForRemoteNotificationsWithDeviceToken(e){return w(this,null,(function*(){var t,s;null==(s=null==(t=this._permissionLifecycleCallbacks)?void 0:t.onPushSDKDidRegisterForRemoteNotificationsWithDeviceToken)||s.call(t,e)}))}onPushSDKDidFailToRegisterForRemoteNotificationsWithError(e){return w(this,null,(function*(){var t,s;null==(s=null==(t=this._permissionLifecycleCallbacks)?void 0:t.onPushSDKDidFailToRegisterForRemoteNotificationsWithError)||s.call(t,e)}))}onPushSDKDidReceivePermissionStatusChange(e){return w(this,null,(function*(){var t,s,i,r;switch(null==(s=null==(t=this._permissionLifecycleCallbacks)?void 0:t.onPushSDKDidReceivePermissionStatusChange)||s.call(t,e),e){case Be.GRANTED:case Be.DENIED:null==(i=this.promptsController)||i._disable();break;case Be.DISMISSED:null==(r=this.promptsController)||r._enable()}}))}}const Ft=()=>new G(W.STORAGE_NOT_AVAILABLE,null," - IndexedDB"),Bt=()=>new G(W.IDB_INVALID_STORE_NAME),Vt=()=>new G(W.IDB_BLOCKED);class Gt extends At{constructor(e,t=ee._getInstance("IdbStore")){super(Rt.IDB,e,t)}get _isAvailable(){return Ue._getIsEnvBaseSupported()[0]&&!!this._storeName&&!!this._indexedDB}get _indexedDB(){return Ue._scope.indexedDB}get _isSafari(){return Ue._isSafari}_getData(e){return w(this,null,(function*(){return this._executeTransaction("read",e)}))}_setData(e,t){return w(this,null,(function*(){return this._executeTransaction("write",[e,t],(()=>{e!==L._pnStorageTypeLuaKey&&this._updateLua()}))}))}_removeData(e){return w(this,null,(function*(){return this._executeTransaction("delete",e)}))}_openDatabase(){return w(this,null,(function*(){return new Promise((e=>{if(!this._indexedDB)return void e(De.Err(Ft()));if(!this._storeName)return void e(De.Err(Bt()));const t=this._indexedDB.open("pn_store",1);t.onerror=s=>{e(De.Err(t.error||new Error(s)))},t.onsuccess=t=>{this._handleOnOpenSuccess(t.target.result,(t=>{e(De.Ok(t))}))},t.onupgradeneeded=e=>{this._handleOnUpgradeNeeded(e.target.result)},t.onblocked=()=>{e(De.Err(Vt()))}}))}))}_handleOnOpenSuccess(e,t){e.onversionchange=()=>{this._handleOnVersionChange(e)},this._isSafari&&this._selfHeal(e),t(e)}_handleOnUpgradeNeeded(e){e.objectStoreNames.contains(Tt.sub)||e.createObjectStore(Tt.sub,{keyPath:"k"}),e.objectStoreNames.contains(Tt.sdk)||e.createObjectStore(Tt.sdk,{keyPath:"k"}),e.objectStoreNames.contains(Tt.WORKER)||e.createObjectStore(Tt.WORKER,{keyPath:"k"})}_handleOnVersionChange(e){e.close()}_executeTransaction(e,t,s){return w(this,null,(function*(){const i=yield this._openDatabase();if(i.isErr())return i;const r=i.unwrap();return new Promise((i=>{const n=this._storeName,o="read"===e?"readonly":"readwrite",a=r.transaction(n,o),l=(new Date).getTime(),u=a.objectStore(n),c="write"===e?t[0]:t;let d;switch(e){case"read":d=u.get(c);break;case"write":d=u.put({k:c,value:t[1],ts:c===L._pnStorageTypeLuaKey?t[1]:l});break;case"delete":d=u.delete(c)}a.onabort=e=>{i(De.Err(d.error||new Error(e)))},a.oncomplete=()=>{var r,n,o,a;let l;switch(e){case"read":l=De.Ok({value:null!=(n=null==(r=d.result)?void 0:r.value)?n:null,ts:null!=(a=null==(o=d.result)?void 0:o.ts)?a:0,sourceType:this._storageType});break;case"write":l=De.Ok(t[1]);break;case"delete":l=De.Ok(null)}i(l),null==s||s(l)}}))}))}_updateLua(){this._executeTransaction("write",[L._pnStorageTypeLuaKey,(new Date).getTime()]).then((e=>{var t;e.isErr()&&this._logger.verbose(`Unable to set lua for ${this._storeName}`,null==(t=e.getErr())?void 0:t.message)}))}_selfHeal(e){Object.keys(Tt).every((t=>e.objectStoreNames.contains(t)))||this._handleOnUpgradeNeeded(e)}}const Ht=()=>new G(W.STORAGE_NS_REQUIRED,null,"Mem");class jt extends At{constructor(e,t=ee._getInstance("MemStore")){super(Rt.MEM,e,t),v(this,"_db"),this._db={}}get _isAvailable(){return null!==this._storeName}_getData(e){return w(this,null,(function*(){var t,s,i;if(!this._storeName)return De.Err(Ht());const r=null==(t=this._db[this._storeName])?void 0:t[e];return De.Ok({value:null!=(s=null==r?void 0:r.value)?s:null,ts:null!=(i=null==r?void 0:r.ts)?i:0,sourceType:this._storageType})}))}_setData(e,t){return w(this,null,(function*(){var s,i;return this._storeName?(null!=(s=this._db)[i=this._storeName]||(s[i]={}),this._db[this._storeName][e]={value:t,ts:(new Date).getTime()},De.Ok(t)):De.Err(Ht())}))}_removeData(e){return w(this,null,(function*(){var t;return this._storeName?(void 0!==(null==(t=this._db[this._storeName])?void 0:t[e])&&delete this._db[this._storeName][e],De.Ok(null)):De.Err(Ht())}))}}const Qt=()=>new G(W.STORAGE_NOT_AVAILABLE,null," - Session"),Yt=e=>new G(W.STORAGE_KEY_EMPTY,null,e),qt=e=>new G(W.STORAGE_FAILED_TO_OPEN,e," - Session");class zt extends At{constructor(e,t=ee._getInstance("SessionStore")){super(Rt.SESSION,e,t)}get _isAvailable(){return!!this._storeName&&!this._isInWorkerGlobalScope&&this.storageAvailable()}get _store(){return Ke._scope.sessionStorage}_getData(e){return w(this,null,(function*(){if(!this._isAvailable)return De.Err(Qt());const t=this._openStore();if(t.isErr())return t;const s=t.unwrap()[e]||null;return null==s&&e!==L._pnStorageTypeLuaKey?De.Err(Yt(e)):De.Ok(s)}))}_setData(e,t){return w(this,null,(function*(){if(!this._isAvailable)return De.Err(Qt());const s=this._openStore();if(s.isErr())return s;const i=s.unwrap();return i[e]=e===L._pnStorageTypeLuaKey?t:{value:t,ts:(new Date).getTime()},this._persist(i),De.Ok(t)}))}_removeData(e){return w(this,null,(function*(){const t=this._openStore();if(t.isErr())return t;const s=t.unwrap();return s[this._storeName]&&e in s[this._storeName]&&(delete s[this._storeName][e],this._persist(s)),De.Ok(null)}))}_openStore(){var e;let t={};if(!this._storeName)return De.Err(qt(new Error("Store cannot be accessed without a store name set")));try{const s=null!=(e=this._store.getItem(this._storeName))?e:"{}",i=JSON.parse(s);i&&"object"==typeof i&&!Array.isArray(i)&&(t=i)}catch(s){const e=qt(B(s));return this._logger.warn(e.message),De.Err(e)}return De.Ok(t)}_persist(e){try{e&&"object"==typeof e&&!Array.isArray(e)&&(e[L._pnStorageTypeLuaKey]=(new Date).getTime()),this._store.setItem(this._storeName,JSON.stringify(e))}catch(t){this._logger.error(B(t))}}storageAvailable(){let e;try{e=this._store;const t=L._pnSessionStorageKey+"_test_";return e.setItem(t,t),e.removeItem(t),!0}catch(t){return t instanceof DOMException&&"QuotaExceededError"===t.name&&!!e&&0!==e.length}}}const Xt=e=>new Error(`No available stores found for ${e.join(", ")}`),Zt=e=>new G(W.STORAGE_KEY_EMPTY,null,e);class Jt{constructor(e,t,s=ee._getInstance("StorageManager")){v(this,"_storeName"),v(this,"_logger"),v(this,"_stores"),v(this,"_preferredStores"),this._storeName=e,this._preferredStores=t,this._logger=s,this._stores=Object.fromEntries(this._preferredStores.map((t=>{switch(t){case Rt.IDB:return[Rt.IDB,new Gt(e)];case Rt.COOKIE:return[Rt.COOKIE,new $t(e)];case Rt.LEGACY_COOKIE:return[Rt.LEGACY_COOKIE,new $t(null)];case Rt.MEM:return[Rt.MEM,new jt(e)];case Rt.SESSION:return[Rt.SESSION,new zt(e)]}})))}_getAvailableStores(e){const t=null!=e?e:this._preferredStores,s=t.filter((e=>!!this._stores[e]&&this._stores[e]._isAvailable));return 0===s.length?De.Err(Xt(t)):De.Ok(s.map((e=>this._stores[e])))}_getData(e,t){return w(this,null,(function*(){const s=yield this._getTimestampedData(e,t);return s.isErr()?s:De.Ok(s.unwrap().value)}))}_getDataSync(e,t){const s=this._getTimestampedDataSync(e,t);return s.isErr()?s:De.Ok(s.unwrap().value)}_getTimestampedData(e,t){return w(this,null,(function*(){const s=yield this._mGetTimestampedData(e,t),i=Object.values(s).filter((e=>e.isOk()&&null!==e.unwrap().value)).map((e=>e.unwrap()));return i.length?(i.length>1&&i.sort(((e,t)=>t.ts-e.ts)),De.Ok(i[0])):De.Err(Zt(e))}))}_getTimestampedDataSync(e,t){const s=this._mGetTimestampedDataSync(e,t),i=Object.values(s).filter((e=>e.isOk()&&null!==e.unwrap().value)).map((e=>e.unwrap()));return i.length?De.Ok(i[0]):De.Err(Zt(e))}_mGetTimestampedData(e,t){return w(this,null,(function*(){var s;const i={},r=null!=(s=null==t?void 0:t.preferredStores)?s:this._preferredStores;return(yield Promise.all(r.map((t=>{var s;return(null==(s=this._stores[t])?void 0:s._isAvailable)?this._stores[t]._getData(e).then((e=>[t,e])):[t,De.Ok({value:null,ts:0})]})))).forEach((([e,t])=>{i[e]=t})),i}))}_mGetTimestampedDataSync(e,t){var s;const i={};return(null!=(s=null==t?void 0:t.preferredStores)?s:this._preferredStores).filter((e=>this._stores[e]&&"_getDataSync"in this._stores[e])).map((e=>this._stores[e])).map((t=>(null==t?void 0:t._isAvailable)?[t._storageType,t._getDataSync(e)]:[t._storageType,De.Ok({value:null,ts:0})])).forEach((([e,t])=>{i[e]=t})),i}_setData(e,t,s){return w(this,null,(function*(){var i;const r=null!=(i=null==s?void 0:s.preferredStores)?i:this._preferredStores,n=yield Promise.all(r.map((s=>{var i;return(null==(i=this._stores[s])?void 0:i._isAvailable)?this._stores[s]._setData(e,t).then((t=>(t.isErr()&&this._logger.warn(`Unable to set [${s}:error] ${e}`,t.getErr().message),t))):Promise.resolve(null).then((t=>(this._logger.warn(`Unable to set [${s}:not_available] ${e}`),t)))})));return this._parseSetterResponse(n,r,t)}))}_setDataSync(e,t,s){var i;const r=null!=(i=null==s?void 0:s.preferredStores)?i:this._preferredStores,n=r.filter((e=>this._stores[e]&&"_getDataSync"in this._stores[e])).map((e=>this._stores[e])).map((s=>{if(null==s?void 0:s._isAvailable){const i=s._setDataSync(e,t);return i.isErr()&&this._logger.warn(`Unable to set [${s}:error] ${e}`,i.getErr().message),i}return this._logger.warn(`Unable to set [${s}:not_available] ${e}`),null}));return this._parseSetterResponse(n,r,t)}_removeData(e,t){return w(this,null,(function*(){var s;const i=null!=(s=null==t?void 0:t.preferredStores)?s:this._preferredStores,r=yield Promise.all(i.map((t=>{var s;return(null==(s=this._stores[t])?void 0:s._isAvailable)?this._stores[t]._removeData(e):null})));return this._parseSetterResponse(r,i,null)}))}_parseSetterResponse(e,t,s){if(e.every((e=>null===e||e.isErr()))){const s=e.find((e=>null==e?void 0:e.getErr()));return s?(Xe._dispatch(Xe.EventType.ERROR,s.getErr()),this._logger.warn(s.getErr().message),s):De.Err(Xt(t))}return e.forEach((e=>{(null==e?void 0:e.isErr())&&Xe._dispatch(Xe.EventType.ERROR,e.getErr())})),De.Ok(s)}}var es=(e=>(e.anonymousId="id",e.locale="ll",e.timeZone="tz",e.token="t",e.externalId="xid",e.isSubscribed="s",e.subscriberStatus="ss",e.DISMISSED_STATUS_EXPIRATION="dse",e.isInDeletedState="udr",e.LAST_PAGE_VIEWED="lpgv",e.IS_USER_IN_SOFT_UNSUBSCRIBE_STATE="sunsub",e))(es||{});const ts={id:"pushly.user_puuid",t:"_pntx",xid:"_pnxd",ss:"_pnss",udr:"_pnudr",dse:"_pnpdm"};var ss=(e=>(e.logLevel="log",e.eventsCache="ev",e.domainConfig="d",e.PROMPTS_CACHE="p",e.PROMPTS_OCCURRENCES_MAP="pocm",e.PROMPTS_LAST_VIEWED="plv",e))(ss||{}),is=(e=>(e.SESSION_START="sxst",e.SESSION_RUNTIME="sxrt",e.SESSION_PAGE_VIEWS="sxpv",e.SESSION_PAGE_VIEW_START="sxpvs",e.SESSION_READY_PROMPT="sxrp",e))(is||{});function rs(e,t,s){const i=Array.from(e.entries()).reduce(t,null!=s?s:[]);return void 0!==s&&typeof e!=typeof s?i:new Map(i)}const ns=[Rt.IDB,Rt.MEM],os=[Rt.SESSION,Rt.MEM];class as extends Jt{constructor(e){super(Tt.sdk,[Rt.MEM,Rt.IDB,Rt.SESSION],null!=e?e:ee._getInstance("SettingsStore"))}_getDomainConfig(){return w(this,null,(function*(){return(yield this._getTimestampedData(ss.domainConfig,{preferredStores:ns})).unwrapOrNull()}))}_setDomainConfig(e){return w(this,null,(function*(){return(yield this._setData(ss.domainConfig,e,{preferredStores:ns})).unwrapOrNull()}))}_getCachedEvents(){return w(this,null,(function*(){return(yield this._getData(ss.eventsCache,{preferredStores:ns})).unwrapOr([])}))}_setCachedEvents(e){return w(this,null,(function*(){return(yield this._setData(ss.eventsCache,e,{preferredStores:ns})).unwrapOr([])}))}_getCachedPrompts(){return w(this,null,(function*(){return(yield this._getTimestampedData(ss.PROMPTS_CACHE,{preferredStores:os})).unwrapOrNull()}))}_setCachedPrompts(e){return w(this,null,(function*(){return(yield this._setData(ss.PROMPTS_CACHE,e,{preferredStores:os})).unwrapOrNull()}))}_getViewedPromptOccurrencesCount(){return w(this,null,(function*(){return rs(yield this._getViewedPromptOccurrencesMap(),((e,[,t])=>e+t.length),0)}))}_getViewedPromptOccurrencesMap(){return w(this,null,(function*(){return(yield this._getData(ss.PROMPTS_OCCURRENCES_MAP,{preferredStores:ns})).unwrapOr(new Map)}))}_dropViewedPromptOccurrencesNotInInterval(e){return w(this,null,(function*(){const t=rs(yield this._getViewedPromptOccurrencesMap(),((t,[s,i])=>{const r=i.filter((t=>Math.abs(Ae(t))<=e));return r.length>0&&t.push([s,r]),t}));yield this._setData(ss.PROMPTS_OCCURRENCES_MAP,t)}))}_incrementViewedOccurrencesForPromptId(e){return w(this,null,(function*(){var t;const s=yield this._getViewedPromptOccurrencesMap();s.set(e,[(new Date).getTime(),...null!=(t=s.get(e))?t:[]]),yield this._setData(ss.PROMPTS_OCCURRENCES_MAP,s)}))}_getLastViewedPromptId(){return w(this,null,(function*(){return(yield this._getData(ss.PROMPTS_LAST_VIEWED,{preferredStores:ns})).unwrapOrNull()}))}_setLastViewedPromptId(e){return w(this,null,(function*(){return(yield this._setData(ss.PROMPTS_LAST_VIEWED,e,{preferredStores:ns})).unwrapOrNull()}))}_setLastMatchedPromptId(e){return w(this,null,(function*(){return(null===e?yield this._removeData(is.SESSION_READY_PROMPT):yield this._setData(is.SESSION_READY_PROMPT,e)).unwrapOrNull()}))}_getLastMatchedPromptId(){return w(this,null,(function*(){return(yield this._getData(is.SESSION_READY_PROMPT)).unwrapOrNull()}))}}const ls=[Rt.COOKIE,Rt.IDB,Rt.MEM],us=[Rt.IDB,Rt.MEM],cs=[Rt.SESSION,Rt.MEM];class ds extends Jt{constructor(e,t=ee._getInstance("UserStore")){super(Tt.sub,[Rt.MEM,Rt.IDB,Rt.COOKIE,Rt.SESSION],t),v(this,"_legacyStorage"),this._legacyStorage=e}_synchronizeData(){return w(this,null,(function*(){yield(()=>w(this,null,(function*(){const e=this._getAvailableStores([Rt.IDB,Rt.COOKIE]).unwrapOr([]);if(e.length<=1)return void this._logger.verbose("[Sync] No available stores to synchronize");const t=yield Promise.all(e.map((e=>e._getLastUpdatedAt().then((t=>({store:e,lua:t}))))));if(new Set(t.map((e=>e.lua.getTime()))).size<=1)return void this._logger.verbose("[Sync] Stores are already synchronized");t.length>1&&t.sort(((e,t)=>e.lua.getTime()<t.lua.getTime()?1:e.lua.getTime()>t.lua.getTime()?-1:0));const[s,...i]=t;this._logger.verbose(`[Sync] Starting synchronization from ${s.store._storageType}`);const r=[es.anonymousId,es.subscriberStatus,es.isInDeletedState,es.DISMISSED_STATUS_EXPIRATION];yield Promise.all(r.map((e=>s.store._getData(e).then((t=>w(this,null,(function*(){if(t.isErr())return void(t.getErr().message!==Zt(e).message&&this._logger.verbose(`[Sync] Unable to read ${e} value from ${s.store._storageType}. ${t.getErr().message}`));let r=null===t.unwrap().value?i.map((t=>t.store._removeData(e).then((s=>[t.store._storageType,e,s])))):i.map((s=>s.store._setData(e,t.unwrap().value).then((t=>[s.store._storageType,e,t]))));yield Promise.all(r).then((e=>e.forEach((([e,t,s])=>{s.isErr()?this._logger.verbose(`[Sync] Unable to synchronize ${t} value to ${e}. ${s.getErr().message}`):this._logger.verbose(`[Sync] Synchronized ${t} value to ${e}`)}))))}))))))),yield Promise.all(i.map((e=>e.store._setLastUpdatedAt(s.lua).then((t=>{t.isErr()&&this._logger.verbose(`[Sync] Unable to synchronize lua value for ${e.store._storageType}. ${t.getErr().message}`)}))))),this._logger.verbose(`[Sync] Completed synchronization from ${s.store._storageType}`)})))(),yield this._evaluateSubscriberDismissedState()}))}_evaluateSubscriberDismissedState(){return w(this,null,(function*(){const e=yield this._getSubscriberStatus(),t=yield this._getSubscriberStatusDismissedExpiration();e===ge.DISMISSED&&(null===t||(new Date).getTime()>=t)?(this._logger.info("Removing subscriber dismissed state"),yield Promise.all([this._removeData(es.DISMISSED_STATUS_EXPIRATION),this._setSubscriberStatus(ge.NOT_DETERMINED)])):e!==ge.DISMISSED&&null!==t&&(this._logger.verbose("Removing subscriber dismissed expiration key"),yield this._removeData(es.DISMISSED_STATUS_EXPIRATION))}))}_getAnonymousId(){return w(this,null,(function*(){let e=(yield this._getData(es.anonymousId,{preferredStores:ls})).unwrapOrNull();if(!e){const t=this._legacyStorage._getAnonymousId(),s=yield this._setData(es.anonymousId,null!=t?t:ae(),{preferredStores:ls});s.isOk()&&(e=s.unwrap(),this._removeLegacyKey(ts[es.anonymousId]))}return e}))}_getAnonymousIdSync(){let e=this._getDataSync(es.anonymousId,{preferredStores:[Rt.COOKIE]}).unwrapOrNull();if(!e){const t=this._legacyStorage._getAnonymousId(),s=this._setDataSync(es.anonymousId,null!=t?t:ae(),{preferredStores:[Rt.COOKIE]});s.isOk()&&(e=s.unwrap())}return e}_getLocale(){return w(this,null,(function*(){return(yield this._getData(es.locale,{preferredStores:us})).unwrapOrNull()}))}_setLocale(e){return w(this,null,(function*(){return(yield this._setData(es.locale,e,{preferredStores:us})).unwrapOrNull()}))}_getTimeZone(){return w(this,null,(function*(){return(yield this._getData(es.timeZone,{preferredStores:us})).unwrapOrNull()}))}_setTimeZone(e){return w(this,null,(function*(){return(yield this._setData(es.timeZone,e,{preferredStores:us})).unwrapOrNull()}))}_getExternalId(){return w(this,null,(function*(){let e=(yield this._getData(es.externalId,{preferredStores:us})).unwrapOrNull();if(!e){const t=this._legacyStorage._getExternalId();if(t){(yield this._setData(es.externalId,t,{preferredStores:us})).isOk()&&(e=t,this._removeLegacyKey(ts[es.externalId]))}}return e}))}_getExternalIdSync(){let e=this._getDataSync(es.externalId,{preferredStores:[Rt.COOKIE]}).unwrapOrNull();if(!e){const t=this._legacyStorage._getExternalId();if(t){this._setDataSync(es.externalId,t,{preferredStores:[Rt.COOKIE]}).isOk()&&(e=t)}}return e}_setExternalId(e){return w(this,null,(function*(){return(yield this._setData(es.externalId,e,{preferredStores:us})).isOk()}))}_removeExternalId(){return w(this,null,(function*(){return(yield this._removeData(es.externalId,{preferredStores:us})).isOk()}))}_getIsSubscribed(){return w(this,null,(function*(){return(yield this._getSubscriberStatus())===ge.SUBSCRIBED}))}_getSubscriberStatus(){return w(this,null,(function*(){const e=yield this._getData(es.subscriberStatus,{preferredStores:ls});let t=ge.NOT_DETERMINED;const s=e.unwrapOrNull();if(null===s){const e=this._legacyStorage._getSubscriberStatus(),s=yield this._setData(es.subscriberStatus,pe[null!=e?e:t],{preferredStores:ls});s.isOk()&&(t=me(s.unwrap())),e&&this._removeLegacyKey(ts[es.subscriberStatus])}else t=me(s);return t}))}_getIsUserInSoftUnsubscribedState(){return w(this,null,(function*(){return!!(yield this._getData(es.IS_USER_IN_SOFT_UNSUBSCRIBE_STATE,{preferredStores:ls})).unwrapOrNull()}))}_setIsUserInSoftUnsubscribedState(){return w(this,null,(function*(){yield this._setData(es.IS_USER_IN_SOFT_UNSUBSCRIBE_STATE,1,{preferredStores:ls})}))}_unsetIsUserInSoftUnsubscribedState(){return w(this,null,(function*(){yield this._removeData(es.IS_USER_IN_SOFT_UNSUBSCRIBE_STATE,{preferredStores:ls})}))}_getSubscriberStatusSync(){const e=this._getDataSync(es.subscriberStatus,{preferredStores:[Rt.COOKIE]});let t=ge.NOT_DETERMINED;const s=e.unwrapOrNull();if(null===s){const e=this._legacyStorage._getSubscriberStatus(),s=this._setDataSync(es.subscriberStatus,pe[null!=e?e:t],{preferredStores:[Rt.COOKIE]});s.isOk()&&(t=me(s.unwrap()))}else t=me(s);return t}_setSubscriberStatus(e){return w(this,null,(function*(){return(yield this._setData(es.subscriberStatus,pe[e],{preferredStores:ls})).isOk()}))}_setSubscriberStatusDismissed(e){return w(this,null,(function*(){if(!(yield this._setSubscriberStatus(ge.DISMISSED)))return!1;return(yield this._setData(es.DISMISSED_STATUS_EXPIRATION,(new Date).getTime()+1e3*e,{preferredStores:ls})).isOk()}))}_getSubscriberStatusDismissedExpiration(){return w(this,null,(function*(){let e=(yield this._getData(es.DISMISSED_STATUS_EXPIRATION,{preferredStores:ls})).unwrapOrNull();if(!e){const t=yield this._legacyStorage._getDismissedStatusExpiration();t&&(e=t,yield this._setData(es.DISMISSED_STATUS_EXPIRATION,t,{preferredStores:ls}))}return e}))}_getIsInDeletedState(){return w(this,null,(function*(){let e=!1;const t=(yield this._getData(es.isInDeletedState,{preferredStores:ls})).unwrapOrNull();if(null!==t)e=!!t;else{const t=this._legacyStorage._getIsInDeletedState(),s=(null!=t?t:e)?1:0,i=yield this._setData(es.isInDeletedState,s,{preferredStores:ls});i.isOk()&&(e=!!i.unwrap(),this._removeLegacyKey(ts[es.isInDeletedState]))}return e}))}_setIsInDeletedState(e){return w(this,null,(function*(){return(yield this._setData(es.isInDeletedState,e?1:0,{preferredStores:ls})).isOk()}))}_getLastPageViewed(){return w(this,null,(function*(){return(yield this._getData(es.LAST_PAGE_VIEWED,{preferredStores:cs})).unwrapOrNull()}))}_setLastPageViewed(e){return w(this,null,(function*(){return(yield this._setData(es.LAST_PAGE_VIEWED,e,{preferredStores:cs})).isOk()}))}_removeLegacyKey(e){this._logger.debug(`!! Legacy key removal DISABLED !! key: ${e}`)}}class _s extends Jt{constructor(e){super(null,[Rt.LEGACY_COOKIE],null!=e?e:ee._getInstance("LegacyStoreManager"))}_getAnonymousId(){return this._getDataSync(ts[es.anonymousId]).unwrapOrNull()}_getExternalId(){return this._getDataSync(ts[es.externalId]).unwrapOrNull()}_getSubscriberStatus(){let e=null;const t=this._getDataSync(ts[es.subscriberStatus]).unwrapOrNull();return t&&(e=me(t)),e}_getIsInDeletedState(){return this._getDataSync(ts[es.isInDeletedState]).unwrapOrNull()}_getDismissedStatusExpiration(){return w(this,null,(function*(){return(yield this._getData(ts[es.DISMISSED_STATUS_EXPIRATION])).unwrapOrNull()}))}}class hs{constructor(e={},t){v(this,"_logger"),v(this,"_eventQueue"),v(this,"_trackedEventQueueTimer"),v(this,"_isEventQueueFlushing"),this.asyncProvider=e,this._logger=null!=t?t:ee._getInstance("EventManager"),this._eventQueue=[],this._isEventQueueFlushing=!1,this._setup()}_setup(){this._hydrateEventQueue().then((()=>this._startEventQueueTimer()))}_canSend(){return w(this,null,(function*(){var e,t,s;return null!=(s=null==(t=(e=this.asyncProvider)._canSend)?void 0:t.call(e))?s:Promise.resolve(!0)}))}_track(e,t={}){this._trackAsync(e,t).then()}_trackAsync(e){return w(this,arguments,(function*(e,t={}){try{let s;if(e instanceof Error){if(G._isSuppressed(e))return;s=yield _e._getErrorEvent(e),s.data.logs=this._logger._getLogs(!0).splice(-10).reverse(),t&&(s.data[L._tevFieldErrorContext]=t)}else s="string"==typeof e?yield _e._build(e,t):e;return yield this._trackEvent(s)}catch(s){this._logger.error(s)}}))}_trackEvent(e){return w(this,null,(function*(){if(this._eventQueue.length>=L._eventQueueMaxSize&&(this._eventQueue=this._eventQueue.slice(0,L._eventQueueMaxSize-1),yield this._persistEventQueue()),this._eventQueue.find((t=>t.event_id===e.event_id)))return void this._logger.debug(`Event ${e.event_id} has already been added to the queue`);if(this._eventQueue.find((t=>_e._isEqual(t,e))))return void this._logger.debug(`Event ${e.event_id} is a duplicate event`);if(!(yield this._canSend())||(t=e.action,!["debug","sdk_impression","prompt_not_shown","error","subscribed","manual_unsubscribed","unsubscribed","udr","notification_impression","notification_click","notification_close","soft_unsubscribe","soft_resubscribe","la_register","la_end","iam_click","iam_subscribe","iam_impression","iam_close","session_start","session_heartbeat"].includes(t)&&!ne(t)))return this._logger.debug(`Queueing event ${e.event_id} (${e.action})`),this._eventQueue.push(e),void(yield this._persistEventQueue());var t;this._logger.debug(`Processing event ${e.event_id} (${e.action})`);const s=yield this._process([e],(e=>["subscribed"].includes(e)?L._kApiAllowUrl:L._kApiEventsUrl)(e.action));s.isErr()&&(this._logger.verbose(`Requeueing event ${e.event_id} (${e.action})`),this._eventQueue.unshift(e))}))}_hydrateEventQueue(){return w(this,null,(function*(){if(!this.asyncProvider._getCachedEvents)return void this._logger.verbose("Cache evaluator not set");const e=yield this.asyncProvider._getCachedEvents();if(!e.length)return void this._logger.verbose("Cache is empty");const t=e.filter((e=>-1===this._eventQueue.findIndex((t=>t.event_id===e.event_id))));this._eventQueue.push(...t),t.length&&(this._logger.verbose(`Rehydrated ${t.length} event(s) from cache`),yield this._persistEventQueue())}))}_startEventQueueTimer(){this._trackedEventQueueTimer?this._logger.verbose("Queue timer already initialized"):this._trackedEventQueueTimer=setTimeout((()=>{this._flushEventQueue().then((()=>{this._trackedEventQueueTimer=null,this._startEventQueueTimer()}))}),L._eventQueueFlushIntervalMS)}_flushEventQueue(){return w(this,null,(function*(){if(!this._eventQueue.length||this._isEventQueueFlushing||!(yield this._canSend()))return;yield this._cleanupEventQueue();const e=yield this._getNextBatch();if(!e.length)return void this._setEventQueueFlushingState(!1);(yield this._process(e,L._kApiEventsUrl)).isErr()&&this._eventQueue.push(...e)}))}_process(e,t){return w(this,null,(function*(){let s;yield this._preloadTrackedEventUtilProperties(),e.forEach((e=>{_e._prepareSendEvent(e)}));const i=e.map((e=>{const t=e,{sendAttemptCount:i,jxms:r,data:n}=t,o=b(t,["sendAttemptCount","jxms","data"]);return s=r,Object.assign((e=>{const t={};for(const s of Object.keys(e))void 0!==e[s]&&null!==e[s]&&(t[s]=e[s]);return t})(o),{data:n})}));let r;this._logger.verbose("Dispatching event processing");try{let n=1==i.length?i[0]:i;this._logger.verbose(`Building request data: ${n}`),r=new Te(Re.POST,t,n,{jitterMillis:s}),e.some((e=>{return t=e.action,["subscribed","soft_unsubscribe","soft_resubscribe","la_register","iam_click","iam_subscribe","iam_impression","iam_close"].includes(t);var t}))&&(this._logger.verbose("Adding priority header"),r._setIsPriority(!0)),this._logger.debug(`Prepared ${e.length} event(s):`,n)}catch(n){const e=B(n);return this._logger.error(`Unable to prepare events: ${e.message}`),De.Err(e)}if(r){const e=yield r._perform();return e.isErr()?(this._logger.error("Send failed;",e.getErr().message),e):(this._logger.verbose("Send successful"),De.Ok(!0))}return this._logger.verbose("No request to process"),De.Ok(!1)}))}_getNextBatch(){return w(this,null,(function*(){if(!(this._eventQueue.length>L._eventQueueFlushTriggerSize?L._eventQueueFlushTriggerSize:this._eventQueue.length))return[];const e=[],t=!!this.asyncProvider._getIsSubscribed&&(yield this.asyncProvider._getIsSubscribed()),s=this._eventQueue.filter((s=>{let i=t||(r=s.action,!["external_id","deregister_external_id","permission_changed","profile","profile_append","profile_remove","page_tag_visit","purchase","update_cart","add_to_cart","view_item","notification_impression","notification_click","notification_close","soft_unsubscribe","soft_resubscribe","manual_unsubscribed","unsubscribed","session_heartbeat","session_start"].includes(r));var r;return i&&e.push(s),!i}));return e.length&&(this._eventQueue=s,yield this._persistEventQueue()),e}))}_cleanupEventQueue(){return w(this,null,(function*(){if(!this._eventQueue.length)return;const e=this._eventQueue.filter((e=>e.sendAttemptCount<L._eventMaxSendAttempts));e.length!==this._eventQueue.length&&(this._eventQueue=e,yield this._persistEventQueue())}))}_setEventQueueFlushingState(e){this._isEventQueueFlushing=e}_persistEventQueue(){return w(this,null,(function*(){if(this.asyncProvider._setCachedEvents)return this._eventQueue.forEach((e=>{e.token instanceof PushSubscription&&(e.token=e.token.toJSON())})),this.asyncProvider._setCachedEvents(this._eventQueue).catch((e=>this._logger.critical(e))).then()}))}_preloadTrackedEventUtilProperties(){return w(this,null,(function*(){var e,t,s,i,r,n,o,a,l;yield Promise.all([_e._domainId?null:null==(s=null==(t=(e=this.asyncProvider)._getDomainId)?void 0:t.call(e))?void 0:s.then((e=>{_e._domainId=e})),_e._anonymousId?null:null==(n=null==(r=(i=this.asyncProvider)._getAnonymousId)?void 0:r.call(i))?void 0:n.then((e=>{_e._anonymousId=e})),_e._token?null:null==(l=null==(a=(o=this.asyncProvider)._getToken)?void 0:a.call(o))?void 0:l.then((e=>{e&&(_e._token=e)}))]).catch()}))}}class gs{constructor(e,t){v(this,"_userProfileMod"),this.settingsStore=e,this.userStore=t}get _isBaseEnvSupported(){return Ke._getIsEnvBaseSupported()[0]}setUserProfileModule(e){this._userProfileMod=e}_canSend(){return w(this,null,(function*(){return this.userStore._getIsInDeletedState().then((e=>!e))}))}_getAnonymousId(){return w(this,null,(function*(){return this.userStore._getAnonymousId()}))}_getIsSubscribed(){return w(this,null,(function*(){return this.userStore._getIsSubscribed()}))}_getToken(){return w(this,null,(function*(){return this._isBaseEnvSupported&&this._userProfileMod?this._userProfileMod.getToken():null}))}_getDomainId(){return w(this,null,(function*(){var e,t,s,i;let r=null!=(t=null==(e=fe._injectedDomainConfig)?void 0:e.id)?t:null;if(!r){const e=yield this.settingsStore._getDomainConfig();r=null!=(i=null==(s=null==e?void 0:e.value)?void 0:s.id)?i:null}return r}))}_getCachedEvents(){return w(this,null,(function*(){return this.settingsStore._getCachedEvents()}))}_setCachedEvents(e){return w(this,null,(function*(){return this.settingsStore._setCachedEvents(e)}))}}class ps{constructor(e){v(this,"timer"),this.store=e,this.timer=new st(this._handleSessionTimerDidAdvance.bind(this),1,{autoStart:!1})}_start(){return w(this,null,(function*(){this.timer.isStarted?this.timer._unpause():this.timer._start()}))}_stop(){return w(this,null,(function*(){this.timer._pause()}))}_handleSessionTimerDidAdvance(){return w(this,null,(function*(){const e=yield this.store._getSessionRuntimeSeconds();yield this.store._setSessionRuntimeSeconds(e+1)}))}}class ms{constructor(e){v(this,"transient"),this.transient=new ps(e)}_start(){return w(this,null,(function*(){yield this.transient._start()}))}}class Ss extends Jt{constructor(e){super(Tt.sdk,[Rt.SESSION,Rt.MEM],null!=e?e:ee._getInstance("SessionStore"))}_setSessionStart(e){return w(this,null,(function*(){return(yield this._setData(is.SESSION_START,e)).unwrapOrNull()}))}_getSessionStart(){return w(this,null,(function*(){const e=(yield this._getData(is.SESSION_START)).unwrapOrNull();return e?new Date(e):null}))}_getCurrentPageViewStart(){return w(this,null,(function*(){const e=(yield this._getData(is.SESSION_PAGE_VIEW_START)).unwrapOrNull();return e?new Date(e):null}))}_getSessionPageViewCount(){return w(this,null,(function*(){return(yield this._getData(is.SESSION_PAGE_VIEWS)).unwrapOr(0)}))}_getSessionRuntimeSeconds(){return w(this,null,(function*(){return(yield this._getData(is.SESSION_RUNTIME)).unwrapOr(0)}))}_setSessionRuntimeSeconds(e){return w(this,null,(function*(){return(yield this._setData(is.SESSION_RUNTIME,e)).unwrapOrNull()}))}_incrementSessionPageViewCount(){return w(this,null,(function*(){const e=yield this._getSessionPageViewCount();yield Promise.all([this._setData(is.SESSION_PAGE_VIEWS,e+1),this._setData(is.SESSION_PAGE_VIEW_START,(new Date).getTime())])}))}}class Es{constructor(e,t){v(this,"debugPanelElement"),this.settingsStore=e,this.eventManager=t}_getIsEventsEnabled(){return w(this,null,(function*(){let e=[];const t=fe._injectedDomainConfig;if(t)e=t.flags;else{const t=yield this.settingsStore._getDomainConfig();(null==t?void 0:t.value.flags)&&(e=t.value.flags)}return e.includes(fe._sdkDebugEventsEnabledFlag)}))}_shouldShowDebugPanel(){return this._currLocation&&/(^|[?&#])(push(ly)?_debug(73485)?)=1(?=[&#]|$)/i.test(this._currLocation.href)}get _currLocation(){return Ue._location}get _document(){return Ue._document}get _clipboard(){return Ue._navigator.clipboard}get _userAgent(){return Ue._navigator.userAgent}_hideDebugPanel(){return w(this,null,(function*(){if(this.debugPanelElement)try{this._document.body.removeChild(this.debugPanelElement)}catch(e){}}))}_showDebugPanel(e){return w(this,arguments,(function*({userId:e,subscriberStatus:t,endpoint:s,externalId:i,browserPermission:r}){var n,o,a,l;const u=this._document,c=`Push User Id: ${e}, Subscriber State: ${t}, External ID: ${i}, Endpoint: ${s}, Browser Permissions: ${r}, UserAgent: ${this._userAgent}`.trim(),d=`pushly_debug_handle_${ae(12)}`,_=`pushly_debug_close_${ae(12)}`,h=`pushly_debug_copy_${ae(12)}`,g=`pushly_debug_shadow_${ae(12)}`,p=null!=(n=this.debugPanelElement)?n:u.createElement("div");var m;p.classList.add("sw-user-debug-drawer-wrapper"),p.innerHTML=`\n<style>\n.sw-user-debug-drawer-wrapper {\n  display: block !important;\n  box-sizing: border-box;\n  position: absolute;\n  z-index: 9999;\n  bottom: 120px;\n  left: -320px;\n  width: 320px;\n  border-radius: 4px;\n  box-shadow: 0 0 12px -3px #0003;\n\n  background: rgb(251, 251, 251);\n  transition: left .24s linear;\n  \n  font-family: -apple-system, system, system-ui, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;\n  font-size: 13px;\n  line-height: 1.15em;\n  font-weight: 500;\n  color: #545454;\n}\n\n.sw-user-debug-drawer-wrapper.open {\n  left: 0;\n}\n\n.sw-user-debug-drawer-wrapper .sw-user-debug-shadow {\n  visibility: hidden;\n  border: none;\n  box-shadow: none;\n  outline: none;\n  position: absolute;\n  z-index: -1;\n}\n\n.sw-user-debug-drawer-wrapper .sw-user-debug-shadow.copying {\n  visibility: visible;\n}\n\n.sw-user-debug-drawer-wrapper > .sw-user-debug-drawer > .sw-user-debug-drawer-handle {\n  display: block;\n  box-sizing: border-box;\n  position: absolute;\n  background: #0077a0;\n  border-radius: 0 0 6px 6px;\n  box-shadow: -1px 1px 10px -4px black;\n  top: 50%;\n  right: -66px;\n  transform: translateY(-50%) rotate(-90deg);\n  padding: 8px 20px 8px 20px;\n  color: #fff;\n  font-size: 13px;\n  white-space: nowrap;\n\n  cursor: pointer;\n}\n\n.sw-user-debug-drawer-wrapper > .sw-user-debug-drawer > .sw-user-debug-drawer-handle > .sw-user-debug-label {\n  display: block;\n  box-sizing: border-box;\n  width: 60px;\n}\n\n.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content {\n  font-size: 12px;\n  padding: 20px;\n}\n\n.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-label {\n  color: #222;\n  font-weight: bold;\n\n  display: block;\n  box-sizing: border-box;\n  margin-bottom: 4px;\n}\n\n.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-value {\n  display: block;\n  word-break: keep-all;\n  box-sizing: border-box;\n  border: 1px #0002 solid;\n  border-radius: 3px;\n  padding: 6px;\n  margin-bottom: 1em;\n  width: 100%;\n  background: #F2F2F2;\n  font-size: 1em;\n  line-height: 14px;\n}\n\n.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-actions {\n  display: flex;\n  align-content: flex-end;\n  justify-content: flex-end;\n  gap: 8px;\n\n  margin-top: 12px;\n}\n\n.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-actions > .sw-user-debug-btn {\n  display: block;\n  border: none;\n  padding: 6px 14px;\n  border-radius: 3px;\n  transition: all .24s;\n  cursor: pointer;\n}\n\n.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-actions > .sw-user-debug-btn.copy {\n  background: #0077a0;\n  color: #fff;\n  transition: all 1s;\n}\n\n.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-actions > .sw-user-debug-btn.copy.success {\n  background: green;\n}\n.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-actions > .sw-user-debug-btn.copy.success span {\n  font-size: 12px;\n}\n\n.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-actions > .sw-user-debug-btn.close {\n  background: unset;\n  color: #888888;\n}\n\n</style>\n<div class="sw-user-debug-drawer">\n    <div id="${d}" class="sw-user-debug-drawer-handle">\n        <span class="sw-user-debug-label">\n            Push SDK\n        </span>\n    </div>\n    <div class="sw-user-debug-drawer-content">\n        <div class="sw-user-debug-label">\n            Push User ID\n        </div>\n        <input class="sw-user-debug-value" value="${e}" disabled="disabled" />\n\n        <div class="sw-user-debug-label">\n            External ID\n        </div>\n        <input class="sw-user-debug-value" value="${null!=i?i:"Not set"}" disabled="disabled" />\n\n        <div class="sw-user-debug-label">\n            Subscription State\n        </div>\n        <span>\n            ${m=t,m.charAt(0).toUpperCase()+m.slice(1)}\n        </span>\n\n        <div class="sw-user-debug-actions">\n            <button id="${_}" class="sw-user-debug-btn close">\n                Close\n            </button>\n            <button id="${h}" class="sw-user-debug-btn copy">\n                Copy\n            </button>\n        </div>\n    </div>\n</div>\n`.trim().replace(/(<[^>]*?>)|[\r\n]+|[\s]{2,}/g,"$1").trim();const S=()=>w(this,null,(function*(){p.classList.contains("open")?p.classList.remove("open"):p.classList.add("open")})),E=null==(o=p.getElementsByClassName("sw-user-debug-drawer-handle"))?void 0:o[0];E&&E.id===d&&E.addEventListener("click",S);const f=null==(a=p.getElementsByClassName("close"))?void 0:a[0];f&&f.id===_&&f.addEventListener("click",S);const b=()=>{let e=!1;try{this._clipboard.writeText(c),e=!0}catch(t){try{const t=u.createElement("input");u.body.appendChild(t),t.id=g,t.classList.add("sw-user-debug-shadow"),t.type="textarea",t.defaultValue=c,t.classList.add("copying"),t.select(),e=u.execCommand("copy"),t.classList.remove("copying")}catch(s){}}e&&(v.classList.add("success"),v.innerHTML="Copied <span>&#x2713;</span>".trim(),setTimeout((()=>{v.classList.remove("success"),v.innerHTML="Copy"}),1e3))},v=null==(l=p.getElementsByClassName("copy"))?void 0:l[0];v&&v.id===h&&v.addEventListener("click",b),this.debugPanelElement||(u.body.appendChild(p),this.debugPanelElement=p)}))}_debug(e,t={},s=!1){(()=>w(this,null,(function*(){ne(e)&&(s||(yield this._getIsEventsEnabled()))&&this.eventManager._track(e,t)})))().then()}_debugPromptNotShown(e,t){const s={[fe._tevDataPromptNotShownKey]:e};return t&&(s[fe._tevFieldErrorMessage]=t),this._debug(re.PROMPT_NOT_SHOWN,s)}_debugUnknownAsyncBrowserCommand(e){return this.eventManager._track(new G(W.UNKNOWN_ASYNC_COMMAND,null,String(e[0])),{async_command:e})}_debugUnknownConfigurationKeys(e){return this.eventManager._track(new G(W.UNKNOWN_CONFIG_KEYS),{push_sdk_config:e})}_debugUnknownContextKey(e){return this.eventManager._track(new G(W.UNKNOWN_CONTEXT_KEY,null,e),{context_key:e})}_debugUnknownPromptMessage(e){return this.eventManager._track(new G(W.UNKNOWN_PROMPT_MESSAGE),{prompt_message:e})}}u=new WeakMap,c=new WeakMap;let fs=class e{constructor(e,t,s,i,r,n){v(this,"UserProfile"),v(this,"EComm"),v(this,"PushNotifications"),v(this,"Prompts"),P(this,u,void 0),P(this,c,void 0),D(this,u,e),D(this,c,null!=n?n:ee._getInstance()),this.UserProfile=t,this.EComm=s,this.PushNotifications=i,this.Prompts=r}static getInstance(){const t=we();if(t)return t;const s=new as,i=new ds(new _s),r=new Ss,n=new gs(s,i),o=new hs(n);Xe._setEventManager(o);const a=new Wt(o,s,i,new ms(r),new Es(s,o)),l=new he(a),u=new ye(a),c=new Ee(a),d=new Ie(a);return n.setUserProfileModule(l),new e(a,l,u,c,d)}setConfiguration(e){I(this,u)._setConfiguration(e)}getConfiguration(){var e;return null!=(e=I(this,u).loadConfig)?e:null}get version(){return fe._libraryVersion}get iid(){return I(this,u).iid}get isLoaded(){return I(this,u).isLoaded}registerPushSDKLifecycleCallbacks(e){I(this,u)._registerPushSdkLifecycleCallbacks(e)}registerPermissionLifecycleCallbacks(e){I(this,u)._registerPermissionLifecycleCallbacks(e)}registerAppMessageLifecycleCallbacks(e){I(this,u)._registerAppMessageLifecycleCallbacks(e)}registerPromptLifecycleCallbacks(e){I(this,u)._registerPromptLifecycleCallbacks(e)}get logLevel(){return I(this,c).logLevel}set logLevel(e){I(this,c).logLevel=e}debug(e=!0){return w(this,null,(function*(){yield I(this,u)._toggleDebugPanel(e)}))}load(e){this.setConfiguration(e)}requestNotificationPermission(e){return w(this,null,(function*(){void 0===e?this.PushNotifications.showPermissionPrompt():this.PushNotifications.showPermissionPrompt(e)}))}showLogs(e=!0){this.logLevel=e?O.VERBOSE:O.NONE}getLogs(){return I(this,c)._getLogs()}isUserSoftUnsubscribed(){return w(this,null,(function*(){return this.PushNotifications.getIsPaused()}))}isUserEligibleToPrompt(){return w(this,null,(function*(){return this.PushNotifications.getIsEligibleToPrompt()}))}isUserSubscribed(){return w(this,null,(function*(){return this.PushNotifications.getIsSubscribed()}))}get context(){return I(this,u)._legacyContext}getUser(){return this.context.user}on(e,t){this.push([`on_${e}`,t])}watch(e,t){this.on(e,t)}watchOnce(e,t){this.on(e,t)}trigger(e,t){this.push([e,t])}push(e,t){try{switch(e[0]){case te.LOAD:this.setConfiguration(e[1]);break;case te.REQUEST_USER_DELETION:this.UserProfile.requestUserDeletion();break;case te.DEBUG:I(this,u)._toggleDebugPanel();break;case te.CONFIRM_CONSENT:break;case te.EXTERNAL_ID:this.UserProfile.setExternalId(e[1]);break;case te.DEREGISTER_EXTERNAL_ID:this.UserProfile.unsetExternalId();break;case te.PROFILE:this.UserProfile.set(e[1]);break;case te.PROFILE_APPEND:Object.entries(e[1]).forEach((([e,t])=>{this.UserProfile.append(e,t)}));break;case te.PROFILE_REMOVE:Object.entries(e[1]).forEach((([e,t])=>{this.UserProfile.remove(e,t)}));break;case te.PAGE_TAG_VISIT:{const t=Ke._location.href;let i=[];if(Array.isArray(e[1]))i=e[1];else try{i=[String(e[1])]}catch(s){}i=i.filter((e=>{try{return void 0!==e&&"undefined"!==e&&null!==e&&"null"!==e&&!!String(e).trim()}catch(s){}return!1})).map((e=>e.toString())),I(this,u)._executeWhenConfiguredIfEnabled((()=>{I(this,c).verbose(`Sending ${i.length} tag${i.length>1?"s":""} for ${t}`),I(this,u).eventManager._track(re.PAGE_TAG_VISIT,{[fe._tevDataPageUrlKey]:t,[fe._tevDataPageTagsKey]:i})}));break}case te.SHOW_PROMPT:if(1===e.length)this.PushNotifications.showPermissionPrompt();else{const{id:t,checkEligibility:s}=e[1];if(null==t)return void I(this,c).warn(`${te.SHOW_PROMPT} command missing Prompt ID.`);this.PushNotifications.showPermissionPrompt(t,{skipEligibilityCheck:!s})}break;case te.VIEW_ITEM:{const t="products"in e[1]?e[1].products:e[1].events;Array.isArray(t)&&I(this,u)._executeWhenConfiguredIfEnabled((()=>{I(this,c).verbose(`Adding ${t.length} item${t.length>1?"s":""} to viewed items`),I(this,u).eventManager._track(re.VIEW_ITEM,e[1])}));break}case te.ADD_TO_CART:{const t="products"in e[1]?e[1].products:e[1].events;Array.isArray(t)&&I(this,u)._executeWhenConfiguredIfEnabled((()=>{I(this,c).verbose(`Adding ${t.length} item${t.length>1?"s":""} to cart`),I(this,u).eventManager._track(re.ADD_TO_CART,e[1])}));break}case te.UPDATE_CART:{const t="products"in e[1]?e[1].products:e[1].events;Array.isArray(t)&&I(this,u)._executeWhenConfiguredIfEnabled((()=>{t.length?I(this,c).verbose(`Updating cart with ${t.length} item${t.length>1?"s":""}.`):I(this,c).verbose("Clearing cart"),I(this,u).eventManager._track(re.UPDATE_CART,e[1])}));break}case te.PURCHASE:if(1===e.length)I(this,c).verbose("Tracking purchase"),I(this,u).eventManager._track(re.PURCHASE);else{let t;"products"in e[1]&&(t=e[1].products=e[1].products.map((e=>ve(e,be.PRODUCT)))),"events"in e[1]&&(t=e[1].events=e[1].events.map((e=>ve(e,be.EVENT)))),Array.isArray(t)||(t=void 0);const s=["Tracking purchase"];(null==t?void 0:t.length)&&s.push(`of ${t.length} item${t.length>1?"s":""}`),"purchase_id"in e[1]&&s.push(`Purchase ID: ${e[1].purchase_id}`),"price_value"in e[1]&&s.push(`Total value: ${e[1].price_value}`),I(this,c).verbose(s.join(" ")),I(this,u).eventManager._track(re.PURCHASE,e[1])}break;case`on_${se.LOADED}`:case`on_${se.WEB_PUSH_SUPPORTED}`:case`on_${se.WEB_PUSH_UNSUPPORTED}`:case`on_${se.READY}`:case`on_${se.PROMPT_ELIGIBLE}`:case`on_${se.PROMPT_INELIGIBLE}`:case`on_${se.PROMPT_SHOWN}`:case`on_${se.PROMPT_DISMISSED}`:case`on_${se.PROMPT_ALLOWED}`:case`on_${se.PERMISSION_SHOWN}`:case`on_${se.PERMISSION_ALLOWED}`:case`on_${se.PERMISSION_DENIED}`:case`on_${se.PERMISSION_DISMISSED}`:{const s=e[0].replace(/^on_/,"");"function"==typeof e[1]?I(this,u)._registerLegacyEventCallback(s,e[1],t):I(this,c).warn("Invalid SDK event handler callback specified:",e);break}default:!ie.includes(e[0])&&I(this,u).debugController&&I(this,u).debugController._debugUnknownAsyncBrowserCommand(e),I(this,c).warn("Unknown SDK command received:",e)}}catch(i){const e=B(i);I(this,c).error(e),I(this,u).eventManager._track(e)}}};const bs=fs.getInstance();let vs;try{vs=ee._getInstance()}catch(ys){vs=console}try{if(window.self===window.top||window.self!==window.top&&window.frameElement&&"about:blank"===window.frameElement.src){const e=window.PushlySDK;if(e&&e instanceof Array)for(const t of e)bs.push(t);window.PushlySDK=bs}else vs.warn("PushlySDK must be loaded from the top frame or a sourceless iFrame")}catch(Is){vs.warn("Unable to assign global PushlySDK"),vs.error(Is)}return e.PushSDK=bs,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),e}({});
